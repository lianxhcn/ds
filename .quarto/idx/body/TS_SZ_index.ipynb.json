{"title":"上证指数的时序特征","markdown":{"headingText":"上证指数的时序特征","containsRefs":false,"markdown":"\n&emsp;\n\n\n本讲使用 `akshare` 库获取上证指数的历史数据，并使用 `statsmodels` 库进行时间序列分析。主要包括：\n- 在线获取上证指数的历史数据，包括：收盘价、开盘价、最高价、最低价、成交量等。\n- 计算日收益率、周收益率和年化收益率，并采用 `matplotlib` 库进行可视化。\n- 图示收益率的分布特征\n  - 收益率的直方图、密度函数图等\n  - 收益率的自相关图、偏自相关图等\n- 收益率的波动性分析\n  - 收益率标准差、方差等\n\n## 获取数据\n\n## 收盘价走势图\n\n### 静态图形\n\n### 交互图\n\n接下来，我们使用 `plotly` 扩展包创建一个交互式折线图。顾名思义，这类图形可以在在鼠标悬停时，显示该时点的日期、收益率等信息。要点如下：\n\n1. 数据准备\n\n   - **时间筛选**：通过 `start_date` 和 `end_date` 设置起始时间和结束时间，结合 `pandas.to_datetime()` 函数将日期列转换为标准时间格式，并筛选出指定时间区间内的数据。\n   - **数据合并**：使用 `merge()` 函数将包含日收益率的 DataFrame 与主数据表按照日期列进行合并，使得每一日的收盘价配套显示对应的日收益率。\n\n2. 图形绘制\n\n   - **图层添加**：调用 `go.Scatter()` 添加一条收盘价的折线图（`mode='lines'` 表示仅显示折线，不显示节点）。\n   - **交互信息**：利用 `hovertemplate` 参数自定义鼠标悬停时显示的内容，包括：日期（格式化为 `年-月-日`）、收盘价（保留两位小数）、日收益率（百分号格式，保留两位小数）等。\n\n3. 图表布局设置\n\n   - 通过 `fig.update_layout()` 设置图表标题、坐标轴标题、交互模式等：\n     - `hovermode='x unified'`：使得交互提示在同一垂直线上统一显示\n     - `template='plotly_white'`：采用白色背景模板\n   - 设置 `margin` 确保图形四周留有足够的空间，避免遮挡\n\n该图表可嵌入网页或 Jupyter Notebook 中动态展示，是教学、报告与展示金融时间序列数据的有力工具。\n\n### 钉形图\n\n钉形图（`candlestick chart`）是一种常用的金融图表，用于显示某一时间段内的价格波动情况。它通过“钉子”形状的图形来表示开盘价、收盘价、最高价和最低价。钉形图的主要优点在于能够直观地展示价格走势和波动范围，便于分析市场情绪和趋势。\n\n> 有关钉形图的详细解释，参见 [Everything you can do with a time series](https://www.kaggle.com/code/thebrownviking20/everything-you-can-do-with-a-time-series)\n\n钉形图的构建主要包括以下几个步骤：\n1. **数据准备**：从 `akshare` 获取上证指数的历史数据，包括开盘价、收盘价、最高价和最低价等。将数据转换为 `pandas` DataFrame 格式，并设置日期为索引。\n2. **图形绘制**：使用 `plotly.graph_objects` 中的 `go.Candlestick()` 函数创建钉形图。该函数需要传入开盘价、收盘价、最高价和最低价等数据，并设置相应的颜色（上涨为绿色，下跌为红色）。\n3. **图表布局设置**：通过 `fig.update_layout()` 设置图表的标题、坐标轴标签、背景颜色等属性。可以使用 `plotly` 提供的多种模板来美化图表。\n4. **交互功能**：钉形图支持鼠标悬停时显示详细信息，包括日期、开盘价、收盘价、最高价和最低价等。可以通过设置 `hovertemplate` 来定制显示内容。\n\n## 收益率\n\n收益率是金融时间序列分析中的重要指标，通常用于衡量资产价格变动的幅度和速度。我们将计算上证指数的日收益率、周收益率和年化收益率，并进行可视化展示。\n- **日收益率**：表示某一天的收盘价与前一天收盘价的比值变化，通常用百分比表示。\n- **周收益率**：表示某一周的收盘价与前一周收盘价的比值变化，通常用百分比表示。\n- **年化收益率**：表示某一年内的收益率，通常用百分比表示。年化收益率可以通过将日收益率乘以交易天数来计算。\n\n### 日收益率时序图\n\n- **计算方法**：日收益率 = (今日收盘价 - 昨日收盘价) / 昨日收盘价\n- **可视化**：\n  - 使用 `plt.plot(x, y)` 绘制日收益率的折线图，观察其波动趋势。\n  - 使用 `matplotlib` 绘制日收益率的直方图和密度函数图，观察其分布特征。\n\n### 箱线图（Boxplot）\n\n箱线图用于展示数据的分布特征，常用于识别数据的集中趋势、离散程度以及可能存在的异常值（outliers）。它特别适合金融数据的分布分析，比如收益率、资产波动率等。\n\n详情参见：[]()\n\n箱线图由以下几个核心部分组成：\n\n* **中位数（Median）**：箱体中间的横线，表示数据的第 50 个百分位数。\n* **第一四分位数（Q1）**：箱体下缘，表示数据的第 25 个百分位数。\n* **第三四分位数（Q3）**：箱体上缘，表示数据的第 75 个百分位数。\n* **四分位距（IQR）**：$IQR = Q3 - Q1$，表示数据的中间 50% 的范围。\n* **上胡须**：延伸至 $Q1 - 1.5 \\times IQR$ 的位置，用于捕捉非异常值的最大范围。\n* **下胡须**：延伸至 $Q3 + 1.5 \\times IQR$ 的位置，用于捕捉非异常值的最小范围。\n* **异常值（Outliers）**：胡须之外的黑点，表示极端收益波动的观察值。\n\n<img style=\"width: 550px\" src=\"https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/box_plots_01.png\">\n\n```raw\n     Q1-1.5IQR   Q1   median  Q3   Q3+1.5IQR\n                  |-----:-----|\n  o      |--------|     :     |--------|    o  o\n                  |-----:-----|\nflier             <----------->            fliers\n                       IQR\n```\n\n### 同时呈现多个箱线图\n\n在实际应用中，可以同时呈现多个箱线图，以便比较不同时间段或不同资产的收益率分布特征。可以使用 `matplotlib` 的 `subplots()` 函数创建多个子图，并在每个子图上绘制箱线图。\n\n## 直方图\n\n### 何谓直方图？\n\n直方图（Histogram）是一种用于展示**数值型变量分布情况**的图形工具。其原理是将数据划分为若干**连续、不重叠的区间**（称为“bin”或“箱子”），统计每个区间内数据点的数量，并以矩形的高度表示频数或频率。\n\n设有一组日收益率数据 $\\{r_1, r_2, \\ldots, r_n\\}$，我们将其划分为 $K$ 个等宽的区间，每个区间的宽度为：\n\n$$\nh = \\frac{\\max(r) - \\min(r)}{K}\n$$\n\n第 $k$ 个区间为 $[a_k, a_{k+1})$，其频数记为 $f_k$，那么对应的矩形高度就是 $f_k$（或标准化后的频率）。绘图过程中，横轴表示收益率区间，纵轴表示该区间的频数或频率。\n\n### 核心代码说明\n\n以下代码用于绘制上证指数的日收益率直方图：\n\n```python\nsz_index_plot['daily_return'].dropna().hist(bins=200, figsize=(8, 5))\n```\n\n说明如下：\n\n* `daily_return`：表示日收益率列。\n* `dropna()`：删除缺失值，避免影响绘图。\n* `hist()`：调用 `pandas.DataFrame.hist()` 方法，底层封装了 `matplotlib.pyplot.hist()`。\n* `bins=200`：将数据划分为 200 个等宽区间，越大越平滑，但过大可能导致过度拟合。\n\n### 常用参数汇总\n\n| 参数名       | 说明                | 示例                                             |\n| --------- | ----------------- | ---------------------------------------------- |\n| `bins`    | 设置箱子的数量或箱边界       | `bins=50`，或 `bins=[-0.1, -0.05, 0, 0.05, 0.1]` |\n| `density` | 是否标准化为概率密度（面积为 1） | `density=True`                                 |\n| `figsize` | 图形大小（宽, 高）        | `figsize=(10, 6)`                              |\n| `color`   | 设置柱体颜色            | `color='skyblue'`                              |\n| `alpha`   | 设置透明度（0\\~1）       | `alpha=0.7`                                    |\n| `grid`    | 是否显示网格            | `grid=True`                                    |\n\n### 实用建议\n\n- 若要观察收益率的**分布是否对称**，建议加上垂直参考线，例如均值或中位数。\n- 若需与正态分布对比，可叠加核密度曲线（使用 `seaborn.histplot` 或 `sns.kdeplot`）。\n- 若数据包含极端值，可调整 `xlim` 参数限制横轴范围，聚焦主要密度区域。\n\n直方图有助于识别收益率分布的偏态、厚尾特征，是金融时间序列分析中不可或缺的工具之一。\n\n## 核密度函数\n\n核密度函数 (Kernel Density Estimation, KDE) 是一种用于估计未知概率密度函数的非参数方法，适用于连续型数据且不依赖于事先指定的分布形式。其基本思想是：在密度函数的每一个估计点上，根据样本点到该点的距离，使用核函数分配权重并加权平均，从而构建平滑的密度曲线。\n\n设样本为 $x_1, x_2, \\dots, x_n$，其密度函数在任意点 $x$ 上的估计形式为：\n\n$$\n\\hat{f}_h(x) = \\frac{1}{n h} \\sum_{i=1}^{n} K\\left( \\frac{x - x_i}{h} \\right)\n$$\n\n其中：\n\n- $K(\\cdot)$ 是核函数（kernel function），通常是一个对称的概率密度函数；\n- $h > 0$ 是带宽参数（bandwidth），控制核函数的缩放程度和平滑水平；\n- $\\hat{f}_h(x)$ 是点 $x$ 处的密度估计值。\n\n### 核函数\n\n在实际应用中，核函数的选择对估计结果的影响相对较小，而带宽的设置对估计曲线的光滑程度影响较大。\n\n核函数的作用可以理解为：在估计点 $x$ 处，根据样本点 $x_i$ 与 $x$ 之间的距离，赋予不同的权重。距离 $x$ 越近的样本点，其权重越大；距离越远，权重越小。通过对所有样本点的加权平均，得到该点的密度估计。将所有位置的估计值拼接起来，即可得到整体的密度函数曲线。\n\n为了更清楚地理解核函数的加权机制，我们可以对距离进行标准化处理，设：\n\n$$\nu_i = \\frac{X_i - c}{h}\n$$\n\n则以下两式等价：\n\n$$\n|u_i| \\leq 1 \\Longleftrightarrow |X_i - c| \\leq h\n$$\n\n记 $D_i = |X_i - c|$，表示第 $i$ 个观察值与估计点 $c$ 的距离。核函数的任务就是为每个 $D_i$ 分配权重。\n\n如下图所示，三种典型核函数的权重分配机制具有显著差异：\n\n<img style=\"width: 600px\" src=\"https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/Fig-NP-kernel-fn01.png\">\n\n- Uniform 核：在 $|u| \\leq 1$ 范围内赋予所有观察值相同的权重，超出范围的样本点权重为 0 (相当于弃之不用)。对应的密度估计不具有平滑性，常用于教学演示。\n- Triangle 核：采用线性下降的加权方式，距离估计点越近权重越大，边界处权重为 0，估计结果具有一定的连续性。\n- Epanechnikov 核：采用抛物线型权重函数，在 $u=0$ 处取得最大值，具有最小均方误差（MSE）性质，估计曲线光滑、效率较高。\n- Gaussian 核：采用正态分布函数，所有样本点均有非零权重，平滑程度高，适用于大多数实际应用场景。\n\n### 核函数的性质\n\n**常见核函数及其表达式：**\n\n- **Uniform 核函数** $K(u) = \\frac{1}{2} \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$ （也称为 Rectangular 核函数）\n\n- **Triangle 核函数** $K(u) = (1 - \\left|u\\right|) \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$\n- **Epanechnikov 核函数** $K(u) = \\frac{3}{4}(1 - u^2) \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$\n- **Quartic 核函数** $K(u) = \\frac{15}{16}(1 - u^2)^2 \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$\n- **Triweight 核函数** $K(u) = \\frac{35}{32}(1 - u^2)^3 \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$\n- **Gaussian 核函数** $K(u) = \\frac{1}{\\sqrt{2\\pi}} \\exp\\left(-\\frac{u^2}{2}\\right)$\n- **Cosinus 核函数** $K(u) = \\frac{\\pi}{4} \\cos\\left(\\frac{\\pi}{2} u\\right) \\cdot \\mathbf{1}\\{\\left|u\\right| \\leq 1\\}$\n\n<img style=\"width: 600px\" src=\"https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/Fig-NP-kernel-fn02.png\">\n\n核函数通常需要满足以下数学性质：\n\n1. 非负性：$K(u) \\geq 0$\n2. 单位积分：$\\int_{-\\infty}^{\\infty} K(u) \\, du = 1$\n3. 对称性：$K(u) = K(-u)$\n4. 有限的二阶矩：$\\int u^2 K(u) \\, du < \\infty$\n\n实际使用中，还有一些细节需要注意。例如，部分文献或软件将 $\\mathbf{1}\\{|u| \\leq 1\\}$ 写为 $\\mathbf{1}\\{|u| < 1\\}$。对于连续变量，两者几乎没有区别；但若数据是离散型的（如整数型变量），则可能影响边界值是否被纳入计算。\n\n核密度估计的构造可以理解为：以每一个样本点为中心放置一个缩放后的核函数，然后在每一个估计位置 $x$ 上，取所有样本点的核值加权平均。因此，它是一种基于样本加权“局部贡献”的整体平滑过程。\n\n总结而言：\n\n- 核函数定义了如何根据样本点与估计点之间的距离分配权重；\n- 带宽参数决定了每个样本点的影响范围；\n- 合理选择核函数和带宽参数是核密度估计中最关键的步骤；\n- 核密度估计为我们提供了一种平滑、灵活且无需模型假设的分布估计方法，广泛应用于经济学、金融学、机器学习等领域的探索性数据分析任务中。\n\n\n## 周收益率和月收益率\n- 周收益率：`(本周收盘价 - 上周收盘价) / 上周收盘价`\n- 月收益率：`(本月收盘价 - 上月收盘价) / 上月收盘价`\n\n#### 核心代码解读：\n\n- `sz_index['day'].dt.isocalendar().week`：获取日期的周数。具体而言，`dt.isocalendar()` 返回一个 DataFrame，其中包含 ISO 日历的年、周和星期几。我们只需要周数，因此使用 `.week` 来提取它。类似的，可以使用 `.dt.isocalendar().month` 来获取月份；用 `.dt.isocalendar().year` 来获取年份。\n    - `sz_index['day'].dt.isocalendar().year`：获取日期的年份。类似地，使用 `.year` 来提取年份。\n- `weekly_return = sz_index.groupby('year_week')['close'].apply(lambda x: (x.iloc[-1] - x.iloc[0]) / x.iloc[0])`：对每个周进行分组，计算该周的收益率。具体而言，`groupby('year_week')` 将数据按年和周进行分组，然后使用 `apply()` 函数对每个组应用一个 lambda 函数。这个 lambda 函数计算该组的最后一个收盘价和第一个收盘价之间的收益率。\n    - `apply()` 函数的用法：`apply()` 函数可以对 DataFrame 或 Series 的每一行或每一列应用一个函数。它可以用于数据转换、聚合和其他操作。在这里，我们使用 `apply()` 函数来计算每个组的收益率。`apply()` 函数的语法格式为：\n        ```python\n        DataFrame.apply(func, axis=0, raw=False, result_type=None, args=(), **kwds)\n        ```\n        - `func`：要应用的函数，可以是 Python 内置函数或自定义函数。\n        - `axis`：指定应用函数的轴，0 表示按列应用，1 表示按行应用。默认值为 0。\n        - `raw`：如果为 True，则传递原始数据而不是 Series 对象。默认值为 False。\n    - `lambda x: (x.iloc[-1] - x.iloc[0]) / x.iloc[0]`：这是一个匿名函数，用于计算每个组的收益率。`x` 是传递给 lambda 函数的参数，表示当前组的数据。`x.iloc[-1]` 表示该组的最后一个收盘价，`x.iloc[0]` 表示该组的第一个收盘价。通过计算这两个值之间的差值并除以第一个收盘价，我们得到了该组的收益率。\n\n## 年化收益率和标准差\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"number-sections":true,"highlight-style":"atom-one","css":["../styles.css"],"output-file":"TS_SZ_index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.33","editor":"visual","theme":"cosmo","linestretch":1.6,"fontsize":"11.5pt","highlight":true,"callout-appearance":"default","md-extensions":["callout"],"includes":{"after-body":"../_includes/counter.html"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}