{"title":"分仓散点图","markdown":{"headingText":"分仓散点图","containsRefs":false,"markdown":"\n\n\n## 何谓分仓散点图\n\n分仓散点图（也称为分组均值图、Binned Scatterplot、Grouped Scatterplot），是将连续自变量 $x$ 按照某种规则分为若干组（bin/decile/quantile），每组内取 $x$ 和 $y$ 的均值，进而绘制 $(\\bar{x}_g, \\bar{y}_g)$ 散点。\n\n这种方法可以有效缓解单个观测值的随机波动与噪音影响，更直观地展示 $x$ 与 $y$ 的整体关系和非线性结构。分仓散点图常用于大样本、点密集的数据集，是经济学、社会科学等领域中描述性和机制检验的重要可视化工具。\n\n## binscatter 的绘制具体步骤\n\n1. **选择分组变量**：通常为 $x$。\n2. **确定分组方式与分组数 $G$**：\n   * 通常用分位数（如十分位）、也可等宽分组 (每组的样本数相同)；\n   * $G$ 一般取 10-20，样本量大时可适当增加。\n3. **组内计算均值**：每组算出 $\\bar{x}_g, \\bar{y}_g$ 或 $\\bar{\\tilde{x}}_g, \\bar{\\tilde{y}}_g$。其中，$g = 1, 2, \\cdots G$\n4. **绘图**：以 $(\\bar{x}_g, \\bar{y}_g)$ 绘制散点；可叠加拟合线 (基于原始数据而非生成的散点)、置信区间等。\n\n\n\n\n\n::: {.callout-tip}\n### 提示词\n\n模拟如下过程，Python 代码：\n1. y = 10 + 0.5x + e\n2. e ~ N(0, 1)\n3. x ~ N(5, 2)\n4. 样本量为 500\n5. 绘制分仓散点图，bins = 10，每组的样本数相同；添加分仓线 (虚线，灰色)\n6. 添加：原始数据的拟合线 (实线，蓝色)，置信区间 (阴影区域，蓝色，透明度=0.3)。\n7. 添加：分仓散点图的拟合线 (实线，红色)，置信区间 (阴影区域，红色，透明度=0.3)。\n\n:::\n\n### 回归结果对比\n\n我们来对比一下原始数据回归与分仓散点图回归的结果，主要包括系数估计值 ($\\hat{\\beta}$)、标准误、t 值、p 值和 $R^2$。\n\n二者的模型设定如下：\n\n1. 原始数据回归：$y = \\beta_0 + \\beta_1 x + e$\n2. 分仓散点图回归：$\\bar{y}_g = \\theta_0 + \\theta_1 \\bar{x}_g + u$\n\n基于上述目标，可以先撰写如下提示词 (数学公式可以直接使用 LaTeX 语法；统计量可以用 `b`, `se`, `R2` 等，AI 基本上都能理解)：\n\n::: {.callout-tip}\n### 提示词\n\n```md\n做两个回归，列表呈现回归结果：\n\n1. data = df_sim\n2. 原始数据回归：$y = \\beta_0 + \\beta_1 x + e$\n3. 分仓散点图回归：$\\bar{y}_g = \\theta_0 + \\theta_1 \\bar{x}_g + u$\n4. 回归结果表格中包含：b、se、t、p值、N, R2。\n```\n\n:::\n\n可以看出：\n\n1. 原始数据回归与分仓散点图回归的斜率估计非常接近，说明分组均值并不会改变 $x$ 对 $y$ 的主效应估计。\n2. 分仓散点图回归的标准误略大于原始回归，这是因为分组后有效观测数大幅减少，估计的不确定性相对提高（尽管分组均值降低了部分噪音）。\n3. 分仓散点图回归的 $R^2$ 显著高于原始回归，反映出分组均值有效去除了大量噪声，突出了 $x$ 与 $y$ 的主干趋势。\n\n\n\n### 例 2：实际数据-教育回报率\n\n此处，我们使用实际数据集（如教育回报率）来演示分仓散点图的应用。\n\n::: {.callout-tip}\n### 产生提示词的提示词\n\n按照我提供的样本，为下面的代码块撰写一段提示词，以便其他读者可以基于这些提示词生成他们所需的代码 (可能是 R 或 Stata  代码)\n\n:::\n\n\n\n::: {.callout-tip}\n\n### 提示词\n\n```md\n绘制一个带有分组均值点的散点图：\n\n1. 数据来源：mroz 数据集（来自 Wooldridge 教材）\n   url = \"https://vincentarelbundock.github.io/Rdatasets/csv/wooldridge/mroz.csv\"\n2. 变量选择：\n   - x 轴变量：educ（受教育年限）\n   - y 轴变量：lwage（工资对数）\n3. 步骤要求：\n   - 清理缺失值\n   - 将数据按照 educ 进行分位数分组（10 组）\n   - 绘制原始散点图（空心圆点表示）\n   - 标出每组的 $(\\bar{x}_g, \\bar{y}_g)$ 均值点（用红色实心圆）\n   - 在分位点位置加竖线（黑色虚线）\n4. 图形美化要求：\n   - 添加合适的标题与坐标轴标签\n   - 图例区分原始数据与分组均值\n   - 使用紧凑排版，避免遮挡\n```\n\n:::\n\n\n::: {.callout-tip}\n### 提示词\n\n分别用原始数据 (df_edu) 和分仓散点数据 (bin_means) 进行 OLS 回归，列表对比结果。\n\n:::\n\n\n## 理论基础\n\n### 条件期望角度的解释\n\n在概率与统计中，**条件期望** $E(y|x)$ 指的是在给定 $x$ 取某一值或落入某一区间时，$y$ 的平均值。具体来说：\n\n* 理论上，$E(y|x)$ 能完整反映 $y$ 随 $x$ 变化的均值趋势。这是理解 $x$ 如何影响 $y$ 的基础，也是回归、因果推断等分析的理论起点。\n* 实际数据有限且带有噪音，无法对每一个 $x$ 逐点估计 $E(y|x)$。\n\n分仓散点图的思想是：\n\n* 将 $x$ 按分位点或等宽区间划分为 $G$ 个组，每组编号 $g=1,2,\\ldots,G$；\n* 在每组内，计算 $x$ 和 $y$ 的均值 $\\bar{x}_g, \\bar{y}_g$，以 $(\\bar{x}_g, \\bar{y}_g)$ 作为代表；\n* 这些分组均值点就是 $E(y|x \\in g)$ 的经验近似。\n\n数学表达如下：\n\n$$\n\\bar{y}_g = \\frac{1}{n_g} \\sum_{i \\in g} y_i \\approx E(y|x \\in g)\n$$\n\n其中 $n_g$ 是第 $g$ 组的观测数，$i \\in g$ 表示第 $i$ 个观测属于该组。\n\n那么，为什么分组均值可以近似条件期望？\n\n* 在每个小区间 $x \\in g$ 内，$x$ 的变化较小，$\\bar{y}_g$ 就是 $y$ 在 $x$ 落入该区间时的平均水平；\n* 分组数量足够多时，$(\\bar{x}_g, \\bar{y}_g)$ 可以密集覆盖 $E(y|x)$ 曲线；\n* 分组数过多或过少都会影响估计精度，需要结合样本量和研究目标设定。\n\n![](https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/Stata：binscatter和binscatter2命令简介_Fig4_条件期望函数_钟声.png)\n\n> Source: Stepner M. Binscatter: Binned scatterplots in stata[J]. StataConference, 2014. [-PDF-](https://michaelstepner.com/binscatter/binscatter-StataConference2014.pdf)\n\n### 图示\n\n\n\n::: {.callout-tip}\n### 提示词\n\n以 bin 为分组变量，绘制 wage 的如下图形：\n- 各组的小提琴图，但不用显示中位数和胡虚线。\n- 各组的散点图 (marker = 'o', alpha = 0.5, 蓝色)。\n- 各组的均值点 (实心圆点，红色) + 均值点连接线 (实线，红色)。\n\n:::\n\n### 条件期望的扩展（考虑控制变量）\n\n在多元分析中，我们关心 $x$ 与 $y$ 的关系时，往往需要控制其他变量 $z$，即关注 $E(y|x, z)$。对应的多元回归模型通常设定为：\n\n$$\ny_i = \\alpha + \\beta x_i + \\gamma z_i + e_i \\tag{1}\n$$\n\n* $E(y|x, z)$ 描述的是在 $z$ 固定时，给定 $x$ 对应的 $y$ 的期望值。\n* 多数情况下，$corr(x, z) \\neq 0$，即 $x$ 和 $z$ 之间存在相关性。这意味着 $E(y|x, z) \\neq E(y|x)$。因此，直接绘制 $E(y|x)$ 的分仓散点图无法反应 $E(y|x, z)$ 的真实关系。\n\n那么，如何在控制 变量 $z$ 的情况下估计 $E(y|x, z)$ 呢？\n\n#### FWL 定理（残差法）\n\n1. 用 $y$ 对 $z$ 回归，得到残差 $\\tilde{y}$，即去除了 $y$ 中受 $z$ 影响的部分；\n2. 用 $x$ 对 $z$ 回归，得到残差 $\\tilde{x}$，即去除了 $x$ 中受 $z$ 影响的部分；\n3. 对 $\\tilde{x}$ 分组，计算每组 $\\tilde{y}$ 的均值 $(\\bar{\\tilde{x}}_g, \\bar{\\tilde{y}}_g)$；\n4. 以 $(\\bar{\\tilde{x}}_g, \\bar{\\tilde{y}}_g)$ 作图，可以近似 $E(y|x, z)$。\n\n表达式如下：\n\n$$\n\\tilde{y}_i = y_i - E(y|z_i)\n$$\n\n$$\n\\tilde{x}_i = x_i - E(x|z_i)\n$$\n\n每组均值 $\\bar{\\tilde{y}}_g$ 就近似于 $E(y|x, z)$ 在该分组下的条件期望。\n\n有关 FWL 定理的详细介绍，请参见：\n\n- 胡雨霄, 2020, [图示线性回归系数：Frisch-Waugh-Lovell定理与部分回归图](https://www.lianxh.cn/details/113.html), 连享会 No.113.\n- 胡雨霄, 2020, [R2分解：相对重要性分析 (Dominance Analysis)](https://www.lianxh.cn/details/52.html), 连享会 No.52.\n\n\n![](https://fig-lianxh.oss-cn-shenzhen.aliyuncs.com/OLS-FWL-venn.png)\n\n\n\n## 几个问题\n\n### 为何要采用等分组？\n\n细心的读者可能已经注意到，在上述例子中，我们都采用了等分组的方式。即将 $x$ 的取值范围分为 $G$ 个相等的区间，每个区间内的样本数尽可能相同。这种方法有几个优点：\n\n1. **均衡样本量**：每组的样本数相近，避免某些组过于稀疏导致估计不稳定。\n2. **简化计算**：由于每个组的样本数相同，当我们基于组均值进行回归时，无需调整权重或考虑样本量差异。如果以 $x$ 的取值范围进行分组，会导致每个组中的样本数都不同，那么用 $\\bar{y}_g$ 与 $\\bar{x}_g$ 进行回归时，就需要对每个组的样本量进行加权，计算复杂度会增加。\n\n\n### 如何选择 bins 的数量？\n\n构建分仓散点图时，分仓数量（$G$）的选择至关重要。分仓数较多时，可以更细致地揭示 $x$ 与 $y$ 之间的非线性关系，但每个分组内的数据点变少，导致估计的方差增大，结果更易受偶然波动影响。反之，分仓数较少时，每组包含的数据点更多，估计更稳定，但可能掩盖了变量之间的复杂结构和非线性趋势。这实际上是“方差-偏差权衡”（variance-bias tradeoff）问题：$G$ 越大，偏差越小但方差越大；$G$ 越小，方差减小但偏差可能增大。因此，分仓数量的选择应结合样本量、变量分布和分析目标进行权衡与调整。\n\n在 Stepner (2014) 编写的 Stata 命令 `binscatter` 中，$G$ 的默认值为 20。Stepner 称，根据他的个人经验，这一数值的表现较好。\n\n[Cattaneo](https://doi.org/10.1257/aer.20221576) et al. ([2024](https://nppackages.github.io/references/Cattaneo-Crump-Farrell-Feng_2024_AER.pdf), AER) 的理论分析表明，使综合均方误差最小化的分仓数 $G$ 与 $n^{1 /3}$ 成正比 ($n$ 为样本数)。因此，观测值越大，$G$ 的取值越大。不过，其他因素也很重要。例如，保持 $x$ 的分布不变，$x$ 和 $y$ 之间的关系曲线越复杂，$G$ 的取值也应该越大 (否则均方误差会增加)。\n\n| $n$  | $n^{1/3}$ |\n| ------:| ----------- |\n| 1,000   | 10.0        |\n| 5,000   | 17.1        |\n| 10,000  | 21.5        |\n| 100,000 | 46.4        |\n\n根据上表，多数情况下，取 $G$ 为 10-20 是合适的。对于大样本（如 $n > 10,000$），可以考虑增加到 30-50，但需要注意避免过拟合和噪音干扰。\n\n\n\n\n## Python 实例\n\n在劳动经济学中，一个核心问题是：工人的工资 $Y$ 由什么因素决定？虽然这是一个因果推断问题，但我们可以先从预测的角度进行分析。\n\n在下面的工资案例中，$Y$ 表示工人的（对数）小时工资，$X$ 是工人的特征向量，例如教育、工作经验、性别等。这里我们关注两个主要问题：\n\n* 如何利用与工作相关的特征（如教育和经验）更好地预测工资 $Y$？\n* 在其他工作相关特征 $X$ 相同的情况下，男性和女性工人的预测工资有何不同？\n\n本实验首先聚焦于预测问题。\n\n### 数据说明\n\n本次分析的数据来源于 2015 年美国现行人口调查（CPS）三月补充调查。我们筛选了 25 至 64 岁的白人非西班牙裔个体，要求每年工作超过 50 周且每周工作时间超过 35 小时。排除了自雇人员、居住在集体宿舍的个体、军人、农业或私人家庭部门的个体，以及在收入和就业状态报告上存在不一致、变量有缺失或分配信息的观测，同时剔除了小时工资低于 3 的样本。\n\n我们关注的核心变量 $Y$，即（对数）小时工资率，是由年收入除以总工作小时数得到的。其中，总工作小时数等于每年工作周数乘以每周通常工作小时数。在分析中，我们还聚焦于未婚（从未结婚）工人。最终样本量为 $n=5150$。\n\n> **Source**: Chernozhukov, V. & Hansen, C. & Kallus, N. & Spindler, M. & Syrgkanis, V. (**2024**): Applied Causal Inference Powered by ML and AI. [CausalML-book.org](https://causalml-book.org/); arXiv:2403.02467. [-PDF-](https://arxiv.org/pdf/2403.02467)，[Website](https://causalml-book.org/), [github](https://github.com/CausalAIBook/MetricsMLNotebooks) &rarr; [This Note](https://github.com/CausalAIBook/MetricsMLNotebooks/blob/main/PM1/python-ols-and-lasso-for-wage-prediction.ipynb) \n\n#### 变量标签与变量解释\n\n下面列示了该数据集中每个变量的常用英文标签及中文解释说明。部分变量根据 CPS 典型设定和相关代码本推断并补充。\n\n\n| 变量名   | 英文标签                         | 中文解释                          |\n| -- | - | -- |\n| wage  | Hourly wage                  | 小时工资（美元）                      |\n| lwage | Log hourly wage              | 小时工资的对数                       |\n| sex   | Female (1=Female)            | 性别（女性=1，男性=0）                 |\n| shs   | <12 years of schooling       | 教育年限未满 12 年（未完成高中）            |\n| hsg   | High school graduate         | 高中毕业                          |\n| scl   | Some college                 | 大学肄业（上过大学但未获得学位）              |\n| clg   | College graduate             | 大学毕业（获得学士学位）                  |\n| ad    | Advanced degree              | 研究生学历（硕士或博士）                  |\n| mw    | Midwest region               | 美国中西部地区（居住地）                  |\n| so    | South region                 | 美国南部地区（居住地）                   |\n| we    | West region                  | 美国西部地区（居住地）                   |\n| ne    | Northeast region             | 美国东北地区（居住地）                   |\n| exp1  | Potential experience         | 潜在工作经验年数（age - education - 6） |\n| exp2  | Potential experience squared | 潜在工作经验年数的平方                   |\n| exp3  | Potential experience cubed   | 潜在工作经验年数的三次方                  |\n| exp4  | Potential experience^4       | 潜在工作经验年数的四次方                  |\n| occ   | Occupation code              | 职业代码（细分，通常为 3-5 位数）           |\n| occ2  | Major occupation group       | 职业大类代码（22 类）                  |\n| ind   | Industry code                | 行业代码（细分，通常为 3-5 位数）           |\n| ind2  | Major industry group         | 行业大类代码（22 类）                  |\n\n\n#### 变量进一步解释和常见分组\n\n* **学历变量（shs, hsg, scl, clg, ad）**\n  这些是**互斥**的 dummy 变量，每个人只能属于其中一个。常见定义如下：\n\n  * `shs`: 小于高中毕业（未完成高中学业）\n  * `hsg`: 高中毕业但没有上过大学\n  * `scl`: 上过大学但未毕业（包括两年制大学、部分大学课程等，未获得学位）\n  * `clg`: 获得学士学位（本科毕业）\n  * `ad`: 获得更高学位（硕士及以上）\n\n* **地区变量（mw, so, we, ne）**\n  根据居住地划分的美国四大区域，具体可以参考美国人口调查标准地区定义。\n\n* **经验变量（exp1, exp2, exp3, exp4）**\n  经验变量通常由公式 $exp1 = \\text{age} - \\text{years of schooling} - 6$ 计算，近似代表进入劳动力市场的年数，其高次项常用于工资方程中的经验-工资非线性关系建模。\n\n* **职业/行业变量（occ, occ2, ind, ind2）**\n\n  * `occ`/`ind` 为细分的职业/行业代码，通常来自于 CPS 的详细分类。\n  * `occ2`/`ind2` 则为大类分组，便于建模和控制大类异质性。\n\n\n#### 参考说明与代码本依据\n\n这些变量的定义可参考 CPS（Current Population Survey）文档和相关学术论文，例如：\n\n- Angrist, J. D., & Pischke, J.-S. (2009). *Mostly Harmless Econometrics: An Empiricist's Companion*. Princeton University Press. [Link](https://press.princeton.edu/books/paperback/9780691120355/mostly-harmless-econometrics), [Google](https://scholar.google.com/scholar?q=Mostly+Harmless+Econometrics).\n- Card, D., & Krueger, A. B. (1992). School Quality and Black-White Relative Earnings: A Direct Assessment. *Quarterly Journal of Economics*, 107(1), 151–200. [Link](https://doi.org/10.2307/2118323), [PDF](http://sci-hub.ren/10.2307/2118323), [Google](https://scholar.google.com/scholar?q=School+Quality+and+Black-White+Relative+Earnings).\n\n\n\n### 初步分析\n\n#### 变量生成及变量标签\n\n在本节中，我们将对数据集进行变量生成和标签定义，以便后续分析和建模。\n\n::: {.callout-tip}\n### 提示词\n\n- 基于 sex 生成新变量：带标签的变量 sex_label\n  - `sex_label`：{0: Male; 1: Female}，表示性别。我们将其转换为字符串标签。\n\n- 教育水平和地区\n  - 定义一个新变量：edu_group，表示教育水平的分组，取值为 `{'shs': '<HS', 'hsg': 'HS', 'scl': 'Some College', 'clg': 'College', 'ad': 'Advanced'}`。后续分析中采用这个变量更便于分组绘图和统计分析。\n  - 定义一个新变量：regeion，表示居住地区的分组，取值为 `{'mw': 'Midwest', 'so': 'South', 'we': 'West', 'ne': 'Northeast'}`。后续分析中采用这个变量更便于分组绘图和统计分析。\n\n:::\n\n\n### 分仓散点图\n\n\n#### 原始数据散点图：wage 与 experience 的关系\n\n::: {.callout-tip}\n### 提示词\n\n- 绘制 wage 和 experience 的 '散点图+线性回归线 (+ 95% CI)' 图。\n- 绘制 wage 和 experience 的 '散点图+二次曲线拟合线 (+ 95% CI)' 图。\n\n:::\n\n#### 分仓散点图\n\n::: {.callout-tip}\n### 提示词\n\n- 绘制 wage 和 experience 的 '分仓散点图 (binscatter) + 线性回归线 (+ 95% CI)' 图。\n\n:::\n\n::: {.callout-tip}\n### 提示词-代码和图形解读\n\n1. 写 1-2 段文字，解读上面的代码中的核心语句；\n2. 写 1-2 段文字，解读上面的图形。Note: 对于图形右侧，Experience > 37 的部分，看起来有一些异常值，请给出合理的解释。\n3. 格式要求：所有括号都采用半角模式，即 `()`；中英文混排加空格；输出内容为 Markdown 格式\n\n:::\n\n\n上述代码的核心在于利用 `binned_statistic()` 函数将工作经验 (exp1) 按等宽区间分箱，并计算每个区间内工资 (wage) 的均值，形成分仓散点图 (binscatter)。`plt.scatter()` 用于绘制每个分组的均值点，`sns.regplot()` 则基于原始数据拟合线性回归线，并自动添加 95% 置信区间，帮助直观展示工资与经验的整体线性关系。\n\n从图形来看，蓝色点代表每个经验分组的平均工资，橙色实线为原始数据的线性拟合，阴影区域为置信区间。整体趋势显示工资随经验增加而上升，但在经验大于 37 年的右侧区域，分组均值出现异常波动。这通常是因为高经验区间的样本数量较少，极端值对均值影响较大，导致均值点偏离主趋势。因此，右侧的异常点主要反映了数据稀疏和偶然波动，而非真实的工资-经验关系。\n\n### 分仓非线性拟合线\n\n::: {.callout-tip}\n### 提示词\n\n绘制 wage 和 experience 的 '分仓散点图 (binscatter)' 图：\n\n- bins = 20 \n- 添加非线性拟合线和 95% CI，多项式阶数 p 选择最优值\n- y 轴刻度：5(5)40\n:::\n\n从图中似乎可以看到如下结果：\n\n1. 工资与经验之间存在非线性关系，甚至出现了波浪形的变化关系。\n2. 在数据分析中，我们应该将注意力放在「多数样本」上，因此，如果不考虑左侧的三个样本点 (工龄不足 5 年的样本) 和右侧的三个样本点 (工龄超过 40 年的样本)，工资与经验之间的关系大体上呈现出「倒 U 型关系」。这与我们的常识基本相符：工龄较短时，工资随着经验的增加而增加；工龄达到一定程度后，工资增长速度减缓甚至可能下降。\n3. 更为重要的是，上述关系并未考虑其他变量的影响，因此我们需要进一步控制其他变量（如教育水平、性别等）来更准确地分析工资与经验之间的关系。\n\n#### 性别差异\n\n::: {.callout-tip}\n### 提示词\n\n定义一个函数，`plot_binscatter_by()`：\n\n- df, xvar, yvar \n- groupvar='group variable name'\n- 绘制 y ~ x 分仓非线性拟合线，p = 4 (default)\n- 针对 groupvar 变量的每个取值，绘制分仓散点图和拟合线\n- 图例：使用 groupvar 的标签；仅呈现 binned 的标签，不用显示 bins fit 的标签，否则图例会占据太大面积\n:::\n\n::: {.callout-tip}\n### 提示词\n\n使用上述 `plot_binscatter_by` 函数绘图：在同一幅图中，绘制 Male 和 Female 的分仓散点图和拟合线。\n:::\n\n\n### 去除控制变量的影响\n\n::: {.callout-tip}\n### 提示词\n\n绘制 ln(wage) 和 experience 的 '分仓散点图 (binscatter)' 图：\n\n- bins = 20 \n- 添加非线性拟合线和 95% CI，多项式阶数 p 选择最优值\n- y 轴刻度：5(5)40\n- 控制变量：edu_group, region, sex \n  - 采用 FWL 定理去掉上述控制变量的影响\n- 绘图时：横轴和纵轴的变量都加上各自的原始值的样本均值，以提高可读性\n:::\n\n## 小结\n\n\n本章介绍了分仓散点图的基本原理与绘制方法，并结合工资决定因素的例子，演示了其在 Python 中的实际应用。\n\n事实上，分仓散点图不仅是描述变量关系的直观工具，更在应用经济学和社会科学实证研究中具有重要意义。\n\n- 首先，分仓散点图可作为多元回归结果的可视化手段。我们可以利用 Frisch-Waugh-Lovell（FWL）定理，在控制协变量影响的前提下，直观呈现核心自变量与因变量之间的净关系，这对于理解回归系数背后的经济含义和展示部分效应尤为有用。\n\n- 其次，分仓散点图还是模型设定的重要工具。通过观察分仓均值的变化趋势，我们可以初步判断变量之间的非线性关系或结构性断点，为进一步采用多项式回归、分段回归等方法提供依据。\n\n- 再次，在数据分析和预处理阶段，分仓散点图有助于快速发现异常值、极端点以及样本结构变化，从而提高数据分析的准确性和稳健性。\n\n- 最后，该方法还常用于断点回归设计（RDD）、政策评估、因果推断等前沿实证领域，是展示数据特征和检验研究假设的有力工具。\n\n总体来看，分仓散点图作为连接理论分析、数据探索与实证模型设定的桥梁，已经成为现代数据分析和应用计量经济学研究中不可或缺的基础工具。\n\n\n## 参考文献\n\n* Cattaneo, M. D., Jansson, M., & Ma, X. (2022). binsreg: Estimating and validating binscatter estimators. The Stata Journal, 22(1), 65–99. [Link](https://doi.org/10.1177/1536867X221082097), [PDF](http://sci-hub.ren/10.1177/1536867X221082097), [Google](https://scholar.google.com/scholar?q=binsreg).\n- Cattaneo, M. D., Crump, R. K., Farrell, M. H., & Feng, Y. (2024). On Binscatter. American Economic Review, 114(5), 1488--1514. [Link](https://doi.org/10.1257/aer.20221576) (rep), [PDF](https://nppackages.github.io/references/Cattaneo-Crump-Farrell-Feng_2024_AER.pdf), [Appendix](https://www.aeaweb.org/doi/10.1257/aer.20221576.appx), [Google](https://scholar.google.com/scholar?q=On%20Binscatter), [\\-Replication-](https://www.openicpsr.org/openicpsr/project/195103/version/V1/view).\n- Frisch, R., & Waugh, F. V. (1933). Partial Time Regressions as Compared with Individual Trends. Econometrica, 1(4), 387–401. [Link](https://doi.org/10.2307/1907330), [PDF](http://sci-hub.ren/10.2307/1907330), [Google](https://scholar.google.com/scholar?q=Partial+Time+Regressions+as+Compared+with+Individual+Trends).\n- Lovell, M. C. (1963). Seasonal Adjustment of Economic Time Series and Multiple Regression Analysis. Journal of the American Statistical Association, 58(304), 993–1010. [Link](https://doi.org/10.1080/01621459.1963.10480673), [PDF](http://sci-hub.ren/10.1080/01621459.1963.10480673), [Google](https://scholar.google.com/scholar?q=Seasonal+Adjustment+of+Economic+Time+Series+and+Multiple+Regression+Analysis).\n- Stepner M. Binscatter: Binned scatterplots in stata[J]. StataConference, 2014. [-PDF-](https://michaelstepner.com/binscatter/binscatter-StataConference2014.pdf)\n- 朱志英, 2022, [Stata：分仓散点图应用-binscatter](https://www.lianxh.cn/details/1139.html), 连享会 No.1139.\n- 钟声, 2022, [Stata：分仓散点图绘制-binscatter-binscatter2](https://www.lianxh.cn/details/870.html), 连享会 No.870.\n\n\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"wrap","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"number-sections":true,"highlight-style":"atom-one","css":["../styles.css"],"output-file":"regress_03_binscatter.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.39","editor":"visual","theme":"cosmo","linestretch":1.6,"fontsize":"11.5pt","highlight":true,"callout-appearance":"default","md-extensions":["callout"],"includes":{"after-body":"../_includes/counter.html"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}