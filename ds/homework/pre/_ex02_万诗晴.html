<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>39&nbsp; ex02_万诗晴 – 数据分析</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../homework/pre/_ex02_吴倩茵.html" rel="next">
<link href="../../homework/pre/Stock_G4_03_data_analysis.html" rel="prev">
<link href="../../images/ds-book-logo-40.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e8fb9d25728d58bfeac61b497e4a6629.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8434d2026ae8291579158df2ad8dfa64.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../homework/pre/Dangdang_G7_01_data_clean.html"><strong>作业展示</strong></a></li><li class="breadcrumb-item"><a href="../../homework/pre/_ex02_万诗晴.html"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">ex02_万诗晴</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="https://book.lianxh.cn/ds/index.html" class="sidebar-logo-link">
      <img src="../../images/ds-book-logo-40.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../"></a><a href="../../index.html">DS</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://www.lianxh.cn" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-house-fill"></i></a>
    <a href="https://lianxh-class.cn/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-camera-video-fill"></i></a>
    <a href="https://github.com/arlionn/ds" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据分析</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/_home.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">关于我们</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">前言</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Python 基础</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_py_with_AI_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">借助 AI 写代码</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_py_with_AI_pic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Ansome Python + AI</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_1_install-Python-Anocanda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Python：安装和环境配置</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_2_install_FAQs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Python 安装常见问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_3_markdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Python 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_01_grammer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Python 代码风格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_02_QuickReference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Python 常用命令速查表</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_03_Packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Python 常用扩展包</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_04_import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Python：import 使用详解</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_05_OOP.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Python：语法解析-面向对象编程</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_06_filepath.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Python 路径设置</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_02_numpy_scipy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">NumPy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_02_pandas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">pandas 快速入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_03_matplotlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Matplotlib简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_04_func_and_module.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">函数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_05_class.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">类和对象</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>数据分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/data_02_data_type.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">数据分析是什么？</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/data_02_get_data_GMD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">获取数据：GMD</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/TS_SZ_index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">上证指数的时序特征</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>可视化</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Python 可视化：简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_box_violin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">箱型图和小提琴图</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_histogram.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">直方图</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_kdensity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">核密度函数图</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>回归分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/test_AB_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">A/B test-分组对照试验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_01_OLS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">线性回归模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_02_wage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">线性回归分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_03_binscatter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">分仓散点图</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>时间序列分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/TS_FRED_US_unemploy_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">案例：美国失业率和通胀率关系分析</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>作业展示</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Dangdang_G7_01_data_clean.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">当当网-G7-01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Dangdang_G7_02_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">当当网-G7-02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/G8_China_stock_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">G8-中国上市公司</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_01_data_crawler.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">G4-01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_02_data_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">G4-02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_03_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">G4-03</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_万诗晴.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">ex02_万诗晴</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_吴倩茵.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">ex02_吴倩茵</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_朱少荣.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">ex02_朱少荣</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_黄伊姿.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">ex02_黄伊姿</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../homework/pre/Dangdang_G7_01_data_clean.html"><strong>作业展示</strong></a></li><li class="breadcrumb-item"><a href="../../homework/pre/_ex02_万诗晴.html"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">ex02_万诗晴</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">ex02_万诗晴</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="e9791435" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">from</span> openpyxl <span class="im">import</span> load_workbook</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># 定义目录路径</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>directory <span class="op">=</span> <span class="st">"/Users/wanshiqing/Desktop/python_code/CSMAR/data_raw_zip"</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># 定义需要提取的列</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>required_columns <span class="op">=</span> [</span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="st">'负债合计'</span>, <span class="st">'资产总计'</span>, <span class="st">'流动负债合计'</span>, <span class="st">'长期负债合计'</span>, </span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="st">'期末现金及现金等价物余额'</span>, <span class="st">'净利润'</span>, <span class="st">'所有者权益合计'</span>,</span>
<span id="cb1-12"><a href="#cb1-12"></a>    <span class="st">'短期借款'</span>, <span class="st">'长期借款'</span>, <span class="st">'股权集中度1'</span>, <span class="st">'股权集中度9'</span>,</span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="st">'首次上市日期'</span>, <span class="st">'行业代码'</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>]</span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co"># 初始化一个空的DataFrame用于存储最终结果</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>merged_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co"># 遍历目录下所有Excel文件</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="cf">for</span> filename <span class="kw">in</span> os.listdir(directory):</span>
<span id="cb1-21"><a href="#cb1-21"></a>    <span class="cf">if</span> filename.endswith(<span class="st">'.xlsx'</span>):</span>
<span id="cb1-22"><a href="#cb1-22"></a>        file_path <span class="op">=</span> os.path.join(directory, filename)</span>
<span id="cb1-23"><a href="#cb1-23"></a>        </span>
<span id="cb1-24"><a href="#cb1-24"></a>        <span class="co"># 检查文件是否有效</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>        <span class="cf">try</span>:</span>
<span id="cb1-26"><a href="#cb1-26"></a>            <span class="co"># 使用openpyxl加载工作簿获取第一行作为列名</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>            wb <span class="op">=</span> load_workbook(file_path, read_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-28"><a href="#cb1-28"></a>            sheet <span class="op">=</span> wb.active</span>
<span id="cb1-29"><a href="#cb1-29"></a>            first_row <span class="op">=</span> [cell.value <span class="cf">for</span> cell <span class="kw">in</span> sheet[<span class="dv">1</span>]]</span>
<span id="cb1-30"><a href="#cb1-30"></a>            wb.close()</span>
<span id="cb1-31"><a href="#cb1-31"></a>            </span>
<span id="cb1-32"><a href="#cb1-32"></a>            <span class="co"># 读取Excel文件，使用第一行作为列名</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>            df <span class="op">=</span> pd.read_excel(file_path, header<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-34"><a href="#cb1-34"></a>            </span>
<span id="cb1-35"><a href="#cb1-35"></a>            <span class="co"># 检查必需的列是否存在</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>(col <span class="kw">in</span> df.columns <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'证券代码'</span>, <span class="st">'时间'</span>]):</span>
<span id="cb1-37"><a href="#cb1-37"></a>                <span class="bu">print</span>(<span class="ss">f"跳过 </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">: 缺少'证券代码'或'时间'列"</span>)</span>
<span id="cb1-38"><a href="#cb1-38"></a>                <span class="cf">continue</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>                </span>
<span id="cb1-40"><a href="#cb1-40"></a>            <span class="co"># 筛选需要的列（只保留存在的列）</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>            available_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> required_columns <span class="cf">if</span> col <span class="kw">in</span> df.columns]</span>
<span id="cb1-42"><a href="#cb1-42"></a>            cols_to_keep <span class="op">=</span> [<span class="st">'证券代码'</span>, <span class="st">'时间'</span>] <span class="op">+</span> available_cols</span>
<span id="cb1-43"><a href="#cb1-43"></a>            </span>
<span id="cb1-44"><a href="#cb1-44"></a>            <span class="co"># 只保留需要的列</span></span>
<span id="cb1-45"><a href="#cb1-45"></a>            df <span class="op">=</span> df[cols_to_keep]</span>
<span id="cb1-46"><a href="#cb1-46"></a>            </span>
<span id="cb1-47"><a href="#cb1-47"></a>            <span class="co"># 合并数据</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>            <span class="cf">if</span> merged_df.empty:</span>
<span id="cb1-49"><a href="#cb1-49"></a>                merged_df <span class="op">=</span> df</span>
<span id="cb1-50"><a href="#cb1-50"></a>            <span class="cf">else</span>:</span>
<span id="cb1-51"><a href="#cb1-51"></a>                merged_df <span class="op">=</span> pd.merge(</span>
<span id="cb1-52"><a href="#cb1-52"></a>                    merged_df, </span>
<span id="cb1-53"><a href="#cb1-53"></a>                    df, </span>
<span id="cb1-54"><a href="#cb1-54"></a>                    on<span class="op">=</span>[<span class="st">'证券代码'</span>, <span class="st">'时间'</span>], </span>
<span id="cb1-55"><a href="#cb1-55"></a>                    how<span class="op">=</span><span class="st">'outer'</span>,</span>
<span id="cb1-56"><a href="#cb1-56"></a>                    suffixes<span class="op">=</span>(<span class="st">''</span>, <span class="st">'_dup'</span>)</span>
<span id="cb1-57"><a href="#cb1-57"></a>                )</span>
<span id="cb1-58"><a href="#cb1-58"></a>                </span>
<span id="cb1-59"><a href="#cb1-59"></a>                <span class="co"># 处理重复列（保留第一个出现的列）</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>                <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-61"><a href="#cb1-61"></a>                    <span class="cf">if</span> col <span class="kw">in</span> merged_df.columns <span class="kw">and</span> <span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_dup"</span> <span class="kw">in</span> merged_df.columns:</span>
<span id="cb1-62"><a href="#cb1-62"></a>                        merged_df[col] <span class="op">=</span> merged_df[col].combine_first(merged_df[<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_dup"</span>])</span>
<span id="cb1-63"><a href="#cb1-63"></a>                        merged_df.drop(<span class="ss">f"</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_dup"</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-64"><a href="#cb1-64"></a>                        </span>
<span id="cb1-65"><a href="#cb1-65"></a>            <span class="bu">print</span>(<span class="ss">f"成功合并: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-66"><a href="#cb1-66"></a>            </span>
<span id="cb1-67"><a href="#cb1-67"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-68"><a href="#cb1-68"></a>            <span class="bu">print</span>(<span class="ss">f"处理 </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss"> 时出错: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="co"># 输出结果信息</span></span>
<span id="cb1-71"><a href="#cb1-71"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">合并完成!"</span>)</span>
<span id="cb1-72"><a href="#cb1-72"></a><span class="bu">print</span>(<span class="ss">f"总记录数: </span><span class="sc">{</span><span class="bu">len</span>(merged_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-73"><a href="#cb1-73"></a><span class="bu">print</span>(<span class="ss">f"包含列: </span><span class="sc">{</span><span class="bu">list</span>(merged_df.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-74"><a href="#cb1-74"></a></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co"># 保存结果到新文件</span></span>
<span id="cb1-76"><a href="#cb1-76"></a>merged_df.to_excel(<span class="st">"merged_data.xlsx"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>成功合并: 资产负债表-2000-2024.xlsx
成功合并: CSMAR常用变量-2000-2024.xlsx
成功合并: 上市公司基本信息年度表.xlsx
跳过 上市公司基本信息变更表2000-2024.xlsx: 缺少'证券代码'或'时间'列
成功合并: 利润表-现金流量表-2000-2024.xlsx

合并完成!
总记录数: 145874
包含列: ['证券代码', '时间', '负债合计', '资产总计', '流动负债合计', '长期负债合计', '所有者权益合计', '短期借款', '长期借款', '股权集中度1', '股权集中度9', '首次上市日期', '行业代码', '期末现金及现金等价物余额', '净利润']</code></pre>
</div>
</div>
<div id="05d15de4" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># 1. 筛选时间 &gt;= 2000 的数据</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>merged_df <span class="op">=</span> merged_df[merged_df[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>].copy()</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># 2. 计算各项指标（处理分母为0的情况）</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># 安全除法函数</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="kw">def</span> safe_divide(a, b):</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="cf">return</span> np.divide(a, b, out<span class="op">=</span>np.zeros_like(a, dtype<span class="op">=</span><span class="bu">float</span>), </span>
<span id="cb3-12"><a href="#cb3-12"></a>                    where<span class="op">=</span>(b <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (<span class="op">~</span>np.isnan(b)) <span class="op">&amp;</span> (<span class="op">~</span>np.isnan(a)))</span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co"># 计算各项比率</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>merged_df[<span class="st">'Lev'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'负债合计'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-16"><a href="#cb3-16"></a>merged_df[<span class="st">'SL'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'流动负债合计'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-17"><a href="#cb3-17"></a>merged_df[<span class="st">'LL'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'长期负债合计'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-18"><a href="#cb3-18"></a>merged_df[<span class="st">'SDR'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'流动负债合计'</span>], merged_df[<span class="st">'负债合计'</span>])</span>
<span id="cb3-19"><a href="#cb3-19"></a>merged_df[<span class="st">'Cash'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'期末现金及现金等价物余额'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-20"><a href="#cb3-20"></a>merged_df[<span class="st">'ROA'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'净利润'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-21"><a href="#cb3-21"></a>merged_df[<span class="st">'ROE'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'净利润'</span>], merged_df[<span class="st">'所有者权益合计'</span>])</span>
<span id="cb3-22"><a href="#cb3-22"></a>merged_df[<span class="st">'SLoan'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'短期借款'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-23"><a href="#cb3-23"></a>merged_df[<span class="st">'LLoan'</span>] <span class="op">=</span> safe_divide(merged_df[<span class="st">'长期借款'</span>], merged_df[<span class="st">'资产总计'</span>])</span>
<span id="cb3-24"><a href="#cb3-24"></a></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co"># 直接赋值股权集中度</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>merged_df[<span class="st">'Top1'</span>] <span class="op">=</span> merged_df[<span class="st">'股权集中度1'</span>]</span>
<span id="cb3-27"><a href="#cb3-27"></a>merged_df[<span class="st">'HHI5'</span>] <span class="op">=</span> merged_df[<span class="st">'股权集中度9'</span>]</span>
<span id="cb3-28"><a href="#cb3-28"></a></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co"># 计算Size = ln(资产总计)，添加小常数避免log(0)</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>merged_df[<span class="st">'Size'</span>] <span class="op">=</span> np.log(merged_df[<span class="st">'资产总计'</span>] <span class="op">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb3-31"><a href="#cb3-31"></a></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="co"># 3. 计算Age（公司年龄）</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co"># 将首次上市日期转换为datetime格式</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="kw">def</span> convert_date(date_val):</span>
<span id="cb3-35"><a href="#cb3-35"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(date_val, <span class="bu">str</span>) <span class="kw">and</span> <span class="bu">len</span>(date_val) <span class="op">==</span> <span class="dv">8</span>:</span>
<span id="cb3-36"><a href="#cb3-36"></a>        <span class="cf">return</span> datetime.strptime(date_val, <span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb3-37"><a href="#cb3-37"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(date_val, (<span class="bu">int</span>, <span class="bu">float</span>)):</span>
<span id="cb3-38"><a href="#cb3-38"></a>        <span class="cf">return</span> datetime(<span class="bu">int</span>(date_val), <span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># 处理整数年份</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>    <span class="cf">return</span> pd.NaT</span>
<span id="cb3-40"><a href="#cb3-40"></a></span>
<span id="cb3-41"><a href="#cb3-41"></a>merged_df[<span class="st">'首次上市日期'</span>] <span class="op">=</span> merged_df[<span class="st">'首次上市日期'</span>].<span class="bu">apply</span>(convert_date)</span>
<span id="cb3-42"><a href="#cb3-42"></a></span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="co"># 计算公司上市年限</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>today <span class="op">=</span> datetime.now()</span>
<span id="cb3-45"><a href="#cb3-45"></a>merged_df[<span class="st">'Age'</span>] <span class="op">=</span> ((today <span class="op">-</span> merged_df[<span class="st">'首次上市日期'</span>]).dt.days <span class="op">/</span> <span class="dv">365</span>).fillna(<span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb3-46"><a href="#cb3-46"></a></span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="co"># 4. 处理离群值（缩尾处理）</span></span>
<span id="cb3-48"><a href="#cb3-48"></a><span class="co"># 需要缩尾的变量列表</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>winsorize_vars <span class="op">=</span> [</span>
<span id="cb3-50"><a href="#cb3-50"></a>    <span class="st">'Lev'</span>, <span class="st">'SL'</span>, <span class="st">'LL'</span>, <span class="st">'SDR'</span>, <span class="st">'Cash'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, </span>
<span id="cb3-51"><a href="#cb3-51"></a>    <span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Top1'</span>, <span class="st">'HHI5'</span>, <span class="st">'Size'</span>, <span class="st">'Age'</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>]</span>
<span id="cb3-53"><a href="#cb3-53"></a></span>
<span id="cb3-54"><a href="#cb3-54"></a><span class="cf">for</span> var <span class="kw">in</span> winsorize_vars:</span>
<span id="cb3-55"><a href="#cb3-55"></a>    <span class="cf">if</span> var <span class="kw">in</span> merged_df.columns:</span>
<span id="cb3-56"><a href="#cb3-56"></a>        <span class="co"># 计算1%和99%分位数</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>        low <span class="op">=</span> merged_df[var].quantile(<span class="fl">0.01</span>)</span>
<span id="cb3-58"><a href="#cb3-58"></a>        high <span class="op">=</span> merged_df[var].quantile(<span class="fl">0.99</span>)</span>
<span id="cb3-59"><a href="#cb3-59"></a>        </span>
<span id="cb3-60"><a href="#cb3-60"></a>        <span class="co"># 缩尾处理</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>        merged_df[var] <span class="op">=</span> merged_df[var].clip(lower<span class="op">=</span>low, upper<span class="op">=</span>high)</span>
<span id="cb3-62"><a href="#cb3-62"></a></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co"># 显示处理结果</span></span>
<span id="cb3-64"><a href="#cb3-64"></a><span class="bu">print</span>(<span class="st">"数据处理完成！"</span>)</span>
<span id="cb3-65"><a href="#cb3-65"></a><span class="bu">print</span>(<span class="ss">f"处理后数据形状: </span><span class="sc">{</span>merged_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-66"><a href="#cb3-66"></a><span class="bu">print</span>(<span class="ss">f"包含的指标: </span><span class="sc">{</span>winsorize_vars<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="bu">print</span>(<span class="ss">f"时间范围: </span><span class="sc">{</span>merged_df[<span class="st">'时间'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>merged_df[<span class="st">'时间'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-68"><a href="#cb3-68"></a><span class="bu">print</span>(<span class="ss">f"公司上市年限范围: </span><span class="sc">{</span>merged_df[<span class="st">'Age'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>merged_df[<span class="st">'Age'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss"> 年"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>数据处理完成！
处理后数据形状: (145874, 28)
包含的指标: ['Lev', 'SL', 'LL', 'SDR', 'Cash', 'ROA', 'ROE', 'SLoan', 'LLoan', 'Top1', 'HHI5', 'Size', 'Age']
时间范围: 2000 - 2024
公司上市年限范围: 0 - 0 年</code></pre>
</div>
</div>
<div id="f34aaffc" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># 定义要统计的指标列表</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>metrics <span class="op">=</span> [</span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="st">'Lev'</span>, <span class="st">'SL'</span>, <span class="st">'LL'</span>, <span class="st">'SDR'</span>, <span class="st">'Cash'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, </span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Top1'</span>, <span class="st">'HHI5'</span>, <span class="st">'Size'</span>, <span class="st">'Age'</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>]</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># 1. 按'时间'分组</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>grouped <span class="op">=</span> merged_df.groupby(<span class="st">'时间'</span>)</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># 2. 为每个指标计算统计量</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co"># 创建空的DataFrame存储结果</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>result_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co"># 对每个指标计算统计量</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb5-18"><a href="#cb5-18"></a>    <span class="cf">if</span> metric <span class="kw">in</span> merged_df.columns:</span>
<span id="cb5-19"><a href="#cb5-19"></a>        <span class="co"># 计算各种统计量</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>        stat_df <span class="op">=</span> grouped[metric].agg([</span>
<span id="cb5-21"><a href="#cb5-21"></a>            (<span class="st">'平均值'</span>, <span class="st">'mean'</span>),</span>
<span id="cb5-22"><a href="#cb5-22"></a>            (<span class="st">'中位数'</span>, <span class="st">'median'</span>),</span>
<span id="cb5-23"><a href="#cb5-23"></a>            (<span class="st">'标准差'</span>, <span class="st">'std'</span>),</span>
<span id="cb5-24"><a href="#cb5-24"></a>            (<span class="st">'最小值'</span>, <span class="st">'min'</span>),</span>
<span id="cb5-25"><a href="#cb5-25"></a>            (<span class="st">'最大值'</span>, <span class="st">'max'</span>)</span>
<span id="cb5-26"><a href="#cb5-26"></a>        ])</span>
<span id="cb5-27"><a href="#cb5-27"></a>        </span>
<span id="cb5-28"><a href="#cb5-28"></a>        <span class="co"># 重命名列以包含指标名称</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>        stat_df.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> col <span class="kw">in</span> stat_df.columns]</span>
<span id="cb5-30"><a href="#cb5-30"></a>        </span>
<span id="cb5-31"><a href="#cb5-31"></a>        <span class="co"># 合并到结果DataFrame</span></span>
<span id="cb5-32"><a href="#cb5-32"></a>        <span class="cf">if</span> result_df.empty:</span>
<span id="cb5-33"><a href="#cb5-33"></a>            result_df <span class="op">=</span> stat_df</span>
<span id="cb5-34"><a href="#cb5-34"></a>        <span class="cf">else</span>:</span>
<span id="cb5-35"><a href="#cb5-35"></a>            result_df <span class="op">=</span> result_df.join(stat_df)</span>
<span id="cb5-36"><a href="#cb5-36"></a></span>
<span id="cb5-37"><a href="#cb5-37"></a><span class="co"># 3. 打印结果表格</span></span>
<span id="cb5-38"><a href="#cb5-38"></a><span class="co"># 设置显示选项以展示完整数据</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="va">None</span>)</span>
<span id="cb5-40"><a href="#cb5-40"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb5-41"><a href="#cb5-41"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)</span>
<span id="cb5-42"><a href="#cb5-42"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.4f}</span><span class="st">'</span>.<span class="bu">format</span>)</span>
<span id="cb5-43"><a href="#cb5-43"></a></span>
<span id="cb5-44"><a href="#cb5-44"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="bu">print</span>(<span class="st">"按时间分组的指标统计结果:"</span>)</span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb5-47"><a href="#cb5-47"></a><span class="bu">print</span>(result_df)</span>
<span id="cb5-48"><a href="#cb5-48"></a></span>
<span id="cb5-49"><a href="#cb5-49"></a><span class="co"># 4. 可选：保存结果到Excel文件</span></span>
<span id="cb5-50"><a href="#cb5-50"></a>result_df.to_excel(<span class="st">"time_grouped_statistics.xlsx"</span>)</span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">结果已保存至 'time_grouped_statistics.xlsx'"</span>)</span>
<span id="cb5-52"><a href="#cb5-52"></a></span>
<span id="cb5-53"><a href="#cb5-53"></a><span class="co"># 5. 可选：生成更易读的格式（每个指标单独表格）</span></span>
<span id="cb5-54"><a href="#cb5-54"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">按指标分组的详细统计:"</span>)</span>
<span id="cb5-55"><a href="#cb5-55"></a><span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb5-56"><a href="#cb5-56"></a>    <span class="cf">if</span> metric <span class="kw">in</span> merged_df.columns:</span>
<span id="cb5-57"><a href="#cb5-57"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb5-58"><a href="#cb5-58"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss"> 的年度统计:"</span>)</span>
<span id="cb5-59"><a href="#cb5-59"></a>        <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb5-60"><a href="#cb5-60"></a>        metric_df <span class="op">=</span> grouped[metric].agg([<span class="st">'mean'</span>, <span class="st">'median'</span>, <span class="st">'std'</span>, <span class="st">'min'</span>, <span class="st">'max'</span>])</span>
<span id="cb5-61"><a href="#cb5-61"></a>        metric_df.columns <span class="op">=</span> [<span class="st">'平均值'</span>, <span class="st">'中位数'</span>, <span class="st">'标准差'</span>, <span class="st">'最小值'</span>, <span class="st">'最大值'</span>]</span>
<span id="cb5-62"><a href="#cb5-62"></a>        <span class="bu">print</span>(metric_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>====================================================================================================
按时间分组的指标统计结果:
====================================================================================================
      Lev_平均值  Lev_中位数  Lev_标准差  Lev_最小值  Lev_最大值  SL_平均值  SL_中位数  SL_标准差  SL_最小值  SL_最大值  LL_平均值  LL_中位数  LL_标准差  LL_最小值  LL_最大值  SDR_平均值  SDR_中位数  SDR_标准差  SDR_最小值  SDR_最大值  Cash_平均值  Cash_中位数  Cash_标准差  Cash_最小值  Cash_最大值  ROA_平均值  ROA_中位数  ROA_标准差  ROA_最小值  ROA_最大值  ROE_平均值  ROE_中位数  ROE_标准差  ROE_最小值  ROE_最大值  SLoan_平均值  SLoan_中位数  SLoan_标准差  SLoan_最小值  SLoan_最大值  LLoan_平均值  LLoan_中位数  LLoan_标准差  LLoan_最小值  LLoan_最大值  Top1_平均值  Top1_中位数  Top1_标准差  Top1_最小值  Top1_最大值  HHI5_平均值  HHI5_中位数  HHI5_标准差  HHI5_最小值  HHI5_最大值  Size_平均值  Size_中位数  Size_标准差  Size_最小值  Size_最大值  Age_平均值  Age_中位数  Age_标准差  Age_最小值  Age_最大值
时间                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
2000   0.0889   0.0000   0.1960   0.0000   0.9384  0.0759  0.0000  0.1710  0.0000  0.8289  0.0112  0.0000  0.0405  0.0000  0.3676   0.1742   0.0000   0.3557   0.0000   1.0000    0.0316    0.0000    0.0854    0.0000    0.5748   0.0069   0.0000   0.0309  -0.2173   0.1733   0.0118   0.0000   0.0680  -0.6118   0.3274     0.0330     0.0000     0.0846     0.0000     0.4217     0.0095     0.0000     0.0354     0.0000     0.3057       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN   20.9439   20.8770    0.8634   18.7922   25.5963   0.0000   0.0000   0.0000        0        0
2001   0.0977   0.0000   0.2069   0.0000   0.9384  0.0828  0.0000  0.1792  0.0000  0.8289  0.0126  0.0000  0.0444  0.0000  0.3676   0.1846   0.0000   0.3621   0.0000   1.0000    0.0364    0.0000    0.0907    0.0000    0.5748   0.0045   0.0000   0.0318  -0.2173   0.1733   0.0076   0.0000   0.0705  -0.6118   0.3274     0.0375     0.0000     0.0916     0.0000     0.4217     0.0110     0.0000     0.0396     0.0000     0.3057       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN   21.0155   20.9372    0.9086   18.7922   26.6102   0.0000   0.0000   0.0000        0        0
2002   0.1067   0.0000   0.2174   0.0000   0.9384  0.0911  0.0000  0.1894  0.0000  0.8289  0.0133  0.0000  0.0462  0.0000  0.3676   0.1943   0.0000   0.3694   0.0000   1.0000    0.0353    0.0000    0.0864    0.0000    0.5748   0.0035   0.0000   0.0331  -0.2173   0.1733   0.0059   0.0000   0.0763  -0.6118   0.3274     0.0399     0.0000     0.0952     0.0000     0.4217     0.0112     0.0000     0.0402     0.0000     0.3057       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN   21.0789   20.9909    0.9640   18.7922   26.6412   0.0000   0.0000   0.0000        0        0
2003   0.1157   0.0000   0.2289   0.0000   0.9384  0.0979  0.0000  0.1983  0.0000  0.8289  0.0148  0.0000  0.0489  0.0000  0.3676   0.2018   0.0000   0.3735   0.0000   1.0000    0.0357    0.0000    0.0853    0.0000    0.5748   0.0045   0.0000   0.0326  -0.2173   0.1733   0.0096   0.0000   0.0705  -0.6118   0.3274     0.0436     0.0000     0.1004     0.0000     0.4217     0.0124     0.0000     0.0429     0.0000     0.3057   42.4786   41.2759   16.9773    8.2744   74.5657    0.2295    0.1979    0.1415    0.0129    0.5604   21.1775   21.1037    1.0087   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2004   0.1277   0.0000   0.2420   0.0000   0.9384  0.1079  0.0000  0.2096  0.0000  0.8289  0.0165  0.0000  0.0532  0.0000  0.3676   0.2137   0.0000   0.3804   0.0000   1.0000    0.0371    0.0000    0.0865    0.0000    0.5748   0.0045   0.0000   0.0368  -0.2173   0.1733   0.0089   0.0000   0.0848  -0.6118   0.3274     0.0462     0.0000     0.1028     0.0000     0.4217     0.0138     0.0000     0.0462     0.0000     0.3057   41.7888   39.8541   16.6441    8.2744   74.5657    0.2241    0.1887    0.1380    0.0129    0.5604   21.2251   21.1329    1.0575   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2005   0.1329   0.0000   0.2513   0.0000   0.9384  0.1126  0.0000  0.2178  0.0000  0.8289  0.0165  0.0000  0.0534  0.0000  0.3676   0.2141   0.0000   0.3816   0.0000   1.0000    0.0325    0.0000    0.0780    0.0000    0.5748   0.0021   0.0000   0.0390  -0.2173   0.1733   0.0050   0.0000   0.0928  -0.6118   0.3274     0.0453     0.0000     0.1014     0.0000     0.4217     0.0136     0.0000     0.0464     0.0000     0.3057   40.3061   37.7029   16.1135    8.2744   74.5657    0.2101    0.1726    0.1314    0.0129    0.5604   21.2723   21.1804    1.0952   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2006   0.1423   0.0000   0.2590   0.0000   0.9384  0.1195  0.0000  0.2226  0.0000  0.8289  0.0179  0.0000  0.0561  0.0000  0.3676   0.2254   0.0000   0.3882   0.0000   1.0000    0.0356    0.0000    0.0827    0.0000    0.5748   0.0062   0.0000   0.0371  -0.2173   0.1733   0.0143   0.0000   0.0860  -0.6118   0.3274     0.0450     0.0000     0.0986     0.0000     0.4217     0.0148     0.0000     0.0490     0.0000     0.3057   36.0474   33.5374   14.8700    8.2744   74.5657    0.1706    0.1397    0.1153    0.0129    0.5604   21.3349   21.2300    1.2137   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2007   0.1489   0.0000   0.2595   0.0000   0.9384  0.1226  0.0000  0.2204  0.0000  0.8289  0.0183  0.0000  0.0562  0.0000  0.3676   0.2378   0.0000   0.3922   0.0000   1.0000    0.0420    0.0000    0.0932    0.0000    0.5748   0.0121   0.0000   0.0398  -0.2173   0.1733   0.0239   0.0000   0.0879  -0.6118   0.3274     0.0442     0.0000     0.0961     0.0000     0.4217     0.0154     0.0000     0.0496     0.0000     0.3057   35.7441   33.8986   15.0713    8.2744   74.5657    0.1683    0.1410    0.1163    0.0129    0.5604   21.4913   21.3551    1.3487   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2008   0.1523   0.0000   0.2621   0.0000   0.9384  0.1247  0.0000  0.2211  0.0000  0.8289  0.0197  0.0000  0.0595  0.0000  0.3676   0.2459   0.0000   0.3967   0.0000   1.0000    0.0431    0.0000    0.0932    0.0000    0.5748   0.0075   0.0000   0.0423  -0.2173   0.1733   0.0133   0.0000   0.0964  -0.6118   0.3274     0.0439     0.0000     0.0958     0.0000     0.4217     0.0162     0.0000     0.0514     0.0000     0.3057   36.3457   34.7571   15.3350    8.2744   74.5657    0.1732    0.1459    0.1200    0.0129    0.5604   21.5479   21.3960    1.3864   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2009   0.1611   0.0000   0.2662   0.0000   0.9384  0.1272  0.0000  0.2182  0.0000  0.8289  0.0242  0.0000  0.0680  0.0000  0.3676   0.2598   0.0000   0.3986   0.0000   1.0000    0.0587    0.0000    0.1203    0.0000    0.5748   0.0112   0.0000   0.0422  -0.2173   0.1733   0.0217   0.0000   0.0906  -0.6118   0.3274     0.0402     0.0000     0.0890     0.0000     0.4217     0.0197     0.0000     0.0578     0.0000     0.3057   36.2315   33.9747   15.4842    8.2744   74.5657    0.1722    0.1428    0.1226    0.0129    0.5604   21.6160   21.4406    1.4466   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2010   0.1757   0.0000   0.2679   0.0000   0.9384  0.1389  0.0000  0.2193  0.0000  0.8289  0.0259  0.0000  0.0700  0.0000  0.3676   0.3127   0.0000   0.4203   0.0000   1.0000    0.0844    0.0000    0.1520    0.0000    0.5748   0.0184   0.0000   0.0411  -0.2173   0.1733   0.0335   0.0000   0.0849  -0.6118   0.3274     0.0400     0.0000     0.0874     0.0000     0.4217     0.0209     0.0000     0.0594     0.0000     0.3057   36.2102   34.2386   15.5565    8.2744   74.5657    0.1743    0.1471    0.1235    0.0129    0.5604   21.6827   21.4765    1.4304   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2011   0.1860   0.0000   0.2682   0.0000   0.9384  0.1484  0.0000  0.2204  0.0000  0.8289  0.0261  0.0000  0.0694  0.0000  0.3676   0.3495   0.0000   0.4316   0.0000   1.0000    0.0907    0.0000    0.1519    0.0000    0.5748   0.0190   0.0000   0.0433  -0.2173   0.1733   0.0330   0.0000   0.0887  -0.6118   0.3274     0.0440     0.0000     0.0901     0.0000     0.4217     0.0194     0.0000     0.0559     0.0000     0.3057   36.1617   34.3301   15.4639    8.2744   74.5657    0.1748    0.1499    0.1226    0.0129    0.5604   21.7769   21.5709    1.4129   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2012   0.1952   0.0000   0.2690   0.0000   0.9384  0.1533  0.0000  0.2183  0.0000  0.8289  0.0292  0.0000  0.0723  0.0000  0.3676   0.3619   0.0000   0.4297   0.0000   1.0000    0.0878    0.0000    0.1420    0.0000    0.5748   0.0168   0.0000   0.0405  -0.2173   0.1733   0.0295   0.0000   0.0794  -0.6118   0.3274     0.0455     0.0000     0.0910     0.0000     0.4217     0.0192     0.0000     0.0549     0.0000     0.3057   36.3319   34.5098   15.4586    8.2744   74.5657    0.1764    0.1486    0.1231    0.0129    0.5604   21.8578   21.6565    1.4048   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2013   0.2032   0.0000   0.2705   0.0000   0.9384  0.1584  0.0000  0.2178  0.0000  0.8289  0.0314  0.0000  0.0736  0.0000  0.3676   0.3661   0.0000   0.4267   0.0000   1.0000    0.0763    0.0000    0.1220    0.0000    0.5748   0.0168   0.0000   0.0414  -0.2173   0.1733   0.0287   0.0000   0.0867  -0.6118   0.3274     0.0471     0.0000     0.0910     0.0000     0.4217     0.0204     0.0000     0.0565     0.0000     0.3057   35.8246   33.9492   15.4485    8.2744   74.5657    0.1715    0.1410    0.1220    0.0129    0.5604   21.9543   21.7591    1.4178   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2014   0.2157   0.0000   0.2715   0.0000   0.9384  0.1679  0.0000  0.2185  0.0000  0.8289  0.0322  0.0000  0.0736  0.0000  0.3676   0.3869   0.0000   0.4275   0.0000   1.0000    0.0730    0.0000    0.1161    0.0000    0.5748   0.0175   0.0000   0.0421  -0.2173   0.1733   0.0296   0.0000   0.0889  -0.6118   0.3274     0.0476     0.0000     0.0879     0.0000     0.4217     0.0205     0.0000     0.0558     0.0000     0.3057   35.1844   33.2892   15.1536    8.2744   74.5657    0.1653    0.1347    0.1187    0.0129    0.5604   22.0098   21.8438    1.4550   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2015   0.2309   0.1214   0.2681   0.0000   0.9384  0.1798  0.0837  0.2153  0.0000  0.8289  0.0344  0.0000  0.0756  0.0000  0.3676   0.4295   0.4229   0.4305   0.0000   1.0000    0.0840    0.0279    0.1196    0.0000    0.5748   0.0181   0.0000   0.0466  -0.2173   0.1733   0.0290   0.0000   0.0985  -0.6118   0.3274     0.0501     0.0000     0.0883     0.0000     0.4217     0.0210     0.0000     0.0552     0.0000     0.3057   34.3022   32.3816   14.7945    8.2744   74.5657    0.1589    0.1309    0.1141    0.0129    0.5604   22.0226   21.8990    1.5138   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2016   0.2475   0.1859   0.2645   0.0000   0.9384  0.1917  0.1363  0.2113  0.0000  0.8289  0.0365  0.0000  0.0767  0.0000  0.3676   0.4754   0.6084   0.4285   0.0000   1.0000    0.0963    0.0538    0.1250    0.0000    0.5748   0.0245   0.0068   0.0473  -0.2173   0.1733   0.0400   0.0144   0.0941  -0.6118   0.3274     0.0475     0.0000     0.0824     0.0000     0.4217     0.0214     0.0000     0.0541     0.0000     0.3057   33.5103   31.4033   14.6316    8.2744   74.5657    0.1538    0.1251    0.1109    0.0129    0.5604   22.0736   21.9816    1.5629   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2017   0.2741   0.2383   0.2622   0.0000   0.9384  0.2142  0.1855  0.2109  0.0000  0.8289  0.0393  0.0000  0.0772  0.0000  0.3676   0.5345   0.7239   0.4211   0.0000   1.0000    0.1021    0.0666    0.1212    0.0000    0.5748   0.0297   0.0170   0.0500  -0.2173   0.1733   0.0498   0.0373   0.0963  -0.6118   0.3274     0.0553     0.0000     0.0875     0.0000     0.4217     0.0238     0.0000     0.0556     0.0000     0.3057   33.5683   31.4047   14.4857    8.2744   74.5657    0.1555    0.1288    0.1099    0.0129    0.5604   22.0994   21.9898    1.5535   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2018   0.2934   0.2728   0.2683   0.0000   0.9384  0.2301  0.2085  0.2191  0.0000  0.8289  0.0400  0.0000  0.0757  0.0000  0.3676   0.5485   0.7469   0.4180   0.0000   1.0000    0.0953    0.0651    0.1121    0.0000    0.5748   0.0219   0.0128   0.0637  -0.2173   0.1733   0.0329   0.0300   0.1372  -0.6118   0.3274     0.0602     0.0031     0.0896     0.0000     0.4217     0.0247     0.0000     0.0555     0.0000     0.3057   33.3975   31.0586   14.4908    8.2744   74.5657    0.1545    0.1261    0.1100    0.0129    0.5604   22.1755   22.0455    1.5673   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2019   0.3085   0.2933   0.2689   0.0000   0.9384  0.2397  0.2174  0.2196  0.0000  0.8289  0.0424  0.0000  0.0771  0.0000  0.3676   0.5704   0.7565   0.4059   0.0000   1.0000    0.1029    0.0697    0.1189    0.0000    0.5748   0.0229   0.0158   0.0659  -0.2173   0.1733   0.0354   0.0369   0.1410  -0.6118   0.3274     0.0602     0.0071     0.0901     0.0000     0.4217     0.0265     0.0000     0.0567     0.0000     0.3057   32.8718   30.2994   14.6041    8.2744   74.5657    0.1513    0.1195    0.1107    0.0129    0.5604   22.2027   22.0435    1.5642   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2020   0.3346   0.3254   0.2598   0.0000   0.9384  0.2596  0.2459  0.2122  0.0000  0.8289  0.0461  0.0000  0.0801  0.0000  0.3676   0.6340   0.8068   0.3781   0.0000   1.0000    0.1320    0.0975    0.1344    0.0000    0.5748   0.0274   0.0243   0.0676  -0.2173   0.1733   0.0417   0.0510   0.1435  -0.6118   0.3274     0.0603     0.0158     0.0870     0.0000     0.4217     0.0296     0.0000     0.0606     0.0000     0.3057   32.3871   29.9751   14.6354    8.2744   74.5657    0.1482    0.1160    0.1109    0.0129    0.5604   22.1986   21.9821    1.5351   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2021   0.3658   0.3599   0.2502   0.0000   0.9384  0.2795  0.2636  0.2047  0.0000  0.8289  0.0565  0.0134  0.0853  0.0000  0.3676   0.6803   0.8221   0.3359   0.0000   1.0000    0.1422    0.1088    0.1320    0.0000    0.5748   0.0318   0.0326   0.0685  -0.2173   0.1733   0.0470   0.0636   0.1482  -0.6118   0.3274     0.0588     0.0189     0.0838     0.0000     0.4217     0.0315     0.0000     0.0615     0.0000     0.3057   32.2697   29.9000   14.7268    8.2744   74.5657    0.1475    0.1153    0.1114    0.0129    0.5604   22.2486   22.0020    1.5105   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2022   0.3779   0.3673   0.2412   0.0000   0.9384  0.2850  0.2680  0.1963  0.0000  0.8289  0.0624  0.0188  0.0873  0.0000  0.3676   0.7103   0.8242   0.3029   0.0000   1.0000    0.1571    0.1224    0.1366    0.0000    0.5748   0.0249   0.0280   0.0684  -0.2173   0.1733   0.0343   0.0532   0.1481  -0.6118   0.3274     0.0600     0.0245     0.0823     0.0000     0.4217     0.0363     0.0000     0.0643     0.0000     0.3057   32.0465   29.6882   14.6861    8.2744   74.5657    0.1457    0.1141    0.1108    0.0129    0.5604   22.3020   22.0442    1.4761   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2023   0.3853   0.3728   0.2350   0.0000   0.9384  0.2848  0.2640  0.1892  0.0000  0.8289  0.0697  0.0258  0.0918  0.0000  0.3676   0.7201   0.8161   0.2808   0.0000   1.0000    0.1610    0.1244    0.1352    0.0000    0.5748   0.0206   0.0246   0.0631  -0.2173   0.1733   0.0241   0.0460   0.1421  -0.6118   0.3274     0.0585     0.0252     0.0794     0.0000     0.4217     0.0418     0.0024     0.0690     0.0000     0.3057   31.9458   29.5243   14.8259    8.2744   74.5657    0.1450    0.1131    0.1118    0.0129    0.5604   22.3350   22.0580    1.4517   18.7922   26.9180   0.0000   0.0000   0.0000        0        0
2024   0.3961   0.3861   0.2353   0.0000   0.9384  0.2944  0.2777  0.1894  0.0000  0.8289  0.0708  0.0281  0.0925  0.0000  0.3676   0.7298   0.8231   0.2733   0.0000   1.0000    0.1445    0.1136    0.1214    0.0000    0.5748   0.0139   0.0197   0.0657  -0.2173   0.1733   0.0099   0.0383   0.1534  -0.6118   0.3274     0.0610     0.0254     0.0812     0.0000     0.4217     0.0429     0.0036     0.0696     0.0000     0.3057       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN       NaN   22.3424   22.0585    1.4473   18.7922   26.9180   0.0000   0.0000   0.0000        0        0

结果已保存至 'time_grouped_statistics.xlsx'


按指标分组的详细统计:

==================================================
Lev 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0889 0.0000 0.1960 0.0000 0.9384
2001 0.0977 0.0000 0.2069 0.0000 0.9384
2002 0.1067 0.0000 0.2174 0.0000 0.9384
2003 0.1157 0.0000 0.2289 0.0000 0.9384
2004 0.1277 0.0000 0.2420 0.0000 0.9384
2005 0.1329 0.0000 0.2513 0.0000 0.9384
2006 0.1423 0.0000 0.2590 0.0000 0.9384
2007 0.1489 0.0000 0.2595 0.0000 0.9384
2008 0.1523 0.0000 0.2621 0.0000 0.9384
2009 0.1611 0.0000 0.2662 0.0000 0.9384
2010 0.1757 0.0000 0.2679 0.0000 0.9384
2011 0.1860 0.0000 0.2682 0.0000 0.9384
2012 0.1952 0.0000 0.2690 0.0000 0.9384
2013 0.2032 0.0000 0.2705 0.0000 0.9384
2014 0.2157 0.0000 0.2715 0.0000 0.9384
2015 0.2309 0.1214 0.2681 0.0000 0.9384
2016 0.2475 0.1859 0.2645 0.0000 0.9384
2017 0.2741 0.2383 0.2622 0.0000 0.9384
2018 0.2934 0.2728 0.2683 0.0000 0.9384
2019 0.3085 0.2933 0.2689 0.0000 0.9384
2020 0.3346 0.3254 0.2598 0.0000 0.9384
2021 0.3658 0.3599 0.2502 0.0000 0.9384
2022 0.3779 0.3673 0.2412 0.0000 0.9384
2023 0.3853 0.3728 0.2350 0.0000 0.9384
2024 0.3961 0.3861 0.2353 0.0000 0.9384

==================================================
SL 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0759 0.0000 0.1710 0.0000 0.8289
2001 0.0828 0.0000 0.1792 0.0000 0.8289
2002 0.0911 0.0000 0.1894 0.0000 0.8289
2003 0.0979 0.0000 0.1983 0.0000 0.8289
2004 0.1079 0.0000 0.2096 0.0000 0.8289
2005 0.1126 0.0000 0.2178 0.0000 0.8289
2006 0.1195 0.0000 0.2226 0.0000 0.8289
2007 0.1226 0.0000 0.2204 0.0000 0.8289
2008 0.1247 0.0000 0.2211 0.0000 0.8289
2009 0.1272 0.0000 0.2182 0.0000 0.8289
2010 0.1389 0.0000 0.2193 0.0000 0.8289
2011 0.1484 0.0000 0.2204 0.0000 0.8289
2012 0.1533 0.0000 0.2183 0.0000 0.8289
2013 0.1584 0.0000 0.2178 0.0000 0.8289
2014 0.1679 0.0000 0.2185 0.0000 0.8289
2015 0.1798 0.0837 0.2153 0.0000 0.8289
2016 0.1917 0.1363 0.2113 0.0000 0.8289
2017 0.2142 0.1855 0.2109 0.0000 0.8289
2018 0.2301 0.2085 0.2191 0.0000 0.8289
2019 0.2397 0.2174 0.2196 0.0000 0.8289
2020 0.2596 0.2459 0.2122 0.0000 0.8289
2021 0.2795 0.2636 0.2047 0.0000 0.8289
2022 0.2850 0.2680 0.1963 0.0000 0.8289
2023 0.2848 0.2640 0.1892 0.0000 0.8289
2024 0.2944 0.2777 0.1894 0.0000 0.8289

==================================================
LL 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0112 0.0000 0.0405 0.0000 0.3676
2001 0.0126 0.0000 0.0444 0.0000 0.3676
2002 0.0133 0.0000 0.0462 0.0000 0.3676
2003 0.0148 0.0000 0.0489 0.0000 0.3676
2004 0.0165 0.0000 0.0532 0.0000 0.3676
2005 0.0165 0.0000 0.0534 0.0000 0.3676
2006 0.0179 0.0000 0.0561 0.0000 0.3676
2007 0.0183 0.0000 0.0562 0.0000 0.3676
2008 0.0197 0.0000 0.0595 0.0000 0.3676
2009 0.0242 0.0000 0.0680 0.0000 0.3676
2010 0.0259 0.0000 0.0700 0.0000 0.3676
2011 0.0261 0.0000 0.0694 0.0000 0.3676
2012 0.0292 0.0000 0.0723 0.0000 0.3676
2013 0.0314 0.0000 0.0736 0.0000 0.3676
2014 0.0322 0.0000 0.0736 0.0000 0.3676
2015 0.0344 0.0000 0.0756 0.0000 0.3676
2016 0.0365 0.0000 0.0767 0.0000 0.3676
2017 0.0393 0.0000 0.0772 0.0000 0.3676
2018 0.0400 0.0000 0.0757 0.0000 0.3676
2019 0.0424 0.0000 0.0771 0.0000 0.3676
2020 0.0461 0.0000 0.0801 0.0000 0.3676
2021 0.0565 0.0134 0.0853 0.0000 0.3676
2022 0.0624 0.0188 0.0873 0.0000 0.3676
2023 0.0697 0.0258 0.0918 0.0000 0.3676
2024 0.0708 0.0281 0.0925 0.0000 0.3676

==================================================
SDR 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.1742 0.0000 0.3557 0.0000 1.0000
2001 0.1846 0.0000 0.3621 0.0000 1.0000
2002 0.1943 0.0000 0.3694 0.0000 1.0000
2003 0.2018 0.0000 0.3735 0.0000 1.0000
2004 0.2137 0.0000 0.3804 0.0000 1.0000
2005 0.2141 0.0000 0.3816 0.0000 1.0000
2006 0.2254 0.0000 0.3882 0.0000 1.0000
2007 0.2378 0.0000 0.3922 0.0000 1.0000
2008 0.2459 0.0000 0.3967 0.0000 1.0000
2009 0.2598 0.0000 0.3986 0.0000 1.0000
2010 0.3127 0.0000 0.4203 0.0000 1.0000
2011 0.3495 0.0000 0.4316 0.0000 1.0000
2012 0.3619 0.0000 0.4297 0.0000 1.0000
2013 0.3661 0.0000 0.4267 0.0000 1.0000
2014 0.3869 0.0000 0.4275 0.0000 1.0000
2015 0.4295 0.4229 0.4305 0.0000 1.0000
2016 0.4754 0.6084 0.4285 0.0000 1.0000
2017 0.5345 0.7239 0.4211 0.0000 1.0000
2018 0.5485 0.7469 0.4180 0.0000 1.0000
2019 0.5704 0.7565 0.4059 0.0000 1.0000
2020 0.6340 0.8068 0.3781 0.0000 1.0000
2021 0.6803 0.8221 0.3359 0.0000 1.0000
2022 0.7103 0.8242 0.3029 0.0000 1.0000
2023 0.7201 0.8161 0.2808 0.0000 1.0000
2024 0.7298 0.8231 0.2733 0.0000 1.0000

==================================================
Cash 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0316 0.0000 0.0854 0.0000 0.5748
2001 0.0364 0.0000 0.0907 0.0000 0.5748
2002 0.0353 0.0000 0.0864 0.0000 0.5748
2003 0.0357 0.0000 0.0853 0.0000 0.5748
2004 0.0371 0.0000 0.0865 0.0000 0.5748
2005 0.0325 0.0000 0.0780 0.0000 0.5748
2006 0.0356 0.0000 0.0827 0.0000 0.5748
2007 0.0420 0.0000 0.0932 0.0000 0.5748
2008 0.0431 0.0000 0.0932 0.0000 0.5748
2009 0.0587 0.0000 0.1203 0.0000 0.5748
2010 0.0844 0.0000 0.1520 0.0000 0.5748
2011 0.0907 0.0000 0.1519 0.0000 0.5748
2012 0.0878 0.0000 0.1420 0.0000 0.5748
2013 0.0763 0.0000 0.1220 0.0000 0.5748
2014 0.0730 0.0000 0.1161 0.0000 0.5748
2015 0.0840 0.0279 0.1196 0.0000 0.5748
2016 0.0963 0.0538 0.1250 0.0000 0.5748
2017 0.1021 0.0666 0.1212 0.0000 0.5748
2018 0.0953 0.0651 0.1121 0.0000 0.5748
2019 0.1029 0.0697 0.1189 0.0000 0.5748
2020 0.1320 0.0975 0.1344 0.0000 0.5748
2021 0.1422 0.1088 0.1320 0.0000 0.5748
2022 0.1571 0.1224 0.1366 0.0000 0.5748
2023 0.1610 0.1244 0.1352 0.0000 0.5748
2024 0.1445 0.1136 0.1214 0.0000 0.5748

==================================================
ROA 的年度统计:
==================================================
        平均值    中位数    标准差     最小值    最大值
时间                                      
2000 0.0069 0.0000 0.0309 -0.2173 0.1733
2001 0.0045 0.0000 0.0318 -0.2173 0.1733
2002 0.0035 0.0000 0.0331 -0.2173 0.1733
2003 0.0045 0.0000 0.0326 -0.2173 0.1733
2004 0.0045 0.0000 0.0368 -0.2173 0.1733
2005 0.0021 0.0000 0.0390 -0.2173 0.1733
2006 0.0062 0.0000 0.0371 -0.2173 0.1733
2007 0.0121 0.0000 0.0398 -0.2173 0.1733
2008 0.0075 0.0000 0.0423 -0.2173 0.1733
2009 0.0112 0.0000 0.0422 -0.2173 0.1733
2010 0.0184 0.0000 0.0411 -0.2173 0.1733
2011 0.0190 0.0000 0.0433 -0.2173 0.1733
2012 0.0168 0.0000 0.0405 -0.2173 0.1733
2013 0.0168 0.0000 0.0414 -0.2173 0.1733
2014 0.0175 0.0000 0.0421 -0.2173 0.1733
2015 0.0181 0.0000 0.0466 -0.2173 0.1733
2016 0.0245 0.0068 0.0473 -0.2173 0.1733
2017 0.0297 0.0170 0.0500 -0.2173 0.1733
2018 0.0219 0.0128 0.0637 -0.2173 0.1733
2019 0.0229 0.0158 0.0659 -0.2173 0.1733
2020 0.0274 0.0243 0.0676 -0.2173 0.1733
2021 0.0318 0.0326 0.0685 -0.2173 0.1733
2022 0.0249 0.0280 0.0684 -0.2173 0.1733
2023 0.0206 0.0246 0.0631 -0.2173 0.1733
2024 0.0139 0.0197 0.0657 -0.2173 0.1733

==================================================
ROE 的年度统计:
==================================================
        平均值    中位数    标准差     最小值    最大值
时间                                      
2000 0.0118 0.0000 0.0680 -0.6118 0.3274
2001 0.0076 0.0000 0.0705 -0.6118 0.3274
2002 0.0059 0.0000 0.0763 -0.6118 0.3274
2003 0.0096 0.0000 0.0705 -0.6118 0.3274
2004 0.0089 0.0000 0.0848 -0.6118 0.3274
2005 0.0050 0.0000 0.0928 -0.6118 0.3274
2006 0.0143 0.0000 0.0860 -0.6118 0.3274
2007 0.0239 0.0000 0.0879 -0.6118 0.3274
2008 0.0133 0.0000 0.0964 -0.6118 0.3274
2009 0.0217 0.0000 0.0906 -0.6118 0.3274
2010 0.0335 0.0000 0.0849 -0.6118 0.3274
2011 0.0330 0.0000 0.0887 -0.6118 0.3274
2012 0.0295 0.0000 0.0794 -0.6118 0.3274
2013 0.0287 0.0000 0.0867 -0.6118 0.3274
2014 0.0296 0.0000 0.0889 -0.6118 0.3274
2015 0.0290 0.0000 0.0985 -0.6118 0.3274
2016 0.0400 0.0144 0.0941 -0.6118 0.3274
2017 0.0498 0.0373 0.0963 -0.6118 0.3274
2018 0.0329 0.0300 0.1372 -0.6118 0.3274
2019 0.0354 0.0369 0.1410 -0.6118 0.3274
2020 0.0417 0.0510 0.1435 -0.6118 0.3274
2021 0.0470 0.0636 0.1482 -0.6118 0.3274
2022 0.0343 0.0532 0.1481 -0.6118 0.3274
2023 0.0241 0.0460 0.1421 -0.6118 0.3274
2024 0.0099 0.0383 0.1534 -0.6118 0.3274

==================================================
SLoan 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0330 0.0000 0.0846 0.0000 0.4217
2001 0.0375 0.0000 0.0916 0.0000 0.4217
2002 0.0399 0.0000 0.0952 0.0000 0.4217
2003 0.0436 0.0000 0.1004 0.0000 0.4217
2004 0.0462 0.0000 0.1028 0.0000 0.4217
2005 0.0453 0.0000 0.1014 0.0000 0.4217
2006 0.0450 0.0000 0.0986 0.0000 0.4217
2007 0.0442 0.0000 0.0961 0.0000 0.4217
2008 0.0439 0.0000 0.0958 0.0000 0.4217
2009 0.0402 0.0000 0.0890 0.0000 0.4217
2010 0.0400 0.0000 0.0874 0.0000 0.4217
2011 0.0440 0.0000 0.0901 0.0000 0.4217
2012 0.0455 0.0000 0.0910 0.0000 0.4217
2013 0.0471 0.0000 0.0910 0.0000 0.4217
2014 0.0476 0.0000 0.0879 0.0000 0.4217
2015 0.0501 0.0000 0.0883 0.0000 0.4217
2016 0.0475 0.0000 0.0824 0.0000 0.4217
2017 0.0553 0.0000 0.0875 0.0000 0.4217
2018 0.0602 0.0031 0.0896 0.0000 0.4217
2019 0.0602 0.0071 0.0901 0.0000 0.4217
2020 0.0603 0.0158 0.0870 0.0000 0.4217
2021 0.0588 0.0189 0.0838 0.0000 0.4217
2022 0.0600 0.0245 0.0823 0.0000 0.4217
2023 0.0585 0.0252 0.0794 0.0000 0.4217
2024 0.0610 0.0254 0.0812 0.0000 0.4217

==================================================
LLoan 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000 0.0095 0.0000 0.0354 0.0000 0.3057
2001 0.0110 0.0000 0.0396 0.0000 0.3057
2002 0.0112 0.0000 0.0402 0.0000 0.3057
2003 0.0124 0.0000 0.0429 0.0000 0.3057
2004 0.0138 0.0000 0.0462 0.0000 0.3057
2005 0.0136 0.0000 0.0464 0.0000 0.3057
2006 0.0148 0.0000 0.0490 0.0000 0.3057
2007 0.0154 0.0000 0.0496 0.0000 0.3057
2008 0.0162 0.0000 0.0514 0.0000 0.3057
2009 0.0197 0.0000 0.0578 0.0000 0.3057
2010 0.0209 0.0000 0.0594 0.0000 0.3057
2011 0.0194 0.0000 0.0559 0.0000 0.3057
2012 0.0192 0.0000 0.0549 0.0000 0.3057
2013 0.0204 0.0000 0.0565 0.0000 0.3057
2014 0.0205 0.0000 0.0558 0.0000 0.3057
2015 0.0210 0.0000 0.0552 0.0000 0.3057
2016 0.0214 0.0000 0.0541 0.0000 0.3057
2017 0.0238 0.0000 0.0556 0.0000 0.3057
2018 0.0247 0.0000 0.0555 0.0000 0.3057
2019 0.0265 0.0000 0.0567 0.0000 0.3057
2020 0.0296 0.0000 0.0606 0.0000 0.3057
2021 0.0315 0.0000 0.0615 0.0000 0.3057
2022 0.0363 0.0000 0.0643 0.0000 0.3057
2023 0.0418 0.0024 0.0690 0.0000 0.3057
2024 0.0429 0.0036 0.0696 0.0000 0.3057

==================================================
Top1 的年度统计:
==================================================
         平均值     中位数     标准差    最小值     最大值
时间                                         
2000     NaN     NaN     NaN    NaN     NaN
2001     NaN     NaN     NaN    NaN     NaN
2002     NaN     NaN     NaN    NaN     NaN
2003 42.4786 41.2759 16.9773 8.2744 74.5657
2004 41.7888 39.8541 16.6441 8.2744 74.5657
2005 40.3061 37.7029 16.1135 8.2744 74.5657
2006 36.0474 33.5374 14.8700 8.2744 74.5657
2007 35.7441 33.8986 15.0713 8.2744 74.5657
2008 36.3457 34.7571 15.3350 8.2744 74.5657
2009 36.2315 33.9747 15.4842 8.2744 74.5657
2010 36.2102 34.2386 15.5565 8.2744 74.5657
2011 36.1617 34.3301 15.4639 8.2744 74.5657
2012 36.3319 34.5098 15.4586 8.2744 74.5657
2013 35.8246 33.9492 15.4485 8.2744 74.5657
2014 35.1844 33.2892 15.1536 8.2744 74.5657
2015 34.3022 32.3816 14.7945 8.2744 74.5657
2016 33.5103 31.4033 14.6316 8.2744 74.5657
2017 33.5683 31.4047 14.4857 8.2744 74.5657
2018 33.3975 31.0586 14.4908 8.2744 74.5657
2019 32.8718 30.2994 14.6041 8.2744 74.5657
2020 32.3871 29.9751 14.6354 8.2744 74.5657
2021 32.2697 29.9000 14.7268 8.2744 74.5657
2022 32.0465 29.6882 14.6861 8.2744 74.5657
2023 31.9458 29.5243 14.8259 8.2744 74.5657
2024     NaN     NaN     NaN    NaN     NaN

==================================================
HHI5 的年度统计:
==================================================
        平均值    中位数    标准差    最小值    最大值
时间                                     
2000    NaN    NaN    NaN    NaN    NaN
2001    NaN    NaN    NaN    NaN    NaN
2002    NaN    NaN    NaN    NaN    NaN
2003 0.2295 0.1979 0.1415 0.0129 0.5604
2004 0.2241 0.1887 0.1380 0.0129 0.5604
2005 0.2101 0.1726 0.1314 0.0129 0.5604
2006 0.1706 0.1397 0.1153 0.0129 0.5604
2007 0.1683 0.1410 0.1163 0.0129 0.5604
2008 0.1732 0.1459 0.1200 0.0129 0.5604
2009 0.1722 0.1428 0.1226 0.0129 0.5604
2010 0.1743 0.1471 0.1235 0.0129 0.5604
2011 0.1748 0.1499 0.1226 0.0129 0.5604
2012 0.1764 0.1486 0.1231 0.0129 0.5604
2013 0.1715 0.1410 0.1220 0.0129 0.5604
2014 0.1653 0.1347 0.1187 0.0129 0.5604
2015 0.1589 0.1309 0.1141 0.0129 0.5604
2016 0.1538 0.1251 0.1109 0.0129 0.5604
2017 0.1555 0.1288 0.1099 0.0129 0.5604
2018 0.1545 0.1261 0.1100 0.0129 0.5604
2019 0.1513 0.1195 0.1107 0.0129 0.5604
2020 0.1482 0.1160 0.1109 0.0129 0.5604
2021 0.1475 0.1153 0.1114 0.0129 0.5604
2022 0.1457 0.1141 0.1108 0.0129 0.5604
2023 0.1450 0.1131 0.1118 0.0129 0.5604
2024    NaN    NaN    NaN    NaN    NaN

==================================================
Size 的年度统计:
==================================================
         平均值     中位数    标准差     最小值     最大值
时间                                         
2000 20.9439 20.8770 0.8634 18.7922 25.5963
2001 21.0155 20.9372 0.9086 18.7922 26.6102
2002 21.0789 20.9909 0.9640 18.7922 26.6412
2003 21.1775 21.1037 1.0087 18.7922 26.9180
2004 21.2251 21.1329 1.0575 18.7922 26.9180
2005 21.2723 21.1804 1.0952 18.7922 26.9180
2006 21.3349 21.2300 1.2137 18.7922 26.9180
2007 21.4913 21.3551 1.3487 18.7922 26.9180
2008 21.5479 21.3960 1.3864 18.7922 26.9180
2009 21.6160 21.4406 1.4466 18.7922 26.9180
2010 21.6827 21.4765 1.4304 18.7922 26.9180
2011 21.7769 21.5709 1.4129 18.7922 26.9180
2012 21.8578 21.6565 1.4048 18.7922 26.9180
2013 21.9543 21.7591 1.4178 18.7922 26.9180
2014 22.0098 21.8438 1.4550 18.7922 26.9180
2015 22.0226 21.8990 1.5138 18.7922 26.9180
2016 22.0736 21.9816 1.5629 18.7922 26.9180
2017 22.0994 21.9898 1.5535 18.7922 26.9180
2018 22.1755 22.0455 1.5673 18.7922 26.9180
2019 22.2027 22.0435 1.5642 18.7922 26.9180
2020 22.1986 21.9821 1.5351 18.7922 26.9180
2021 22.2486 22.0020 1.5105 18.7922 26.9180
2022 22.3020 22.0442 1.4761 18.7922 26.9180
2023 22.3350 22.0580 1.4517 18.7922 26.9180
2024 22.3424 22.0585 1.4473 18.7922 26.9180

==================================================
Age 的年度统计:
==================================================
        平均值    中位数    标准差  最小值  最大值
时间                                 
2000 0.0000 0.0000 0.0000    0    0
2001 0.0000 0.0000 0.0000    0    0
2002 0.0000 0.0000 0.0000    0    0
2003 0.0000 0.0000 0.0000    0    0
2004 0.0000 0.0000 0.0000    0    0
2005 0.0000 0.0000 0.0000    0    0
2006 0.0000 0.0000 0.0000    0    0
2007 0.0000 0.0000 0.0000    0    0
2008 0.0000 0.0000 0.0000    0    0
2009 0.0000 0.0000 0.0000    0    0
2010 0.0000 0.0000 0.0000    0    0
2011 0.0000 0.0000 0.0000    0    0
2012 0.0000 0.0000 0.0000    0    0
2013 0.0000 0.0000 0.0000    0    0
2014 0.0000 0.0000 0.0000    0    0
2015 0.0000 0.0000 0.0000    0    0
2016 0.0000 0.0000 0.0000    0    0
2017 0.0000 0.0000 0.0000    0    0
2018 0.0000 0.0000 0.0000    0    0
2019 0.0000 0.0000 0.0000    0    0
2020 0.0000 0.0000 0.0000    0    0
2021 0.0000 0.0000 0.0000    0    0
2022 0.0000 0.0000 0.0000    0    0
2023 0.0000 0.0000 0.0000    0    0
2024 0.0000 0.0000 0.0000    0    0</code></pre>
</div>
</div>
<div id="87aadb6e" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="im">import</span> matplotlib.font_manager <span class="im">as</span> fm</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="im">import</span> os</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co"># macOS 中文显示解决方案</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co"># 1. 检查并设置中文字体</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="cf">try</span>:</span>
<span id="cb7-12"><a href="#cb7-12"></a>    <span class="co"># 尝试查找 macOS 系统自带的中文字体</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>    font_names <span class="op">=</span> [<span class="st">'Songti SC'</span>, <span class="st">'STHeiti'</span>, <span class="st">'PingFang SC'</span>, <span class="st">'Hiragino Sans GB'</span>]</span>
<span id="cb7-14"><a href="#cb7-14"></a>    available_fonts <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> fm.fontManager.ttflist]</span>
<span id="cb7-15"><a href="#cb7-15"></a>    </span>
<span id="cb7-16"><a href="#cb7-16"></a>    <span class="co"># 寻找可用的中文字体</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>    chinese_font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>    <span class="cf">for</span> font <span class="kw">in</span> font_names:</span>
<span id="cb7-19"><a href="#cb7-19"></a>        <span class="cf">if</span> font <span class="kw">in</span> available_fonts:</span>
<span id="cb7-20"><a href="#cb7-20"></a>            chinese_font <span class="op">=</span> font</span>
<span id="cb7-21"><a href="#cb7-21"></a>            <span class="cf">break</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>    </span>
<span id="cb7-23"><a href="#cb7-23"></a>    <span class="co"># 如果找到可用字体，设置matplotlib使用它</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="cf">if</span> chinese_font:</span>
<span id="cb7-25"><a href="#cb7-25"></a>        plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [chinese_font]</span>
<span id="cb7-26"><a href="#cb7-26"></a>        <span class="bu">print</span>(<span class="ss">f"使用中文字体: </span><span class="sc">{</span>chinese_font<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-27"><a href="#cb7-27"></a>    <span class="cf">else</span>:</span>
<span id="cb7-28"><a href="#cb7-28"></a>        <span class="co"># 如果找不到系统字体，尝试安装并使用SimHei字体</span></span>
<span id="cb7-29"><a href="#cb7-29"></a>        <span class="bu">print</span>(<span class="st">"未找到系统自带中文字体，尝试安装SimHei..."</span>)</span>
<span id="cb7-30"><a href="#cb7-30"></a>        <span class="cf">try</span>:</span>
<span id="cb7-31"><a href="#cb7-31"></a>            <span class="co"># 安装SimHei字体</span></span>
<span id="cb7-32"><a href="#cb7-32"></a>            <span class="op">!</span>pip install fonttools</span>
<span id="cb7-33"><a href="#cb7-33"></a>            <span class="op">!</span>wget https:<span class="op">//</span>github.com<span class="op">/</span>stylishzhang<span class="op">/</span>simhei<span class="op">-</span>font<span class="op">/</span>raw<span class="op">/</span>master<span class="op">/</span>simhei.ttf <span class="op">-</span>O simhei.ttf</span>
<span id="cb7-34"><a href="#cb7-34"></a>            font_path <span class="op">=</span> os.path.join(os.getcwd(), <span class="st">'simhei.ttf'</span>)</span>
<span id="cb7-35"><a href="#cb7-35"></a>            fm.fontManager.addfont(font_path)</span>
<span id="cb7-36"><a href="#cb7-36"></a>            plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [<span class="st">'SimHei'</span>]</span>
<span id="cb7-37"><a href="#cb7-37"></a>            <span class="bu">print</span>(<span class="st">"成功安装并使用SimHei字体"</span>)</span>
<span id="cb7-38"><a href="#cb7-38"></a>        <span class="cf">except</span>:</span>
<span id="cb7-39"><a href="#cb7-39"></a>            <span class="bu">print</span>(<span class="st">"无法安装SimHei字体，使用英文标题"</span>)</span>
<span id="cb7-40"><a href="#cb7-40"></a>            USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-41"><a href="#cb7-41"></a>    plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># 用来正常显示负号</span></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="cf">except</span>:</span>
<span id="cb7-43"><a href="#cb7-43"></a>    <span class="bu">print</span>(<span class="st">"字体设置失败，使用英文标题"</span>)</span>
<span id="cb7-44"><a href="#cb7-44"></a>    USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-45"><a href="#cb7-45"></a></span>
<span id="cb7-46"><a href="#cb7-46"></a><span class="co"># 2. 设置标题和标签的函数，根据情况使用中文或英文</span></span>
<span id="cb7-47"><a href="#cb7-47"></a><span class="kw">def</span> set_title(title_chinese, title_english):</span>
<span id="cb7-48"><a href="#cb7-48"></a>    <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb7-49"><a href="#cb7-49"></a>        plt.title(title_english, fontsize<span class="op">=</span><span class="dv">7</span>)  <span class="co"># 减小标题字体</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>    <span class="cf">else</span>:</span>
<span id="cb7-51"><a href="#cb7-51"></a>        plt.title(title_chinese, fontsize<span class="op">=</span><span class="dv">7</span>)  <span class="co"># 减小标题字体</span></span>
<span id="cb7-52"><a href="#cb7-52"></a></span>
<span id="cb7-53"><a href="#cb7-53"></a><span class="kw">def</span> set_labels(xlabel_chinese, xlabel_english, ylabel_chinese, ylabel_english):</span>
<span id="cb7-54"><a href="#cb7-54"></a>    <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb7-55"><a href="#cb7-55"></a>        plt.xlabel(xlabel_english, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小坐标轴标签字体</span></span>
<span id="cb7-56"><a href="#cb7-56"></a>        plt.ylabel(ylabel_english, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小坐标轴标签字体</span></span>
<span id="cb7-57"><a href="#cb7-57"></a>    <span class="cf">else</span>:</span>
<span id="cb7-58"><a href="#cb7-58"></a>        plt.xlabel(xlabel_chinese, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小坐标轴标签字体</span></span>
<span id="cb7-59"><a href="#cb7-59"></a>        plt.ylabel(ylabel_chinese, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小坐标轴标签字体</span></span>
<span id="cb7-60"><a href="#cb7-60"></a></span>
<span id="cb7-61"><a href="#cb7-61"></a><span class="co"># 读取第三步分组统计结果数据</span></span>
<span id="cb7-62"><a href="#cb7-62"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/time_grouped_statistics.xlsx'</span></span>
<span id="cb7-63"><a href="#cb7-63"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb7-64"><a href="#cb7-64"></a></span>
<span id="cb7-65"><a href="#cb7-65"></a><span class="co"># 确保时间列是整数类型</span></span>
<span id="cb7-66"><a href="#cb7-66"></a>df[<span class="st">'时间'</span>] <span class="op">=</span> df[<span class="st">'时间'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb7-67"><a href="#cb7-67"></a></span>
<span id="cb7-68"><a href="#cb7-68"></a><span class="co"># 按时间排序</span></span>
<span id="cb7-69"><a href="#cb7-69"></a>df <span class="op">=</span> df.sort_values(<span class="st">'时间'</span>)  <span class="co"># 确保使用正确的中文列名</span></span>
<span id="cb7-70"><a href="#cb7-70"></a></span>
<span id="cb7-71"><a href="#cb7-71"></a><span class="co"># 1. 绘制时序图B1：Lev的均值和中位数</span></span>
<span id="cb7-72"><a href="#cb7-72"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb7-73"><a href="#cb7-73"></a>plt.plot(df[<span class="st">'时间'</span>], df[<span class="st">'Lev_平均值'</span>], label<span class="op">=</span><span class="st">'Lev Mean'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'总负债率均值'</span>, </span>
<span id="cb7-74"><a href="#cb7-74"></a>         marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">3</span>, linewidth<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>)  <span class="co"># 减小标记大小和线宽</span></span>
<span id="cb7-75"><a href="#cb7-75"></a>plt.plot(df[<span class="st">'时间'</span>], df[<span class="st">'Lev_中位数'</span>], label<span class="op">=</span><span class="st">'Lev Median'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'总负债率中位数'</span>, </span>
<span id="cb7-76"><a href="#cb7-76"></a>         marker<span class="op">=</span><span class="st">'s'</span>, markersize<span class="op">=</span><span class="dv">3</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'#ff7f0e'</span>)  <span class="co"># 减小标记大小和线宽</span></span>
<span id="cb7-77"><a href="#cb7-77"></a></span>
<span id="cb7-78"><a href="#cb7-78"></a><span class="co"># 设置标题和标签</span></span>
<span id="cb7-79"><a href="#cb7-79"></a>set_title(<span class="ss">f'总负债率趋势'</span>,  <span class="co"># 简化标题文字</span></span>
<span id="cb7-80"><a href="#cb7-80"></a>          <span class="ss">f'Leverage Ratio Trend'</span>)  <span class="co"># 简化标题文字</span></span>
<span id="cb7-81"><a href="#cb7-81"></a>set_labels(<span class="st">'年份'</span>, <span class="st">'Year'</span>, <span class="st">'总负债率'</span>, <span class="st">'Leverage Ratio'</span>)</span>
<span id="cb7-82"><a href="#cb7-82"></a></span>
<span id="cb7-83"><a href="#cb7-83"></a><span class="co"># 设置网格和刻度</span></span>
<span id="cb7-84"><a href="#cb7-84"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># 减小网格透明度</span></span>
<span id="cb7-85"><a href="#cb7-85"></a>plt.xticks(df[<span class="st">'时间'</span>], rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-86"><a href="#cb7-86"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-87"><a href="#cb7-87"></a></span>
<span id="cb7-88"><a href="#cb7-88"></a><span class="co"># 添加图例</span></span>
<span id="cb7-89"><a href="#cb7-89"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">5</span>, loc<span class="op">=</span><span class="st">'best'</span>)  <span class="co"># 减小图例字体，自动选择最佳位置</span></span>
<span id="cb7-90"><a href="#cb7-90"></a></span>
<span id="cb7-91"><a href="#cb7-91"></a><span class="co"># 美化布局</span></span>
<span id="cb7-92"><a href="#cb7-92"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># 减小内边距</span></span>
<span id="cb7-93"><a href="#cb7-93"></a></span>
<span id="cb7-94"><a href="#cb7-94"></a><span class="co"># 保存图像</span></span>
<span id="cb7-95"><a href="#cb7-95"></a>output_path_b1 <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/Leverage_Trend.png'</span></span>
<span id="cb7-96"><a href="#cb7-96"></a>plt.savefig(output_path_b1, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)  <span class="co"># 裁剪多余空白</span></span>
<span id="cb7-97"><a href="#cb7-97"></a><span class="bu">print</span>(<span class="ss">f"时序图B1已保存至: </span><span class="sc">{</span>output_path_b1<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-98"><a href="#cb7-98"></a></span>
<span id="cb7-99"><a href="#cb7-99"></a><span class="co"># 显示图像</span></span>
<span id="cb7-100"><a href="#cb7-100"></a>plt.show()</span>
<span id="cb7-101"><a href="#cb7-101"></a></span>
<span id="cb7-102"><a href="#cb7-102"></a><span class="co"># 2. 绘制时序图B2：ROA和Cash的均值（双纵坐标）</span></span>
<span id="cb7-103"><a href="#cb7-103"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">3</span>))</span>
<span id="cb7-104"><a href="#cb7-104"></a></span>
<span id="cb7-105"><a href="#cb7-105"></a><span class="co"># 绘制ROA均值（左侧坐标轴）</span></span>
<span id="cb7-106"><a href="#cb7-106"></a>color <span class="op">=</span> <span class="st">'#1f77b4'</span></span>
<span id="cb7-107"><a href="#cb7-107"></a>ax1.plot(df[<span class="st">'时间'</span>], df[<span class="st">'ROA_平均值'</span>], </span>
<span id="cb7-108"><a href="#cb7-108"></a>         label<span class="op">=</span><span class="st">'ROA Mean'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'ROA均值'</span>, </span>
<span id="cb7-109"><a href="#cb7-109"></a>         marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">3</span>, linewidth<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>color)  <span class="co"># 减小标记大小和线宽</span></span>
<span id="cb7-110"><a href="#cb7-110"></a>ax1.set_xlabel(<span class="st">'Year'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小字体</span></span>
<span id="cb7-111"><a href="#cb7-111"></a>ax1.set_ylabel(<span class="st">'ROA'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'ROA'</span>,  <span class="co"># 简化标签</span></span>
<span id="cb7-112"><a href="#cb7-112"></a>               color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小字体</span></span>
<span id="cb7-113"><a href="#cb7-113"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color, labelsize<span class="op">=</span><span class="dv">5</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-114"><a href="#cb7-114"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">5</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-115"><a href="#cb7-115"></a>ax1.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># 减小网格透明度</span></span>
<span id="cb7-116"><a href="#cb7-116"></a></span>
<span id="cb7-117"><a href="#cb7-117"></a><span class="co"># 创建第二个坐标轴（共享x轴）</span></span>
<span id="cb7-118"><a href="#cb7-118"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb7-119"><a href="#cb7-119"></a></span>
<span id="cb7-120"><a href="#cb7-120"></a><span class="co"># 绘制Cash均值（右侧坐标轴）</span></span>
<span id="cb7-121"><a href="#cb7-121"></a>color <span class="op">=</span> <span class="st">'#ff7f0e'</span></span>
<span id="cb7-122"><a href="#cb7-122"></a>ax2.plot(df[<span class="st">'时间'</span>], df[<span class="st">'Cash_平均值'</span>], </span>
<span id="cb7-123"><a href="#cb7-123"></a>         label<span class="op">=</span><span class="st">'Cash Ratio'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'现金比率'</span>,  <span class="co"># 简化标签</span></span>
<span id="cb7-124"><a href="#cb7-124"></a>         marker<span class="op">=</span><span class="st">'s'</span>, markersize<span class="op">=</span><span class="dv">3</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>color)  <span class="co"># 减小标记大小和线宽</span></span>
<span id="cb7-125"><a href="#cb7-125"></a>ax2.set_ylabel(<span class="st">'Cash Ratio'</span> <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE <span class="cf">else</span> <span class="st">'现金比率'</span>,  <span class="co"># 简化标签</span></span>
<span id="cb7-126"><a href="#cb7-126"></a>               color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">6</span>)  <span class="co"># 减小字体</span></span>
<span id="cb7-127"><a href="#cb7-127"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color, labelsize<span class="op">=</span><span class="dv">5</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-128"><a href="#cb7-128"></a></span>
<span id="cb7-129"><a href="#cb7-129"></a><span class="co"># 设置标题</span></span>
<span id="cb7-130"><a href="#cb7-130"></a>plt.title(<span class="ss">f'ROA and Cash Ratio Trend'</span>  <span class="co"># 简化标题</span></span>
<span id="cb7-131"><a href="#cb7-131"></a>          <span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE </span>
<span id="cb7-132"><a href="#cb7-132"></a>          <span class="cf">else</span> <span class="ss">f'ROA与现金比率趋势'</span>,  <span class="co"># 简化标题</span></span>
<span id="cb7-133"><a href="#cb7-133"></a>          fontsize<span class="op">=</span><span class="dv">7</span>)  <span class="co"># 减小标题字体</span></span>
<span id="cb7-134"><a href="#cb7-134"></a></span>
<span id="cb7-135"><a href="#cb7-135"></a><span class="co"># 设置x轴刻度</span></span>
<span id="cb7-136"><a href="#cb7-136"></a>ax1.set_xticks(df[<span class="st">'时间'</span>])</span>
<span id="cb7-137"><a href="#cb7-137"></a>ax1.set_xticklabels(df[<span class="st">'时间'</span>], rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">5</span>)  <span class="co"># 减小刻度字体</span></span>
<span id="cb7-138"><a href="#cb7-138"></a></span>
<span id="cb7-139"><a href="#cb7-139"></a><span class="co"># 添加图例（合并两个坐标轴的图例）</span></span>
<span id="cb7-140"><a href="#cb7-140"></a>lines1, labels1 <span class="op">=</span> ax1.get_legend_handles_labels()</span>
<span id="cb7-141"><a href="#cb7-141"></a>lines2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb7-142"><a href="#cb7-142"></a>ax1.legend(lines1 <span class="op">+</span> lines2, labels1 <span class="op">+</span> labels2, fontsize<span class="op">=</span><span class="dv">5</span>, loc<span class="op">=</span><span class="st">'best'</span>)  <span class="co"># 减小图例字体，自动选择最佳位置</span></span>
<span id="cb7-143"><a href="#cb7-143"></a></span>
<span id="cb7-144"><a href="#cb7-144"></a><span class="co"># 格式化y轴标签为百分比</span></span>
<span id="cb7-145"><a href="#cb7-145"></a>ax1.yaxis.set_major_formatter(mticker.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>, decimals<span class="op">=</span><span class="dv">0</span>))  <span class="co"># 简化百分比格式</span></span>
<span id="cb7-146"><a href="#cb7-146"></a>ax2.yaxis.set_major_formatter(mticker.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>, decimals<span class="op">=</span><span class="dv">0</span>))  <span class="co"># 简化百分比格式</span></span>
<span id="cb7-147"><a href="#cb7-147"></a></span>
<span id="cb7-148"><a href="#cb7-148"></a><span class="co"># 美化布局</span></span>
<span id="cb7-149"><a href="#cb7-149"></a>fig.tight_layout(pad<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># 减小内边距</span></span>
<span id="cb7-150"><a href="#cb7-150"></a></span>
<span id="cb7-151"><a href="#cb7-151"></a><span class="co"># 保存图像</span></span>
<span id="cb7-152"><a href="#cb7-152"></a>output_path_b2 <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/ROA_Cash_Trend.png'</span></span>
<span id="cb7-153"><a href="#cb7-153"></a>plt.savefig(output_path_b2, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)  <span class="co"># 裁剪多余空白</span></span>
<span id="cb7-154"><a href="#cb7-154"></a><span class="bu">print</span>(<span class="ss">f"时序图B2已保存至: </span><span class="sc">{</span>output_path_b2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-155"><a href="#cb7-155"></a></span>
<span id="cb7-156"><a href="#cb7-156"></a><span class="co"># 显示图像</span></span>
<span id="cb7-157"><a href="#cb7-157"></a>plt.show()</span>
<span id="cb7-158"><a href="#cb7-158"></a></span>
<span id="cb7-159"><a href="#cb7-159"></a><span class="co"># 可选：输出统计数据用于参考</span></span>
<span id="cb7-160"><a href="#cb7-160"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">关键统计数据："</span>)</span>
<span id="cb7-161"><a href="#cb7-161"></a><span class="bu">print</span>(df[[<span class="st">'时间'</span>, <span class="st">'Lev_平均值'</span>, <span class="st">'Lev_中位数'</span>, <span class="st">'ROA_平均值'</span>, <span class="st">'Cash_平均值'</span>]].<span class="bu">round</span>(<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>使用中文字体: Songti SC
时序图B1已保存至: /Users/wanshiqing/Desktop/Leverage_Trend.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>时序图B2已保存至: /Users/wanshiqing/Desktop/ROA_Cash_Trend.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-5-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
关键统计数据：
      时间  Lev_平均值  Lev_中位数  ROA_平均值  Cash_平均值
0   2000   0.0889   0.0000   0.0069    0.0316
1   2001   0.0977   0.0000   0.0045    0.0364
2   2002   0.1067   0.0000   0.0035    0.0353
3   2003   0.1157   0.0000   0.0045    0.0357
4   2004   0.1277   0.0000   0.0045    0.0371
5   2005   0.1329   0.0000   0.0021    0.0325
6   2006   0.1423   0.0000   0.0062    0.0356
7   2007   0.1489   0.0000   0.0121    0.0420
8   2008   0.1523   0.0000   0.0075    0.0431
9   2009   0.1611   0.0000   0.0112    0.0587
10  2010   0.1757   0.0000   0.0184    0.0844
11  2011   0.1860   0.0000   0.0190    0.0907
12  2012   0.1952   0.0000   0.0168    0.0878
13  2013   0.2032   0.0000   0.0168    0.0763
14  2014   0.2157   0.0000   0.0175    0.0730
15  2015   0.2309   0.1214   0.0181    0.0840
16  2016   0.2475   0.1859   0.0245    0.0963
17  2017   0.2741   0.2383   0.0297    0.1021
18  2018   0.2934   0.2728   0.0219    0.0953
19  2019   0.3085   0.2933   0.0229    0.1029
20  2020   0.3346   0.3254   0.0274    0.1320
21  2021   0.3658   0.3599   0.0318    0.1422
22  2022   0.3779   0.3673   0.0249    0.1571
23  2023   0.3853   0.3728   0.0206    0.1610
24  2024   0.3961   0.3861   0.0139    0.1445</code></pre>
</div>
</div>
<div id="47b65593" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="im">import</span> matplotlib.font_manager <span class="im">as</span> fm</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="im">import</span> os</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># 设置中文字体（适用于Mac系统）</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="cf">try</span>:</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="co"># 尝试查找 macOS 系统自带的中文字体</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    font_names <span class="op">=</span> [<span class="st">'Songti SC'</span>, <span class="st">'STHeiti'</span>, <span class="st">'PingFang SC'</span>, <span class="st">'Hiragino Sans GB'</span>, <span class="st">'Arial Unicode MS'</span>]</span>
<span id="cb11-12"><a href="#cb11-12"></a>    available_fonts <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> fm.fontManager.ttflist]</span>
<span id="cb11-13"><a href="#cb11-13"></a>    </span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="co"># 寻找可用的中文字体</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>    chinese_font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="cf">for</span> font <span class="kw">in</span> font_names:</span>
<span id="cb11-17"><a href="#cb11-17"></a>        <span class="cf">if</span> font <span class="kw">in</span> available_fonts:</span>
<span id="cb11-18"><a href="#cb11-18"></a>            chinese_font <span class="op">=</span> font</span>
<span id="cb11-19"><a href="#cb11-19"></a>            <span class="cf">break</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>    </span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="co"># 如果找到可用字体，设置matplotlib使用它</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>    <span class="cf">if</span> chinese_font:</span>
<span id="cb11-23"><a href="#cb11-23"></a>        plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [chinese_font]</span>
<span id="cb11-24"><a href="#cb11-24"></a>        <span class="bu">print</span>(<span class="ss">f"使用中文字体: </span><span class="sc">{</span>chinese_font<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-25"><a href="#cb11-25"></a>    <span class="cf">else</span>:</span>
<span id="cb11-26"><a href="#cb11-26"></a>        <span class="bu">print</span>(<span class="st">"未找到系统自带中文字体，使用英文标签"</span>)</span>
<span id="cb11-27"><a href="#cb11-27"></a>        USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>    plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># 用来正常显示负号</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="cf">except</span>:</span>
<span id="cb11-30"><a href="#cb11-30"></a>    <span class="bu">print</span>(<span class="st">"字体设置失败，使用英文标签"</span>)</span>
<span id="cb11-31"><a href="#cb11-31"></a>    USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-32"><a href="#cb11-32"></a></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co"># 读取数据</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb11-35"><a href="#cb11-35"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb11-36"><a href="#cb11-36"></a></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co"># 新增并计算Lev字段（总负债率 = 负债合计 / 资产总计）</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co"># 确保字段存在并处理分母为零的情况</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="cf">if</span> <span class="st">'负债合计'</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">'资产总计'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-40"><a href="#cb11-40"></a>    <span class="co"># 安全除法，避免分母为零</span></span>
<span id="cb11-41"><a href="#cb11-41"></a>    df[<span class="st">'Lev'</span>] <span class="op">=</span> np.where(df[<span class="st">'资产总计'</span>] <span class="op">!=</span> <span class="dv">0</span>, </span>
<span id="cb11-42"><a href="#cb11-42"></a>                       df[<span class="st">'负债合计'</span>] <span class="op">/</span> df[<span class="st">'资产总计'</span>], </span>
<span id="cb11-43"><a href="#cb11-43"></a>                       np.nan)</span>
<span id="cb11-44"><a href="#cb11-44"></a>    <span class="bu">print</span>(<span class="st">"Lev字段计算完成"</span>)</span>
<span id="cb11-45"><a href="#cb11-45"></a><span class="cf">else</span>:</span>
<span id="cb11-46"><a href="#cb11-46"></a>    <span class="co"># 如果字段不存在，尝试可能的变体</span></span>
<span id="cb11-47"><a href="#cb11-47"></a>    possible_debt <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'负债合计'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'负债'</span> <span class="kw">in</span> col]</span>
<span id="cb11-48"><a href="#cb11-48"></a>    possible_assets <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'资产总计'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'资产'</span> <span class="kw">in</span> col]</span>
<span id="cb11-49"><a href="#cb11-49"></a>    </span>
<span id="cb11-50"><a href="#cb11-50"></a>    <span class="cf">if</span> possible_debt <span class="kw">and</span> possible_assets:</span>
<span id="cb11-51"><a href="#cb11-51"></a>        debt_col <span class="op">=</span> possible_debt[<span class="dv">0</span>]</span>
<span id="cb11-52"><a href="#cb11-52"></a>        assets_col <span class="op">=</span> possible_assets[<span class="dv">0</span>]</span>
<span id="cb11-53"><a href="#cb11-53"></a>        df[<span class="st">'Lev'</span>] <span class="op">=</span> np.where(df[assets_col] <span class="op">!=</span> <span class="dv">0</span>, </span>
<span id="cb11-54"><a href="#cb11-54"></a>                           df[debt_col] <span class="op">/</span> df[assets_col], </span>
<span id="cb11-55"><a href="#cb11-55"></a>                           np.nan)</span>
<span id="cb11-56"><a href="#cb11-56"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段计算Lev: </span><span class="sc">{</span>debt_col<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>assets_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-57"><a href="#cb11-57"></a>    <span class="cf">else</span>:</span>
<span id="cb11-58"><a href="#cb11-58"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到计算Lev所需的字段（负债合计和资产总计）"</span>)</span>
<span id="cb11-59"><a href="#cb11-59"></a></span>
<span id="cb11-60"><a href="#cb11-60"></a><span class="co"># 1. 创建行业映射</span></span>
<span id="cb11-61"><a href="#cb11-61"></a>industry_mapping <span class="op">=</span> {</span>
<span id="cb11-62"><a href="#cb11-62"></a>    <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb11-63"><a href="#cb11-63"></a>    <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb11-64"><a href="#cb11-64"></a>    <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb11-65"><a href="#cb11-65"></a>    <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb11-66"><a href="#cb11-66"></a>    <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb11-67"><a href="#cb11-67"></a>    <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb11-68"><a href="#cb11-68"></a>    <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb11-69"><a href="#cb11-69"></a>}</span>
<span id="cb11-70"><a href="#cb11-70"></a></span>
<span id="cb11-71"><a href="#cb11-71"></a><span class="co"># 提取行业代码的首字母</span></span>
<span id="cb11-72"><a href="#cb11-72"></a><span class="cf">if</span> <span class="st">'行业代码'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-73"><a href="#cb11-73"></a>    df[<span class="st">'行业代码'</span>] <span class="op">=</span> df[<span class="st">'行业代码'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb11-74"><a href="#cb11-74"></a>    df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[<span class="st">'行业代码'</span>].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb11-75"><a href="#cb11-75"></a><span class="cf">else</span>:</span>
<span id="cb11-76"><a href="#cb11-76"></a>    <span class="co"># 如果行业代码字段不存在，尝试可能的变体</span></span>
<span id="cb11-77"><a href="#cb11-77"></a>    possible_industry <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'行业'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'industry'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb11-78"><a href="#cb11-78"></a>    <span class="cf">if</span> possible_industry:</span>
<span id="cb11-79"><a href="#cb11-79"></a>        industry_col <span class="op">=</span> possible_industry[<span class="dv">0</span>]</span>
<span id="cb11-80"><a href="#cb11-80"></a>        df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>).<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb11-81"><a href="#cb11-81"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为行业代码: </span><span class="sc">{</span>industry_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-82"><a href="#cb11-82"></a>    <span class="cf">else</span>:</span>
<span id="cb11-83"><a href="#cb11-83"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到行业代码字段"</span>)</span>
<span id="cb11-84"><a href="#cb11-84"></a></span>
<span id="cb11-85"><a href="#cb11-85"></a><span class="co"># 创建行业字段</span></span>
<span id="cb11-86"><a href="#cb11-86"></a>df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业首字母'</span>].<span class="bu">map</span>(industry_mapping)</span>
<span id="cb11-87"><a href="#cb11-87"></a></span>
<span id="cb11-88"><a href="#cb11-88"></a><span class="co"># 处理无法映射的行业</span></span>
<span id="cb11-89"><a href="#cb11-89"></a>unknown_industry <span class="op">=</span> df[df[<span class="st">'行业'</span>].isna()][<span class="st">'行业首字母'</span>].unique()</span>
<span id="cb11-90"><a href="#cb11-90"></a><span class="cf">if</span> <span class="bu">len</span>(unknown_industry) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-91"><a href="#cb11-91"></a>    <span class="bu">print</span>(<span class="ss">f"发现无法映射的行业代码: </span><span class="sc">{</span>unknown_industry<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-92"><a href="#cb11-92"></a>    df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业'</span>].fillna(<span class="st">'其他行业'</span>)</span>
<span id="cb11-93"><a href="#cb11-93"></a></span>
<span id="cb11-94"><a href="#cb11-94"></a><span class="co"># 2. 按'时间'和'行业'分组</span></span>
<span id="cb11-95"><a href="#cb11-95"></a><span class="co"># 3. 计算各行业各时间的总负债率(Lev)均值</span></span>
<span id="cb11-96"><a href="#cb11-96"></a><span class="co"># 确保时间字段存在</span></span>
<span id="cb11-97"><a href="#cb11-97"></a><span class="cf">if</span> <span class="st">'时间'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-98"><a href="#cb11-98"></a>    <span class="co"># 尝试可能的变体</span></span>
<span id="cb11-99"><a href="#cb11-99"></a>    possible_time <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'时间'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'year'</span> <span class="kw">in</span> col.lower() <span class="kw">or</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb11-100"><a href="#cb11-100"></a>    <span class="cf">if</span> possible_time:</span>
<span id="cb11-101"><a href="#cb11-101"></a>        time_col <span class="op">=</span> possible_time[<span class="dv">0</span>]</span>
<span id="cb11-102"><a href="#cb11-102"></a>        df.rename(columns<span class="op">=</span>{time_col: <span class="st">'时间'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-103"><a href="#cb11-103"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为时间: </span><span class="sc">{</span>time_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-104"><a href="#cb11-104"></a>    <span class="cf">else</span>:</span>
<span id="cb11-105"><a href="#cb11-105"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到时间字段"</span>)</span>
<span id="cb11-106"><a href="#cb11-106"></a></span>
<span id="cb11-107"><a href="#cb11-107"></a><span class="co"># 筛选2000年及以后的数据</span></span>
<span id="cb11-108"><a href="#cb11-108"></a>df <span class="op">=</span> df[df[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb11-109"><a href="#cb11-109"></a></span>
<span id="cb11-110"><a href="#cb11-110"></a><span class="co"># 按时间和行业分组计算Lev均值</span></span>
<span id="cb11-111"><a href="#cb11-111"></a>industry_lev <span class="op">=</span> df.groupby([<span class="st">'时间'</span>, <span class="st">'行业'</span>])[<span class="st">'Lev'</span>].mean().reset_index()</span>
<span id="cb11-112"><a href="#cb11-112"></a></span>
<span id="cb11-113"><a href="#cb11-113"></a><span class="co"># 按时间排序</span></span>
<span id="cb11-114"><a href="#cb11-114"></a>industry_lev <span class="op">=</span> industry_lev.sort_values([<span class="st">'时间'</span>, <span class="st">'行业'</span>])</span>
<span id="cb11-115"><a href="#cb11-115"></a></span>
<span id="cb11-116"><a href="#cb11-116"></a><span class="co"># 4. 绘制行业总负债率时序图</span></span>
<span id="cb11-117"><a href="#cb11-117"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb11-118"><a href="#cb11-118"></a></span>
<span id="cb11-119"><a href="#cb11-119"></a><span class="co"># 获取行业列表并排序</span></span>
<span id="cb11-120"><a href="#cb11-120"></a>industries <span class="op">=</span> industry_lev[<span class="st">'行业'</span>].unique()</span>
<span id="cb11-121"><a href="#cb11-121"></a>sorted_industries <span class="op">=</span> <span class="bu">sorted</span>(industries, key<span class="op">=</span><span class="kw">lambda</span> x: industry_lev[industry_lev[<span class="st">'行业'</span>] <span class="op">==</span> x][<span class="st">'Lev'</span>].mean(), reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-122"><a href="#cb11-122"></a></span>
<span id="cb11-123"><a href="#cb11-123"></a><span class="co"># 设置颜色映射</span></span>
<span id="cb11-124"><a href="#cb11-124"></a>colors <span class="op">=</span> plt.cm.tab10(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(sorted_industries)))</span>
<span id="cb11-125"><a href="#cb11-125"></a></span>
<span id="cb11-126"><a href="#cb11-126"></a><span class="co"># 绘制各行业折线</span></span>
<span id="cb11-127"><a href="#cb11-127"></a><span class="cf">for</span> i, industry <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_industries):</span>
<span id="cb11-128"><a href="#cb11-128"></a>    industry_data <span class="op">=</span> industry_lev[industry_lev[<span class="st">'行业'</span>] <span class="op">==</span> industry]</span>
<span id="cb11-129"><a href="#cb11-129"></a>    plt.plot(industry_data[<span class="st">'时间'</span>], industry_data[<span class="st">'Lev'</span>], </span>
<span id="cb11-130"><a href="#cb11-130"></a>             label<span class="op">=</span>industry, marker<span class="op">=</span><span class="st">'o'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span>colors[i])</span>
<span id="cb11-131"><a href="#cb11-131"></a></span>
<span id="cb11-132"><a href="#cb11-132"></a><span class="co"># 设置标题和标签</span></span>
<span id="cb11-133"><a href="#cb11-133"></a><span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb11-134"><a href="#cb11-134"></a>    plt.title(<span class="st">'Industry Leverage Ratio Trends (2000-</span><span class="sc">{}</span><span class="st">)'</span>.<span class="bu">format</span>(industry_lev[<span class="st">'时间'</span>].<span class="bu">max</span>()), fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-135"><a href="#cb11-135"></a>    plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-136"><a href="#cb11-136"></a>    plt.ylabel(<span class="st">'Leverage Ratio (Lev)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-137"><a href="#cb11-137"></a><span class="cf">else</span>:</span>
<span id="cb11-138"><a href="#cb11-138"></a>    plt.title(<span class="st">'各行业总负债率(Lev)变化趋势 (2000-</span><span class="sc">{}</span><span class="st">)'</span>.<span class="bu">format</span>(industry_lev[<span class="st">'时间'</span>].<span class="bu">max</span>()), fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-139"><a href="#cb11-139"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-140"><a href="#cb11-140"></a>    plt.ylabel(<span class="st">'总负债率(Lev)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-141"><a href="#cb11-141"></a></span>
<span id="cb11-142"><a href="#cb11-142"></a><span class="co"># 设置网格</span></span>
<span id="cb11-143"><a href="#cb11-143"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb11-144"><a href="#cb11-144"></a></span>
<span id="cb11-145"><a href="#cb11-145"></a><span class="co"># 添加图例</span></span>
<span id="cb11-146"><a href="#cb11-146"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">10</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb11-147"><a href="#cb11-147"></a></span>
<span id="cb11-148"><a href="#cb11-148"></a><span class="co"># 设置y轴为百分比格式</span></span>
<span id="cb11-149"><a href="#cb11-149"></a>plt.gca().yaxis.set_major_formatter(mticker.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>))</span>
<span id="cb11-150"><a href="#cb11-150"></a></span>
<span id="cb11-151"><a href="#cb11-151"></a><span class="co"># 调整布局</span></span>
<span id="cb11-152"><a href="#cb11-152"></a>plt.tight_layout()</span>
<span id="cb11-153"><a href="#cb11-153"></a></span>
<span id="cb11-154"><a href="#cb11-154"></a><span class="co"># 保存图像</span></span>
<span id="cb11-155"><a href="#cb11-155"></a>output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/Industry_Lev_Trends.png'</span></span>
<span id="cb11-156"><a href="#cb11-156"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb11-157"><a href="#cb11-157"></a><span class="bu">print</span>(<span class="ss">f"行业总负债率时序图已保存至: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-158"><a href="#cb11-158"></a></span>
<span id="cb11-159"><a href="#cb11-159"></a><span class="co"># 显示图像</span></span>
<span id="cb11-160"><a href="#cb11-160"></a>plt.show()</span>
<span id="cb11-161"><a href="#cb11-161"></a></span>
<span id="cb11-162"><a href="#cb11-162"></a><span class="co"># 可选：输出各行业平均负债率</span></span>
<span id="cb11-163"><a href="#cb11-163"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">各行业平均总负债率:"</span>)</span>
<span id="cb11-164"><a href="#cb11-164"></a>industry_avg <span class="op">=</span> industry_lev.groupby(<span class="st">'行业'</span>)[<span class="st">'Lev'</span>].mean().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-165"><a href="#cb11-165"></a><span class="bu">print</span>(industry_avg.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.2%}</span><span class="ss">"</span>))</span>
<span id="cb11-166"><a href="#cb11-166"></a></span>
<span id="cb11-167"><a href="#cb11-167"></a><span class="co"># 可选：绘制小尺寸图表（用于论文）</span></span>
<span id="cb11-168"><a href="#cb11-168"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.5</span>))</span>
<span id="cb11-169"><a href="#cb11-169"></a></span>
<span id="cb11-170"><a href="#cb11-170"></a><span class="co"># 绘制各行业折线（更细线条）</span></span>
<span id="cb11-171"><a href="#cb11-171"></a><span class="cf">for</span> i, industry <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_industries):</span>
<span id="cb11-172"><a href="#cb11-172"></a>    industry_data <span class="op">=</span> industry_lev[industry_lev[<span class="st">'行业'</span>] <span class="op">==</span> industry]</span>
<span id="cb11-173"><a href="#cb11-173"></a>    plt.plot(industry_data[<span class="st">'时间'</span>], industry_data[<span class="st">'Lev'</span>], </span>
<span id="cb11-174"><a href="#cb11-174"></a>             label<span class="op">=</span>industry, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">3</span>, linewidth<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>colors[i])</span>
<span id="cb11-175"><a href="#cb11-175"></a></span>
<span id="cb11-176"><a href="#cb11-176"></a><span class="co"># 设置标题和标签（更小字体）</span></span>
<span id="cb11-177"><a href="#cb11-177"></a><span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb11-178"><a href="#cb11-178"></a>    plt.title(<span class="st">'Industry Leverage Ratio Trends'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-179"><a href="#cb11-179"></a>    plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb11-180"><a href="#cb11-180"></a>    plt.ylabel(<span class="st">'Leverage Ratio'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb11-181"><a href="#cb11-181"></a><span class="cf">else</span>:</span>
<span id="cb11-182"><a href="#cb11-182"></a>    plt.title(<span class="st">'各行业总负债率变化趋势'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-183"><a href="#cb11-183"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb11-184"><a href="#cb11-184"></a>    plt.ylabel(<span class="st">'总负债率'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb11-185"><a href="#cb11-185"></a></span>
<span id="cb11-186"><a href="#cb11-186"></a><span class="co"># 设置网格</span></span>
<span id="cb11-187"><a href="#cb11-187"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb11-188"><a href="#cb11-188"></a></span>
<span id="cb11-189"><a href="#cb11-189"></a><span class="co"># 添加图例（更小字体）</span></span>
<span id="cb11-190"><a href="#cb11-190"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">8</span>, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb11-191"><a href="#cb11-191"></a></span>
<span id="cb11-192"><a href="#cb11-192"></a><span class="co"># 设置y轴为百分比格式</span></span>
<span id="cb11-193"><a href="#cb11-193"></a>plt.gca().yaxis.set_major_formatter(mticker.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>))</span>
<span id="cb11-194"><a href="#cb11-194"></a></span>
<span id="cb11-195"><a href="#cb11-195"></a><span class="co"># 设置刻度字体</span></span>
<span id="cb11-196"><a href="#cb11-196"></a>plt.xticks(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb11-197"><a href="#cb11-197"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb11-198"><a href="#cb11-198"></a></span>
<span id="cb11-199"><a href="#cb11-199"></a><span class="co"># 调整布局</span></span>
<span id="cb11-200"><a href="#cb11-200"></a>plt.tight_layout()</span>
<span id="cb11-201"><a href="#cb11-201"></a></span>
<span id="cb11-202"><a href="#cb11-202"></a><span class="co"># 保存小尺寸图像</span></span>
<span id="cb11-203"><a href="#cb11-203"></a>small_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/Industry_Lev_Trends_small.png'</span></span>
<span id="cb11-204"><a href="#cb11-204"></a>plt.savefig(small_output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb11-205"><a href="#cb11-205"></a><span class="bu">print</span>(<span class="ss">f"小尺寸行业总负债率时序图已保存至: </span><span class="sc">{</span>small_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-206"><a href="#cb11-206"></a></span>
<span id="cb11-207"><a href="#cb11-207"></a><span class="co"># 显示图像</span></span>
<span id="cb11-208"><a href="#cb11-208"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>使用中文字体: Songti SC
Lev字段计算完成
发现无法映射的行业代码: ['I' 'M' 'n' 'N' 'H' 'S' 'L' 'A' 'Q' 'R' 'B' 'P' 'O']
行业总负债率时序图已保存至: /Users/wanshiqing/Desktop/Industry_Lev_Trends.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
各行业平均总负债率:
行业
金融业                 73.06%
交通运输业               69.84%
建筑业                 66.57%
其他行业                57.21%
房地产业                53.43%
电力、热力、燃气及水生产和供应业    52.61%
制造业                 51.64%
批发和零售业              48.92%
Name: Lev, dtype: object
小尺寸行业总负债率时序图已保存至: /Users/wanshiqing/Desktop/Industry_Lev_Trends_small.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-6-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="261f920a" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="im">import</span> matplotlib.font_manager <span class="im">as</span> fm</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="im">import</span> os</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co"># 设置中文字体（适用于Mac系统）</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="cf">try</span>:</span>
<span id="cb14-10"><a href="#cb14-10"></a>    <span class="co"># 尝试查找 macOS 系统自带的中文字体</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>    font_names <span class="op">=</span> [<span class="st">'Songti SC'</span>, <span class="st">'STHeiti'</span>, <span class="st">'PingFang SC'</span>, <span class="st">'Hiragino Sans GB'</span>, <span class="st">'Arial Unicode MS'</span>]</span>
<span id="cb14-12"><a href="#cb14-12"></a>    available_fonts <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> fm.fontManager.ttflist]</span>
<span id="cb14-13"><a href="#cb14-13"></a>    </span>
<span id="cb14-14"><a href="#cb14-14"></a>    <span class="co"># 寻找可用的中文字体</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>    chinese_font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="cf">for</span> font <span class="kw">in</span> font_names:</span>
<span id="cb14-17"><a href="#cb14-17"></a>        <span class="cf">if</span> font <span class="kw">in</span> available_fonts:</span>
<span id="cb14-18"><a href="#cb14-18"></a>            chinese_font <span class="op">=</span> font</span>
<span id="cb14-19"><a href="#cb14-19"></a>            <span class="cf">break</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>    </span>
<span id="cb14-21"><a href="#cb14-21"></a>    <span class="co"># 如果找到可用字体，设置matplotlib使用它</span></span>
<span id="cb14-22"><a href="#cb14-22"></a>    <span class="cf">if</span> chinese_font:</span>
<span id="cb14-23"><a href="#cb14-23"></a>        plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [chinese_font]</span>
<span id="cb14-24"><a href="#cb14-24"></a>        <span class="bu">print</span>(<span class="ss">f"使用中文字体: </span><span class="sc">{</span>chinese_font<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-25"><a href="#cb14-25"></a>    <span class="cf">else</span>:</span>
<span id="cb14-26"><a href="#cb14-26"></a>        <span class="bu">print</span>(<span class="st">"未找到系统自带中文字体，使用英文标签"</span>)</span>
<span id="cb14-27"><a href="#cb14-27"></a>        USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-28"><a href="#cb14-28"></a>    plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># 用来正常显示负号</span></span>
<span id="cb14-29"><a href="#cb14-29"></a><span class="cf">except</span>:</span>
<span id="cb14-30"><a href="#cb14-30"></a>    <span class="bu">print</span>(<span class="st">"字体设置失败，使用英文标签"</span>)</span>
<span id="cb14-31"><a href="#cb14-31"></a>    USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-32"><a href="#cb14-32"></a></span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="co"># 1. 读取文件</span></span>
<span id="cb14-34"><a href="#cb14-34"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb14-35"><a href="#cb14-35"></a><span class="bu">print</span>(<span class="ss">f"正在读取文件: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-36"><a href="#cb14-36"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb14-37"><a href="#cb14-37"></a><span class="bu">print</span>(<span class="ss">f"数据读取成功! 共 </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> 行记录"</span>)</span>
<span id="cb14-38"><a href="#cb14-38"></a></span>
<span id="cb14-39"><a href="#cb14-39"></a><span class="co"># 2. 计算Lev = 总负债率 = 负债合计/资产总计</span></span>
<span id="cb14-40"><a href="#cb14-40"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算总负债率(Lev)..."</span>)</span>
<span id="cb14-41"><a href="#cb14-41"></a><span class="cf">if</span> <span class="st">'负债合计'</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">'资产总计'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb14-42"><a href="#cb14-42"></a>    <span class="co"># 安全除法，避免分母为零</span></span>
<span id="cb14-43"><a href="#cb14-43"></a>    df[<span class="st">'Lev'</span>] <span class="op">=</span> np.where(df[<span class="st">'资产总计'</span>] <span class="op">!=</span> <span class="dv">0</span>, </span>
<span id="cb14-44"><a href="#cb14-44"></a>                       df[<span class="st">'负债合计'</span>] <span class="op">/</span> df[<span class="st">'资产总计'</span>], </span>
<span id="cb14-45"><a href="#cb14-45"></a>                       np.nan)</span>
<span id="cb14-46"><a href="#cb14-46"></a>    <span class="bu">print</span>(<span class="st">"Lev字段计算完成"</span>)</span>
<span id="cb14-47"><a href="#cb14-47"></a><span class="cf">else</span>:</span>
<span id="cb14-48"><a href="#cb14-48"></a>    <span class="co"># 如果字段不存在，尝试可能的变体</span></span>
<span id="cb14-49"><a href="#cb14-49"></a>    possible_debt <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'负债合计'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'负债'</span> <span class="kw">in</span> col]</span>
<span id="cb14-50"><a href="#cb14-50"></a>    possible_assets <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'资产总计'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'资产'</span> <span class="kw">in</span> col]</span>
<span id="cb14-51"><a href="#cb14-51"></a>    </span>
<span id="cb14-52"><a href="#cb14-52"></a>    <span class="cf">if</span> possible_debt <span class="kw">and</span> possible_assets:</span>
<span id="cb14-53"><a href="#cb14-53"></a>        debt_col <span class="op">=</span> possible_debt[<span class="dv">0</span>]</span>
<span id="cb14-54"><a href="#cb14-54"></a>        assets_col <span class="op">=</span> possible_assets[<span class="dv">0</span>]</span>
<span id="cb14-55"><a href="#cb14-55"></a>        df[<span class="st">'Lev'</span>] <span class="op">=</span> np.where(df[assets_col] <span class="op">!=</span> <span class="dv">0</span>, </span>
<span id="cb14-56"><a href="#cb14-56"></a>                           df[debt_col] <span class="op">/</span> df[assets_col], </span>
<span id="cb14-57"><a href="#cb14-57"></a>                           np.nan)</span>
<span id="cb14-58"><a href="#cb14-58"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段计算Lev: </span><span class="sc">{</span>debt_col<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>assets_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-59"><a href="#cb14-59"></a>    <span class="cf">else</span>:</span>
<span id="cb14-60"><a href="#cb14-60"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到计算Lev所需的字段（负债合计和资产总计）"</span>)</span>
<span id="cb14-61"><a href="#cb14-61"></a></span>
<span id="cb14-62"><a href="#cb14-62"></a><span class="co"># 3. 创建行业映射</span></span>
<span id="cb14-63"><a href="#cb14-63"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">创建行业字段..."</span>)</span>
<span id="cb14-64"><a href="#cb14-64"></a>industry_mapping <span class="op">=</span> {</span>
<span id="cb14-65"><a href="#cb14-65"></a>    <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb14-66"><a href="#cb14-66"></a>    <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb14-67"><a href="#cb14-67"></a>    <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb14-68"><a href="#cb14-68"></a>    <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb14-69"><a href="#cb14-69"></a>    <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb14-70"><a href="#cb14-70"></a>    <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb14-71"><a href="#cb14-71"></a>    <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb14-72"><a href="#cb14-72"></a>}</span>
<span id="cb14-73"><a href="#cb14-73"></a></span>
<span id="cb14-74"><a href="#cb14-74"></a><span class="co"># 确保行业代码字段存在</span></span>
<span id="cb14-75"><a href="#cb14-75"></a><span class="cf">if</span> <span class="st">'行业代码'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb14-76"><a href="#cb14-76"></a>    <span class="co"># 尝试查找可能的替代字段</span></span>
<span id="cb14-77"><a href="#cb14-77"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'行业'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'industry'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb14-78"><a href="#cb14-78"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb14-79"><a href="#cb14-79"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为行业代码: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-80"><a href="#cb14-80"></a>        industry_col <span class="op">=</span> possible_cols[<span class="dv">0</span>]</span>
<span id="cb14-81"><a href="#cb14-81"></a>    <span class="cf">else</span>:</span>
<span id="cb14-82"><a href="#cb14-82"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到行业代码字段"</span>)</span>
<span id="cb14-83"><a href="#cb14-83"></a><span class="cf">else</span>:</span>
<span id="cb14-84"><a href="#cb14-84"></a>    industry_col <span class="op">=</span> <span class="st">'行业代码'</span></span>
<span id="cb14-85"><a href="#cb14-85"></a></span>
<span id="cb14-86"><a href="#cb14-86"></a><span class="co"># 将行业代码转换为字符串类型</span></span>
<span id="cb14-87"><a href="#cb14-87"></a>df[industry_col] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb14-88"><a href="#cb14-88"></a></span>
<span id="cb14-89"><a href="#cb14-89"></a><span class="co"># 提取行业代码的首字母</span></span>
<span id="cb14-90"><a href="#cb14-90"></a>df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[industry_col].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb14-91"><a href="#cb14-91"></a></span>
<span id="cb14-92"><a href="#cb14-92"></a><span class="co"># 创建行业字段</span></span>
<span id="cb14-93"><a href="#cb14-93"></a>df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业首字母'</span>].<span class="bu">map</span>(industry_mapping)</span>
<span id="cb14-94"><a href="#cb14-94"></a></span>
<span id="cb14-95"><a href="#cb14-95"></a><span class="co"># 处理无法映射的行业代码</span></span>
<span id="cb14-96"><a href="#cb14-96"></a>unknown_industries <span class="op">=</span> df[df[<span class="st">'行业'</span>].isna()][<span class="st">'行业首字母'</span>].unique()</span>
<span id="cb14-97"><a href="#cb14-97"></a><span class="cf">if</span> <span class="bu">len</span>(unknown_industries) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-98"><a href="#cb14-98"></a>    <span class="bu">print</span>(<span class="ss">f"发现无法映射的行业代码: </span><span class="sc">{</span>unknown_industries<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-99"><a href="#cb14-99"></a>    <span class="co"># 将这些行业归类为"其他行业"</span></span>
<span id="cb14-100"><a href="#cb14-100"></a>    df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业'</span>].fillna(<span class="st">'其他行业'</span>)</span>
<span id="cb14-101"><a href="#cb14-101"></a></span>
<span id="cb14-102"><a href="#cb14-102"></a><span class="co"># 显示行业分布情况</span></span>
<span id="cb14-103"><a href="#cb14-103"></a>industry_counts <span class="op">=</span> df[<span class="st">'行业'</span>].value_counts()</span>
<span id="cb14-104"><a href="#cb14-104"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">行业分布统计:"</span>)</span>
<span id="cb14-105"><a href="#cb14-105"></a><span class="bu">print</span>(industry_counts)</span>
<span id="cb14-106"><a href="#cb14-106"></a></span>
<span id="cb14-107"><a href="#cb14-107"></a><span class="co"># 4. 按行业内每家公司的总资产计算权重</span></span>
<span id="cb14-108"><a href="#cb14-108"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算权重..."</span>)</span>
<span id="cb14-109"><a href="#cb14-109"></a><span class="co"># 先按年份和行业分组，计算每个行业每年的总资产</span></span>
<span id="cb14-110"><a href="#cb14-110"></a>industry_year_assets <span class="op">=</span> df.groupby([<span class="st">'时间'</span>, <span class="st">'行业'</span>])[<span class="st">'资产总计'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb14-111"><a href="#cb14-111"></a>industry_year_assets.rename(columns<span class="op">=</span>{<span class="st">'资产总计'</span>: <span class="st">'行业年总资产'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-112"><a href="#cb14-112"></a></span>
<span id="cb14-113"><a href="#cb14-113"></a><span class="co"># 合并回原始数据框</span></span>
<span id="cb14-114"><a href="#cb14-114"></a>df <span class="op">=</span> pd.merge(df, industry_year_assets, on<span class="op">=</span>[<span class="st">'时间'</span>, <span class="st">'行业'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb14-115"><a href="#cb14-115"></a></span>
<span id="cb14-116"><a href="#cb14-116"></a><span class="co"># 计算权重：公司资产 / 行业年总资产</span></span>
<span id="cb14-117"><a href="#cb14-117"></a>df[<span class="st">'权重'</span>] <span class="op">=</span> df[<span class="st">'资产总计'</span>] <span class="op">/</span> df[<span class="st">'行业年总资产'</span>]</span>
<span id="cb14-118"><a href="#cb14-118"></a></span>
<span id="cb14-119"><a href="#cb14-119"></a><span class="co"># 5. 按'行业'和'时间'分组，计算年加权平均负债率</span></span>
<span id="cb14-120"><a href="#cb14-120"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算年加权平均负债率..."</span>)</span>
<span id="cb14-121"><a href="#cb14-121"></a><span class="co"># 加权平均负债率 = Σ(权重 * Lev)</span></span>
<span id="cb14-122"><a href="#cb14-122"></a>df[<span class="st">'加权负债率'</span>] <span class="op">=</span> df[<span class="st">'权重'</span>] <span class="op">*</span> df[<span class="st">'Lev'</span>]</span>
<span id="cb14-123"><a href="#cb14-123"></a>weighted_lev <span class="op">=</span> df.groupby([<span class="st">'时间'</span>, <span class="st">'行业'</span>])[<span class="st">'加权负债率'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb14-124"><a href="#cb14-124"></a>weighted_lev.rename(columns<span class="op">=</span>{<span class="st">'加权负债率'</span>: <span class="st">'年加权平均负债率'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-125"><a href="#cb14-125"></a></span>
<span id="cb14-126"><a href="#cb14-126"></a><span class="co"># 筛选2000年及以后的数据</span></span>
<span id="cb14-127"><a href="#cb14-127"></a>weighted_lev <span class="op">=</span> weighted_lev[weighted_lev[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb14-128"><a href="#cb14-128"></a></span>
<span id="cb14-129"><a href="#cb14-129"></a><span class="co"># 按时间排序</span></span>
<span id="cb14-130"><a href="#cb14-130"></a>weighted_lev <span class="op">=</span> weighted_lev.sort_values([<span class="st">'时间'</span>, <span class="st">'行业'</span>])</span>
<span id="cb14-131"><a href="#cb14-131"></a></span>
<span id="cb14-132"><a href="#cb14-132"></a><span class="co"># 6. 绘制加权平均负债率时序图</span></span>
<span id="cb14-133"><a href="#cb14-133"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">绘制时序图..."</span>)</span>
<span id="cb14-134"><a href="#cb14-134"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb14-135"><a href="#cb14-135"></a></span>
<span id="cb14-136"><a href="#cb14-136"></a><span class="co"># 获取行业列表并排序</span></span>
<span id="cb14-137"><a href="#cb14-137"></a>industries <span class="op">=</span> weighted_lev[<span class="st">'行业'</span>].unique()</span>
<span id="cb14-138"><a href="#cb14-138"></a>sorted_industries <span class="op">=</span> <span class="bu">sorted</span>(industries, key<span class="op">=</span><span class="kw">lambda</span> x: weighted_lev[weighted_lev[<span class="st">'行业'</span>] <span class="op">==</span> x][<span class="st">'年加权平均负债率'</span>].mean(), </span>
<span id="cb14-139"><a href="#cb14-139"></a>                           reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-140"><a href="#cb14-140"></a></span>
<span id="cb14-141"><a href="#cb14-141"></a><span class="co"># 设置颜色映射</span></span>
<span id="cb14-142"><a href="#cb14-142"></a>colors <span class="op">=</span> plt.cm.tab10(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="bu">len</span>(sorted_industries)))</span>
<span id="cb14-143"><a href="#cb14-143"></a></span>
<span id="cb14-144"><a href="#cb14-144"></a><span class="co"># 绘制各行业折线</span></span>
<span id="cb14-145"><a href="#cb14-145"></a><span class="cf">for</span> i, industry <span class="kw">in</span> <span class="bu">enumerate</span>(sorted_industries):</span>
<span id="cb14-146"><a href="#cb14-146"></a>    industry_data <span class="op">=</span> weighted_lev[weighted_lev[<span class="st">'行业'</span>] <span class="op">==</span> industry]</span>
<span id="cb14-147"><a href="#cb14-147"></a>    plt.plot(industry_data[<span class="st">'时间'</span>], industry_data[<span class="st">'年加权平均负债率'</span>], </span>
<span id="cb14-148"><a href="#cb14-148"></a>             label<span class="op">=</span>industry, marker<span class="op">=</span><span class="st">'o'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span>colors[i])</span>
<span id="cb14-149"><a href="#cb14-149"></a></span>
<span id="cb14-150"><a href="#cb14-150"></a><span class="co"># 设置标题和标签</span></span>
<span id="cb14-151"><a href="#cb14-151"></a><span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb14-152"><a href="#cb14-152"></a>    plt.title(<span class="st">'Industry Weighted Average Leverage Ratio (2000-</span><span class="sc">{}</span><span class="st">)'</span>.<span class="bu">format</span>(weighted_lev[<span class="st">'时间'</span>].<span class="bu">max</span>()), fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-153"><a href="#cb14-153"></a>    plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb14-154"><a href="#cb14-154"></a>    plt.ylabel(<span class="st">'Weighted Average Leverage Ratio'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb14-155"><a href="#cb14-155"></a><span class="cf">else</span>:</span>
<span id="cb14-156"><a href="#cb14-156"></a>    plt.title(<span class="st">'各行业年加权平均负债率变化趋势 (2000-</span><span class="sc">{}</span><span class="st">)'</span>.<span class="bu">format</span>(weighted_lev[<span class="st">'时间'</span>].<span class="bu">max</span>()), fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-157"><a href="#cb14-157"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb14-158"><a href="#cb14-158"></a>    plt.ylabel(<span class="st">'年加权平均负债率'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb14-159"><a href="#cb14-159"></a></span>
<span id="cb14-160"><a href="#cb14-160"></a><span class="co"># 设置网格</span></span>
<span id="cb14-161"><a href="#cb14-161"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-162"><a href="#cb14-162"></a></span>
<span id="cb14-163"><a href="#cb14-163"></a><span class="co"># 添加图例</span></span>
<span id="cb14-164"><a href="#cb14-164"></a>plt.legend(fontsize<span class="op">=</span><span class="dv">12</span>, loc<span class="op">=</span><span class="st">'best'</span>, frameon<span class="op">=</span><span class="va">True</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-165"><a href="#cb14-165"></a></span>
<span id="cb14-166"><a href="#cb14-166"></a><span class="co"># 设置y轴为百分比格式</span></span>
<span id="cb14-167"><a href="#cb14-167"></a>plt.gca().yaxis.set_major_formatter(mticker.PercentFormatter(xmax<span class="op">=</span><span class="fl">1.0</span>))</span>
<span id="cb14-168"><a href="#cb14-168"></a></span>
<span id="cb14-169"><a href="#cb14-169"></a><span class="co"># 设置x轴刻度</span></span>
<span id="cb14-170"><a href="#cb14-170"></a>plt.xticks(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb14-171"><a href="#cb14-171"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb14-172"><a href="#cb14-172"></a></span>
<span id="cb14-173"><a href="#cb14-173"></a><span class="co"># 调整布局</span></span>
<span id="cb14-174"><a href="#cb14-174"></a>plt.tight_layout()</span>
<span id="cb14-175"><a href="#cb14-175"></a></span>
<span id="cb14-176"><a href="#cb14-176"></a><span class="co"># 保存图像</span></span>
<span id="cb14-177"><a href="#cb14-177"></a>output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/Industry_Weighted_Lev_Trends.png'</span></span>
<span id="cb14-178"><a href="#cb14-178"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb14-179"><a href="#cb14-179"></a><span class="bu">print</span>(<span class="ss">f"行业加权平均负债率时序图已保存至: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-180"><a href="#cb14-180"></a></span>
<span id="cb14-181"><a href="#cb14-181"></a><span class="co"># 显示图像</span></span>
<span id="cb14-182"><a href="#cb14-182"></a>plt.show()</span>
<span id="cb14-183"><a href="#cb14-183"></a></span>
<span id="cb14-184"><a href="#cb14-184"></a><span class="co"># 可选：输出各行业平均加权负债率</span></span>
<span id="cb14-185"><a href="#cb14-185"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">各行业平均加权负债率:"</span>)</span>
<span id="cb14-186"><a href="#cb14-186"></a>industry_avg <span class="op">=</span> weighted_lev.groupby(<span class="st">'行业'</span>)[<span class="st">'年加权平均负债率'</span>].mean().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-187"><a href="#cb14-187"></a><span class="bu">print</span>(industry_avg.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.2%}</span><span class="ss">"</span>))</span>
<span id="cb14-188"><a href="#cb14-188"></a></span>
<span id="cb14-189"><a href="#cb14-189"></a><span class="co"># 可选：保存加权平均结果</span></span>
<span id="cb14-190"><a href="#cb14-190"></a>output_csv_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/weighted_industry_lev.csv'</span></span>
<span id="cb14-191"><a href="#cb14-191"></a>weighted_lev.to_csv(output_csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-192"><a href="#cb14-192"></a><span class="bu">print</span>(<span class="ss">f"加权平均负债率数据已保存至: </span><span class="sc">{</span>output_csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-193"><a href="#cb14-193"></a></span>
<span id="cb14-194"><a href="#cb14-194"></a><span class="co"># 保存处理后的数据</span></span>
<span id="cb14-195"><a href="#cb14-195"></a>output_excel_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/processed_data.xlsx'</span></span>
<span id="cb14-196"><a href="#cb14-196"></a>df.to_excel(output_excel_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-197"><a href="#cb14-197"></a><span class="bu">print</span>(<span class="ss">f"处理后的完整数据已保存至: </span><span class="sc">{</span>output_excel_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-198"><a href="#cb14-198"></a></span>
<span id="cb14-199"><a href="#cb14-199"></a><span class="co"># 完成</span></span>
<span id="cb14-200"><a href="#cb14-200"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">第六步处理完成!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>使用中文字体: Songti SC
正在读取文件: /Users/wanshiqing/Desktop/python_code/merged_data.xlsx
数据读取成功! 共 145874 行记录

计算总负债率(Lev)...
Lev字段计算完成

创建行业字段...
发现无法映射的行业代码: ['I' 'M' 'n' 'N' 'H' 'S' 'L' 'A' 'Q' 'R' 'B' 'P' 'O']

行业分布统计:
行业
其他行业                92759
制造业                 40346
批发和零售业               2770
交通运输业                2447
房地产业                 2065
金融业                  2027
电力、热力、燃气及水生产和供应业     2004
建筑业                  1456
Name: count, dtype: int64

计算权重...

计算年加权平均负债率...

绘制时序图...
行业加权平均负债率时序图已保存至: /Users/wanshiqing/Desktop/Industry_Weighted_Lev_Trends.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
各行业平均加权负债率:
行业
金融业                 76.42%
建筑业                 73.70%
其他行业                65.89%
房地产业                62.75%
电力、热力、燃气及水生产和供应业    59.95%
批发和零售业              58.89%
制造业                 52.94%
交通运输业               52.62%
Name: 年加权平均负债率, dtype: object
加权平均负债率数据已保存至: /Users/wanshiqing/Desktop/weighted_industry_lev.csv
处理后的完整数据已保存至: /Users/wanshiqing/Desktop/processed_data.xlsx

第六步处理完成!</code></pre>
</div>
</div>
<div id="5ce77adb" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="co"># 1. 读取文件</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="bu">print</span>(<span class="ss">f"正在读取文件: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-8"><a href="#cb17-8"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="bu">print</span>(<span class="ss">f"数据读取成功! 共 </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> 行记录"</span>)</span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="bu">print</span>(<span class="ss">f"原始字段: </span><span class="sc">{</span>df<span class="sc">.</span>columns<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-11"><a href="#cb17-11"></a></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co"># 2. 计算并新增字段</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算并新增财务指标字段..."</span>)</span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="kw">def</span> safe_divide(numerator, denominator):</span>
<span id="cb17-15"><a href="#cb17-15"></a>    <span class="co">"""安全除法函数，处理分母为零的情况"""</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>    <span class="cf">return</span> np.where(denominator <span class="op">!=</span> <span class="dv">0</span>, numerator <span class="op">/</span> denominator, np.nan)</span>
<span id="cb17-17"><a href="#cb17-17"></a></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="co"># 确保所需字段存在</span></span>
<span id="cb17-19"><a href="#cb17-19"></a>required_fields <span class="op">=</span> [<span class="st">'短期借款'</span>, <span class="st">'长期借款'</span>, <span class="st">'负债合计'</span>, <span class="st">'资产总计'</span>, <span class="st">'期末现金及现金等价物余额'</span>, </span>
<span id="cb17-20"><a href="#cb17-20"></a>                  <span class="st">'净利润'</span>, <span class="st">'所有者权益合计'</span>]</span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="cf">for</span> field <span class="kw">in</span> required_fields:</span>
<span id="cb17-22"><a href="#cb17-22"></a>    <span class="cf">if</span> field <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb17-23"><a href="#cb17-23"></a>        <span class="bu">print</span>(<span class="ss">f"警告: 字段 '</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">' 不存在，尝试查找替代字段..."</span>)</span>
<span id="cb17-24"><a href="#cb17-24"></a>        <span class="co"># 尝试查找可能的替代字段</span></span>
<span id="cb17-25"><a href="#cb17-25"></a>        possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> field <span class="kw">in</span> col <span class="kw">or</span> field.lower() <span class="kw">in</span> col.lower()]</span>
<span id="cb17-26"><a href="#cb17-26"></a>        <span class="cf">if</span> possible_cols:</span>
<span id="cb17-27"><a href="#cb17-27"></a>            df.rename(columns<span class="op">=</span>{possible_cols[<span class="dv">0</span>]: field}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-28"><a href="#cb17-28"></a>            <span class="bu">print</span>(<span class="ss">f"  使用替代字段: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> 作为 </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-29"><a href="#cb17-29"></a>        <span class="cf">else</span>:</span>
<span id="cb17-30"><a href="#cb17-30"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"无法找到必需的字段: </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-31"><a href="#cb17-31"></a></span>
<span id="cb17-32"><a href="#cb17-32"></a><span class="co"># 计算新增字段</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>df[<span class="st">'SLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'短期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb17-34"><a href="#cb17-34"></a>df[<span class="st">'LLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'长期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb17-35"><a href="#cb17-35"></a>df[<span class="st">'Lev'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'负债合计'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb17-36"><a href="#cb17-36"></a>df[<span class="st">'Cash'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'期末现金及现金等价物余额'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb17-37"><a href="#cb17-37"></a>df[<span class="st">'ROA'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb17-38"><a href="#cb17-38"></a>df[<span class="st">'ROE'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'所有者权益合计'</span>])</span>
<span id="cb17-39"><a href="#cb17-39"></a></span>
<span id="cb17-40"><a href="#cb17-40"></a><span class="co"># 检查计算结果</span></span>
<span id="cb17-41"><a href="#cb17-41"></a><span class="bu">print</span>(<span class="st">"新增字段计算完成:"</span>)</span>
<span id="cb17-42"><a href="#cb17-42"></a><span class="bu">print</span>(<span class="ss">f"  SLoan: </span><span class="sc">{</span>df[<span class="st">'SLoan'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-43"><a href="#cb17-43"></a><span class="bu">print</span>(<span class="ss">f"  LLoan: </span><span class="sc">{</span>df[<span class="st">'LLoan'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-44"><a href="#cb17-44"></a><span class="bu">print</span>(<span class="ss">f"  Lev: </span><span class="sc">{</span>df[<span class="st">'Lev'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-45"><a href="#cb17-45"></a><span class="bu">print</span>(<span class="ss">f"  Cash: </span><span class="sc">{</span>df[<span class="st">'Cash'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-46"><a href="#cb17-46"></a><span class="bu">print</span>(<span class="ss">f"  ROA: </span><span class="sc">{</span>df[<span class="st">'ROA'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-47"><a href="#cb17-47"></a><span class="bu">print</span>(<span class="ss">f"  ROE: </span><span class="sc">{</span>df[<span class="st">'ROE'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> 个有效值"</span>)</span>
<span id="cb17-48"><a href="#cb17-48"></a></span>
<span id="cb17-49"><a href="#cb17-49"></a><span class="co"># 3. 创建行业字段</span></span>
<span id="cb17-50"><a href="#cb17-50"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">创建行业字段..."</span>)</span>
<span id="cb17-51"><a href="#cb17-51"></a>industry_mapping <span class="op">=</span> {</span>
<span id="cb17-52"><a href="#cb17-52"></a>    <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb17-53"><a href="#cb17-53"></a>    <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb17-54"><a href="#cb17-54"></a>    <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb17-55"><a href="#cb17-55"></a>    <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb17-56"><a href="#cb17-56"></a>    <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb17-57"><a href="#cb17-57"></a>    <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb17-58"><a href="#cb17-58"></a>    <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb17-59"><a href="#cb17-59"></a>}</span>
<span id="cb17-60"><a href="#cb17-60"></a></span>
<span id="cb17-61"><a href="#cb17-61"></a><span class="co"># 确保行业代码字段存在</span></span>
<span id="cb17-62"><a href="#cb17-62"></a><span class="cf">if</span> <span class="st">'行业代码'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb17-63"><a href="#cb17-63"></a>    <span class="co"># 尝试查找可能的替代字段</span></span>
<span id="cb17-64"><a href="#cb17-64"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'行业'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'industry'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb17-65"><a href="#cb17-65"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb17-66"><a href="#cb17-66"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为行业代码: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-67"><a href="#cb17-67"></a>        industry_col <span class="op">=</span> possible_cols[<span class="dv">0</span>]</span>
<span id="cb17-68"><a href="#cb17-68"></a>    <span class="cf">else</span>:</span>
<span id="cb17-69"><a href="#cb17-69"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到行业代码字段"</span>)</span>
<span id="cb17-70"><a href="#cb17-70"></a><span class="cf">else</span>:</span>
<span id="cb17-71"><a href="#cb17-71"></a>    industry_col <span class="op">=</span> <span class="st">'行业代码'</span></span>
<span id="cb17-72"><a href="#cb17-72"></a></span>
<span id="cb17-73"><a href="#cb17-73"></a><span class="co"># 将行业代码转换为字符串类型</span></span>
<span id="cb17-74"><a href="#cb17-74"></a>df[industry_col] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb17-75"><a href="#cb17-75"></a></span>
<span id="cb17-76"><a href="#cb17-76"></a><span class="co"># 提取行业代码的首字母</span></span>
<span id="cb17-77"><a href="#cb17-77"></a>df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[industry_col].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb17-78"><a href="#cb17-78"></a></span>
<span id="cb17-79"><a href="#cb17-79"></a><span class="co"># 创建行业字段</span></span>
<span id="cb17-80"><a href="#cb17-80"></a>df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业首字母'</span>].<span class="bu">map</span>(industry_mapping)</span>
<span id="cb17-81"><a href="#cb17-81"></a></span>
<span id="cb17-82"><a href="#cb17-82"></a><span class="co"># 处理无法映射的行业代码</span></span>
<span id="cb17-83"><a href="#cb17-83"></a>unknown_industries <span class="op">=</span> df[df[<span class="st">'行业'</span>].isna()][<span class="st">'行业首字母'</span>].unique()</span>
<span id="cb17-84"><a href="#cb17-84"></a><span class="cf">if</span> <span class="bu">len</span>(unknown_industries) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-85"><a href="#cb17-85"></a>    <span class="bu">print</span>(<span class="ss">f"发现无法映射的行业代码: </span><span class="sc">{</span>unknown_industries<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-86"><a href="#cb17-86"></a>    <span class="co"># 将这些行业归类为"其他行业"</span></span>
<span id="cb17-87"><a href="#cb17-87"></a>    df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业'</span>].fillna(<span class="st">'其他行业'</span>)</span>
<span id="cb17-88"><a href="#cb17-88"></a></span>
<span id="cb17-89"><a href="#cb17-89"></a><span class="co"># 显示行业分布情况</span></span>
<span id="cb17-90"><a href="#cb17-90"></a>industry_counts <span class="op">=</span> df[<span class="st">'行业'</span>].value_counts()</span>
<span id="cb17-91"><a href="#cb17-91"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">行业分布统计:"</span>)</span>
<span id="cb17-92"><a href="#cb17-92"></a><span class="bu">print</span>(industry_counts)</span>
<span id="cb17-93"><a href="#cb17-93"></a></span>
<span id="cb17-94"><a href="#cb17-94"></a><span class="co"># 4. 按'行业'和'时间'分组，计算平均值</span></span>
<span id="cb17-95"><a href="#cb17-95"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业和时间分组计算平均值..."</span>)</span>
<span id="cb17-96"><a href="#cb17-96"></a><span class="co"># 筛选2000年及以后的数据</span></span>
<span id="cb17-97"><a href="#cb17-97"></a>df <span class="op">=</span> df[df[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb17-98"><a href="#cb17-98"></a></span>
<span id="cb17-99"><a href="#cb17-99"></a><span class="co"># 分组计算平均值</span></span>
<span id="cb17-100"><a href="#cb17-100"></a>grouped <span class="op">=</span> df.groupby([<span class="st">'行业'</span>, <span class="st">'时间'</span>]).agg({</span>
<span id="cb17-101"><a href="#cb17-101"></a>    <span class="st">'SLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-102"><a href="#cb17-102"></a>    <span class="st">'LLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-103"><a href="#cb17-103"></a>    <span class="st">'Lev'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-104"><a href="#cb17-104"></a>    <span class="st">'Cash'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-105"><a href="#cb17-105"></a>    <span class="st">'ROA'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-106"><a href="#cb17-106"></a>    <span class="st">'ROE'</span>: <span class="st">'mean'</span></span>
<span id="cb17-107"><a href="#cb17-107"></a>}).reset_index()</span>
<span id="cb17-108"><a href="#cb17-108"></a></span>
<span id="cb17-109"><a href="#cb17-109"></a><span class="co"># 重命名列</span></span>
<span id="cb17-110"><a href="#cb17-110"></a>grouped.rename(columns<span class="op">=</span>{</span>
<span id="cb17-111"><a href="#cb17-111"></a>    <span class="st">'SLoan'</span>: <span class="st">'短期借款比率'</span>,</span>
<span id="cb17-112"><a href="#cb17-112"></a>    <span class="st">'LLoan'</span>: <span class="st">'长期借款比率'</span>,</span>
<span id="cb17-113"><a href="#cb17-113"></a>    <span class="st">'Lev'</span>: <span class="st">'总负债率'</span>,</span>
<span id="cb17-114"><a href="#cb17-114"></a>    <span class="st">'Cash'</span>: <span class="st">'现金比率'</span>,</span>
<span id="cb17-115"><a href="#cb17-115"></a>    <span class="st">'ROA'</span>: <span class="st">'资产收益率'</span>,</span>
<span id="cb17-116"><a href="#cb17-116"></a>    <span class="st">'ROE'</span>: <span class="st">'净资产收益率'</span></span>
<span id="cb17-117"><a href="#cb17-117"></a>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-118"><a href="#cb17-118"></a></span>
<span id="cb17-119"><a href="#cb17-119"></a><span class="co"># 按时间和行业排序</span></span>
<span id="cb17-120"><a href="#cb17-120"></a>grouped <span class="op">=</span> grouped.sort_values([<span class="st">'时间'</span>, <span class="st">'行业'</span>])</span>
<span id="cb17-121"><a href="#cb17-121"></a></span>
<span id="cb17-122"><a href="#cb17-122"></a><span class="co"># 5. 列表呈现</span></span>
<span id="cb17-123"><a href="#cb17-123"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业和时间分组的财务指标平均值:"</span>)</span>
<span id="cb17-124"><a href="#cb17-124"></a>pd.set_option(<span class="st">'display.max_rows'</span>, <span class="va">None</span>)</span>
<span id="cb17-125"><a href="#cb17-125"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb17-126"><a href="#cb17-126"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)</span>
<span id="cb17-127"><a href="#cb17-127"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="bu">isinstance</span>(x, <span class="bu">float</span>) <span class="cf">else</span> x)</span>
<span id="cb17-128"><a href="#cb17-128"></a></span>
<span id="cb17-129"><a href="#cb17-129"></a><span class="co"># 显示表格</span></span>
<span id="cb17-130"><a href="#cb17-130"></a><span class="bu">print</span>(grouped)</span>
<span id="cb17-131"><a href="#cb17-131"></a></span>
<span id="cb17-132"><a href="#cb17-132"></a><span class="co"># 保存结果到Excel（保留原始数值）</span></span>
<span id="cb17-133"><a href="#cb17-133"></a>output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_financial_metrics.xlsx'</span></span>
<span id="cb17-134"><a href="#cb17-134"></a>grouped.to_excel(output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-135"><a href="#cb17-135"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">结果已保存至: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-136"><a href="#cb17-136"></a></span>
<span id="cb17-137"><a href="#cb17-137"></a><span class="co"># 创建格式化版本用于展示</span></span>
<span id="cb17-138"><a href="#cb17-138"></a>formatted_grouped <span class="op">=</span> grouped.copy()</span>
<span id="cb17-139"><a href="#cb17-139"></a>percent_cols <span class="op">=</span> [<span class="st">'短期借款比率'</span>, <span class="st">'长期借款比率'</span>, <span class="st">'总负债率'</span>, <span class="st">'现金比率'</span>, <span class="st">'资产收益率'</span>, <span class="st">'净资产收益率'</span>]</span>
<span id="cb17-140"><a href="#cb17-140"></a><span class="cf">for</span> col <span class="kw">in</span> percent_cols:</span>
<span id="cb17-141"><a href="#cb17-141"></a>    formatted_grouped[col] <span class="op">=</span> formatted_grouped[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.2%}</span><span class="ss">"</span> <span class="cf">if</span> pd.notnull(x) <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb17-142"><a href="#cb17-142"></a></span>
<span id="cb17-143"><a href="#cb17-143"></a><span class="co"># 保存格式化版本</span></span>
<span id="cb17-144"><a href="#cb17-144"></a>formatted_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_financial_metrics_formatted.xlsx'</span></span>
<span id="cb17-145"><a href="#cb17-145"></a>formatted_grouped.to_excel(formatted_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-146"><a href="#cb17-146"></a><span class="bu">print</span>(<span class="ss">f"格式化结果已保存至: </span><span class="sc">{</span>formatted_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-147"><a href="#cb17-147"></a></span>
<span id="cb17-148"><a href="#cb17-148"></a><span class="co"># 按行业汇总（使用原始数值）</span></span>
<span id="cb17-149"><a href="#cb17-149"></a>industry_summary <span class="op">=</span> grouped.groupby(<span class="st">'行业'</span>).agg({</span>
<span id="cb17-150"><a href="#cb17-150"></a>    <span class="st">'短期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-151"><a href="#cb17-151"></a>    <span class="st">'长期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-152"><a href="#cb17-152"></a>    <span class="st">'总负债率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-153"><a href="#cb17-153"></a>    <span class="st">'现金比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-154"><a href="#cb17-154"></a>    <span class="st">'资产收益率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb17-155"><a href="#cb17-155"></a>    <span class="st">'净资产收益率'</span>: <span class="st">'mean'</span></span>
<span id="cb17-156"><a href="#cb17-156"></a>}).reset_index()</span>
<span id="cb17-157"><a href="#cb17-157"></a></span>
<span id="cb17-158"><a href="#cb17-158"></a><span class="co"># 创建格式化版本用于展示</span></span>
<span id="cb17-159"><a href="#cb17-159"></a>formatted_summary <span class="op">=</span> industry_summary.copy()</span>
<span id="cb17-160"><a href="#cb17-160"></a><span class="cf">for</span> col <span class="kw">in</span> percent_cols:</span>
<span id="cb17-161"><a href="#cb17-161"></a>    formatted_summary[col] <span class="op">=</span> formatted_summary[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.2%}</span><span class="ss">"</span> <span class="cf">if</span> pd.notnull(x) <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb17-162"><a href="#cb17-162"></a></span>
<span id="cb17-163"><a href="#cb17-163"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业汇总的财务指标平均值:"</span>)</span>
<span id="cb17-164"><a href="#cb17-164"></a><span class="bu">print</span>(formatted_summary)</span>
<span id="cb17-165"><a href="#cb17-165"></a></span>
<span id="cb17-166"><a href="#cb17-166"></a><span class="co"># 保存行业汇总结果</span></span>
<span id="cb17-167"><a href="#cb17-167"></a>summary_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_summary.xlsx'</span></span>
<span id="cb17-168"><a href="#cb17-168"></a>industry_summary.to_excel(summary_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-169"><a href="#cb17-169"></a><span class="bu">print</span>(<span class="ss">f"行业汇总结果已保存至: </span><span class="sc">{</span>summary_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-170"><a href="#cb17-170"></a></span>
<span id="cb17-171"><a href="#cb17-171"></a><span class="co"># 保存格式化行业汇总结果</span></span>
<span id="cb17-172"><a href="#cb17-172"></a>formatted_summary_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_summary_formatted.xlsx'</span></span>
<span id="cb17-173"><a href="#cb17-173"></a>formatted_summary.to_excel(formatted_summary_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-174"><a href="#cb17-174"></a><span class="bu">print</span>(<span class="ss">f"格式化行业汇总结果已保存至: </span><span class="sc">{</span>formatted_summary_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-175"><a href="#cb17-175"></a></span>
<span id="cb17-176"><a href="#cb17-176"></a><span class="co"># 保存处理后的完整数据</span></span>
<span id="cb17-177"><a href="#cb17-177"></a>full_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/processed_financial_data.xlsx'</span></span>
<span id="cb17-178"><a href="#cb17-178"></a>df.to_excel(full_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-179"><a href="#cb17-179"></a><span class="bu">print</span>(<span class="ss">f"处理后的完整数据已保存至: </span><span class="sc">{</span>full_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-180"><a href="#cb17-180"></a></span>
<span id="cb17-181"><a href="#cb17-181"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">第七步处理完成!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: /Users/wanshiqing/Desktop/python_code/merged_data.xlsx
数据读取成功! 共 145874 行记录
原始字段: ['证券代码', '时间', '负债合计', '资产总计', '流动负债合计', '长期负债合计', '所有者权益合计', '短期借款', '长期借款', '股权集中度1', '股权集中度9', '首次上市日期', '行业代码', '期末现金及现金等价物余额', '净利润']

计算并新增财务指标字段...
新增字段计算完成:
  SLoan: 62635 个有效值
  LLoan: 52544 个有效值
  Lev: 71787 个有效值
  Cash: 71637 个有效值
  ROA: 71787 个有效值
  ROE: 71785 个有效值

创建行业字段...
发现无法映射的行业代码: ['I' 'M' 'n' 'N' 'H' 'S' 'L' 'A' 'Q' 'R' 'B' 'P' 'O']

行业分布统计:
行业
其他行业                92759
制造业                 40346
批发和零售业               2770
交通运输业                2447
房地产业                 2065
金融业                  2027
电力、热力、燃气及水生产和供应业     2004
建筑业                  1456
Name: count, dtype: int64

按行业和时间分组计算平均值...

按行业和时间分组的财务指标平均值:
                   行业    时间  短期借款比率  长期借款比率   总负债率   现金比率    资产收益率  净资产收益率
0               交通运输业  2000  0.1634  0.0255 0.4352 0.2127   0.0510  0.0894
25               其他行业  2000  0.2289  0.0481 0.5270 0.1506   0.0124 -0.0290
50                制造业  2000  0.1564  0.0518 0.4253 0.1649   0.0340  0.0385
75                建筑业  2000  0.2016  0.0372 0.5859 0.1326   0.0168 -0.0140
100              房地产业  2000  0.1005  0.0627 0.3374 0.1797   0.0354  0.0260
125            批发和零售业  2000  0.1144  0.0757 0.4143 0.1786   0.0453  0.0790
150  电力、热力、燃气及水生产和供应业  2000  0.0859  0.0818 0.3502 0.1416   0.0508  0.0868
175               金融业  2000  0.2199  0.0345 0.4928 0.1112   0.0174  0.0391
1               交通运输业  2001  0.1946  0.0274 0.4708 0.2360   0.0185  0.1264
26               其他行业  2001  0.2385  0.0633 0.6050 0.1546  -0.0435 -0.0013
51                制造业  2001  0.1815  0.0552 0.4759 0.1799  -0.0226  0.0121
76                建筑业  2001  0.1744  0.0405 0.5885 0.1625   0.0085  0.0137
101              房地产业  2001  0.1028  0.0620 0.3572 0.1902   0.0386  0.0636
126            批发和零售业  2001  0.1023  0.0893 0.3571 0.1676   0.0446  0.0661
151  电力、热力、燃气及水生产和供应业  2001  0.0806  0.0936 0.3427 0.1506   0.0532  0.0841
176               金融业  2001  0.2339  0.0387 0.5941 0.1358   0.0003 -0.3361
2               交通运输业  2002  0.1951  0.0254 0.4826 0.2425   0.0153  0.0129
27               其他行业  2002  0.2488  0.0432 0.6260 0.1398  -0.0641  0.0259
52                制造业  2002  0.1876  0.0529 0.4951 0.1651  -0.0082  0.3696
77                建筑业  2002  0.1491  0.0592 0.5831 0.1467   0.0059 -0.0518
102              房地产业  2002  0.1232  0.0352 0.3652 0.1511   0.0378  0.0519
127            批发和零售业  2002  0.1093  0.0791 0.3625 0.1512   0.0401  0.0542
152  电力、热力、燃气及水生产和供应业  2002  0.0995  0.1211 0.3895 0.1481   0.0437  0.0718
177               金融业  2002  0.2175  0.0509 0.5645 0.1346  -0.0485 -0.2999
3               交通运输业  2003  0.2075  0.0207 0.5140 0.2448  -0.0724  0.0589
28               其他行业  2003  0.2773  0.0444 0.7274 0.1415  -0.0293  0.0224
53                制造业  2003  0.1942  0.0550 0.5041 0.1549   0.0159  0.0058
78                建筑业  2003  0.1690  0.0628 0.6071 0.1570  -0.0167  0.0745
103              房地产业  2003  0.1479  0.0533 0.4085 0.1314   0.0094  0.0538
128            批发和零售业  2003  0.1235  0.0813 0.3607 0.1531   0.0416  0.0317
153  电力、热力、燃气及水生产和供应业  2003  0.1041  0.1439 0.4176 0.1197   0.0444  0.0719
178               金融业  2003  0.2183  0.0618 0.6016 0.1326   0.0023 -0.2258
4               交通运输业  2004  0.2731  0.0152 0.6922 0.2184  -0.2616  0.0563
29               其他行业  2004  0.2798  0.0489 0.7673 0.1409  -0.0519 -0.0033
54                制造业  2004  0.2054  0.0560 0.5453 0.1525   0.0017 -0.0472
79                建筑业  2004  0.1713  0.0591 0.7306 0.1593  -0.0680  0.0738
104              房地产业  2004  0.1502  0.0685 0.4563 0.1250   0.0366  0.0733
129            批发和零售业  2004  0.1168  0.0760 0.3806 0.2736   0.0526  0.0717
154  电力、热力、燃气及水生产和供应业  2004  0.1189  0.1756 0.4544 0.1107   0.0371  0.0739
179               金融业  2004  0.2150  0.0743 0.6655 0.1309   0.0265  0.0259
5               交通运输业  2005  0.2125  0.0168 0.6484 0.5956  -0.0816  0.0068
30               其他行业  2005  0.2519  0.0488 0.7725 0.1286  -0.0077 -0.2177
55                制造业  2005  0.2261  0.0525 0.6412 0.2234  -0.0205  0.0135
80                建筑业  2005  0.1500  0.0797 0.6577 0.1290   0.0201  0.0634
105              房地产业  2005  0.1555  0.0753 0.4773 0.1137   0.0257  0.0121
130            批发和零售业  2005  0.1180  0.0880 0.4323 0.1335   0.0141  0.1234
155  电力、热力、燃气及水生产和供应业  2005  0.1189  0.1898 0.4891 0.0926   0.0225 -0.0285
180               金融业  2005  0.2039  0.0755 0.7313 0.1171   0.0031  0.0293
6               交通运输业  2006  0.2790  0.0170 0.9116 0.2204  -0.1807  0.0481
31               其他行业  2006  0.2364  0.0508 0.8276 0.1330   0.0082  1.4331
56                制造业  2006  0.7699  0.0506 1.6935 0.1333  -2.5587  0.5948
81                建筑业  2006  0.1352  0.0673 0.6436 0.1597   0.0247  0.0680
106              房地产业  2006  0.1287  0.0724 0.4758 0.1310   0.0272  0.0348
131            批发和零售业  2006  0.1362  0.0956 0.4858 0.1381   0.0355  0.1183
156  电力、热力、燃气及水生产和供应业  2006  0.1443  0.1882 0.5253 0.2559   0.0305  0.0643
181               金融业  2006  0.1438  0.1087 0.6489 0.1083   0.0228 -0.0339
7               交通运输业  2007  0.2470  0.0198 2.0235 0.2401   7.8151 -0.0115
32               其他行业  2007  0.2082  0.0520 0.8273 0.1565   0.0407  0.0836
57                制造业  2007  0.2224  0.0461 0.7052 0.1420   0.0884  0.0759
82                建筑业  2007  0.1432  0.0631 0.6775 0.1525   0.0285  0.1039
107              房地产业  2007  0.1300  0.0621 0.4344 0.1695   0.0697  0.1268
132            批发和零售业  2007  0.1573  0.1023 0.5740 0.1260   0.0606  2.6564
157  电力、热力、燃气及水生产和供应业  2007  0.1526  0.1892 0.5305 0.0845   0.0381  0.0805
182               金融业  2007  0.0973  0.1163 0.7034 0.1518   0.0994  0.0200
8               交通运输业  2008  0.1413  0.0108 2.2589 0.2529 227.7890 -1.5804
33               其他行业  2008  0.2205  0.0546 1.0286 0.1570  -0.0418  0.1250
58                制造业  2008  0.2072  0.0457 0.6415 0.1445   0.0206  0.0117
83                建筑业  2008  0.1449  0.0724 0.6990 0.1315   0.0060  0.0379
108              房地产业  2008  0.1456  0.0643 0.4388 0.1375   0.0353  0.0895
133            批发和零售业  2008  0.1082  0.1179 0.4595 0.1236   0.0678 -0.1113
158  电力、热力、燃气及水生产和供应业  2008  0.1702  0.2419 0.6054 0.0813  -0.0026 -0.0417
183               金融业  2008  0.0941  0.1142 0.7663 0.1147   0.0563  0.0774
9               交通运输业  2009  0.1145  0.0156 2.0586 0.3451  -0.4008  0.1220
34               其他行业  2009  0.1521  0.0603 0.7977 0.1805   0.0238  0.0847
59                制造业  2009  0.1625  0.0535 0.5628 0.1871   0.0443 -0.2628
84                建筑业  2009  0.1003  0.0776 0.6809 0.1903   0.0214  0.0670
109              房地产业  2009  0.1498  0.0673 0.4925 0.2135  -0.0411  0.1126
134            批发和零售业  2009  0.0858  0.1220 0.4476 0.1400   0.0407  0.0764
159  电力、热力、燃气及水生产和供应业  2009  0.1416  0.2451 0.6180 0.0897   0.0150  0.1043
184               金融业  2009  0.0623  0.1395 1.1700 0.1672   0.0422  0.0963
10              交通运输业  2010  0.0849  0.0115 0.6682 0.4039  -0.0014  0.0913
35               其他行业  2010  0.1113  0.0600 0.7035 0.2116   0.0510  0.1311
60                制造业  2010  0.1265  0.0420 0.4879 0.2398   0.0505  0.1148
85                建筑业  2010  0.0764  0.0833 0.6543 0.2021   0.0429  0.1215
110              房地产业  2010  0.1091  0.0644 0.4688 0.2488   0.0580 -0.0476
135            批发和零售业  2010  0.0722  0.1425 0.4449 0.1465   0.0546  0.0959
160  电力、热力、燃气及水生产和供应业  2010  0.1298  0.2309 0.5980 0.1027   0.0289  0.0550
185               金融业  2010  0.0606  0.1414 0.6841 0.1551   0.0310  0.1472
11              交通运输业  2011  0.0552  0.0159 0.3584 0.3938   0.0615  0.0962
36               其他行业  2011  0.1087  0.0491 0.6165 0.2068   0.0941  1.6309
61                制造业  2011  0.1249  0.0334 0.4428 0.2234   0.0621  0.5538
86                建筑业  2011  0.0988  0.0657 0.6520 0.1940   0.0350  0.1059
111              房地产业  2011  0.0741  0.0622 0.3871 0.2676   0.0512  0.0852
136            批发和零售业  2011  0.0674  0.1265 0.4578 0.1469   0.0453  0.0405
161  电力、热力、燃气及水生产和供应业  2011  0.1264  0.2252 0.6076 0.0924   0.0240  0.0483
186               金融业  2011  0.0536  0.1299 0.6264 0.1244   0.0324  0.1062
12              交通运输业  2012  0.0774  0.1115 0.4582 0.1367   0.0452  0.1351
37               其他行业  2012  0.0893  0.0434 0.4785 0.2437   0.0436  0.1372
62                制造业  2012  0.1180  0.0299 0.4286 0.2051   0.0383  0.0785
87                建筑业  2012  0.1067  0.0636 0.6586 0.1642   0.0320  0.0921
112              房地产业  2012  0.0527  0.1373 0.6284 0.1277   0.0304  0.1008
137            批发和零售业  2012  0.1335  0.0305 0.5512 0.2032   0.0367  0.0841
162  电力、热力、燃气及水生产和供应业  2012  0.1134  0.1958 0.5789 0.0963   0.0301  0.0703
187               金融业  2012  0.0021  0.0002 0.7009 0.2808   0.0198  0.1060
13              交通运输业  2013  0.1111  0.1104 0.5558 0.1212  -0.0524  0.0632
38               其他行业  2013  0.0883  0.0437 0.4093 0.2097   0.0707  0.5023
63                制造业  2013  0.1172  0.0298 0.4137 0.1672   0.1126  0.2525
88                建筑业  2013  0.1002  0.0735 0.6862 0.1550   0.0270  0.0775
113              房地产业  2013  0.0528  0.1635 0.6276 0.1246   0.0309  0.0914
138            批发和零售业  2013  0.1328  0.0364 0.5635 0.1874   0.0310  0.0668
163  电力、热力、燃气及水生产和供应业  2013  0.1046  0.1900 0.5701 0.0930   0.0412  0.0780
188               金融业  2013  0.0060  0.0043 0.7335 0.2108   0.0236  0.1204
14              交通运输业  2014  0.0685  0.1104 0.4525 0.1172   0.1394  0.6070
39               其他行业  2014  0.0864  0.0427 0.4152 0.1835   0.0423  0.0480
64                制造业  2014  0.1119  0.0273 0.4527 0.1500   0.0041  0.0021
89                建筑业  2014  0.0990  0.0607 0.6836 0.1286   0.0241  0.0758
114              房地产业  2014  0.0569  0.1552 0.6335 0.1053   0.0184 -0.0142
139            批发和零售业  2014  0.1300  0.0371 0.5801 0.1733   0.0228  0.0092
164  电力、热力、燃气及水生产和供应业  2014  0.0864  0.1892 0.5616 0.0970   0.0323  0.0672
189               金融业  2014  0.0069  0.0099 0.7969 0.2083   0.0282  0.1389
15              交通运输业  2015  0.0595  0.1039 0.4358 0.1215   0.0449  0.0829
40               其他行业  2015  0.0833  0.0374 0.4096 0.1834   0.0429  0.0764
65                制造业  2015  0.1043  0.0262 0.3979 0.1543   0.0322  0.0179
90                建筑业  2015  0.1052  0.0588 0.6428 0.1490   0.0246  0.0677
115              房地产业  2015  0.0623  0.1408 0.6398 0.1308   0.0080  0.0315
140            批发和零售业  2015  0.1236  0.0343 0.5452 0.1694   0.0273  0.0405
165  电力、热力、燃气及水生产和供应业  2015  0.0900  0.1836 0.5495 0.1024   0.0417  0.0784
190               金融业  2015  0.0139  0.0068 0.8049 0.2319   0.0294  0.1581
16              交通运输业  2016  0.0586  0.1302 0.4361 0.1181   0.0378  0.0575
41               其他行业  2016  0.0725  0.0705 0.3915 0.1943   0.0465  0.0714
66                制造业  2016  0.0888  0.0462 0.3842 0.1595   0.0480  0.0901
91                建筑业  2016  0.0921  0.0754 0.6133 0.1583   0.0205  0.0620
116              房地产业  2016  0.0412  0.1536 0.6438 0.1657   0.0194  0.0734
141            批发和零售业  2016  0.1035  0.0569 0.5205 0.1705   0.0297  0.0554
166  电力、热力、燃气及水生产和供应业  2016  0.0727  0.1919 0.5353 0.0951   0.0378  0.0798
191               金融业  2016  0.0142  0.0213 0.7872 0.1800   0.0171  0.0950
17              交通运输业  2017  0.0960  0.1287 0.4207 0.1285   0.0534  0.0933
42               其他行业  2017  0.1081  0.0724 0.3994 0.1807   0.0379 -0.1738
67                制造业  2017  0.1210  0.0527 0.3820 0.1524   0.0477  0.1855
92                建筑业  2017  0.1137  0.0834 0.6182 0.1432  -0.0026 -0.4727
117              房地产业  2017  0.0626  0.1574 0.6424 0.1475   0.0278  0.0813
142            批发和零售业  2017  0.1321  0.0566 0.5258 0.1701   0.0249 -0.0570
167  电力、热力、燃气及水生产和供应业  2017  0.1156  0.1954 0.5323 0.1089   0.0279  0.0419
192               金融业  2017  0.0420  0.0589 0.7741 0.1473   0.0148  0.0813
18              交通运输业  2018  0.1037  0.1268 0.4710 0.1137  -0.0051  0.0754
43               其他行业  2018  0.1161  0.0727 0.4582 0.1631  -0.0407 -0.3808
68                制造业  2018  0.1261  0.0534 0.4040 0.1375   0.0298 -0.0025
93                建筑业  2018  0.1876  0.0793 0.9298 0.1330  -0.2883 -0.0585
118              房地产业  2018  0.0474  0.1466 0.6434 0.1385   0.0196 -0.1915
143            批发和零售业  2018  0.1420  0.0488 0.5468 0.1571   0.0118 -1.1753
168  电力、热力、燃气及水生产和供应业  2018  0.1165  0.1863 0.5476 0.1010   0.0186 -0.0357
193               金融业  2018  0.0358  0.0473 0.7685 0.1331   0.0096  0.0638
19              交通运输业  2019  0.0932  0.1433 0.4743 0.1132   0.0373  0.1092
44               其他行业  2019  0.1067  0.0720 0.4313 0.1659   0.0111  0.0099
69                制造业  2019  0.1242  0.0547 0.4216 0.1450   0.0078 -0.0276
94                建筑业  2019  0.1021  0.0874 0.6617 0.1239   0.0132  0.0055
119              房地产业  2019  0.0483  0.1361 0.6309 0.1260   0.0228  0.0494
144            批发和零售业  2019  0.1427  0.0527 0.5421 0.1452   0.0165 -0.0384
169  电力、热力、燃气及水生产和供应业  2019  0.1100  0.1830 0.5516 0.0891   0.0172 -0.0243
194               金融业  2019  0.0353  0.0516 0.7619 0.1525   0.0041  0.0488
20              交通运输业  2020  0.0929  0.1446 0.4819 0.1228   0.0188  0.0520
45               其他行业  2020  0.0969  0.0789 0.4225 0.1890   0.0177  0.0471
70                制造业  2020  0.1243  0.0568 0.4588 0.1707   0.0314  0.0503
95                建筑业  2020  0.0866  0.0937 0.6508 0.1371   0.0085  0.0254
120              房地产业  2020  0.0466  0.1409 0.6432 0.1345  -0.0035  0.1168
145            批发和零售业  2020  0.1360  0.0555 0.5426 0.1707   0.0118  0.0118
170  电力、热力、燃气及水生产和供应业  2020  0.1014  0.1842 0.5597 0.0965   0.0282  0.0785
195               金融业  2020  0.0349  0.0531 0.7487 0.1689  -0.1048 -0.1841
21              交通运输业  2021  0.0720  0.1406 0.4530 0.1318   0.0376  0.0352
46               其他行业  2021  0.0889  0.0781 0.4260 0.1930   0.0171 -0.0276
71                制造业  2021  0.1005  0.0565 0.3919 0.1674   0.0461  0.0230
96                建筑业  2021  0.0805  0.0880 0.6763 0.1307  -0.0328 -0.3335
121              房地产业  2021  0.0407  0.1258 0.6574 0.1128   0.0035 -0.0536
146            批发和零售业  2021  0.1192  0.0553 0.5361 0.1597   0.0192 -0.0121
171  电力、热力、燃气及水生产和供应业  2021  0.0941  0.1935 0.5724 0.1002   0.0095 -0.0553
196               金融业  2021  0.0344  0.0423 0.7755 0.1656   0.0038  0.0843
22              交通运输业  2022  0.0734  0.1348 0.4478 0.1473   0.0328 -0.3942
47               其他行业  2022  0.0843  0.0751 0.4117 0.1984   0.0039 -0.0406
72                制造业  2022  0.0916  0.0614 0.3815 0.1779   0.0370  0.0470
97                建筑业  2022  0.0810  0.0893 0.6974 0.1234  -0.0215  0.0909
122              房地产业  2022  0.0427  0.1289 0.6654 0.1090  -0.0116 -0.0665
147            批发和零售业  2022  0.1254  0.0528 0.5411 0.1465   0.0144 -0.0168
172  电力、热力、燃气及水生产和供应业  2022  0.0878  0.2031 0.5561 0.1118   0.0244  0.0627
197               金融业  2022  0.0368  0.0402 0.7843 0.1639   0.0041 -0.0617
23              交通运输业  2023  0.0720  0.1424 0.4402 0.1390   0.0368  0.0745
48               其他行业  2023  0.0813  0.0816 0.4036 0.1981   0.0094  0.9045
73                制造业  2023  0.0844  0.0695 0.3796 0.1766   0.0269  0.0250
98                建筑业  2023  0.0694  0.1041 0.6851 0.1233  -0.0015 -0.1590
123              房地产业  2023  0.0441  0.1361 0.6233 0.1141  -0.0011 -0.0476
148            批发和零售业  2023  0.1222  0.0575 0.5354 0.1495   0.0049 -0.0009
173  电力、热力、燃气及水生产和供应业  2023  0.0800  0.2187 0.5474 0.1047   0.0324  0.1107
198               金融业  2023  0.0282  0.0509 0.7709 0.1602   0.0080  0.0444
24              交通运输业  2024  0.0410  0.1501 0.4101 0.1340   0.0465  0.0709
49               其他行业  2024  0.0864  0.0805 0.4194 0.1548   0.0068 -0.0007
74                制造业  2024  0.0838  0.0700 0.3924 0.1589   0.0387  0.0737
99                建筑业  2024  0.0431  0.1260 0.6778 0.1512   0.0178 -0.0010
124              房地产业  2024  0.0159  0.1928 0.5790 0.1832  -0.0048 -0.0452
149            批发和零售业  2024  0.0950  0.0856 0.5226 0.1268   0.0158  0.0299
174  电力、热力、燃气及水生产和供应业  2024  0.0729  0.2388 0.5615 0.0917   0.0341  0.0657
199               金融业  2024  0.0170  0.0463 0.8081 0.1737   0.0137  0.0785

结果已保存至: /Users/wanshiqing/Desktop/industry_financial_metrics.xlsx
格式化结果已保存至: /Users/wanshiqing/Desktop/industry_financial_metrics_formatted.xlsx

按行业汇总的财务指标平均值:
                 行业  短期借款比率  长期借款比率    总负债率    现金比率    资产收益率  净资产收益率
0             交通运输业  12.75%   7.60%  69.84%  21.01%  940.90%   0.71%
1              其他行业  15.00%   5.89%  57.21%  17.43%    1.20%  17.83%
2               制造业  16.64%   4.92%  51.64%  16.93%   -7.17%   9.18%
3               建筑业  11.92%   7.40%  66.57%  14.95%   -0.22%   0.54%
4              房地产业   8.53%  10.66%  53.43%  15.12%    2.17%   3.23%
5            批发和零售业  11.80%   7.42%  48.92%  16.03%    3.24%   9.20%
6  电力、热力、燃气及水生产和供应业  10.87%  18.72%  52.61%  11.03%    3.05%   5.15%
7               金融业   8.51%   6.08%  73.06%  15.84%    1.43%   1.68%
行业汇总结果已保存至: /Users/wanshiqing/Desktop/industry_summary.xlsx
格式化行业汇总结果已保存至: /Users/wanshiqing/Desktop/industry_summary_formatted.xlsx
处理后的完整数据已保存至: /Users/wanshiqing/Desktop/processed_financial_data.xlsx

第七步处理完成!</code></pre>
</div>
</div>
<div id="a0d80d8f" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="im">from</span> openpyxl.styles <span class="im">import</span> Border, Side, PatternFill, Font</span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="im">from</span> openpyxl.utils <span class="im">import</span> get_column_letter</span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co"># 1. 读取文件</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="bu">print</span>(<span class="ss">f"正在读取文件: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-9"><a href="#cb19-9"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="bu">print</span>(<span class="ss">f"数据读取成功! 共 </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> 行记录"</span>)</span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co"># 2. 计算并新增字段</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算并新增财务指标字段..."</span>)</span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="kw">def</span> safe_divide(numerator, denominator):</span>
<span id="cb19-15"><a href="#cb19-15"></a>    <span class="co">"""安全除法函数，处理分母为零的情况"""</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>    <span class="cf">return</span> np.where(denominator <span class="op">!=</span> <span class="dv">0</span>, numerator <span class="op">/</span> denominator, np.nan)</span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="co"># 确保所需字段存在</span></span>
<span id="cb19-19"><a href="#cb19-19"></a>required_fields <span class="op">=</span> [<span class="st">'短期借款'</span>, <span class="st">'长期借款'</span>, <span class="st">'负债合计'</span>, <span class="st">'资产总计'</span>, <span class="st">'期末现金及现金等价物余额'</span>, </span>
<span id="cb19-20"><a href="#cb19-20"></a>                  <span class="st">'净利润'</span>, <span class="st">'所有者权益合计'</span>]</span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="cf">for</span> field <span class="kw">in</span> required_fields:</span>
<span id="cb19-22"><a href="#cb19-22"></a>    <span class="cf">if</span> field <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb19-23"><a href="#cb19-23"></a>        <span class="bu">print</span>(<span class="ss">f"警告: 字段 '</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">' 不存在，尝试查找替代字段..."</span>)</span>
<span id="cb19-24"><a href="#cb19-24"></a>        possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> field <span class="kw">in</span> col <span class="kw">or</span> field.lower() <span class="kw">in</span> col.lower()]</span>
<span id="cb19-25"><a href="#cb19-25"></a>        <span class="cf">if</span> possible_cols:</span>
<span id="cb19-26"><a href="#cb19-26"></a>            df.rename(columns<span class="op">=</span>{possible_cols[<span class="dv">0</span>]: field}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-27"><a href="#cb19-27"></a>            <span class="bu">print</span>(<span class="ss">f"  使用替代字段: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> 作为 </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-28"><a href="#cb19-28"></a>        <span class="cf">else</span>:</span>
<span id="cb19-29"><a href="#cb19-29"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"无法找到必需的字段: </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-30"><a href="#cb19-30"></a></span>
<span id="cb19-31"><a href="#cb19-31"></a><span class="co"># 计算新增字段</span></span>
<span id="cb19-32"><a href="#cb19-32"></a>df[<span class="st">'SLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'短期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb19-33"><a href="#cb19-33"></a>df[<span class="st">'LLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'长期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb19-34"><a href="#cb19-34"></a>df[<span class="st">'Lev'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'负债合计'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb19-35"><a href="#cb19-35"></a>df[<span class="st">'Cash'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'期末现金及现金等价物余额'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb19-36"><a href="#cb19-36"></a>df[<span class="st">'ROA'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb19-37"><a href="#cb19-37"></a>df[<span class="st">'ROE'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'所有者权益合计'</span>])</span>
<span id="cb19-38"><a href="#cb19-38"></a></span>
<span id="cb19-39"><a href="#cb19-39"></a><span class="co"># 3. 创建行业字段</span></span>
<span id="cb19-40"><a href="#cb19-40"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">创建行业字段..."</span>)</span>
<span id="cb19-41"><a href="#cb19-41"></a>industry_mapping <span class="op">=</span> {</span>
<span id="cb19-42"><a href="#cb19-42"></a>    <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb19-43"><a href="#cb19-43"></a>    <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb19-44"><a href="#cb19-44"></a>    <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb19-45"><a href="#cb19-45"></a>    <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb19-46"><a href="#cb19-46"></a>    <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb19-47"><a href="#cb19-47"></a>    <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb19-48"><a href="#cb19-48"></a>    <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb19-49"><a href="#cb19-49"></a>}</span>
<span id="cb19-50"><a href="#cb19-50"></a></span>
<span id="cb19-51"><a href="#cb19-51"></a><span class="co"># 确保行业代码字段存在</span></span>
<span id="cb19-52"><a href="#cb19-52"></a><span class="cf">if</span> <span class="st">'行业代码'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb19-53"><a href="#cb19-53"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'行业'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'industry'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb19-54"><a href="#cb19-54"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb19-55"><a href="#cb19-55"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为行业代码: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-56"><a href="#cb19-56"></a>        industry_col <span class="op">=</span> possible_cols[<span class="dv">0</span>]</span>
<span id="cb19-57"><a href="#cb19-57"></a>    <span class="cf">else</span>:</span>
<span id="cb19-58"><a href="#cb19-58"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到行业代码字段"</span>)</span>
<span id="cb19-59"><a href="#cb19-59"></a><span class="cf">else</span>:</span>
<span id="cb19-60"><a href="#cb19-60"></a>    industry_col <span class="op">=</span> <span class="st">'行业代码'</span></span>
<span id="cb19-61"><a href="#cb19-61"></a></span>
<span id="cb19-62"><a href="#cb19-62"></a><span class="co"># 将行业代码转换为字符串类型</span></span>
<span id="cb19-63"><a href="#cb19-63"></a>df[industry_col] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb19-64"><a href="#cb19-64"></a>df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[industry_col].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb19-65"><a href="#cb19-65"></a>df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业首字母'</span>].<span class="bu">map</span>(industry_mapping)</span>
<span id="cb19-66"><a href="#cb19-66"></a></span>
<span id="cb19-67"><a href="#cb19-67"></a><span class="co"># 处理无法映射的行业代码</span></span>
<span id="cb19-68"><a href="#cb19-68"></a>unknown_industries <span class="op">=</span> df[df[<span class="st">'行业'</span>].isna()][<span class="st">'行业首字母'</span>].unique()</span>
<span id="cb19-69"><a href="#cb19-69"></a><span class="cf">if</span> <span class="bu">len</span>(unknown_industries) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb19-70"><a href="#cb19-70"></a>    <span class="bu">print</span>(<span class="ss">f"发现无法映射的行业代码: </span><span class="sc">{</span>unknown_industries<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-71"><a href="#cb19-71"></a>    df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业'</span>].fillna(<span class="st">'其他行业'</span>)</span>
<span id="cb19-72"><a href="#cb19-72"></a></span>
<span id="cb19-73"><a href="#cb19-73"></a><span class="co"># 4. 按'行业'和'时间'分组，计算平均值</span></span>
<span id="cb19-74"><a href="#cb19-74"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业和时间分组计算平均值..."</span>)</span>
<span id="cb19-75"><a href="#cb19-75"></a>df <span class="op">=</span> df[df[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb19-76"><a href="#cb19-76"></a>grouped <span class="op">=</span> df.groupby([<span class="st">'行业'</span>, <span class="st">'时间'</span>]).agg({</span>
<span id="cb19-77"><a href="#cb19-77"></a>    <span class="st">'SLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-78"><a href="#cb19-78"></a>    <span class="st">'LLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-79"><a href="#cb19-79"></a>    <span class="st">'Lev'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-80"><a href="#cb19-80"></a>    <span class="st">'Cash'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-81"><a href="#cb19-81"></a>    <span class="st">'ROA'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-82"><a href="#cb19-82"></a>    <span class="st">'ROE'</span>: <span class="st">'mean'</span></span>
<span id="cb19-83"><a href="#cb19-83"></a>}).reset_index()</span>
<span id="cb19-84"><a href="#cb19-84"></a></span>
<span id="cb19-85"><a href="#cb19-85"></a><span class="co"># 重命名列</span></span>
<span id="cb19-86"><a href="#cb19-86"></a>grouped.rename(columns<span class="op">=</span>{</span>
<span id="cb19-87"><a href="#cb19-87"></a>    <span class="st">'SLoan'</span>: <span class="st">'短期借款比率'</span>,</span>
<span id="cb19-88"><a href="#cb19-88"></a>    <span class="st">'LLoan'</span>: <span class="st">'长期借款比率'</span>,</span>
<span id="cb19-89"><a href="#cb19-89"></a>    <span class="st">'Lev'</span>: <span class="st">'总负债率'</span>,</span>
<span id="cb19-90"><a href="#cb19-90"></a>    <span class="st">'Cash'</span>: <span class="st">'现金比率'</span>,</span>
<span id="cb19-91"><a href="#cb19-91"></a>    <span class="st">'ROA'</span>: <span class="st">'资产收益率'</span>,</span>
<span id="cb19-92"><a href="#cb19-92"></a>    <span class="st">'ROE'</span>: <span class="st">'净资产收益率'</span></span>
<span id="cb19-93"><a href="#cb19-93"></a>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-94"><a href="#cb19-94"></a></span>
<span id="cb19-95"><a href="#cb19-95"></a><span class="co"># 按时间和行业排序</span></span>
<span id="cb19-96"><a href="#cb19-96"></a>grouped <span class="op">=</span> grouped.sort_values([<span class="st">'时间'</span>, <span class="st">'行业'</span>])</span>
<span id="cb19-97"><a href="#cb19-97"></a></span>
<span id="cb19-98"><a href="#cb19-98"></a><span class="co"># 5. 创建美观的实线表格</span></span>
<span id="cb19-99"><a href="#cb19-99"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">创建美观的实线表格..."</span>)</span>
<span id="cb19-100"><a href="#cb19-100"></a></span>
<span id="cb19-101"><a href="#cb19-101"></a><span class="co"># 定义样式函数</span></span>
<span id="cb19-102"><a href="#cb19-102"></a><span class="kw">def</span> format_table(styler):</span>
<span id="cb19-103"><a href="#cb19-103"></a>    <span class="co"># 设置百分比格式</span></span>
<span id="cb19-104"><a href="#cb19-104"></a>    styler.<span class="bu">format</span>({</span>
<span id="cb19-105"><a href="#cb19-105"></a>        <span class="st">'短期借款比率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span>,</span>
<span id="cb19-106"><a href="#cb19-106"></a>        <span class="st">'长期借款比率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span>,</span>
<span id="cb19-107"><a href="#cb19-107"></a>        <span class="st">'总负债率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span>,</span>
<span id="cb19-108"><a href="#cb19-108"></a>        <span class="st">'现金比率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span>,</span>
<span id="cb19-109"><a href="#cb19-109"></a>        <span class="st">'资产收益率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span>,</span>
<span id="cb19-110"><a href="#cb19-110"></a>        <span class="st">'净资产收益率'</span>: <span class="st">'</span><span class="sc">{:.2%}</span><span class="st">'</span></span>
<span id="cb19-111"><a href="#cb19-111"></a>    })</span>
<span id="cb19-112"><a href="#cb19-112"></a>    </span>
<span id="cb19-113"><a href="#cb19-113"></a>    <span class="co"># 设置表头样式</span></span>
<span id="cb19-114"><a href="#cb19-114"></a>    styler.set_table_styles([</span>
<span id="cb19-115"><a href="#cb19-115"></a>        {<span class="st">'selector'</span>: <span class="st">'th'</span>, <span class="st">'props'</span>: [</span>
<span id="cb19-116"><a href="#cb19-116"></a>            (<span class="st">'border'</span>, <span class="st">'1px solid black'</span>),</span>
<span id="cb19-117"><a href="#cb19-117"></a>            (<span class="st">'background-color'</span>, <span class="st">'#4F81BD'</span>),</span>
<span id="cb19-118"><a href="#cb19-118"></a>            (<span class="st">'color'</span>, <span class="st">'white'</span>),</span>
<span id="cb19-119"><a href="#cb19-119"></a>            (<span class="st">'font-weight'</span>, <span class="st">'bold'</span>),</span>
<span id="cb19-120"><a href="#cb19-120"></a>            (<span class="st">'text-align'</span>, <span class="st">'center'</span>)</span>
<span id="cb19-121"><a href="#cb19-121"></a>        ]},</span>
<span id="cb19-122"><a href="#cb19-122"></a>        {<span class="st">'selector'</span>: <span class="st">'td'</span>, <span class="st">'props'</span>: [</span>
<span id="cb19-123"><a href="#cb19-123"></a>            (<span class="st">'border'</span>, <span class="st">'1px solid black'</span>),</span>
<span id="cb19-124"><a href="#cb19-124"></a>            (<span class="st">'text-align'</span>, <span class="st">'center'</span>)</span>
<span id="cb19-125"><a href="#cb19-125"></a>        ]},</span>
<span id="cb19-126"><a href="#cb19-126"></a>        {<span class="st">'selector'</span>: <span class="st">'tr:nth-child(even)'</span>, <span class="st">'props'</span>: [</span>
<span id="cb19-127"><a href="#cb19-127"></a>            (<span class="st">'background-color'</span>, <span class="st">'#DCE6F1'</span>)</span>
<span id="cb19-128"><a href="#cb19-128"></a>        ]},</span>
<span id="cb19-129"><a href="#cb19-129"></a>        {<span class="st">'selector'</span>: <span class="st">'tr:nth-child(odd)'</span>, <span class="st">'props'</span>: [</span>
<span id="cb19-130"><a href="#cb19-130"></a>            (<span class="st">'background-color'</span>, <span class="st">'white'</span>)</span>
<span id="cb19-131"><a href="#cb19-131"></a>        ]}</span>
<span id="cb19-132"><a href="#cb19-132"></a>    ])</span>
<span id="cb19-133"><a href="#cb19-133"></a>    </span>
<span id="cb19-134"><a href="#cb19-134"></a>    <span class="co"># 设置列宽</span></span>
<span id="cb19-135"><a href="#cb19-135"></a>    styler.set_properties(<span class="op">**</span>{</span>
<span id="cb19-136"><a href="#cb19-136"></a>        <span class="st">'width'</span>: <span class="st">'100px'</span>,</span>
<span id="cb19-137"><a href="#cb19-137"></a>        <span class="st">'max-width'</span>: <span class="st">'100px'</span></span>
<span id="cb19-138"><a href="#cb19-138"></a>    })</span>
<span id="cb19-139"><a href="#cb19-139"></a>    </span>
<span id="cb19-140"><a href="#cb19-140"></a>    <span class="cf">return</span> styler</span>
<span id="cb19-141"><a href="#cb19-141"></a></span>
<span id="cb19-142"><a href="#cb19-142"></a><span class="co"># 应用样式</span></span>
<span id="cb19-143"><a href="#cb19-143"></a>styled_table <span class="op">=</span> grouped.style.pipe(format_table)</span>
<span id="cb19-144"><a href="#cb19-144"></a></span>
<span id="cb19-145"><a href="#cb19-145"></a><span class="co"># 保存为HTML</span></span>
<span id="cb19-146"><a href="#cb19-146"></a>html_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_financial_metrics.html'</span></span>
<span id="cb19-147"><a href="#cb19-147"></a><span class="cf">with</span> <span class="bu">open</span>(html_output_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb19-148"><a href="#cb19-148"></a>    f.write(styled_table.to_html())</span>
<span id="cb19-149"><a href="#cb19-149"></a><span class="bu">print</span>(<span class="ss">f"HTML表格已保存至: </span><span class="sc">{</span>html_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-150"><a href="#cb19-150"></a></span>
<span id="cb19-151"><a href="#cb19-151"></a><span class="co"># 保存为带格式的Excel</span></span>
<span id="cb19-152"><a href="#cb19-152"></a><span class="kw">def</span> apply_excel_formatting(writer, df, sheet_name<span class="op">=</span><span class="st">'Sheet1'</span>):</span>
<span id="cb19-153"><a href="#cb19-153"></a>    <span class="co">"""应用Excel格式设置"""</span></span>
<span id="cb19-154"><a href="#cb19-154"></a>    workbook <span class="op">=</span> writer.book</span>
<span id="cb19-155"><a href="#cb19-155"></a>    worksheet <span class="op">=</span> writer.sheets[sheet_name]</span>
<span id="cb19-156"><a href="#cb19-156"></a>    </span>
<span id="cb19-157"><a href="#cb19-157"></a>    <span class="co"># 定义边框样式</span></span>
<span id="cb19-158"><a href="#cb19-158"></a>    thin_border <span class="op">=</span> Border(</span>
<span id="cb19-159"><a href="#cb19-159"></a>        left<span class="op">=</span>Side(style<span class="op">=</span><span class="st">'thin'</span>),</span>
<span id="cb19-160"><a href="#cb19-160"></a>        right<span class="op">=</span>Side(style<span class="op">=</span><span class="st">'thin'</span>),</span>
<span id="cb19-161"><a href="#cb19-161"></a>        top<span class="op">=</span>Side(style<span class="op">=</span><span class="st">'thin'</span>),</span>
<span id="cb19-162"><a href="#cb19-162"></a>        bottom<span class="op">=</span>Side(style<span class="op">=</span><span class="st">'thin'</span>)</span>
<span id="cb19-163"><a href="#cb19-163"></a>    )</span>
<span id="cb19-164"><a href="#cb19-164"></a>    </span>
<span id="cb19-165"><a href="#cb19-165"></a>    <span class="co"># 定义填充颜色</span></span>
<span id="cb19-166"><a href="#cb19-166"></a>    header_fill <span class="op">=</span> PatternFill(start_color<span class="op">=</span><span class="st">'4F81BD'</span>, end_color<span class="op">=</span><span class="st">'4F81BD'</span>, fill_type<span class="op">=</span><span class="st">'solid'</span>)</span>
<span id="cb19-167"><a href="#cb19-167"></a>    even_row_fill <span class="op">=</span> PatternFill(start_color<span class="op">=</span><span class="st">'DCE6F1'</span>, end_color<span class="op">=</span><span class="st">'DCE6F1'</span>, fill_type<span class="op">=</span><span class="st">'solid'</span>)</span>
<span id="cb19-168"><a href="#cb19-168"></a>    odd_row_fill <span class="op">=</span> PatternFill(start_color<span class="op">=</span><span class="st">'FFFFFF'</span>, end_color<span class="op">=</span><span class="st">'FFFFFF'</span>, fill_type<span class="op">=</span><span class="st">'solid'</span>)</span>
<span id="cb19-169"><a href="#cb19-169"></a>    </span>
<span id="cb19-170"><a href="#cb19-170"></a>    <span class="co"># 定义字体</span></span>
<span id="cb19-171"><a href="#cb19-171"></a>    header_font <span class="op">=</span> Font(color<span class="op">=</span><span class="st">'FFFFFF'</span>, bold<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-172"><a href="#cb19-172"></a>    data_font <span class="op">=</span> Font()</span>
<span id="cb19-173"><a href="#cb19-173"></a>    </span>
<span id="cb19-174"><a href="#cb19-174"></a>    <span class="co"># 设置列宽</span></span>
<span id="cb19-175"><a href="#cb19-175"></a>    <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(df.columns):</span>
<span id="cb19-176"><a href="#cb19-176"></a>        col_letter <span class="op">=</span> get_column_letter(i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb19-177"><a href="#cb19-177"></a>        worksheet.column_dimensions[col_letter].width <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb19-178"><a href="#cb19-178"></a>    </span>
<span id="cb19-179"><a href="#cb19-179"></a>    <span class="co"># 应用格式到所有单元格</span></span>
<span id="cb19-180"><a href="#cb19-180"></a>    <span class="cf">for</span> row <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb19-181"><a href="#cb19-181"></a>        <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(df.columns)):</span>
<span id="cb19-182"><a href="#cb19-182"></a>            cell <span class="op">=</span> worksheet.cell(row<span class="op">=</span>row <span class="op">+</span> <span class="dv">1</span>, column<span class="op">=</span>col <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb19-183"><a href="#cb19-183"></a>            cell.border <span class="op">=</span> thin_border</span>
<span id="cb19-184"><a href="#cb19-184"></a>            </span>
<span id="cb19-185"><a href="#cb19-185"></a>            <span class="co"># 表头样式</span></span>
<span id="cb19-186"><a href="#cb19-186"></a>            <span class="cf">if</span> row <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-187"><a href="#cb19-187"></a>                cell.fill <span class="op">=</span> header_fill</span>
<span id="cb19-188"><a href="#cb19-188"></a>                cell.font <span class="op">=</span> header_font</span>
<span id="cb19-189"><a href="#cb19-189"></a>            <span class="co"># 数据行样式</span></span>
<span id="cb19-190"><a href="#cb19-190"></a>            <span class="cf">else</span>:</span>
<span id="cb19-191"><a href="#cb19-191"></a>                <span class="cf">if</span> row <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-192"><a href="#cb19-192"></a>                    cell.fill <span class="op">=</span> even_row_fill</span>
<span id="cb19-193"><a href="#cb19-193"></a>                <span class="cf">else</span>:</span>
<span id="cb19-194"><a href="#cb19-194"></a>                    cell.fill <span class="op">=</span> odd_row_fill</span>
<span id="cb19-195"><a href="#cb19-195"></a>                cell.font <span class="op">=</span> data_font</span>
<span id="cb19-196"><a href="#cb19-196"></a>    </span>
<span id="cb19-197"><a href="#cb19-197"></a>    <span class="co"># 冻结首行</span></span>
<span id="cb19-198"><a href="#cb19-198"></a>    worksheet.freeze_panes <span class="op">=</span> <span class="st">'A2'</span></span>
<span id="cb19-199"><a href="#cb19-199"></a></span>
<span id="cb19-200"><a href="#cb19-200"></a><span class="co"># 保存为Excel</span></span>
<span id="cb19-201"><a href="#cb19-201"></a>excel_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_financial_metrics.xlsx'</span></span>
<span id="cb19-202"><a href="#cb19-202"></a><span class="cf">with</span> pd.ExcelWriter(excel_output_path, engine<span class="op">=</span><span class="st">'openpyxl'</span>) <span class="im">as</span> writer:</span>
<span id="cb19-203"><a href="#cb19-203"></a>    grouped.to_excel(writer, index<span class="op">=</span><span class="va">False</span>, sheet_name<span class="op">=</span><span class="st">'行业财务指标'</span>)</span>
<span id="cb19-204"><a href="#cb19-204"></a>    apply_excel_formatting(writer, grouped, sheet_name<span class="op">=</span><span class="st">'行业财务指标'</span>)</span>
<span id="cb19-205"><a href="#cb19-205"></a><span class="bu">print</span>(<span class="ss">f"带格式的Excel表格已保存至: </span><span class="sc">{</span>excel_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-206"><a href="#cb19-206"></a></span>
<span id="cb19-207"><a href="#cb19-207"></a><span class="co"># 创建行业汇总表</span></span>
<span id="cb19-208"><a href="#cb19-208"></a>industry_summary <span class="op">=</span> grouped.groupby(<span class="st">'行业'</span>).agg({</span>
<span id="cb19-209"><a href="#cb19-209"></a>    <span class="st">'短期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-210"><a href="#cb19-210"></a>    <span class="st">'长期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-211"><a href="#cb19-211"></a>    <span class="st">'总负债率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-212"><a href="#cb19-212"></a>    <span class="st">'现金比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-213"><a href="#cb19-213"></a>    <span class="st">'资产收益率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb19-214"><a href="#cb19-214"></a>    <span class="st">'净资产收益率'</span>: <span class="st">'mean'</span></span>
<span id="cb19-215"><a href="#cb19-215"></a>}).reset_index()</span>
<span id="cb19-216"><a href="#cb19-216"></a></span>
<span id="cb19-217"><a href="#cb19-217"></a><span class="co"># 应用样式到汇总表</span></span>
<span id="cb19-218"><a href="#cb19-218"></a>styled_summary <span class="op">=</span> industry_summary.style.pipe(format_table)</span>
<span id="cb19-219"><a href="#cb19-219"></a></span>
<span id="cb19-220"><a href="#cb19-220"></a><span class="co"># 保存汇总表</span></span>
<span id="cb19-221"><a href="#cb19-221"></a>summary_html_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_summary.html'</span></span>
<span id="cb19-222"><a href="#cb19-222"></a><span class="cf">with</span> <span class="bu">open</span>(summary_html_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb19-223"><a href="#cb19-223"></a>    f.write(styled_summary.to_html())</span>
<span id="cb19-224"><a href="#cb19-224"></a><span class="bu">print</span>(<span class="ss">f"行业汇总HTML表格已保存至: </span><span class="sc">{</span>summary_html_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-225"><a href="#cb19-225"></a></span>
<span id="cb19-226"><a href="#cb19-226"></a><span class="co"># 保存汇总表到Excel</span></span>
<span id="cb19-227"><a href="#cb19-227"></a>summary_excel_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/industry_summary.xlsx'</span></span>
<span id="cb19-228"><a href="#cb19-228"></a><span class="cf">with</span> pd.ExcelWriter(summary_excel_path, engine<span class="op">=</span><span class="st">'openpyxl'</span>) <span class="im">as</span> writer:</span>
<span id="cb19-229"><a href="#cb19-229"></a>    industry_summary.to_excel(writer, index<span class="op">=</span><span class="va">False</span>, sheet_name<span class="op">=</span><span class="st">'行业汇总'</span>)</span>
<span id="cb19-230"><a href="#cb19-230"></a>    apply_excel_formatting(writer, industry_summary, sheet_name<span class="op">=</span><span class="st">'行业汇总'</span>)</span>
<span id="cb19-231"><a href="#cb19-231"></a><span class="bu">print</span>(<span class="ss">f"行业汇总Excel表格已保存至: </span><span class="sc">{</span>summary_excel_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-232"><a href="#cb19-232"></a></span>
<span id="cb19-233"><a href="#cb19-233"></a><span class="co"># 保存处理后的完整数据</span></span>
<span id="cb19-234"><a href="#cb19-234"></a>full_output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/processed_financial_data.xlsx'</span></span>
<span id="cb19-235"><a href="#cb19-235"></a>df.to_excel(full_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-236"><a href="#cb19-236"></a><span class="bu">print</span>(<span class="ss">f"处理后的完整数据已保存至: </span><span class="sc">{</span>full_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-237"><a href="#cb19-237"></a></span>
<span id="cb19-238"><a href="#cb19-238"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">第七步处理完成!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: /Users/wanshiqing/Desktop/python_code/merged_data.xlsx
数据读取成功! 共 145874 行记录

计算并新增财务指标字段...

创建行业字段...
发现无法映射的行业代码: ['I' 'M' 'n' 'N' 'H' 'S' 'L' 'A' 'Q' 'R' 'B' 'P' 'O']

按行业和时间分组计算平均值...

创建美观的实线表格...
HTML表格已保存至: /Users/wanshiqing/Desktop/industry_financial_metrics.html
带格式的Excel表格已保存至: /Users/wanshiqing/Desktop/industry_financial_metrics.xlsx
行业汇总HTML表格已保存至: /Users/wanshiqing/Desktop/industry_summary.html
行业汇总Excel表格已保存至: /Users/wanshiqing/Desktop/industry_summary.xlsx
处理后的完整数据已保存至: /Users/wanshiqing/Desktop/processed_financial_data.xlsx

第七步处理完成!</code></pre>
</div>
</div>
<div id="c81bfecc" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co"># 1. 读取文件</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="bu">print</span>(<span class="ss">f"正在读取文件: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-8"><a href="#cb21-8"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="bu">print</span>(<span class="ss">f"数据读取成功! 共 </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> 行记录"</span>)</span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co"># 2. 计算并新增字段</span></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">计算并新增财务指标字段..."</span>)</span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="kw">def</span> safe_divide(numerator, denominator):</span>
<span id="cb21-14"><a href="#cb21-14"></a>    <span class="co">"""安全除法函数，处理分母为零的情况"""</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>    <span class="cf">return</span> np.where(denominator <span class="op">!=</span> <span class="dv">0</span>, numerator <span class="op">/</span> denominator, np.nan)</span>
<span id="cb21-16"><a href="#cb21-16"></a></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="co"># 确保所需字段存在</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>required_fields <span class="op">=</span> [<span class="st">'短期借款'</span>, <span class="st">'长期借款'</span>, <span class="st">'负债合计'</span>, <span class="st">'资产总计'</span>, <span class="st">'期末现金及现金等价物余额'</span>, </span>
<span id="cb21-19"><a href="#cb21-19"></a>                  <span class="st">'净利润'</span>, <span class="st">'所有者权益合计'</span>]</span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="cf">for</span> field <span class="kw">in</span> required_fields:</span>
<span id="cb21-21"><a href="#cb21-21"></a>    <span class="cf">if</span> field <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb21-22"><a href="#cb21-22"></a>        <span class="bu">print</span>(<span class="ss">f"警告: 字段 '</span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">' 不存在，尝试查找替代字段..."</span>)</span>
<span id="cb21-23"><a href="#cb21-23"></a>        possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> field <span class="kw">in</span> col <span class="kw">or</span> field.lower() <span class="kw">in</span> col.lower()]</span>
<span id="cb21-24"><a href="#cb21-24"></a>        <span class="cf">if</span> possible_cols:</span>
<span id="cb21-25"><a href="#cb21-25"></a>            df.rename(columns<span class="op">=</span>{possible_cols[<span class="dv">0</span>]: field}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-26"><a href="#cb21-26"></a>            <span class="bu">print</span>(<span class="ss">f"  使用替代字段: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> 作为 </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-27"><a href="#cb21-27"></a>        <span class="cf">else</span>:</span>
<span id="cb21-28"><a href="#cb21-28"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"无法找到必需的字段: </span><span class="sc">{</span>field<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-29"><a href="#cb21-29"></a></span>
<span id="cb21-30"><a href="#cb21-30"></a><span class="co"># 计算新增字段</span></span>
<span id="cb21-31"><a href="#cb21-31"></a>df[<span class="st">'SLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'短期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb21-32"><a href="#cb21-32"></a>df[<span class="st">'LLoan'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'长期借款'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb21-33"><a href="#cb21-33"></a>df[<span class="st">'Lev'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'负债合计'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb21-34"><a href="#cb21-34"></a>df[<span class="st">'Cash'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'期末现金及现金等价物余额'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb21-35"><a href="#cb21-35"></a>df[<span class="st">'ROA'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'资产总计'</span>])</span>
<span id="cb21-36"><a href="#cb21-36"></a>df[<span class="st">'ROE'</span>] <span class="op">=</span> safe_divide(df[<span class="st">'净利润'</span>], df[<span class="st">'所有者权益合计'</span>])</span>
<span id="cb21-37"><a href="#cb21-37"></a></span>
<span id="cb21-38"><a href="#cb21-38"></a><span class="co"># 3. 创建行业字段</span></span>
<span id="cb21-39"><a href="#cb21-39"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">创建行业字段..."</span>)</span>
<span id="cb21-40"><a href="#cb21-40"></a>industry_mapping <span class="op">=</span> {</span>
<span id="cb21-41"><a href="#cb21-41"></a>    <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb21-42"><a href="#cb21-42"></a>    <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb21-43"><a href="#cb21-43"></a>    <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb21-44"><a href="#cb21-44"></a>    <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb21-45"><a href="#cb21-45"></a>    <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb21-46"><a href="#cb21-46"></a>    <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb21-47"><a href="#cb21-47"></a>    <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb21-48"><a href="#cb21-48"></a>}</span>
<span id="cb21-49"><a href="#cb21-49"></a></span>
<span id="cb21-50"><a href="#cb21-50"></a><span class="co"># 确保行业代码字段存在</span></span>
<span id="cb21-51"><a href="#cb21-51"></a><span class="cf">if</span> <span class="st">'行业代码'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb21-52"><a href="#cb21-52"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'行业'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'industry'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb21-53"><a href="#cb21-53"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb21-54"><a href="#cb21-54"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为行业代码: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-55"><a href="#cb21-55"></a>        industry_col <span class="op">=</span> possible_cols[<span class="dv">0</span>]</span>
<span id="cb21-56"><a href="#cb21-56"></a>    <span class="cf">else</span>:</span>
<span id="cb21-57"><a href="#cb21-57"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到行业代码字段"</span>)</span>
<span id="cb21-58"><a href="#cb21-58"></a><span class="cf">else</span>:</span>
<span id="cb21-59"><a href="#cb21-59"></a>    industry_col <span class="op">=</span> <span class="st">'行业代码'</span></span>
<span id="cb21-60"><a href="#cb21-60"></a></span>
<span id="cb21-61"><a href="#cb21-61"></a><span class="co"># 将行业代码转换为字符串类型</span></span>
<span id="cb21-62"><a href="#cb21-62"></a>df[industry_col] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb21-63"><a href="#cb21-63"></a>df[<span class="st">'行业首字母'</span>] <span class="op">=</span> df[industry_col].<span class="bu">str</span>[<span class="dv">0</span>]</span>
<span id="cb21-64"><a href="#cb21-64"></a>df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业首字母'</span>].<span class="bu">map</span>(industry_mapping)</span>
<span id="cb21-65"><a href="#cb21-65"></a></span>
<span id="cb21-66"><a href="#cb21-66"></a><span class="co"># 处理无法映射的行业代码</span></span>
<span id="cb21-67"><a href="#cb21-67"></a>unknown_industries <span class="op">=</span> df[df[<span class="st">'行业'</span>].isna()][<span class="st">'行业首字母'</span>].unique()</span>
<span id="cb21-68"><a href="#cb21-68"></a><span class="cf">if</span> <span class="bu">len</span>(unknown_industries) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-69"><a href="#cb21-69"></a>    <span class="bu">print</span>(<span class="ss">f"发现无法映射的行业代码: </span><span class="sc">{</span>unknown_industries<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-70"><a href="#cb21-70"></a>    df[<span class="st">'行业'</span>] <span class="op">=</span> df[<span class="st">'行业'</span>].fillna(<span class="st">'其他行业'</span>)</span>
<span id="cb21-71"><a href="#cb21-71"></a></span>
<span id="cb21-72"><a href="#cb21-72"></a><span class="co"># 4. 按'行业'和'时间'分组，计算平均值</span></span>
<span id="cb21-73"><a href="#cb21-73"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业和时间分组计算平均值..."</span>)</span>
<span id="cb21-74"><a href="#cb21-74"></a>df <span class="op">=</span> df[df[<span class="st">'时间'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb21-75"><a href="#cb21-75"></a>grouped <span class="op">=</span> df.groupby([<span class="st">'行业'</span>, <span class="st">'时间'</span>]).agg({</span>
<span id="cb21-76"><a href="#cb21-76"></a>    <span class="st">'SLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-77"><a href="#cb21-77"></a>    <span class="st">'LLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-78"><a href="#cb21-78"></a>    <span class="st">'Lev'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-79"><a href="#cb21-79"></a>    <span class="st">'Cash'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-80"><a href="#cb21-80"></a>    <span class="st">'ROA'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-81"><a href="#cb21-81"></a>    <span class="st">'ROE'</span>: <span class="st">'mean'</span></span>
<span id="cb21-82"><a href="#cb21-82"></a>}).reset_index()</span>
<span id="cb21-83"><a href="#cb21-83"></a></span>
<span id="cb21-84"><a href="#cb21-84"></a><span class="co"># 重命名列</span></span>
<span id="cb21-85"><a href="#cb21-85"></a>grouped.rename(columns<span class="op">=</span>{</span>
<span id="cb21-86"><a href="#cb21-86"></a>    <span class="st">'SLoan'</span>: <span class="st">'短期借款比率'</span>,</span>
<span id="cb21-87"><a href="#cb21-87"></a>    <span class="st">'LLoan'</span>: <span class="st">'长期借款比率'</span>,</span>
<span id="cb21-88"><a href="#cb21-88"></a>    <span class="st">'Lev'</span>: <span class="st">'总负债率'</span>,</span>
<span id="cb21-89"><a href="#cb21-89"></a>    <span class="st">'Cash'</span>: <span class="st">'现金比率'</span>,</span>
<span id="cb21-90"><a href="#cb21-90"></a>    <span class="st">'ROA'</span>: <span class="st">'资产收益率'</span>,</span>
<span id="cb21-91"><a href="#cb21-91"></a>    <span class="st">'ROE'</span>: <span class="st">'净资产收益率'</span></span>
<span id="cb21-92"><a href="#cb21-92"></a>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-93"><a href="#cb21-93"></a></span>
<span id="cb21-94"><a href="#cb21-94"></a><span class="co"># 按时间和行业排序</span></span>
<span id="cb21-95"><a href="#cb21-95"></a>grouped <span class="op">=</span> grouped.sort_values([<span class="st">'时间'</span>, <span class="st">'行业'</span>])</span>
<span id="cb21-96"><a href="#cb21-96"></a></span>
<span id="cb21-97"><a href="#cb21-97"></a><span class="co"># 5. 在控制台输出美观的实线表格</span></span>
<span id="cb21-98"><a href="#cb21-98"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">按行业和时间分组的财务指标平均值:"</span>)</span>
<span id="cb21-99"><a href="#cb21-99"></a></span>
<span id="cb21-100"><a href="#cb21-100"></a><span class="co"># 格式化百分比列</span></span>
<span id="cb21-101"><a href="#cb21-101"></a><span class="kw">def</span> format_percent(value):</span>
<span id="cb21-102"><a href="#cb21-102"></a>    <span class="co">"""将数值格式化为百分比字符串"""</span></span>
<span id="cb21-103"><a href="#cb21-103"></a>    <span class="cf">if</span> pd.isnull(value):</span>
<span id="cb21-104"><a href="#cb21-104"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb21-105"><a href="#cb21-105"></a>    <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">:.2%}</span><span class="ss">"</span></span>
<span id="cb21-106"><a href="#cb21-106"></a></span>
<span id="cb21-107"><a href="#cb21-107"></a><span class="co"># 应用格式化</span></span>
<span id="cb21-108"><a href="#cb21-108"></a>formatted_grouped <span class="op">=</span> grouped.copy()</span>
<span id="cb21-109"><a href="#cb21-109"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'短期借款比率'</span>, <span class="st">'长期借款比率'</span>, <span class="st">'总负债率'</span>, <span class="st">'现金比率'</span>, <span class="st">'资产收益率'</span>, <span class="st">'净资产收益率'</span>]:</span>
<span id="cb21-110"><a href="#cb21-110"></a>    formatted_grouped[col] <span class="op">=</span> formatted_grouped[col].<span class="bu">apply</span>(format_percent)</span>
<span id="cb21-111"><a href="#cb21-111"></a></span>
<span id="cb21-112"><a href="#cb21-112"></a><span class="co"># 使用tabulate创建美观的表格</span></span>
<span id="cb21-113"><a href="#cb21-113"></a>table <span class="op">=</span> tabulate(</span>
<span id="cb21-114"><a href="#cb21-114"></a>    formatted_grouped,</span>
<span id="cb21-115"><a href="#cb21-115"></a>    headers<span class="op">=</span>[</span>
<span id="cb21-116"><a href="#cb21-116"></a>        <span class="st">'行业'</span>, <span class="st">'年份'</span>, </span>
<span id="cb21-117"><a href="#cb21-117"></a>        <span class="st">'短期借款比率'</span>, <span class="st">'长期借款比率'</span>, </span>
<span id="cb21-118"><a href="#cb21-118"></a>        <span class="st">'总负债率'</span>, <span class="st">'现金比率'</span>,</span>
<span id="cb21-119"><a href="#cb21-119"></a>        <span class="st">'资产收益率'</span>, <span class="st">'净资产收益率'</span></span>
<span id="cb21-120"><a href="#cb21-120"></a>    ],</span>
<span id="cb21-121"><a href="#cb21-121"></a>    tablefmt<span class="op">=</span><span class="st">'grid'</span>,</span>
<span id="cb21-122"><a href="#cb21-122"></a>    stralign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-123"><a href="#cb21-123"></a>    numalign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-124"><a href="#cb21-124"></a>    showindex<span class="op">=</span><span class="va">False</span></span>
<span id="cb21-125"><a href="#cb21-125"></a>)</span>
<span id="cb21-126"><a href="#cb21-126"></a></span>
<span id="cb21-127"><a href="#cb21-127"></a><span class="co"># 打印表格</span></span>
<span id="cb21-128"><a href="#cb21-128"></a><span class="bu">print</span>(table)</span>
<span id="cb21-129"><a href="#cb21-129"></a></span>
<span id="cb21-130"><a href="#cb21-130"></a><span class="co"># 6. 按行业汇总并输出</span></span>
<span id="cb21-131"><a href="#cb21-131"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">按行业汇总的财务指标平均值:"</span>)</span>
<span id="cb21-132"><a href="#cb21-132"></a></span>
<span id="cb21-133"><a href="#cb21-133"></a><span class="co"># 计算行业平均值</span></span>
<span id="cb21-134"><a href="#cb21-134"></a>industry_summary <span class="op">=</span> grouped.groupby(<span class="st">'行业'</span>).agg({</span>
<span id="cb21-135"><a href="#cb21-135"></a>    <span class="st">'短期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-136"><a href="#cb21-136"></a>    <span class="st">'长期借款比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-137"><a href="#cb21-137"></a>    <span class="st">'总负债率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-138"><a href="#cb21-138"></a>    <span class="st">'现金比率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-139"><a href="#cb21-139"></a>    <span class="st">'资产收益率'</span>: <span class="st">'mean'</span>,</span>
<span id="cb21-140"><a href="#cb21-140"></a>    <span class="st">'净资产收益率'</span>: <span class="st">'mean'</span></span>
<span id="cb21-141"><a href="#cb21-141"></a>}).reset_index()</span>
<span id="cb21-142"><a href="#cb21-142"></a></span>
<span id="cb21-143"><a href="#cb21-143"></a><span class="co"># 应用格式化</span></span>
<span id="cb21-144"><a href="#cb21-144"></a>formatted_summary <span class="op">=</span> industry_summary.copy()</span>
<span id="cb21-145"><a href="#cb21-145"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'短期借款比率'</span>, <span class="st">'长期借款比率'</span>, <span class="st">'总负债率'</span>, <span class="st">'现金比率'</span>, <span class="st">'资产收益率'</span>, <span class="st">'净资产收益率'</span>]:</span>
<span id="cb21-146"><a href="#cb21-146"></a>    formatted_summary[col] <span class="op">=</span> formatted_summary[col].<span class="bu">apply</span>(format_percent)</span>
<span id="cb21-147"><a href="#cb21-147"></a></span>
<span id="cb21-148"><a href="#cb21-148"></a><span class="co"># 创建汇总表格</span></span>
<span id="cb21-149"><a href="#cb21-149"></a>summary_table <span class="op">=</span> tabulate(</span>
<span id="cb21-150"><a href="#cb21-150"></a>    formatted_summary,</span>
<span id="cb21-151"><a href="#cb21-151"></a>    headers<span class="op">=</span>[</span>
<span id="cb21-152"><a href="#cb21-152"></a>        <span class="st">'行业'</span>, </span>
<span id="cb21-153"><a href="#cb21-153"></a>        <span class="st">'短期借款比率'</span>, <span class="st">'长期借款比率'</span>, </span>
<span id="cb21-154"><a href="#cb21-154"></a>        <span class="st">'总负债率'</span>, <span class="st">'现金比率'</span>,</span>
<span id="cb21-155"><a href="#cb21-155"></a>        <span class="st">'资产收益率'</span>, <span class="st">'净资产收益率'</span></span>
<span id="cb21-156"><a href="#cb21-156"></a>    ],</span>
<span id="cb21-157"><a href="#cb21-157"></a>    tablefmt<span class="op">=</span><span class="st">'grid'</span>,</span>
<span id="cb21-158"><a href="#cb21-158"></a>    stralign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-159"><a href="#cb21-159"></a>    numalign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-160"><a href="#cb21-160"></a>    showindex<span class="op">=</span><span class="va">False</span></span>
<span id="cb21-161"><a href="#cb21-161"></a>)</span>
<span id="cb21-162"><a href="#cb21-162"></a></span>
<span id="cb21-163"><a href="#cb21-163"></a><span class="co"># 打印汇总表格</span></span>
<span id="cb21-164"><a href="#cb21-164"></a><span class="bu">print</span>(summary_table)</span>
<span id="cb21-165"><a href="#cb21-165"></a></span>
<span id="cb21-166"><a href="#cb21-166"></a><span class="co"># 7. 输出行业分布统计</span></span>
<span id="cb21-167"><a href="#cb21-167"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">行业分布统计:"</span>)</span>
<span id="cb21-168"><a href="#cb21-168"></a>industry_counts <span class="op">=</span> df[<span class="st">'行业'</span>].value_counts().reset_index()</span>
<span id="cb21-169"><a href="#cb21-169"></a>industry_counts.columns <span class="op">=</span> [<span class="st">'行业'</span>, <span class="st">'公司数量'</span>]</span>
<span id="cb21-170"><a href="#cb21-170"></a>industry_counts_table <span class="op">=</span> tabulate(</span>
<span id="cb21-171"><a href="#cb21-171"></a>    industry_counts,</span>
<span id="cb21-172"><a href="#cb21-172"></a>    headers<span class="op">=</span>[<span class="st">'行业'</span>, <span class="st">'公司数量'</span>],</span>
<span id="cb21-173"><a href="#cb21-173"></a>    tablefmt<span class="op">=</span><span class="st">'grid'</span>,</span>
<span id="cb21-174"><a href="#cb21-174"></a>    stralign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-175"><a href="#cb21-175"></a>    numalign<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb21-176"><a href="#cb21-176"></a>    showindex<span class="op">=</span><span class="va">False</span></span>
<span id="cb21-177"><a href="#cb21-177"></a>)</span>
<span id="cb21-178"><a href="#cb21-178"></a><span class="bu">print</span>(industry_counts_table)</span>
<span id="cb21-179"><a href="#cb21-179"></a></span>
<span id="cb21-180"><a href="#cb21-180"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">第七步处理完成!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>正在读取文件: /Users/wanshiqing/Desktop/python_code/merged_data.xlsx
数据读取成功! 共 145874 行记录

计算并新增财务指标字段...

创建行业字段...
发现无法映射的行业代码: ['I' 'M' 'n' 'N' 'H' 'S' 'L' 'A' 'Q' 'R' 'B' 'P' 'O']

按行业和时间分组计算平均值...

按行业和时间分组的财务指标平均值:
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|               行业               |  年份  |  短期借款比率  |  长期借款比率  |  总负债率  |  现金比率  |  资产收益率  |  净资产收益率  |
+==================================+========+================+================+============+============+==============+================+
|            交通运输业            |  2000  |     16.34%     |     2.55%      |   43.52%   |   21.27%   |    5.10%     |     8.94%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2000  |     22.89%     |     4.81%      |   52.70%   |   15.06%   |    1.24%     |     -2.90%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2000  |     15.64%     |     5.18%      |   42.53%   |   16.49%   |    3.40%     |     3.85%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2000  |     20.16%     |     3.72%      |   58.59%   |   13.26%   |    1.68%     |     -1.40%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2000  |     10.05%     |     6.27%      |   33.74%   |   17.97%   |    3.54%     |     2.60%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2000  |     11.44%     |     7.57%      |   41.43%   |   17.86%   |    4.53%     |     7.90%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2000  |     8.59%      |     8.18%      |   35.02%   |   14.16%   |    5.08%     |     8.68%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2000  |     21.99%     |     3.45%      |   49.28%   |   11.12%   |    1.74%     |     3.91%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2001  |     19.46%     |     2.74%      |   47.08%   |   23.60%   |    1.85%     |     12.64%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2001  |     23.85%     |     6.33%      |   60.50%   |   15.46%   |    -4.35%    |     -0.13%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2001  |     18.15%     |     5.52%      |   47.59%   |   17.99%   |    -2.26%    |     1.21%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2001  |     17.44%     |     4.05%      |   58.85%   |   16.25%   |    0.85%     |     1.37%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2001  |     10.28%     |     6.20%      |   35.72%   |   19.02%   |    3.86%     |     6.36%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2001  |     10.23%     |     8.93%      |   35.71%   |   16.76%   |    4.46%     |     6.61%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2001  |     8.06%      |     9.36%      |   34.27%   |   15.06%   |    5.32%     |     8.41%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2001  |     23.39%     |     3.87%      |   59.41%   |   13.58%   |    0.03%     |    -33.61%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2002  |     19.51%     |     2.54%      |   48.26%   |   24.25%   |    1.53%     |     1.29%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2002  |     24.88%     |     4.32%      |   62.60%   |   13.98%   |    -6.41%    |     2.59%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2002  |     18.76%     |     5.29%      |   49.51%   |   16.51%   |    -0.82%    |     36.96%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2002  |     14.91%     |     5.92%      |   58.31%   |   14.67%   |    0.59%     |     -5.18%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2002  |     12.32%     |     3.52%      |   36.52%   |   15.11%   |    3.78%     |     5.19%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2002  |     10.93%     |     7.91%      |   36.25%   |   15.12%   |    4.01%     |     5.42%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2002  |     9.95%      |     12.11%     |   38.95%   |   14.81%   |    4.37%     |     7.18%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2002  |     21.75%     |     5.09%      |   56.45%   |   13.46%   |    -4.85%    |    -29.99%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2003  |     20.75%     |     2.07%      |   51.40%   |   24.48%   |    -7.24%    |     5.89%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2003  |     27.73%     |     4.44%      |   72.74%   |   14.15%   |    -2.93%    |     2.24%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2003  |     19.42%     |     5.50%      |   50.41%   |   15.49%   |    1.59%     |     0.58%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2003  |     16.90%     |     6.28%      |   60.71%   |   15.70%   |    -1.67%    |     7.45%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2003  |     14.79%     |     5.33%      |   40.85%   |   13.14%   |    0.94%     |     5.38%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2003  |     12.35%     |     8.13%      |   36.07%   |   15.31%   |    4.16%     |     3.17%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2003  |     10.41%     |     14.39%     |   41.76%   |   11.97%   |    4.44%     |     7.19%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2003  |     21.83%     |     6.18%      |   60.16%   |   13.26%   |    0.23%     |    -22.58%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2004  |     27.31%     |     1.52%      |   69.22%   |   21.84%   |   -26.16%    |     5.63%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2004  |     27.98%     |     4.89%      |   76.73%   |   14.09%   |    -5.19%    |     -0.33%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2004  |     20.54%     |     5.60%      |   54.53%   |   15.25%   |    0.17%     |     -4.72%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2004  |     17.13%     |     5.91%      |   73.06%   |   15.93%   |    -6.80%    |     7.38%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2004  |     15.02%     |     6.85%      |   45.63%   |   12.50%   |    3.66%     |     7.33%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2004  |     11.68%     |     7.60%      |   38.06%   |   27.36%   |    5.26%     |     7.17%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2004  |     11.89%     |     17.56%     |   45.44%   |   11.07%   |    3.71%     |     7.39%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2004  |     21.50%     |     7.43%      |   66.55%   |   13.09%   |    2.65%     |     2.59%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2005  |     21.25%     |     1.68%      |   64.84%   |   59.56%   |    -8.16%    |     0.68%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2005  |     25.19%     |     4.88%      |   77.25%   |   12.86%   |    -0.77%    |    -21.77%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2005  |     22.61%     |     5.25%      |   64.12%   |   22.34%   |    -2.05%    |     1.35%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2005  |     15.00%     |     7.97%      |   65.77%   |   12.90%   |    2.01%     |     6.34%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2005  |     15.55%     |     7.53%      |   47.73%   |   11.37%   |    2.57%     |     1.21%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2005  |     11.80%     |     8.80%      |   43.23%   |   13.35%   |    1.41%     |     12.34%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2005  |     11.89%     |     18.98%     |   48.91%   |   9.26%    |    2.25%     |     -2.85%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2005  |     20.39%     |     7.55%      |   73.13%   |   11.71%   |    0.31%     |     2.93%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2006  |     27.90%     |     1.70%      |   91.16%   |   22.04%   |   -18.07%    |     4.81%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2006  |     23.64%     |     5.08%      |   82.76%   |   13.30%   |    0.82%     |    143.31%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2006  |     76.99%     |     5.06%      |  169.35%   |   13.33%   |   -255.87%   |     59.48%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2006  |     13.52%     |     6.73%      |   64.36%   |   15.97%   |    2.47%     |     6.80%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2006  |     12.87%     |     7.24%      |   47.58%   |   13.10%   |    2.72%     |     3.48%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2006  |     13.62%     |     9.56%      |   48.58%   |   13.81%   |    3.55%     |     11.83%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2006  |     14.43%     |     18.82%     |   52.53%   |   25.59%   |    3.05%     |     6.43%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2006  |     14.38%     |     10.87%     |   64.89%   |   10.83%   |    2.28%     |     -3.39%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2007  |     24.70%     |     1.98%      |  202.35%   |   24.01%   |   781.51%    |     -1.15%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2007  |     20.82%     |     5.20%      |   82.73%   |   15.65%   |    4.07%     |     8.36%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2007  |     22.24%     |     4.61%      |   70.52%   |   14.20%   |    8.84%     |     7.59%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2007  |     14.32%     |     6.31%      |   67.75%   |   15.25%   |    2.85%     |     10.39%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2007  |     13.00%     |     6.21%      |   43.44%   |   16.95%   |    6.97%     |     12.68%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2007  |     15.73%     |     10.23%     |   57.40%   |   12.60%   |    6.06%     |    265.64%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2007  |     15.26%     |     18.92%     |   53.05%   |   8.45%    |    3.81%     |     8.05%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2007  |     9.73%      |     11.63%     |   70.34%   |   15.18%   |    9.94%     |     2.00%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2008  |     14.13%     |     1.08%      |  225.89%   |   25.29%   |  22778.90%   |    -158.04%    |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2008  |     22.05%     |     5.46%      |  102.86%   |   15.70%   |    -4.18%    |     12.50%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2008  |     20.72%     |     4.57%      |   64.15%   |   14.45%   |    2.06%     |     1.17%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2008  |     14.49%     |     7.24%      |   69.90%   |   13.15%   |    0.60%     |     3.79%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2008  |     14.56%     |     6.43%      |   43.88%   |   13.75%   |    3.53%     |     8.95%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2008  |     10.82%     |     11.79%     |   45.95%   |   12.36%   |    6.78%     |    -11.13%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2008  |     17.02%     |     24.19%     |   60.54%   |   8.13%    |    -0.26%    |     -4.17%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2008  |     9.41%      |     11.42%     |   76.63%   |   11.47%   |    5.63%     |     7.74%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2009  |     11.45%     |     1.56%      |  205.86%   |   34.51%   |   -40.08%    |     12.20%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2009  |     15.21%     |     6.03%      |   79.77%   |   18.05%   |    2.38%     |     8.47%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2009  |     16.25%     |     5.35%      |   56.28%   |   18.71%   |    4.43%     |    -26.28%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2009  |     10.03%     |     7.76%      |   68.09%   |   19.03%   |    2.14%     |     6.70%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2009  |     14.98%     |     6.73%      |   49.25%   |   21.35%   |    -4.11%    |     11.26%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2009  |     8.58%      |     12.20%     |   44.76%   |   14.00%   |    4.07%     |     7.64%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2009  |     14.16%     |     24.51%     |   61.80%   |   8.97%    |    1.50%     |     10.43%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2009  |     6.23%      |     13.95%     |  117.00%   |   16.72%   |    4.22%     |     9.63%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2010  |     8.49%      |     1.15%      |   66.82%   |   40.39%   |    -0.14%    |     9.13%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2010  |     11.13%     |     6.00%      |   70.35%   |   21.16%   |    5.10%     |     13.11%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2010  |     12.65%     |     4.20%      |   48.79%   |   23.98%   |    5.05%     |     11.48%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2010  |     7.64%      |     8.33%      |   65.43%   |   20.21%   |    4.29%     |     12.15%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2010  |     10.91%     |     6.44%      |   46.88%   |   24.88%   |    5.80%     |     -4.76%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2010  |     7.22%      |     14.25%     |   44.49%   |   14.65%   |    5.46%     |     9.59%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2010  |     12.98%     |     23.09%     |   59.80%   |   10.27%   |    2.89%     |     5.50%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2010  |     6.06%      |     14.14%     |   68.41%   |   15.51%   |    3.10%     |     14.72%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2011  |     5.52%      |     1.59%      |   35.84%   |   39.38%   |    6.15%     |     9.62%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2011  |     10.87%     |     4.91%      |   61.65%   |   20.68%   |    9.41%     |    163.09%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2011  |     12.49%     |     3.34%      |   44.28%   |   22.34%   |    6.21%     |     55.38%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2011  |     9.88%      |     6.57%      |   65.20%   |   19.40%   |    3.50%     |     10.59%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2011  |     7.41%      |     6.22%      |   38.71%   |   26.76%   |    5.12%     |     8.52%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2011  |     6.74%      |     12.65%     |   45.78%   |   14.69%   |    4.53%     |     4.05%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2011  |     12.64%     |     22.52%     |   60.76%   |   9.24%    |    2.40%     |     4.83%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2011  |     5.36%      |     12.99%     |   62.64%   |   12.44%   |    3.24%     |     10.62%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2012  |     7.74%      |     11.15%     |   45.82%   |   13.67%   |    4.52%     |     13.51%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2012  |     8.93%      |     4.34%      |   47.85%   |   24.37%   |    4.36%     |     13.72%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2012  |     11.80%     |     2.99%      |   42.86%   |   20.51%   |    3.83%     |     7.85%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2012  |     10.67%     |     6.36%      |   65.86%   |   16.42%   |    3.20%     |     9.21%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2012  |     5.27%      |     13.73%     |   62.84%   |   12.77%   |    3.04%     |     10.08%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2012  |     13.35%     |     3.05%      |   55.12%   |   20.32%   |    3.67%     |     8.41%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2012  |     11.34%     |     19.58%     |   57.89%   |   9.63%    |    3.01%     |     7.03%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2012  |     0.21%      |     0.02%      |   70.09%   |   28.08%   |    1.98%     |     10.60%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2013  |     11.11%     |     11.04%     |   55.58%   |   12.12%   |    -5.24%    |     6.32%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2013  |     8.83%      |     4.37%      |   40.93%   |   20.97%   |    7.07%     |     50.23%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2013  |     11.72%     |     2.98%      |   41.37%   |   16.72%   |    11.26%    |     25.25%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2013  |     10.02%     |     7.35%      |   68.62%   |   15.50%   |    2.70%     |     7.75%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2013  |     5.28%      |     16.35%     |   62.76%   |   12.46%   |    3.09%     |     9.14%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2013  |     13.28%     |     3.64%      |   56.35%   |   18.74%   |    3.10%     |     6.68%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2013  |     10.46%     |     19.00%     |   57.01%   |   9.30%    |    4.12%     |     7.80%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2013  |     0.60%      |     0.43%      |   73.35%   |   21.08%   |    2.36%     |     12.04%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2014  |     6.85%      |     11.04%     |   45.25%   |   11.72%   |    13.94%    |     60.70%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2014  |     8.64%      |     4.27%      |   41.52%   |   18.35%   |    4.23%     |     4.80%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2014  |     11.19%     |     2.73%      |   45.27%   |   15.00%   |    0.41%     |     0.21%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2014  |     9.90%      |     6.07%      |   68.36%   |   12.86%   |    2.41%     |     7.58%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2014  |     5.69%      |     15.52%     |   63.35%   |   10.53%   |    1.84%     |     -1.42%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2014  |     13.00%     |     3.71%      |   58.01%   |   17.33%   |    2.28%     |     0.92%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2014  |     8.64%      |     18.92%     |   56.16%   |   9.70%    |    3.23%     |     6.72%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2014  |     0.69%      |     0.99%      |   79.69%   |   20.83%   |    2.82%     |     13.89%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2015  |     5.95%      |     10.39%     |   43.58%   |   12.15%   |    4.49%     |     8.29%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2015  |     8.33%      |     3.74%      |   40.96%   |   18.34%   |    4.29%     |     7.64%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2015  |     10.43%     |     2.62%      |   39.79%   |   15.43%   |    3.22%     |     1.79%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2015  |     10.52%     |     5.88%      |   64.28%   |   14.90%   |    2.46%     |     6.77%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2015  |     6.23%      |     14.08%     |   63.98%   |   13.08%   |    0.80%     |     3.15%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2015  |     12.36%     |     3.43%      |   54.52%   |   16.94%   |    2.73%     |     4.05%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2015  |     9.00%      |     18.36%     |   54.95%   |   10.24%   |    4.17%     |     7.84%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2015  |     1.39%      |     0.68%      |   80.49%   |   23.19%   |    2.94%     |     15.81%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2016  |     5.86%      |     13.02%     |   43.61%   |   11.81%   |    3.78%     |     5.75%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2016  |     7.25%      |     7.05%      |   39.15%   |   19.43%   |    4.65%     |     7.14%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2016  |     8.88%      |     4.62%      |   38.42%   |   15.95%   |    4.80%     |     9.01%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2016  |     9.21%      |     7.54%      |   61.33%   |   15.83%   |    2.05%     |     6.20%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2016  |     4.12%      |     15.36%     |   64.38%   |   16.57%   |    1.94%     |     7.34%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2016  |     10.35%     |     5.69%      |   52.05%   |   17.05%   |    2.97%     |     5.54%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2016  |     7.27%      |     19.19%     |   53.53%   |   9.51%    |    3.78%     |     7.98%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2016  |     1.42%      |     2.13%      |   78.72%   |   18.00%   |    1.71%     |     9.50%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2017  |     9.60%      |     12.87%     |   42.07%   |   12.85%   |    5.34%     |     9.33%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2017  |     10.81%     |     7.24%      |   39.94%   |   18.07%   |    3.79%     |    -17.38%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2017  |     12.10%     |     5.27%      |   38.20%   |   15.24%   |    4.77%     |     18.55%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2017  |     11.37%     |     8.34%      |   61.82%   |   14.32%   |    -0.26%    |    -47.27%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2017  |     6.26%      |     15.74%     |   64.24%   |   14.75%   |    2.78%     |     8.13%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2017  |     13.21%     |     5.66%      |   52.58%   |   17.01%   |    2.49%     |     -5.70%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2017  |     11.56%     |     19.54%     |   53.23%   |   10.89%   |    2.79%     |     4.19%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2017  |     4.20%      |     5.89%      |   77.41%   |   14.73%   |    1.48%     |     8.13%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2018  |     10.37%     |     12.68%     |   47.10%   |   11.37%   |    -0.51%    |     7.54%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2018  |     11.61%     |     7.27%      |   45.82%   |   16.31%   |    -4.07%    |    -38.08%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2018  |     12.61%     |     5.34%      |   40.40%   |   13.75%   |    2.98%     |     -0.25%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2018  |     18.76%     |     7.93%      |   92.98%   |   13.30%   |   -28.83%    |     -5.85%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2018  |     4.74%      |     14.66%     |   64.34%   |   13.85%   |    1.96%     |    -19.15%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2018  |     14.20%     |     4.88%      |   54.68%   |   15.71%   |    1.18%     |    -117.53%    |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2018  |     11.65%     |     18.63%     |   54.76%   |   10.10%   |    1.86%     |     -3.57%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2018  |     3.58%      |     4.73%      |   76.85%   |   13.31%   |    0.96%     |     6.38%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2019  |     9.32%      |     14.33%     |   47.43%   |   11.32%   |    3.73%     |     10.92%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2019  |     10.67%     |     7.20%      |   43.13%   |   16.59%   |    1.11%     |     0.99%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2019  |     12.42%     |     5.47%      |   42.16%   |   14.50%   |    0.78%     |     -2.76%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2019  |     10.21%     |     8.74%      |   66.17%   |   12.39%   |    1.32%     |     0.55%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2019  |     4.83%      |     13.61%     |   63.09%   |   12.60%   |    2.28%     |     4.94%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2019  |     14.27%     |     5.27%      |   54.21%   |   14.52%   |    1.65%     |     -3.84%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2019  |     11.00%     |     18.30%     |   55.16%   |   8.91%    |    1.72%     |     -2.43%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2019  |     3.53%      |     5.16%      |   76.19%   |   15.25%   |    0.41%     |     4.88%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2020  |     9.29%      |     14.46%     |   48.19%   |   12.28%   |    1.88%     |     5.20%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2020  |     9.69%      |     7.89%      |   42.25%   |   18.90%   |    1.77%     |     4.71%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2020  |     12.43%     |     5.68%      |   45.88%   |   17.07%   |    3.14%     |     5.03%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2020  |     8.66%      |     9.37%      |   65.08%   |   13.71%   |    0.85%     |     2.54%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2020  |     4.66%      |     14.09%     |   64.32%   |   13.45%   |    -0.35%    |     11.68%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2020  |     13.60%     |     5.55%      |   54.26%   |   17.07%   |    1.18%     |     1.18%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2020  |     10.14%     |     18.42%     |   55.97%   |   9.65%    |    2.82%     |     7.85%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2020  |     3.49%      |     5.31%      |   74.87%   |   16.89%   |   -10.48%    |    -18.41%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2021  |     7.20%      |     14.06%     |   45.30%   |   13.18%   |    3.76%     |     3.52%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2021  |     8.89%      |     7.81%      |   42.60%   |   19.30%   |    1.71%     |     -2.76%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2021  |     10.05%     |     5.65%      |   39.19%   |   16.74%   |    4.61%     |     2.30%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2021  |     8.05%      |     8.80%      |   67.63%   |   13.07%   |    -3.28%    |    -33.35%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2021  |     4.07%      |     12.58%     |   65.74%   |   11.28%   |    0.35%     |     -5.36%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2021  |     11.92%     |     5.53%      |   53.61%   |   15.97%   |    1.92%     |     -1.21%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2021  |     9.41%      |     19.35%     |   57.24%   |   10.02%   |    0.95%     |     -5.53%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2021  |     3.44%      |     4.23%      |   77.55%   |   16.56%   |    0.38%     |     8.43%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2022  |     7.34%      |     13.48%     |   44.78%   |   14.73%   |    3.28%     |    -39.42%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2022  |     8.43%      |     7.51%      |   41.17%   |   19.84%   |    0.39%     |     -4.06%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2022  |     9.16%      |     6.14%      |   38.15%   |   17.79%   |    3.70%     |     4.70%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2022  |     8.10%      |     8.93%      |   69.74%   |   12.34%   |    -2.15%    |     9.09%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2022  |     4.27%      |     12.89%     |   66.54%   |   10.90%   |    -1.16%    |     -6.65%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2022  |     12.54%     |     5.28%      |   54.11%   |   14.65%   |    1.44%     |     -1.68%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2022  |     8.78%      |     20.31%     |   55.61%   |   11.18%   |    2.44%     |     6.27%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2022  |     3.68%      |     4.02%      |   78.43%   |   16.39%   |    0.41%     |     -6.17%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2023  |     7.20%      |     14.24%     |   44.02%   |   13.90%   |    3.68%     |     7.45%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2023  |     8.13%      |     8.16%      |   40.36%   |   19.81%   |    0.94%     |     90.45%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2023  |     8.44%      |     6.95%      |   37.96%   |   17.66%   |    2.69%     |     2.50%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2023  |     6.94%      |     10.41%     |   68.51%   |   12.33%   |    -0.15%    |    -15.90%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2023  |     4.41%      |     13.61%     |   62.33%   |   11.41%   |    -0.11%    |     -4.76%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2023  |     12.22%     |     5.75%      |   53.54%   |   14.95%   |    0.49%     |     -0.09%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2023  |     8.00%      |     21.87%     |   54.74%   |   10.47%   |    3.24%     |     11.07%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2023  |     2.82%      |     5.09%      |   77.09%   |   16.02%   |    0.80%     |     4.44%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|            交通运输业            |  2024  |     4.10%      |     15.01%     |   41.01%   |   13.40%   |    4.65%     |     7.09%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |  2024  |     8.64%      |     8.05%      |   41.94%   |   15.48%   |    0.68%     |     -0.07%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |  2024  |     8.38%      |     7.00%      |   39.24%   |   15.89%   |    3.87%     |     7.37%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |  2024  |     4.31%      |     12.60%     |   67.78%   |   15.12%   |    1.78%     |     -0.10%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |  2024  |     1.59%      |     19.28%     |   57.90%   |   18.32%   |    -0.48%    |     -4.52%     |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |  2024  |     9.50%      |     8.56%      |   52.26%   |   12.68%   |    1.58%     |     2.99%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |  2024  |     7.29%      |     23.88%     |   56.15%   |   9.17%    |    3.41%     |     6.57%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |  2024  |     1.70%      |     4.63%      |   80.81%   |   17.37%   |    1.37%     |     7.85%      |
+----------------------------------+--------+----------------+----------------+------------+------------+--------------+----------------+


按行业汇总的财务指标平均值:
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|               行业               |  短期借款比率  |  长期借款比率  |  总负债率  |  现金比率  |  资产收益率  |  净资产收益率  |
+==================================+================+================+============+============+==============+================+
|            交通运输业            |     12.75%     |     7.60%      |   69.84%   |   21.01%   |   940.90%    |     0.71%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|             其他行业             |     15.00%     |     5.89%      |   57.21%   |   17.43%   |    1.20%     |     17.83%     |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|              制造业              |     16.64%     |     4.92%      |   51.64%   |   16.93%   |    -7.17%    |     9.18%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|              建筑业              |     11.92%     |     7.40%      |   66.57%   |   14.95%   |    -0.22%    |     0.54%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|             房地产业             |     8.53%      |     10.66%     |   53.43%   |   15.12%   |    2.17%     |     3.23%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|           批发和零售业           |     11.80%     |     7.42%      |   48.92%   |   16.03%   |    3.24%     |     9.20%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
| 电力、热力、燃气及水生产和供应业 |     10.87%     |     18.72%     |   52.61%   |   11.03%   |    3.05%     |     5.15%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+
|              金融业              |     8.51%      |     6.08%      |   73.06%   |   15.84%   |    1.43%     |     1.68%      |
+----------------------------------+----------------+----------------+------------+------------+--------------+----------------+


行业分布统计:
+----------------------------------+------------+
|               行业               |  公司数量  |
+==================================+============+
|             其他行业             |   92759    |
+----------------------------------+------------+
|              制造业              |   40346    |
+----------------------------------+------------+
|           批发和零售业           |    2770    |
+----------------------------------+------------+
|            交通运输业            |    2447    |
+----------------------------------+------------+
|             房地产业             |    2065    |
+----------------------------------+------------+
|              金融业              |    2027    |
+----------------------------------+------------+
| 电力、热力、燃气及水生产和供应业 |    2004    |
+----------------------------------+------------+
|              建筑业              |    1456    |
+----------------------------------+------------+

第七步处理完成!</code></pre>
</div>
</div>
<div id="b953c389" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="im">import</span> matplotlib.font_manager <span class="im">as</span> fm</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="im">import</span> os</span>
<span id="cb23-7"><a href="#cb23-7"></a></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co"># 设置中文字体（适用于Mac系统）</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="cf">try</span>:</span>
<span id="cb23-10"><a href="#cb23-10"></a>    <span class="co"># 尝试查找 macOS 系统自带的中文字体</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>    font_names <span class="op">=</span> [<span class="st">'Songti SC'</span>, <span class="st">'STHeiti'</span>, <span class="st">'PingFang SC'</span>, <span class="st">'Hiragino Sans GB'</span>, <span class="st">'Arial Unicode MS'</span>]</span>
<span id="cb23-12"><a href="#cb23-12"></a>    available_fonts <span class="op">=</span> [f.name <span class="cf">for</span> f <span class="kw">in</span> fm.fontManager.ttflist]</span>
<span id="cb23-13"><a href="#cb23-13"></a>    </span>
<span id="cb23-14"><a href="#cb23-14"></a>    <span class="co"># 寻找可用的中文字体</span></span>
<span id="cb23-15"><a href="#cb23-15"></a>    chinese_font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-16"><a href="#cb23-16"></a>    <span class="cf">for</span> font <span class="kw">in</span> font_names:</span>
<span id="cb23-17"><a href="#cb23-17"></a>        <span class="cf">if</span> font <span class="kw">in</span> available_fonts:</span>
<span id="cb23-18"><a href="#cb23-18"></a>            chinese_font <span class="op">=</span> font</span>
<span id="cb23-19"><a href="#cb23-19"></a>            <span class="cf">break</span></span>
<span id="cb23-20"><a href="#cb23-20"></a>    </span>
<span id="cb23-21"><a href="#cb23-21"></a>    <span class="co"># 如果找到可用字体，设置matplotlib使用它</span></span>
<span id="cb23-22"><a href="#cb23-22"></a>    <span class="cf">if</span> chinese_font:</span>
<span id="cb23-23"><a href="#cb23-23"></a>        plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [chinese_font]</span>
<span id="cb23-24"><a href="#cb23-24"></a>        <span class="bu">print</span>(<span class="ss">f"使用中文字体: </span><span class="sc">{</span>chinese_font<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-25"><a href="#cb23-25"></a>    <span class="cf">else</span>:</span>
<span id="cb23-26"><a href="#cb23-26"></a>        <span class="bu">print</span>(<span class="st">"未找到系统自带中文字体，使用英文标签"</span>)</span>
<span id="cb23-27"><a href="#cb23-27"></a>        USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-28"><a href="#cb23-28"></a>    plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># 用来正常显示负号</span></span>
<span id="cb23-29"><a href="#cb23-29"></a><span class="cf">except</span>:</span>
<span id="cb23-30"><a href="#cb23-30"></a>    <span class="bu">print</span>(<span class="st">"字体设置失败，使用英文标签"</span>)</span>
<span id="cb23-31"><a href="#cb23-31"></a>    USE_CHINESE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-32"><a href="#cb23-32"></a></span>
<span id="cb23-33"><a href="#cb23-33"></a><span class="co"># 1. 读取文件</span></span>
<span id="cb23-34"><a href="#cb23-34"></a>input_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/python_code/merged_data.xlsx'</span></span>
<span id="cb23-35"><a href="#cb23-35"></a><span class="bu">print</span>(<span class="ss">f"正在读取文件: </span><span class="sc">{</span>input_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-36"><a href="#cb23-36"></a>df <span class="op">=</span> pd.read_excel(input_path)</span>
<span id="cb23-37"><a href="#cb23-37"></a><span class="bu">print</span>(<span class="ss">f"数据读取成功! 共 </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> 行记录"</span>)</span>
<span id="cb23-38"><a href="#cb23-38"></a></span>
<span id="cb23-39"><a href="#cb23-39"></a><span class="co"># 2. 筛选指定年份的数据</span></span>
<span id="cb23-40"><a href="#cb23-40"></a>selected_years <span class="op">=</span> {<span class="dv">2001</span>, <span class="dv">2003</span>, <span class="dv">2005</span>, <span class="dv">2007</span>, <span class="dv">2009</span>, <span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2021</span>, <span class="dv">2023</span>}</span>
<span id="cb23-41"><a href="#cb23-41"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">筛选年份: </span><span class="sc">{</span><span class="bu">sorted</span>(selected_years)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-42"><a href="#cb23-42"></a></span>
<span id="cb23-43"><a href="#cb23-43"></a><span class="co"># 确保时间字段存在</span></span>
<span id="cb23-44"><a href="#cb23-44"></a><span class="cf">if</span> <span class="st">'时间'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-45"><a href="#cb23-45"></a>    <span class="co"># 尝试查找可能的替代字段</span></span>
<span id="cb23-46"><a href="#cb23-46"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> <span class="st">'时间'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'year'</span> <span class="kw">in</span> col.lower() <span class="kw">or</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb23-47"><a href="#cb23-47"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb23-48"><a href="#cb23-48"></a>        df.rename(columns<span class="op">=</span>{possible_cols[<span class="dv">0</span>]: <span class="st">'时间'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-49"><a href="#cb23-49"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为时间: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-50"><a href="#cb23-50"></a>    <span class="cf">else</span>:</span>
<span id="cb23-51"><a href="#cb23-51"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到时间字段"</span>)</span>
<span id="cb23-52"><a href="#cb23-52"></a></span>
<span id="cb23-53"><a href="#cb23-53"></a><span class="co"># 筛选数据</span></span>
<span id="cb23-54"><a href="#cb23-54"></a>filtered_df <span class="op">=</span> df[df[<span class="st">'时间'</span>].isin(selected_years)].copy()</span>
<span id="cb23-55"><a href="#cb23-55"></a><span class="bu">print</span>(<span class="ss">f"筛选后数据量: </span><span class="sc">{</span><span class="bu">len</span>(filtered_df)<span class="sc">}</span><span class="ss"> 行"</span>)</span>
<span id="cb23-56"><a href="#cb23-56"></a></span>
<span id="cb23-57"><a href="#cb23-57"></a><span class="co"># 3. 检查股权集中度1字段</span></span>
<span id="cb23-58"><a href="#cb23-58"></a><span class="cf">if</span> <span class="st">'股权集中度1'</span> <span class="kw">not</span> <span class="kw">in</span> filtered_df.columns:</span>
<span id="cb23-59"><a href="#cb23-59"></a>    <span class="co"># 尝试查找可能的替代字段</span></span>
<span id="cb23-60"><a href="#cb23-60"></a>    possible_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> filtered_df.columns <span class="cf">if</span> <span class="st">'股权集中度'</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">'top1'</span> <span class="kw">in</span> col.lower()]</span>
<span id="cb23-61"><a href="#cb23-61"></a>    <span class="cf">if</span> possible_cols:</span>
<span id="cb23-62"><a href="#cb23-62"></a>        filtered_df.rename(columns<span class="op">=</span>{possible_cols[<span class="dv">0</span>]: <span class="st">'股权集中度1'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-63"><a href="#cb23-63"></a>        <span class="bu">print</span>(<span class="ss">f"使用替代字段作为股权集中度1: </span><span class="sc">{</span>possible_cols[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-64"><a href="#cb23-64"></a>    <span class="cf">else</span>:</span>
<span id="cb23-65"><a href="#cb23-65"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"无法找到股权集中度1字段"</span>)</span>
<span id="cb23-66"><a href="#cb23-66"></a></span>
<span id="cb23-67"><a href="#cb23-67"></a><span class="co"># 重命名列以便使用</span></span>
<span id="cb23-68"><a href="#cb23-68"></a>filtered_df.rename(columns<span class="op">=</span>{<span class="st">'股权集中度1'</span>: <span class="st">'Top1'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-69"><a href="#cb23-69"></a></span>
<span id="cb23-70"><a href="#cb23-70"></a><span class="co"># 4. 绘制箱线图</span></span>
<span id="cb23-71"><a href="#cb23-71"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb23-72"><a href="#cb23-72"></a></span>
<span id="cb23-73"><a href="#cb23-73"></a><span class="co"># 使用seaborn绘制箱线图</span></span>
<span id="cb23-74"><a href="#cb23-74"></a>sns.boxplot(</span>
<span id="cb23-75"><a href="#cb23-75"></a>    x<span class="op">=</span><span class="st">'时间'</span>, </span>
<span id="cb23-76"><a href="#cb23-76"></a>    y<span class="op">=</span><span class="st">'Top1'</span>, </span>
<span id="cb23-77"><a href="#cb23-77"></a>    data<span class="op">=</span>filtered_df,</span>
<span id="cb23-78"><a href="#cb23-78"></a>    palette<span class="op">=</span><span class="st">'viridis'</span>,</span>
<span id="cb23-79"><a href="#cb23-79"></a>    showfliers<span class="op">=</span><span class="va">True</span>,  <span class="co"># 显示离群值</span></span>
<span id="cb23-80"><a href="#cb23-80"></a>    flierprops<span class="op">=</span><span class="bu">dict</span>(marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>, markerfacecolor<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)  <span class="co"># 离群点样式</span></span>
<span id="cb23-81"><a href="#cb23-81"></a>)</span>
<span id="cb23-82"><a href="#cb23-82"></a></span>
<span id="cb23-83"><a href="#cb23-83"></a><span class="co"># 添加散点图显示数据分布</span></span>
<span id="cb23-84"><a href="#cb23-84"></a>sns.stripplot(</span>
<span id="cb23-85"><a href="#cb23-85"></a>    x<span class="op">=</span><span class="st">'时间'</span>, </span>
<span id="cb23-86"><a href="#cb23-86"></a>    y<span class="op">=</span><span class="st">'Top1'</span>, </span>
<span id="cb23-87"><a href="#cb23-87"></a>    data<span class="op">=</span>filtered_df,</span>
<span id="cb23-88"><a href="#cb23-88"></a>    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb23-89"><a href="#cb23-89"></a>    alpha<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb23-90"><a href="#cb23-90"></a>    jitter<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb23-91"><a href="#cb23-91"></a>    size<span class="op">=</span><span class="dv">3</span></span>
<span id="cb23-92"><a href="#cb23-92"></a>)</span>
<span id="cb23-93"><a href="#cb23-93"></a></span>
<span id="cb23-94"><a href="#cb23-94"></a><span class="co"># 设置标题和标签</span></span>
<span id="cb23-95"><a href="#cb23-95"></a><span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb23-96"><a href="#cb23-96"></a>    plt.title(<span class="st">'Top1 Shareholder Concentration by Year (2001-2023)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb23-97"><a href="#cb23-97"></a>    plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-98"><a href="#cb23-98"></a>    plt.ylabel(<span class="st">'Top1 Concentration (%)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-99"><a href="#cb23-99"></a><span class="cf">else</span>:</span>
<span id="cb23-100"><a href="#cb23-100"></a>    plt.title(<span class="st">'股权集中度(Top1)年度分布 (2001-2023)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb23-101"><a href="#cb23-101"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-102"><a href="#cb23-102"></a>    plt.ylabel(<span class="st">'股权集中度(Top1, %)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-103"><a href="#cb23-103"></a></span>
<span id="cb23-104"><a href="#cb23-104"></a><span class="co"># 设置网格</span></span>
<span id="cb23-105"><a href="#cb23-105"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb23-106"><a href="#cb23-106"></a></span>
<span id="cb23-107"><a href="#cb23-107"></a><span class="co"># 设置y轴为百分比格式</span></span>
<span id="cb23-108"><a href="#cb23-108"></a>plt.gca().yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, _: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">%'</span>))</span>
<span id="cb23-109"><a href="#cb23-109"></a></span>
<span id="cb23-110"><a href="#cb23-110"></a><span class="co"># 调整x轴标签</span></span>
<span id="cb23-111"><a href="#cb23-111"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-112"><a href="#cb23-112"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-113"><a href="#cb23-113"></a></span>
<span id="cb23-114"><a href="#cb23-114"></a><span class="co"># 添加均值线</span></span>
<span id="cb23-115"><a href="#cb23-115"></a><span class="cf">for</span> year <span class="kw">in</span> selected_years:</span>
<span id="cb23-116"><a href="#cb23-116"></a>    year_data <span class="op">=</span> filtered_df[filtered_df[<span class="st">'时间'</span>] <span class="op">==</span> year][<span class="st">'Top1'</span>]</span>
<span id="cb23-117"><a href="#cb23-117"></a>    <span class="cf">if</span> <span class="kw">not</span> year_data.empty:</span>
<span id="cb23-118"><a href="#cb23-118"></a>        mean_value <span class="op">=</span> year_data.mean()</span>
<span id="cb23-119"><a href="#cb23-119"></a>        plt.axhline(mean_value, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb23-120"><a href="#cb23-120"></a>        plt.text(</span>
<span id="cb23-121"><a href="#cb23-121"></a>            <span class="bu">list</span>(selected_years).index(year) <span class="op">+</span> <span class="fl">0.4</span>, </span>
<span id="cb23-122"><a href="#cb23-122"></a>            mean_value <span class="op">+</span> <span class="fl">0.5</span>, </span>
<span id="cb23-123"><a href="#cb23-123"></a>            <span class="ss">f'均值: </span><span class="sc">{</span>mean_value<span class="sc">:.1f}</span><span class="ss">%'</span>, </span>
<span id="cb23-124"><a href="#cb23-124"></a>            fontsize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb23-125"><a href="#cb23-125"></a>            color<span class="op">=</span><span class="st">'red'</span></span>
<span id="cb23-126"><a href="#cb23-126"></a>        )</span>
<span id="cb23-127"><a href="#cb23-127"></a></span>
<span id="cb23-128"><a href="#cb23-128"></a><span class="co"># 添加说明文字</span></span>
<span id="cb23-129"><a href="#cb23-129"></a>plt.figtext(</span>
<span id="cb23-130"><a href="#cb23-130"></a>    <span class="fl">0.5</span>, <span class="fl">0.01</span>, </span>
<span id="cb23-131"><a href="#cb23-131"></a>    <span class="st">'注: 箱线图展示了股权集中度(Top1)的分布情况，包括中位数、四分位数和离群值。红色虚线表示各年份均值。'</span>,</span>
<span id="cb23-132"><a href="#cb23-132"></a>    ha<span class="op">=</span><span class="st">'center'</span>, </span>
<span id="cb23-133"><a href="#cb23-133"></a>    fontsize<span class="op">=</span><span class="dv">12</span>, </span>
<span id="cb23-134"><a href="#cb23-134"></a>    color<span class="op">=</span><span class="st">'gray'</span></span>
<span id="cb23-135"><a href="#cb23-135"></a>)</span>
<span id="cb23-136"><a href="#cb23-136"></a></span>
<span id="cb23-137"><a href="#cb23-137"></a><span class="co"># 美化布局</span></span>
<span id="cb23-138"><a href="#cb23-138"></a>plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.03</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])</span>
<span id="cb23-139"><a href="#cb23-139"></a></span>
<span id="cb23-140"><a href="#cb23-140"></a><span class="co"># 显示图像</span></span>
<span id="cb23-141"><a href="#cb23-141"></a>plt.show()</span>
<span id="cb23-142"><a href="#cb23-142"></a></span>
<span id="cb23-143"><a href="#cb23-143"></a><span class="co"># 5. 可选：保存图像</span></span>
<span id="cb23-144"><a href="#cb23-144"></a>save_option <span class="op">=</span> <span class="bu">input</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">是否保存图像? (y/n): "</span>).strip().lower()</span>
<span id="cb23-145"><a href="#cb23-145"></a><span class="cf">if</span> save_option <span class="op">==</span> <span class="st">'y'</span>:</span>
<span id="cb23-146"><a href="#cb23-146"></a>    output_path <span class="op">=</span> <span class="st">'/Users/wanshiqing/Desktop/Top1_Concentration_Boxplot.png'</span></span>
<span id="cb23-147"><a href="#cb23-147"></a>    plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb23-148"><a href="#cb23-148"></a>    <span class="bu">print</span>(<span class="ss">f"图像已保存至: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-149"><a href="#cb23-149"></a></span>
<span id="cb23-150"><a href="#cb23-150"></a><span class="co"># 6. 可选：输出描述性统计</span></span>
<span id="cb23-151"><a href="#cb23-151"></a>stats <span class="op">=</span> filtered_df.groupby(<span class="st">'时间'</span>)[<span class="st">'Top1'</span>].describe()</span>
<span id="cb23-152"><a href="#cb23-152"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">股权集中度(Top1)描述性统计:"</span>)</span>
<span id="cb23-153"><a href="#cb23-153"></a><span class="bu">print</span>(stats)</span>
<span id="cb23-154"><a href="#cb23-154"></a></span>
<span id="cb23-155"><a href="#cb23-155"></a><span class="co"># 7. 可选：绘制小提琴图</span></span>
<span id="cb23-156"><a href="#cb23-156"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb23-157"><a href="#cb23-157"></a>sns.violinplot(</span>
<span id="cb23-158"><a href="#cb23-158"></a>    x<span class="op">=</span><span class="st">'时间'</span>, </span>
<span id="cb23-159"><a href="#cb23-159"></a>    y<span class="op">=</span><span class="st">'Top1'</span>, </span>
<span id="cb23-160"><a href="#cb23-160"></a>    data<span class="op">=</span>filtered_df,</span>
<span id="cb23-161"><a href="#cb23-161"></a>    palette<span class="op">=</span><span class="st">'viridis'</span>,</span>
<span id="cb23-162"><a href="#cb23-162"></a>    inner<span class="op">=</span><span class="st">'quartile'</span></span>
<span id="cb23-163"><a href="#cb23-163"></a>)</span>
<span id="cb23-164"><a href="#cb23-164"></a></span>
<span id="cb23-165"><a href="#cb23-165"></a><span class="co"># 设置标题和标签</span></span>
<span id="cb23-166"><a href="#cb23-166"></a><span class="cf">if</span> <span class="st">'USE_CHINESE'</span> <span class="kw">in</span> <span class="bu">globals</span>() <span class="kw">and</span> <span class="kw">not</span> USE_CHINESE:</span>
<span id="cb23-167"><a href="#cb23-167"></a>    plt.title(<span class="st">'Top1 Shareholder Concentration Distribution by Year (2001-2023)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb23-168"><a href="#cb23-168"></a>    plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-169"><a href="#cb23-169"></a>    plt.ylabel(<span class="st">'Top1 Concentration (%)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-170"><a href="#cb23-170"></a><span class="cf">else</span>:</span>
<span id="cb23-171"><a href="#cb23-171"></a>    plt.title(<span class="st">'股权集中度(Top1)分布密度 (2001-2023)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb23-172"><a href="#cb23-172"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-173"><a href="#cb23-173"></a>    plt.ylabel(<span class="st">'股权集中度(Top1, %)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-174"><a href="#cb23-174"></a></span>
<span id="cb23-175"><a href="#cb23-175"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, axis<span class="op">=</span><span class="st">'y'</span>)</span>
<span id="cb23-176"><a href="#cb23-176"></a>plt.gca().yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, _: <span class="ss">f'</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">%'</span>))</span>
<span id="cb23-177"><a href="#cb23-177"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-178"><a href="#cb23-178"></a>plt.yticks(fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-179"><a href="#cb23-179"></a>plt.tight_layout()</span>
<span id="cb23-180"><a href="#cb23-180"></a>plt.show()</span>
<span id="cb23-181"><a href="#cb23-181"></a></span>
<span id="cb23-182"><a href="#cb23-182"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">第八步处理完成!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>使用中文字体: Songti SC
正在读取文件: /Users/wanshiqing/Desktop/python_code/merged_data.xlsx
数据读取成功! 共 145874 行记录

筛选年份: [2001, 2003, 2005, 2007, 2009, 2011, 2013, 2015, 2017, 2019, 2021, 2023]
筛选后数据量: 70020 行</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/3k/c1rhghwj4xn7zh2x1sj__yt40000gn/T/ipykernel_78879/1595533376.py:74: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.boxplot(
posx and posy should be finite values
posx and posy should be finite values</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-11-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
股权集中度(Top1)描述性统计:
         count    mean     std    min     25%     50%     75%     max
时间                                                                   
2001    0.0000     NaN     NaN    NaN     NaN     NaN     NaN     NaN
2003 1261.0000 42.5528 17.1819 1.0606 28.6106 41.2759 57.0763 84.9984
2005 1350.0000 40.3382 16.2244 4.2380 27.8414 37.7029 54.1632 84.9785
2007 1512.0000 35.7774 15.2386 0.8225 23.4900 33.8986 47.2268 86.2863
2009 1670.0000 36.2720 15.6566 3.6355 23.8093 33.9747 48.1963 86.2003
2011 2295.0000 36.2038 15.6702 2.1969 23.7754 34.3301 47.2724 89.4086
2013 2466.0000 35.8655 15.6545 2.1969 23.5093 33.9492 46.6042 89.4086
2015 2806.0000 34.3266 14.9910 0.2863 22.6479 32.3816 44.2865 89.9858
2017 3461.0000 33.5866 14.6139 4.1456 22.2287 31.4047 42.9266 89.0930
2019 3753.0000 32.8855 14.7056 3.0029 21.5866 30.2994 42.3374 88.2353
2021 4677.0000 32.2911 14.8858 2.4307 21.1241 29.9000 41.5480 89.9910
2023 5322.0000 31.9592 15.0034 1.8464 20.6750 29.5243 41.2309 89.9910</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/3k/c1rhghwj4xn7zh2x1sj__yt40000gn/T/ipykernel_78879/1595533376.py:157: FutureWarning: 

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.violinplot(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_万诗晴_files/figure-html/cell-11-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
第八步处理完成!</code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/book\.lianxh\.cn\/ds\/index\.html");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../homework/pre/Stock_G4_03_data_analysis.html" class="pagination-link" aria-label="G4-03">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">G4-03</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../homework/pre/_ex02_吴倩茵.html" class="pagination-link" aria-label="ex02_吴倩茵">
        <span class="nav-page-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">ex02_吴倩茵</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="https://www.lianxh.cn">www.lianxh.cn</a></p>
</div>
    <div class="nav-footer-right">
<p>Support: <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>