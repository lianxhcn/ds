<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>42&nbsp; ex02_黄伊姿 – 数据分析</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../homework/pre/_ex02_朱少荣.html" rel="prev">
<link href="../../images/ds-book-logo-40.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e8fb9d25728d58bfeac61b497e4a6629.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-8434d2026ae8291579158df2ad8dfa64.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../homework/pre/Dangdang_G7_01_data_clean.html"><strong>作业展示</strong></a></li><li class="breadcrumb-item"><a href="../../homework/pre/_ex02_黄伊姿.html"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">ex02_黄伊姿</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="https://book.lianxh.cn/ds/index.html" class="sidebar-logo-link">
      <img src="../../images/ds-book-logo-40.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../"></a><a href="../../index.html">DS</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://www.lianxh.cn" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-house-fill"></i></a>
    <a href="https://lianxh-class.cn/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-camera-video-fill"></i></a>
    <a href="https://github.com/arlionn/ds" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据分析</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/_home.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">关于我们</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">前言</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>Python 基础</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_py_with_AI_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">借助 AI 写代码</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/00_py_with_AI_pic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Ansome Python + AI</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_1_install-Python-Anocanda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Python：安装和环境配置</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_2_install_FAQs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Python 安装常见问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_3_markdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Python 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_01_grammer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Python 代码风格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_02_QuickReference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Python 常用命令速查表</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_03_Packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Python 常用扩展包</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_04_import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Python：import 使用详解</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_05_OOP.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Python：语法解析-面向对象编程</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_01_basic_06_filepath.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Python 路径设置</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_02_numpy_scipy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">NumPy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_02_pandas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">pandas 快速入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_03_matplotlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Matplotlib简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_04_func_and_module.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">函数</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/01_py_05_class.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">类和对象</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>数据分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/data_02_data_type.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">数据分析是什么？</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/data_02_get_data_GMD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">获取数据：GMD</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/TS_SZ_index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">上证指数的时序特征</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>可视化</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Python 可视化：简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_box_violin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">箱型图和小提琴图</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_histogram.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">直方图</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/graph_dis_kdensity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">核密度函数图</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>回归分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/test_AB_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">A/B test-分组对照试验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_01_OLS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">线性回归模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_02_wage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">线性回归分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/regress_03_binscatter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">分仓散点图</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>时间序列分析</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../body/TS_FRED_US_unemploy_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">案例：美国失业率和通胀率关系分析</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>作业展示</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Dangdang_G7_01_data_clean.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">当当网-G7-01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Dangdang_G7_02_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">当当网-G7-02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/G8_China_stock_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">G8-中国上市公司</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_01_data_crawler.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">G4-01</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_02_data_cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">G4-02</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/Stock_G4_03_data_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">G4-03</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_万诗晴.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">ex02_万诗晴</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_吴倩茵.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">ex02_吴倩茵</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_朱少荣.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">ex02_朱少荣</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../homework/pre/_ex02_黄伊姿.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">ex02_黄伊姿</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#上市公司财务特征分析" id="toc-上市公司财务特征分析" class="nav-link active" data-scroll-target="#上市公司财务特征分析"><span class="header-section-number">42.1</span> 上市公司财务特征分析</a>
  <ul class="collapse">
  <li><a href="#环境准备" id="toc-环境准备" class="nav-link" data-scroll-target="#环境准备"><span class="header-section-number">42.1.1</span> 0. 环境准备</a></li>
  <li><a href="#从txt文件解析指标汇总" id="toc-从txt文件解析指标汇总" class="nav-link" data-scroll-target="#从txt文件解析指标汇总"><span class="header-section-number">42.1.2</span> 1. 从TXT文件解析指标汇总</a></li>
  <li><a href="#数据读取与预处理" id="toc-数据读取与预处理" class="nav-link" data-scroll-target="#数据读取与预处理"><span class="header-section-number">42.1.3</span> 2. 数据读取与预处理</a></li>
  <li><a href="#数据分析" id="toc-数据分析" class="nav-link" data-scroll-target="#数据分析"><span class="header-section-number">42.1.4</span> 3. 数据分析</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../homework/pre/Dangdang_G7_01_data_clean.html"><strong>作业展示</strong></a></li><li class="breadcrumb-item"><a href="../../homework/pre/_ex02_黄伊姿.html"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">ex02_黄伊姿</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">ex02_黄伊姿</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="上市公司财务特征分析" class="level2" data-number="42.1">
<h2 data-number="42.1" class="anchored" data-anchor-id="上市公司财务特征分析"><span class="header-section-number">42.1</span> 上市公司财务特征分析</h2>
<section id="环境准备" class="level3" data-number="42.1.1">
<h3 data-number="42.1.1" class="anchored" data-anchor-id="环境准备"><span class="header-section-number">42.1.1</span> 0. 环境准备</h3>
<div id="f4dcb1b1" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># 环境准备（已排除重复库，仅保留必要模块）</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> os</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> re</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">from</span> scipy.stats.mstats <span class="im">import</span> winsorize</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">import</span> warnings</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Dict, List</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> FuncFormatter</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># 设置中文字体</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>plt.rcParams[<span class="st">"font.family"</span>] <span class="op">=</span> [<span class="st">"Heiti TC"</span>]</span>
<span id="cb1-19"><a href="#cb1-19"></a>plt.rcParams[<span class="st">"axes.unicode_minus"</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># 解决负号显示问题</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)  <span class="co"># 忽略警告</span></span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co"># 配置路径</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>DATA_PATH <span class="op">=</span> <span class="st">"./data/"</span>       <span class="co"># 原始Excel文件夹</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>CSV_PATH <span class="op">=</span> <span class="st">"./csv_files/"</span>  <span class="co"># CSV保存路径</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>OUTPUT_PATH <span class="op">=</span> <span class="st">"./output/"</span>  <span class="co"># 最终输出路径</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>os.makedirs(CSV_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-28"><a href="#cb1-28"></a>os.makedirs(OUTPUT_PATH, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co"># 确保输出文件夹存在</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(OUTPUT_PATH):</span>
<span id="cb1-32"><a href="#cb1-32"></a>    os.makedirs(OUTPUT_PATH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="从txt文件解析指标汇总" class="level3" data-number="42.1.2">
<h3 data-number="42.1.2" class="anchored" data-anchor-id="从txt文件解析指标汇总"><span class="header-section-number">42.1.2</span> 1. 从TXT文件解析指标汇总</h3>
<div id="34e93d78" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># 定义目标文件夹和输出文件路径</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>DATA_PATH <span class="op">=</span> <span class="st">"./data/"</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>OUTPUT_TXT <span class="op">=</span> os.path.join(DATA_PATH, <span class="st">"指标汇总.txt"</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co"># 遍历data文件夹下所有txt文件</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>english_lines <span class="op">=</span> []</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> os.listdir(DATA_PATH):</span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="cf">if</span> <span class="bu">file</span>.endswith(<span class="st">".txt"</span>) <span class="kw">and</span> <span class="bu">file</span> <span class="op">!=</span> <span class="st">"指标汇总.txt"</span>:</span>
<span id="cb2-10"><a href="#cb2-10"></a>        <span class="cf">with</span> <span class="bu">open</span>(os.path.join(DATA_PATH, <span class="bu">file</span>), <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb2-11"><a href="#cb2-11"></a>            <span class="cf">for</span> line <span class="kw">in</span> f:</span>
<span id="cb2-12"><a href="#cb2-12"></a>                <span class="co"># 匹配英文开头的行（以字母开头，可根据实际调整正则）</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>                <span class="cf">if</span> re.match(<span class="vs">r'^[A-Za-z_]'</span>, line.strip()):</span>
<span id="cb2-14"><a href="#cb2-14"></a>                    english_lines.append(line)</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># 去重并保存到指标汇总.txt</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="cf">with</span> <span class="bu">open</span>(OUTPUT_TXT, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb2-18"><a href="#cb2-18"></a>    f.writelines(<span class="bu">list</span>(<span class="bu">set</span>(english_lines)))  <span class="co"># 去重后写入</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="bu">print</span>(<span class="ss">f"已抽取</span><span class="sc">{</span><span class="bu">len</span>(english_lines)<span class="sc">}</span><span class="ss">条行指标到</span><span class="sc">{</span>OUTPUT_TXT<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>已抽取217条行指标到./data/指标汇总.txt</code></pre>
</div>
</div>
<p>上面说明一共有217个指标，我可以把这些指标丢给AI agent，让他帮我找一下做这个分析思路所需要的指标。</p>
</section>
<section id="数据读取与预处理" class="level3" data-number="42.1.3">
<h3 data-number="42.1.3" class="anchored" data-anchor-id="数据读取与预处理"><span class="header-section-number">42.1.3</span> 2. 数据读取与预处理</h3>
<div id="5de2b61d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># 检查第四行是否只包含NaN和"报表类型(合并报表);"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="kw">def</span> should_delete_fourth_row(row):</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="co"># 将NaN转换为字符串'nan'以便比较</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    row_values <span class="op">=</span> row.astype(<span class="bu">str</span>).tolist()</span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="co"># 检查所有值是否为'nan'或'报表类型(合并报表);'</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="cf">return</span> <span class="bu">all</span>(val <span class="kw">in</span> {<span class="st">'nan'</span>, <span class="st">'报表类型(合并报表);'</span>} <span class="cf">for</span> val <span class="kw">in</span> row_values)</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co"># ----------------------</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co"># 第一步：处理Excel并转为CSV（删除第四行报表类型行），并处理文件合并</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># ----------------------</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="kw">def</span> process_excel_to_csv():</span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="bu">print</span>(<span class="st">"开始处理Excel并转换为CSV..."</span>)</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="co"># 检查数据路径是否存在</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(DATA_PATH):</span>
<span id="cb4-18"><a href="#cb4-18"></a>        <span class="bu">print</span>(<span class="ss">f"数据路径 </span><span class="sc">{</span>DATA_PATH<span class="sc">}</span><span class="ss"> 不存在，请检查路径设置。"</span>)</span>
<span id="cb4-19"><a href="#cb4-19"></a>        <span class="cf">return</span></span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>    <span class="co"># 列出数据路径下的所有内容</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>    path_contents <span class="op">=</span> os.listdir(DATA_PATH)</span>
<span id="cb4-23"><a href="#cb4-23"></a>    <span class="bu">print</span>(<span class="ss">f"数据路径 </span><span class="sc">{</span>DATA_PATH<span class="sc">}</span><span class="ss"> 下的内容: </span><span class="sc">{</span>path_contents<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a>    <span class="co"># 创建字典用于存储需要合并的文件对</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>    file_pairs <span class="op">=</span> {}</span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a>    <span class="co"># 获取所有Excel文件</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>    excel_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(DATA_PATH) <span class="cf">if</span> f.endswith((<span class="st">".xlsx"</span>, <span class="st">".xls"</span>))]</span>
<span id="cb4-30"><a href="#cb4-30"></a>    <span class="bu">print</span>(<span class="ss">f"找到的Excel文件: </span><span class="sc">{</span>excel_files<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-31"><a href="#cb4-31"></a></span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="co"># 找出所有需要合并的文件对</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="cf">for</span> i, file1 <span class="kw">in</span> <span class="bu">enumerate</span>(excel_files):</span>
<span id="cb4-34"><a href="#cb4-34"></a>        <span class="cf">for</span> j, file2 <span class="kw">in</span> <span class="bu">enumerate</span>(excel_files):</span>
<span id="cb4-35"><a href="#cb4-35"></a>            <span class="cf">if</span> i <span class="op">&gt;=</span> j:  <span class="co"># 避免重复比较</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>                <span class="cf">continue</span></span>
<span id="cb4-37"><a href="#cb4-37"></a></span>
<span id="cb4-38"><a href="#cb4-38"></a>            name1, ext1 <span class="op">=</span> os.path.splitext(file1)</span>
<span id="cb4-39"><a href="#cb4-39"></a>            name2, ext2 <span class="op">=</span> os.path.splitext(file2)</span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a>            <span class="co"># 去除 "2" 后比较剩余部分是否完全一致</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>            name1_without_2 <span class="op">=</span> name1.replace(<span class="st">"2"</span>, <span class="st">""</span>)</span>
<span id="cb4-43"><a href="#cb4-43"></a>            name2_without_2 <span class="op">=</span> name2.replace(<span class="st">"2"</span>, <span class="st">""</span>)</span>
<span id="cb4-44"><a href="#cb4-44"></a>            <span class="cf">if</span> name1_without_2 <span class="op">==</span> name2_without_2:</span>
<span id="cb4-45"><a href="#cb4-45"></a>                <span class="co"># 确定哪个文件名包含 "2"</span></span>
<span id="cb4-46"><a href="#cb4-46"></a>                <span class="cf">if</span> <span class="st">"2"</span> <span class="kw">in</span> name1:</span>
<span id="cb4-47"><a href="#cb4-47"></a>                    original_file <span class="op">=</span> file2</span>
<span id="cb4-48"><a href="#cb4-48"></a>                    file_to_merge <span class="op">=</span> file1</span>
<span id="cb4-49"><a href="#cb4-49"></a>                <span class="cf">else</span>:</span>
<span id="cb4-50"><a href="#cb4-50"></a>                    original_file <span class="op">=</span> file1</span>
<span id="cb4-51"><a href="#cb4-51"></a>                    file_to_merge <span class="op">=</span> file2</span>
<span id="cb4-52"><a href="#cb4-52"></a></span>
<span id="cb4-53"><a href="#cb4-53"></a>                <span class="co"># 将文件对添加到字典中</span></span>
<span id="cb4-54"><a href="#cb4-54"></a>                file_pairs[original_file] <span class="op">=</span> file_to_merge</span>
<span id="cb4-55"><a href="#cb4-55"></a></span>
<span id="cb4-56"><a href="#cb4-56"></a>    <span class="bu">print</span>(<span class="ss">f"找到的需要合并的文件对: </span><span class="sc">{</span>file_pairs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a>    <span class="co"># 第一阶段：处理需要合并的文件</span></span>
<span id="cb4-59"><a href="#cb4-59"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 开始处理需要合并的文件 ====="</span>)</span>
<span id="cb4-60"><a href="#cb4-60"></a>    <span class="cf">for</span> original_file, file_to_merge <span class="kw">in</span> file_pairs.items():</span>
<span id="cb4-61"><a href="#cb4-61"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">发现需要合并的文件对:"</span>)</span>
<span id="cb4-62"><a href="#cb4-62"></a>        <span class="bu">print</span>(<span class="ss">f"  主文件: </span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-63"><a href="#cb4-63"></a>        <span class="bu">print</span>(<span class="ss">f"  合并文件: </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>        original_path <span class="op">=</span> os.path.join(DATA_PATH, original_file)</span>
<span id="cb4-66"><a href="#cb4-66"></a>        merge_path <span class="op">=</span> os.path.join(DATA_PATH, file_to_merge)</span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a>        <span class="cf">try</span>:</span>
<span id="cb4-69"><a href="#cb4-69"></a>            <span class="co"># 读取两个Excel文件</span></span>
<span id="cb4-70"><a href="#cb4-70"></a>            df_original <span class="op">=</span> pd.read_excel(original_path, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb4-71"><a href="#cb4-71"></a>            df_merge <span class="op">=</span> pd.read_excel(merge_path, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb4-72"><a href="#cb4-72"></a></span>
<span id="cb4-73"><a href="#cb4-73"></a>            <span class="co"># 检查表头是否匹配</span></span>
<span id="cb4-74"><a href="#cb4-74"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">检查表头匹配情况:"</span>)</span>
<span id="cb4-75"><a href="#cb4-75"></a>            max_header_rows <span class="op">=</span> <span class="bu">min</span>(<span class="dv">4</span>, <span class="bu">len</span>(df_original), <span class="bu">len</span>(df_merge))</span>
<span id="cb4-76"><a href="#cb4-76"></a>            header_rows <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-77"><a href="#cb4-77"></a></span>
<span id="cb4-78"><a href="#cb4-78"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_header_rows):</span>
<span id="cb4-79"><a href="#cb4-79"></a>                <span class="cf">if</span> df_original.iloc[i].equals(df_merge.iloc[i]):</span>
<span id="cb4-80"><a href="#cb4-80"></a>                    header_rows <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-81"><a href="#cb4-81"></a>                <span class="cf">else</span>:</span>
<span id="cb4-82"><a href="#cb4-82"></a>                    <span class="cf">break</span></span>
<span id="cb4-83"><a href="#cb4-83"></a></span>
<span id="cb4-84"><a href="#cb4-84"></a>            <span class="cf">if</span> header_rows <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-85"><a href="#cb4-85"></a>                <span class="bu">print</span>(<span class="ss">f"  错误：</span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss"> 和 </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss"> 的表头不匹配，无法合并"</span>)</span>
<span id="cb4-86"><a href="#cb4-86"></a>                <span class="cf">continue</span></span>
<span id="cb4-87"><a href="#cb4-87"></a></span>
<span id="cb4-88"><a href="#cb4-88"></a>            <span class="bu">print</span>(<span class="ss">f"  两个文件的表头在前</span><span class="sc">{</span>header_rows<span class="sc">}</span><span class="ss">行匹配"</span>)</span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a>            <span class="co"># 处理第四行并确定数据起始行</span></span>
<span id="cb4-91"><a href="#cb4-91"></a>            <span class="kw">def</span> process_fourth_row(df, file_name):</span>
<span id="cb4-92"><a href="#cb4-92"></a>                keep_fourth <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-93"><a href="#cb4-93"></a>                <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&gt;=</span> <span class="dv">4</span>:</span>
<span id="cb4-94"><a href="#cb4-94"></a>                    fourth_row <span class="op">=</span> df.iloc[<span class="dv">3</span>]</span>
<span id="cb4-95"><a href="#cb4-95"></a>                    <span class="cf">if</span> should_delete_fourth_row(fourth_row):</span>
<span id="cb4-96"><a href="#cb4-96"></a>                        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">: 第四行只包含空值或'报表类型(合并报表);'，已删除"</span>)</span>
<span id="cb4-97"><a href="#cb4-97"></a>                        data_start <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-98"><a href="#cb4-98"></a>                    <span class="cf">else</span>:</span>
<span id="cb4-99"><a href="#cb4-99"></a>                        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">: 文件中第四行为数据行，无需删除"</span>)</span>
<span id="cb4-100"><a href="#cb4-100"></a>                        keep_fourth <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-101"><a href="#cb4-101"></a>                        data_start <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb4-102"><a href="#cb4-102"></a>                <span class="cf">else</span>:</span>
<span id="cb4-103"><a href="#cb4-103"></a>                    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">: 文件行数少于 4，无第四行需要处理"</span>)</span>
<span id="cb4-104"><a href="#cb4-104"></a>                    data_start <span class="op">=</span> <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-105"><a href="#cb4-105"></a></span>
<span id="cb4-106"><a href="#cb4-106"></a>                <span class="cf">return</span> keep_fourth, data_start</span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">处理第四行:"</span>)</span>
<span id="cb4-109"><a href="#cb4-109"></a>            original_keep_fourth, original_data_start <span class="op">=</span> process_fourth_row(df_original, original_file)</span>
<span id="cb4-110"><a href="#cb4-110"></a>            merge_keep_fourth, merge_data_start <span class="op">=</span> process_fourth_row(df_merge, file_to_merge)</span>
<span id="cb4-111"><a href="#cb4-111"></a></span>
<span id="cb4-112"><a href="#cb4-112"></a>            <span class="co"># 分别处理两个文件并保存为CSV</span></span>
<span id="cb4-113"><a href="#cb4-113"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">处理并保存主文件为CSV:"</span>)</span>
<span id="cb4-114"><a href="#cb4-114"></a>            original_header <span class="op">=</span> df_original.head(header_rows)</span>
<span id="cb4-115"><a href="#cb4-115"></a>            <span class="cf">if</span> <span class="bu">len</span>(df_original) <span class="op">&gt;=</span> original_data_start:</span>
<span id="cb4-116"><a href="#cb4-116"></a>                original_data <span class="op">=</span> df_original[original_data_start <span class="op">-</span> <span class="dv">1</span>:]</span>
<span id="cb4-117"><a href="#cb4-117"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss">: 从第</span><span class="sc">{</span>original_data_start<span class="sc">}</span><span class="ss">行开始加载数据，共</span><span class="sc">{</span><span class="bu">len</span>(original_data)<span class="sc">}</span><span class="ss">行"</span>)</span>
<span id="cb4-118"><a href="#cb4-118"></a>            <span class="cf">else</span>:</span>
<span id="cb4-119"><a href="#cb4-119"></a>                original_data <span class="op">=</span> pd.DataFrame()</span>
<span id="cb4-120"><a href="#cb4-120"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss">: 没有数据行"</span>)</span>
<span id="cb4-121"><a href="#cb4-121"></a>            </span>
<span id="cb4-122"><a href="#cb4-122"></a>            <span class="co"># 合并表头和数据</span></span>
<span id="cb4-123"><a href="#cb4-123"></a>            original_merged_df <span class="op">=</span> pd.concat([original_header, original_data]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-124"><a href="#cb4-124"></a>            </span>
<span id="cb4-125"><a href="#cb4-125"></a>            <span class="co"># 设置多级表头</span></span>
<span id="cb4-126"><a href="#cb4-126"></a>            <span class="cf">if</span> <span class="bu">len</span>(original_merged_df) <span class="op">&gt;=</span> header_rows:</span>
<span id="cb4-127"><a href="#cb4-127"></a>                new_header <span class="op">=</span> original_merged_df.iloc[:header_rows].values.tolist()</span>
<span id="cb4-128"><a href="#cb4-128"></a>                original_merged_df <span class="op">=</span> original_merged_df[header_rows:]</span>
<span id="cb4-129"><a href="#cb4-129"></a>                original_merged_df.columns <span class="op">=</span> pd.MultiIndex.from_arrays(new_header)</span>
<span id="cb4-130"><a href="#cb4-130"></a>            </span>
<span id="cb4-131"><a href="#cb4-131"></a>            <span class="co"># 保存主文件为CSV</span></span>
<span id="cb4-132"><a href="#cb4-132"></a>            base_name <span class="op">=</span> os.path.splitext(original_file)[<span class="dv">0</span>]</span>
<span id="cb4-133"><a href="#cb4-133"></a>            original_csv_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_name<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb4-134"><a href="#cb4-134"></a>            original_csv_path <span class="op">=</span> os.path.join(CSV_PATH, original_csv_name)</span>
<span id="cb4-135"><a href="#cb4-135"></a>            original_merged_df.to_csv(original_csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-136"><a href="#cb4-136"></a>            <span class="bu">print</span>(<span class="ss">f"  成功保存：</span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>original_csv_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-137"><a href="#cb4-137"></a>            </span>
<span id="cb4-138"><a href="#cb4-138"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">处理并保存合并文件为CSV:"</span>)</span>
<span id="cb4-139"><a href="#cb4-139"></a>            merge_header <span class="op">=</span> df_merge.head(header_rows)</span>
<span id="cb4-140"><a href="#cb4-140"></a>            <span class="cf">if</span> <span class="bu">len</span>(df_merge) <span class="op">&gt;=</span> merge_data_start:</span>
<span id="cb4-141"><a href="#cb4-141"></a>                merge_data <span class="op">=</span> df_merge[merge_data_start <span class="op">-</span> <span class="dv">1</span>:]</span>
<span id="cb4-142"><a href="#cb4-142"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss">: 从第</span><span class="sc">{</span>merge_data_start<span class="sc">}</span><span class="ss">行开始加载数据，共</span><span class="sc">{</span><span class="bu">len</span>(merge_data)<span class="sc">}</span><span class="ss">行"</span>)</span>
<span id="cb4-143"><a href="#cb4-143"></a>            <span class="cf">else</span>:</span>
<span id="cb4-144"><a href="#cb4-144"></a>                merge_data <span class="op">=</span> pd.DataFrame()</span>
<span id="cb4-145"><a href="#cb4-145"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss">: 没有数据行"</span>)</span>
<span id="cb4-146"><a href="#cb4-146"></a>            </span>
<span id="cb4-147"><a href="#cb4-147"></a>            <span class="co"># 合并表头和数据</span></span>
<span id="cb4-148"><a href="#cb4-148"></a>            merge_merged_df <span class="op">=</span> pd.concat([merge_header, merge_data]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-149"><a href="#cb4-149"></a>            </span>
<span id="cb4-150"><a href="#cb4-150"></a>            <span class="co"># 设置多级表头</span></span>
<span id="cb4-151"><a href="#cb4-151"></a>            <span class="cf">if</span> <span class="bu">len</span>(merge_merged_df) <span class="op">&gt;=</span> header_rows:</span>
<span id="cb4-152"><a href="#cb4-152"></a>                new_header <span class="op">=</span> merge_merged_df.iloc[:header_rows].values.tolist()</span>
<span id="cb4-153"><a href="#cb4-153"></a>                merge_merged_df <span class="op">=</span> merge_merged_df[header_rows:]</span>
<span id="cb4-154"><a href="#cb4-154"></a>                merge_merged_df.columns <span class="op">=</span> pd.MultiIndex.from_arrays(new_header)</span>
<span id="cb4-155"><a href="#cb4-155"></a>            </span>
<span id="cb4-156"><a href="#cb4-156"></a>            <span class="co"># 保存合并文件为CSV</span></span>
<span id="cb4-157"><a href="#cb4-157"></a>            merge_base_name <span class="op">=</span> os.path.splitext(file_to_merge)[<span class="dv">0</span>]</span>
<span id="cb4-158"><a href="#cb4-158"></a>            merge_csv_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>merge_base_name<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb4-159"><a href="#cb4-159"></a>            merge_csv_path <span class="op">=</span> os.path.join(CSV_PATH, merge_csv_name)</span>
<span id="cb4-160"><a href="#cb4-160"></a>            merge_merged_df.to_csv(merge_csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-161"><a href="#cb4-161"></a>            <span class="bu">print</span>(<span class="ss">f"  成功保存：</span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>merge_csv_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-162"><a href="#cb4-162"></a>            </span>
<span id="cb4-163"><a href="#cb4-163"></a>            <span class="co"># 合并两个CSV文件</span></span>
<span id="cb4-164"><a href="#cb4-164"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">合并两个CSV文件:"</span>)</span>
<span id="cb4-165"><a href="#cb4-165"></a>            <span class="co"># 读取主CSV文件（包含表头）</span></span>
<span id="cb4-166"><a href="#cb4-166"></a>            df_original_csv <span class="op">=</span> pd.read_csv(original_csv_path, header<span class="op">=</span>[i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(header_rows)])</span>
<span id="cb4-167"><a href="#cb4-167"></a>            <span class="co"># 读取合并CSV文件（跳过表头）</span></span>
<span id="cb4-168"><a href="#cb4-168"></a>            df_merge_csv <span class="op">=</span> pd.read_csv(merge_csv_path, header<span class="op">=</span>[i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(header_rows)])</span>
<span id="cb4-169"><a href="#cb4-169"></a>            </span>
<span id="cb4-170"><a href="#cb4-170"></a>            <span class="co"># 合并数据（不包含表头）</span></span>
<span id="cb4-171"><a href="#cb4-171"></a>            merged_data <span class="op">=</span> pd.concat([df_original_csv, df_merge_csv], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-172"><a href="#cb4-172"></a>            </span>
<span id="cb4-173"><a href="#cb4-173"></a>            <span class="co"># 保存合并后的CSV文件</span></span>
<span id="cb4-174"><a href="#cb4-174"></a>            total_csv_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_name<span class="sc">}</span><span class="ss">_total.csv"</span></span>
<span id="cb4-175"><a href="#cb4-175"></a>            total_csv_path <span class="op">=</span> os.path.join(CSV_PATH, total_csv_name)</span>
<span id="cb4-176"><a href="#cb4-176"></a>            merged_data.to_csv(total_csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-177"><a href="#cb4-177"></a>            </span>
<span id="cb4-178"><a href="#cb4-178"></a>            total_rows <span class="op">=</span> <span class="bu">len</span>(merged_data)</span>
<span id="cb4-179"><a href="#cb4-179"></a>            <span class="bu">print</span>(<span class="ss">f"  合并完成，总数据行数: </span><span class="sc">{</span>total_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-180"><a href="#cb4-180"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">成功合并并保存：</span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss"> + </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>total_csv_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-181"><a href="#cb4-181"></a></span>
<span id="cb4-182"><a href="#cb4-182"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-183"><a href="#cb4-183"></a>            <span class="bu">print</span>(<span class="ss">f"合并 </span><span class="sc">{</span>original_file<span class="sc">}</span><span class="ss"> 和 </span><span class="sc">{</span>file_to_merge<span class="sc">}</span><span class="ss"> 失败：</span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-184"><a href="#cb4-184"></a></span>
<span id="cb4-185"><a href="#cb4-185"></a>    <span class="co"># 第二阶段：处理剩余的单个文件</span></span>
<span id="cb4-186"><a href="#cb4-186"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">===== 开始处理单个文件 ====="</span>)</span>
<span id="cb4-187"><a href="#cb4-187"></a>    processed_files <span class="op">=</span> <span class="bu">set</span>(file_pairs.keys()).union(<span class="bu">set</span>(file_pairs.values()))</span>
<span id="cb4-188"><a href="#cb4-188"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> os.listdir(DATA_PATH):</span>
<span id="cb4-189"><a href="#cb4-189"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">file</span>.endswith((<span class="st">".xlsx"</span>, <span class="st">".xls"</span>)) <span class="kw">or</span> <span class="bu">file</span> <span class="kw">in</span> processed_files:</span>
<span id="cb4-190"><a href="#cb4-190"></a>            <span class="cf">continue</span></span>
<span id="cb4-191"><a href="#cb4-191"></a></span>
<span id="cb4-192"><a href="#cb4-192"></a>        file_path <span class="op">=</span> os.path.join(DATA_PATH, <span class="bu">file</span>)</span>
<span id="cb4-193"><a href="#cb4-193"></a>        csv_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>splitext(<span class="bu">file</span>)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">.csv"</span></span>
<span id="cb4-194"><a href="#cb4-194"></a>        csv_path <span class="op">=</span> os.path.join(CSV_PATH, csv_name)</span>
<span id="cb4-195"><a href="#cb4-195"></a></span>
<span id="cb4-196"><a href="#cb4-196"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">处理单个文件: </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-197"><a href="#cb4-197"></a></span>
<span id="cb4-198"><a href="#cb4-198"></a>        <span class="cf">try</span>:</span>
<span id="cb4-199"><a href="#cb4-199"></a>            <span class="co"># 读取 Excel</span></span>
<span id="cb4-200"><a href="#cb4-200"></a>            df <span class="op">=</span> pd.read_excel(file_path, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb4-201"><a href="#cb4-201"></a></span>
<span id="cb4-202"><a href="#cb4-202"></a>            <span class="bu">print</span>(<span class="ss">f"  成功读取文件 </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">，数据有 </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> 行 </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> 列"</span>)</span>
<span id="cb4-203"><a href="#cb4-203"></a></span>
<span id="cb4-204"><a href="#cb4-204"></a>            <span class="co"># 保留表头行</span></span>
<span id="cb4-205"><a href="#cb4-205"></a>            header_rows <span class="op">=</span> <span class="bu">min</span>(<span class="dv">3</span>, <span class="bu">len</span>(df))</span>
<span id="cb4-206"><a href="#cb4-206"></a>            new_df <span class="op">=</span> df.head(header_rows)</span>
<span id="cb4-207"><a href="#cb4-207"></a></span>
<span id="cb4-208"><a href="#cb4-208"></a>            <span class="co"># 处理第四行</span></span>
<span id="cb4-209"><a href="#cb4-209"></a>            keep_fourth <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-210"><a href="#cb4-210"></a>            <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&gt;=</span> <span class="dv">4</span>:</span>
<span id="cb4-211"><a href="#cb4-211"></a>                fourth_row <span class="op">=</span> df.iloc[<span class="dv">3</span>]</span>
<span id="cb4-212"><a href="#cb4-212"></a>                <span class="cf">if</span> should_delete_fourth_row(fourth_row):</span>
<span id="cb4-213"><a href="#cb4-213"></a>                    <span class="bu">print</span>(<span class="ss">f"  第四行只包含空值或'报表类型(合并报表);'，已删除"</span>)</span>
<span id="cb4-214"><a href="#cb4-214"></a>                    data_start <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-215"><a href="#cb4-215"></a>                <span class="cf">else</span>:</span>
<span id="cb4-216"><a href="#cb4-216"></a>                    <span class="bu">print</span>(<span class="ss">f"  文件中第四行为数据行，无需删除"</span>)</span>
<span id="cb4-217"><a href="#cb4-217"></a>                    new_df <span class="op">=</span> pd.concat([new_df, pd.DataFrame(fourth_row).T])</span>
<span id="cb4-218"><a href="#cb4-218"></a>                    keep_fourth <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-219"><a href="#cb4-219"></a>                    data_start <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb4-220"><a href="#cb4-220"></a>            <span class="cf">else</span>:</span>
<span id="cb4-221"><a href="#cb4-221"></a>                <span class="bu">print</span>(<span class="ss">f"  文件行数少于 4，无第四行需要处理"</span>)</span>
<span id="cb4-222"><a href="#cb4-222"></a>                data_start <span class="op">=</span> <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-223"><a href="#cb4-223"></a></span>
<span id="cb4-224"><a href="#cb4-224"></a>            <span class="co"># 加载数据</span></span>
<span id="cb4-225"><a href="#cb4-225"></a>            <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">&gt;=</span> data_start:</span>
<span id="cb4-226"><a href="#cb4-226"></a>                data <span class="op">=</span> df[data_start <span class="op">-</span> <span class="dv">1</span>:]</span>
<span id="cb4-227"><a href="#cb4-227"></a>                new_df <span class="op">=</span> pd.concat([new_df, data]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-228"><a href="#cb4-228"></a>                <span class="bu">print</span>(<span class="ss">f"  从第</span><span class="sc">{</span>data_start<span class="sc">}</span><span class="ss">行开始加载数据，共</span><span class="sc">{</span><span class="bu">len</span>(data)<span class="sc">}</span><span class="ss">行"</span>)</span>
<span id="cb4-229"><a href="#cb4-229"></a>            <span class="cf">else</span>:</span>
<span id="cb4-230"><a href="#cb4-230"></a>                <span class="bu">print</span>(<span class="ss">f"  没有数据行"</span>)</span>
<span id="cb4-231"><a href="#cb4-231"></a></span>
<span id="cb4-232"><a href="#cb4-232"></a>            <span class="co"># 设置多级表头</span></span>
<span id="cb4-233"><a href="#cb4-233"></a>            <span class="cf">if</span> <span class="bu">len</span>(new_df) <span class="op">&gt;=</span> header_rows:</span>
<span id="cb4-234"><a href="#cb4-234"></a>                new_header <span class="op">=</span> new_df.iloc[:header_rows].values.tolist()</span>
<span id="cb4-235"><a href="#cb4-235"></a>                new_df <span class="op">=</span> new_df[header_rows:]</span>
<span id="cb4-236"><a href="#cb4-236"></a>                new_df.columns <span class="op">=</span> pd.MultiIndex.from_arrays(new_header)</span>
<span id="cb4-237"><a href="#cb4-237"></a></span>
<span id="cb4-238"><a href="#cb4-238"></a>            <span class="co"># 保存为 CSV 文件</span></span>
<span id="cb4-239"><a href="#cb4-239"></a>            new_df.to_csv(csv_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-240"><a href="#cb4-240"></a>            <span class="bu">print</span>(<span class="ss">f"  成功处理并转换：</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>csv_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-241"><a href="#cb4-241"></a></span>
<span id="cb4-242"><a href="#cb4-242"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-243"><a href="#cb4-243"></a>            <span class="bu">print</span>(<span class="ss">f"  处理 </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss"> 失败：</span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-244"><a href="#cb4-244"></a></span>
<span id="cb4-245"><a href="#cb4-245"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Excel 处理及 CSV 转换完成</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb4-246"><a href="#cb4-246"></a></span>
<span id="cb4-247"><a href="#cb4-247"></a></span>
<span id="cb4-248"><a href="#cb4-248"></a><span class="co"># ----------------------</span></span>
<span id="cb4-249"><a href="#cb4-249"></a><span class="co"># 执行全流程</span></span>
<span id="cb4-250"><a href="#cb4-250"></a><span class="co"># ----------------------</span></span>
<span id="cb4-251"><a href="#cb4-251"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb4-252"><a href="#cb4-252"></a>    process_excel_to_csv()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>开始处理Excel并转换为CSV...
数据路径 ./data/ 下的内容: ['跨表查询_沪深京股票2(年频).xlsx', 'STK_LISTEDCOINFOCHG[DES][xlsx].txt', 'STK_LISTEDCOINFOCHG.xlsx', '.DS_Store', '跨表查询_沪深京股票(年频).xlsx', '跨表查询_沪深京股票2(年频)[DES][.xlsx].txt', 'STK_LISTEDCOINFOANL.xlsx', '资产负债表_沪深京股票2(年频).xlsx', '常用变量查询（年度）.xlsx', '资产负债表_沪深京股票(年频).xlsx', '跨表查询_沪深京股票(年频)[DES][.xlsx].txt', 'STK_LISTEDCOINFOANL[DES][xlsx].txt', '资产负债表_沪深京股票(年频)[DES][.xlsx].txt', '指标汇总.txt', '常用变量查询（年度）[DES][xlsx].txt', '资产负债表_沪深京股票2(年频)[DES][.xlsx].txt']
找到的Excel文件: ['跨表查询_沪深京股票2(年频).xlsx', 'STK_LISTEDCOINFOCHG.xlsx', '跨表查询_沪深京股票(年频).xlsx', 'STK_LISTEDCOINFOANL.xlsx', '资产负债表_沪深京股票2(年频).xlsx', '常用变量查询（年度）.xlsx', '资产负债表_沪深京股票(年频).xlsx']
找到的需要合并的文件对: {'跨表查询_沪深京股票(年频).xlsx': '跨表查询_沪深京股票2(年频).xlsx', '资产负债表_沪深京股票(年频).xlsx': '资产负债表_沪深京股票2(年频).xlsx'}

===== 开始处理需要合并的文件 =====

发现需要合并的文件对:
  主文件: 跨表查询_沪深京股票(年频).xlsx
  合并文件: 跨表查询_沪深京股票2(年频).xlsx

检查表头匹配情况:
  两个文件的表头在前4行匹配

处理第四行:
  跨表查询_沪深京股票(年频).xlsx: 第四行只包含空值或'报表类型(合并报表);'，已删除
  跨表查询_沪深京股票2(年频).xlsx: 第四行只包含空值或'报表类型(合并报表);'，已删除

处理并保存主文件为CSV:
  跨表查询_沪深京股票(年频).xlsx: 从第5行开始加载数据，共64163行
  成功保存：跨表查询_沪深京股票(年频).xlsx -&gt; 跨表查询_沪深京股票(年频).csv

处理并保存合并文件为CSV:
  跨表查询_沪深京股票2(年频).xlsx: 从第5行开始加载数据，共81662行
  成功保存：跨表查询_沪深京股票2(年频).xlsx -&gt; 跨表查询_沪深京股票2(年频).csv

合并两个CSV文件:
  合并完成，总数据行数: 145825

成功合并并保存：跨表查询_沪深京股票(年频).xlsx + 跨表查询_沪深京股票2(年频).xlsx -&gt; 跨表查询_沪深京股票(年频)_total.csv

发现需要合并的文件对:
  主文件: 资产负债表_沪深京股票(年频).xlsx
  合并文件: 资产负债表_沪深京股票2(年频).xlsx

检查表头匹配情况:
  两个文件的表头在前4行匹配

处理第四行:
  资产负债表_沪深京股票(年频).xlsx: 第四行只包含空值或'报表类型(合并报表);'，已删除
  资产负债表_沪深京股票2(年频).xlsx: 第四行只包含空值或'报表类型(合并报表);'，已删除

处理并保存主文件为CSV:
  资产负债表_沪深京股票(年频).xlsx: 从第5行开始加载数据，共64163行
  成功保存：资产负债表_沪深京股票(年频).xlsx -&gt; 资产负债表_沪深京股票(年频).csv

处理并保存合并文件为CSV:
  资产负债表_沪深京股票2(年频).xlsx: 从第5行开始加载数据，共81662行
  成功保存：资产负债表_沪深京股票2(年频).xlsx -&gt; 资产负债表_沪深京股票2(年频).csv

合并两个CSV文件:
  合并完成，总数据行数: 145825

成功合并并保存：资产负债表_沪深京股票(年频).xlsx + 资产负债表_沪深京股票2(年频).xlsx -&gt; 资产负债表_沪深京股票(年频)_total.csv


===== 开始处理单个文件 =====

处理单个文件: STK_LISTEDCOINFOCHG.xlsx
  成功读取文件 STK_LISTEDCOINFOCHG.xlsx，数据有 160279 行 8 列
  文件中第四行为数据行，无需删除
  从第4行开始加载数据，共160276行
  成功处理并转换：STK_LISTEDCOINFOCHG.xlsx -&gt; STK_LISTEDCOINFOCHG.csv

处理单个文件: STK_LISTEDCOINFOANL.xlsx
  成功读取文件 STK_LISTEDCOINFOANL.xlsx，数据有 64174 行 40 列
  文件中第四行为数据行，无需删除
  从第4行开始加载数据，共64171行
  成功处理并转换：STK_LISTEDCOINFOANL.xlsx -&gt; STK_LISTEDCOINFOANL.csv

处理单个文件: 常用变量查询（年度）.xlsx
  成功读取文件 常用变量查询（年度）.xlsx，数据有 61459 行 33 列
  文件中第四行为数据行，无需删除
  从第4行开始加载数据，共61456行
  成功处理并转换：常用变量查询（年度）.xlsx -&gt; 常用变量查询（年度）.csv

Excel 处理及 CSV 转换完成
</code></pre>
</div>
</div>
</section>
<section id="数据分析" class="level3" data-number="42.1.4">
<h3 data-number="42.1.4" class="anchored" data-anchor-id="数据分析"><span class="header-section-number">42.1.4</span> 3. 数据分析</h3>
<section id="问题-a年度统计量计算" class="level4" data-number="42.1.4.1">
<h4 data-number="42.1.4.1" class="anchored" data-anchor-id="问题-a年度统计量计算"><span class="header-section-number">42.1.4.1</span> 问题 A：年度统计量计算</h4>
<div id="d35fae35" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">class</span> DataPreprocessor:</span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="co">"""财务数据前置处理工具，用于加载、预处理和存储关键数据"""</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">'csv_files'</span>, output_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">'output'</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-5"><a href="#cb6-5"></a>        <span class="va">self</span>.data_path <span class="op">=</span> Path(data_path)</span>
<span id="cb6-6"><a href="#cb6-6"></a>        <span class="va">self</span>.output_path <span class="op">=</span> Path(output_path)</span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="va">self</span>.output_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-8"><a href="#cb6-8"></a>        <span class="va">self</span>.data <span class="op">=</span> {}</span>
<span id="cb6-9"><a href="#cb6-9"></a>        <span class="va">self</span>.merged_data <span class="op">=</span> <span class="va">None</span>  <span class="co"># 合并后的原始数据（含行业、年份等）</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>        <span class="va">self</span>.metrics_data <span class="op">=</span> <span class="va">None</span>  <span class="co"># 计算后的指标数据</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>        </span>
<span id="cb6-12"><a href="#cb6-12"></a>    <span class="kw">def</span> load_data(<span class="va">self</span>, file_mapping: Optional[Dict[<span class="bu">str</span>, Dict]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-13"><a href="#cb6-13"></a>        default_files <span class="op">=</span> {</span>
<span id="cb6-14"><a href="#cb6-14"></a>            <span class="st">"资产负债表"</span>: {<span class="st">"filename"</span>: <span class="st">"资产负债表_沪深京股票(年频)_total.csv"</span>},</span>
<span id="cb6-15"><a href="#cb6-15"></a>            <span class="st">"利润表"</span>: {<span class="st">"filename"</span>: <span class="st">"跨表查询_沪深京股票(年频)_total.csv"</span>},</span>
<span id="cb6-16"><a href="#cb6-16"></a>            <span class="st">"公司信息"</span>: {<span class="st">"filename"</span>: <span class="st">"STK_LISTEDCOINFOANL.csv"</span>},</span>
<span id="cb6-17"><a href="#cb6-17"></a>            <span class="st">"股权结构"</span>: {<span class="st">"filename"</span>: <span class="st">"常用变量查询（年度）.csv"</span>}</span>
<span id="cb6-18"><a href="#cb6-18"></a>        }</span>
<span id="cb6-19"><a href="#cb6-19"></a>        files <span class="op">=</span> default_files.copy()</span>
<span id="cb6-20"><a href="#cb6-20"></a>        <span class="cf">if</span> file_mapping:</span>
<span id="cb6-21"><a href="#cb6-21"></a>            <span class="cf">for</span> data_type, mapping <span class="kw">in</span> file_mapping.items():</span>
<span id="cb6-22"><a href="#cb6-22"></a>                <span class="cf">if</span> data_type <span class="kw">in</span> files:</span>
<span id="cb6-23"><a href="#cb6-23"></a>                    files[data_type].update(mapping)</span>
<span id="cb6-24"><a href="#cb6-24"></a>                <span class="cf">else</span>:</span>
<span id="cb6-25"><a href="#cb6-25"></a>                    files[data_type] <span class="op">=</span> mapping</span>
<span id="cb6-26"><a href="#cb6-26"></a>        </span>
<span id="cb6-27"><a href="#cb6-27"></a>        default_column_mappings <span class="op">=</span> {</span>
<span id="cb6-28"><a href="#cb6-28"></a>            <span class="st">"资产负债表"</span>: {<span class="st">'证券代码'</span>: <span class="st">'Symbol'</span>, <span class="st">'时间'</span>: <span class="st">'Year'</span>, <span class="st">'行业代码D'</span>: <span class="st">'IndustryCodeD'</span>,</span>
<span id="cb6-29"><a href="#cb6-29"></a>                          <span class="st">'行业名称D'</span>: <span class="st">'IndustryNameD'</span>, <span class="st">'资产总计'</span>: <span class="st">'TotalAssets'</span>, </span>
<span id="cb6-30"><a href="#cb6-30"></a>                          <span class="st">'负债合计'</span>: <span class="st">'TotalLiabilities'</span>, <span class="st">'流动负债合计'</span>: <span class="st">'CurrentLiabilities'</span>, </span>
<span id="cb6-31"><a href="#cb6-31"></a>                          <span class="st">'非流动负债合计'</span>: <span class="st">'NonCurrentLiabilities'</span>, <span class="st">'货币资金'</span>: <span class="st">'Cash'</span>, </span>
<span id="cb6-32"><a href="#cb6-32"></a>                          <span class="st">'短期借款'</span>: <span class="st">'ShortTermLoans'</span>, <span class="st">'长期借款'</span>: <span class="st">'LongTermLoans'</span>},</span>
<span id="cb6-33"><a href="#cb6-33"></a>            <span class="st">"利润表"</span>: {<span class="st">'证券代码'</span>: <span class="st">'Symbol'</span>, <span class="st">'时间'</span>: <span class="st">'Year'</span>, <span class="st">'净利润'</span>: <span class="st">'NetProfit'</span>, </span>
<span id="cb6-34"><a href="#cb6-34"></a>                      <span class="st">'营业收入'</span>: <span class="st">'OperatingRevenue'</span>, <span class="st">'营业利润'</span>: <span class="st">'OperatingProfit'</span>},</span>
<span id="cb6-35"><a href="#cb6-35"></a>            <span class="st">"公司信息"</span>: {<span class="st">'股票代码'</span>: <span class="st">'Symbol'</span>, <span class="st">'行业代码D'</span>: <span class="st">'IndustryCodeD'</span>, </span>
<span id="cb6-36"><a href="#cb6-36"></a>                        <span class="st">'行业名称D'</span>: <span class="st">'IndustryNameD'</span>, <span class="st">'首次上市日期'</span>: <span class="st">'LISTINGDATE'</span>},  <span class="co"># 映射股票代码</span></span>
<span id="cb6-37"><a href="#cb6-37"></a>            <span class="st">"股权结构"</span>: {<span class="st">'证券代码'</span>: <span class="st">'Symbol'</span>, <span class="st">'时间'</span>: <span class="st">'Year'</span>, </span>
<span id="cb6-38"><a href="#cb6-38"></a>                        <span class="st">'第一大股东持股比例'</span>: <span class="st">'Top1'</span>, <span class="st">'前五大股东持股比例平方和'</span>: <span class="st">'HHI5'</span>}</span>
<span id="cb6-39"><a href="#cb6-39"></a>        }</span>
<span id="cb6-40"><a href="#cb6-40"></a>        </span>
<span id="cb6-41"><a href="#cb6-41"></a>        <span class="cf">for</span> data_type, mapping <span class="kw">in</span> files.items():</span>
<span id="cb6-42"><a href="#cb6-42"></a>            filename <span class="op">=</span> mapping[<span class="st">"filename"</span>]</span>
<span id="cb6-43"><a href="#cb6-43"></a>            file_path <span class="op">=</span> <span class="va">self</span>.data_path <span class="op">/</span> filename</span>
<span id="cb6-44"><a href="#cb6-44"></a>            column_mapping <span class="op">=</span> default_column_mappings.get(data_type, {})</span>
<span id="cb6-45"><a href="#cb6-45"></a>            <span class="cf">if</span> <span class="st">"column_mapping"</span> <span class="kw">in</span> mapping:</span>
<span id="cb6-46"><a href="#cb6-46"></a>                column_mapping.update(mapping[<span class="st">"column_mapping"</span>])</span>
<span id="cb6-47"><a href="#cb6-47"></a>            </span>
<span id="cb6-48"><a href="#cb6-48"></a>            <span class="cf">try</span>:</span>
<span id="cb6-49"><a href="#cb6-49"></a>                <span class="co"># 股权结构数据使用特殊的读取方式，保持与代码1一致</span></span>
<span id="cb6-50"><a href="#cb6-50"></a>                <span class="cf">if</span> data_type <span class="op">==</span> <span class="st">"股权结构"</span>:</span>
<span id="cb6-51"><a href="#cb6-51"></a>                    df <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb6-52"><a href="#cb6-52"></a>                    <span class="cf">if</span> <span class="st">'证券代码'</span> <span class="kw">in</span> df.iloc[<span class="dv">0</span>].values <span class="kw">or</span> <span class="st">'Symbol'</span> <span class="kw">in</span> df.iloc[<span class="dv">0</span>].values:</span>
<span id="cb6-53"><a href="#cb6-53"></a>                        df <span class="op">=</span> pd.read_csv(file_path, header<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-54"><a href="#cb6-54"></a>                <span class="cf">else</span>:</span>
<span id="cb6-55"><a href="#cb6-55"></a>                    <span class="co"># 其他数据类型使用代码2的读取方式</span></span>
<span id="cb6-56"><a href="#cb6-56"></a>                    df <span class="op">=</span> pd.read_csv(file_path, header<span class="op">=</span><span class="dv">1</span>, skiprows<span class="op">=</span>[<span class="dv">2</span>])</span>
<span id="cb6-57"><a href="#cb6-57"></a>                </span>
<span id="cb6-58"><a href="#cb6-58"></a>                df <span class="op">=</span> df.rename(columns<span class="op">=</span>column_mapping)</span>
<span id="cb6-59"><a href="#cb6-59"></a>                </span>
<span id="cb6-60"><a href="#cb6-60"></a>                </span>
<span id="cb6-61"><a href="#cb6-61"></a>                <span class="va">self</span>.data[data_type] <span class="op">=</span> <span class="va">self</span>._preprocess_data(df, data_type)</span>
<span id="cb6-62"><a href="#cb6-62"></a>                <span class="bu">print</span>(<span class="ss">f"✅ 成功加载</span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss">数据，共</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">行"</span>)</span>
<span id="cb6-63"><a href="#cb6-63"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-64"><a href="#cb6-64"></a>                <span class="bu">print</span>(<span class="ss">f"❌ 加载</span><span class="sc">{</span>data_type<span class="sc">}</span><span class="ss">数据失败: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-65"><a href="#cb6-65"></a>                <span class="va">self</span>.data[data_type] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-66"><a href="#cb6-66"></a>        </span>
<span id="cb6-67"><a href="#cb6-67"></a>        <span class="va">self</span>._merge_data()</span>
<span id="cb6-68"><a href="#cb6-68"></a>        <span class="va">self</span>._validate_data()</span>
<span id="cb6-69"><a href="#cb6-69"></a>        <span class="cf">return</span> <span class="va">self</span>.merged_data</span>
<span id="cb6-70"><a href="#cb6-70"></a>    </span>
<span id="cb6-71"><a href="#cb6-71"></a>    <span class="kw">def</span> _preprocess_data(<span class="va">self</span>, df: pd.DataFrame, data_type: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-72"><a href="#cb6-72"></a>        <span class="co">"""预处理单个数据文件"""</span></span>
<span id="cb6-73"><a href="#cb6-73"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>]).columns:</span>
<span id="cb6-74"><a href="#cb6-74"></a>            <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'Symbol'</span>, <span class="st">'IndustryCodeD'</span>, <span class="st">'IndustryNameD'</span>, <span class="st">'LISTINGDATE'</span>]:</span>
<span id="cb6-75"><a href="#cb6-75"></a>                <span class="cf">try</span>:</span>
<span id="cb6-76"><a href="#cb6-76"></a>                    df[col] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb6-77"><a href="#cb6-77"></a>                        df[col].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">'元'</span>, <span class="st">''</span>).<span class="bu">str</span>.replace(<span class="st">','</span>, <span class="st">''</span>).<span class="bu">str</span>.replace(<span class="st">'--'</span>, <span class="st">'nan'</span>),</span>
<span id="cb6-78"><a href="#cb6-78"></a>                        errors<span class="op">=</span><span class="st">'coerce'</span></span>
<span id="cb6-79"><a href="#cb6-79"></a>                    )</span>
<span id="cb6-80"><a href="#cb6-80"></a>                <span class="cf">except</span>:</span>
<span id="cb6-81"><a href="#cb6-81"></a>                    <span class="cf">pass</span></span>
<span id="cb6-82"><a href="#cb6-82"></a>                </span>
<span id="cb6-83"><a href="#cb6-83"></a>        <span class="co"># 处理日期列</span></span>
<span id="cb6-84"><a href="#cb6-84"></a>        <span class="cf">if</span> <span class="st">'LISTINGDATE'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-85"><a href="#cb6-85"></a>            df[<span class="st">'LISTINGDATE'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'LISTINGDATE'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb6-86"><a href="#cb6-86"></a>            </span>
<span id="cb6-87"><a href="#cb6-87"></a>        <span class="cf">if</span> <span class="st">'Year'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-88"><a href="#cb6-88"></a>            df[<span class="st">'Year'</span>] <span class="op">=</span> pd.to_numeric(df[<span class="st">'Year'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>).astype(<span class="st">'Int64'</span>)</span>
<span id="cb6-89"><a href="#cb6-89"></a>            </span>
<span id="cb6-90"><a href="#cb6-90"></a>        <span class="cf">return</span> df</span>
<span id="cb6-91"><a href="#cb6-91"></a>    </span>
<span id="cb6-92"><a href="#cb6-92"></a>    <span class="kw">def</span> _merge_data(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-93"><a href="#cb6-93"></a>        <span class="cf">if</span> <span class="va">self</span>.data[<span class="st">"资产负债表"</span>] <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="va">self</span>.data[<span class="st">"利润表"</span>] <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-94"><a href="#cb6-94"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"资产负债表和利润表数据是必需的"</span>)</span>
<span id="cb6-95"><a href="#cb6-95"></a>            </span>
<span id="cb6-96"><a href="#cb6-96"></a>        <span class="va">self</span>.merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb6-97"><a href="#cb6-97"></a>            <span class="va">self</span>.data[<span class="st">"资产负债表"</span>],</span>
<span id="cb6-98"><a href="#cb6-98"></a>            <span class="va">self</span>.data[<span class="st">"利润表"</span>][[<span class="st">"Symbol"</span>, <span class="st">"Year"</span>, <span class="st">"NetProfit"</span>]],</span>
<span id="cb6-99"><a href="#cb6-99"></a>            on<span class="op">=</span>[<span class="st">"Symbol"</span>, <span class="st">"Year"</span>],</span>
<span id="cb6-100"><a href="#cb6-100"></a>            how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb6-101"><a href="#cb6-101"></a>        )</span>
<span id="cb6-102"><a href="#cb6-102"></a>        </span>
<span id="cb6-103"><a href="#cb6-103"></a>        <span class="co"># 合并公司信息表</span></span>
<span id="cb6-104"><a href="#cb6-104"></a>        <span class="cf">if</span> <span class="va">self</span>.data[<span class="st">"公司信息"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-105"><a href="#cb6-105"></a>            company_columns <span class="op">=</span> [<span class="st">"Symbol"</span>, <span class="st">"IndustryCodeD"</span>, <span class="st">"IndustryNameD"</span>, <span class="st">"LISTINGDATE"</span>]</span>
<span id="cb6-106"><a href="#cb6-106"></a>            available_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> company_columns <span class="cf">if</span> col <span class="kw">in</span> <span class="va">self</span>.data[<span class="st">"公司信息"</span>].columns]</span>
<span id="cb6-107"><a href="#cb6-107"></a>            <span class="cf">if</span> available_columns:</span>
<span id="cb6-108"><a href="#cb6-108"></a>                company_info <span class="op">=</span> <span class="va">self</span>.data[<span class="st">"公司信息"</span>][available_columns]</span>
<span id="cb6-109"><a href="#cb6-109"></a>                <span class="va">self</span>.merged_data <span class="op">=</span> pd.merge(<span class="va">self</span>.merged_data, company_info, on<span class="op">=</span><span class="st">"Symbol"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb6-110"><a href="#cb6-110"></a>        </span>
<span id="cb6-111"><a href="#cb6-111"></a>        <span class="cf">if</span> <span class="va">self</span>.data[<span class="st">"股权结构"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-112"><a href="#cb6-112"></a>            ownership_columns <span class="op">=</span> [<span class="st">"Symbol"</span>, <span class="st">"Year"</span>, <span class="st">"Top1"</span>, <span class="st">"HHI5"</span>]</span>
<span id="cb6-113"><a href="#cb6-113"></a>            available_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> ownership_columns <span class="cf">if</span> col <span class="kw">in</span> <span class="va">self</span>.data[<span class="st">"股权结构"</span>].columns]</span>
<span id="cb6-114"><a href="#cb6-114"></a>            <span class="cf">if</span> available_columns:</span>
<span id="cb6-115"><a href="#cb6-115"></a>                ownership_data <span class="op">=</span> <span class="va">self</span>.data[<span class="st">"股权结构"</span>][available_columns]</span>
<span id="cb6-116"><a href="#cb6-116"></a>                <span class="va">self</span>.merged_data <span class="op">=</span> pd.merge(<span class="va">self</span>.merged_data, ownership_data, on<span class="op">=</span>[<span class="st">"Symbol"</span>, <span class="st">"Year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb6-117"><a href="#cb6-117"></a>                </span>
<span id="cb6-118"><a href="#cb6-118"></a>    </span>
<span id="cb6-119"><a href="#cb6-119"></a>                </span>
<span id="cb6-120"><a href="#cb6-120"></a>        <span class="co"># 计算Age指标（基于精确日期差值，只保留2000年后的数据）</span></span>
<span id="cb6-121"><a href="#cb6-121"></a>        <span class="cf">if</span> <span class="va">self</span>.data[<span class="st">"公司信息"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="st">"LISTINGDATE"</span> <span class="kw">in</span> <span class="va">self</span>.merged_data.columns:</span>
<span id="cb6-122"><a href="#cb6-122"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.merged_data[<span class="st">"LISTINGDATE"</span>].isna().<span class="bu">all</span>():</span>
<span id="cb6-123"><a href="#cb6-123"></a>                <span class="co"># 提取数据中的最大年份作为最晚统计截止日期</span></span>
<span id="cb6-124"><a href="#cb6-124"></a>                max_year <span class="op">=</span> <span class="va">self</span>.merged_data[<span class="st">"Year"</span>].<span class="bu">max</span>()</span>
<span id="cb6-125"><a href="#cb6-125"></a>                <span class="cf">if</span> pd.notna(max_year):</span>
<span id="cb6-126"><a href="#cb6-126"></a>                    latest_date <span class="op">=</span> pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>max_year<span class="sc">}</span><span class="ss">-12-31"</span>)</span>
<span id="cb6-127"><a href="#cb6-127"></a>                    </span>
<span id="cb6-128"><a href="#cb6-128"></a>                    <span class="co"># 为每个公司生成从上市到最晚统计截止日期的所有年份数据</span></span>
<span id="cb6-129"><a href="#cb6-129"></a>                    all_years_data <span class="op">=</span> []</span>
<span id="cb6-130"><a href="#cb6-130"></a>                    <span class="cf">for</span> _, row <span class="kw">in</span> <span class="va">self</span>.merged_data.drop_duplicates(subset<span class="op">=</span>[<span class="st">'Symbol'</span>]).iterrows():</span>
<span id="cb6-131"><a href="#cb6-131"></a>                        <span class="cf">if</span> pd.notna(row[<span class="st">'LISTINGDATE'</span>]):</span>
<span id="cb6-132"><a href="#cb6-132"></a>                            listing_year <span class="op">=</span> row[<span class="st">'LISTINGDATE'</span>].year</span>
<span id="cb6-133"><a href="#cb6-133"></a>                            </span>
<span id="cb6-134"><a href="#cb6-134"></a>                            <span class="co"># 只生成2000年及以后的数据</span></span>
<span id="cb6-135"><a href="#cb6-135"></a>                            start_year <span class="op">=</span> <span class="bu">max</span>(<span class="dv">2000</span>, listing_year)</span>
<span id="cb6-136"><a href="#cb6-136"></a>                            </span>
<span id="cb6-137"><a href="#cb6-137"></a>                            <span class="cf">for</span> year <span class="kw">in</span> <span class="bu">range</span>(start_year, max_year <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb6-138"><a href="#cb6-138"></a>                                year_date <span class="op">=</span> pd.Timestamp(<span class="ss">f"</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-12-31"</span>)</span>
<span id="cb6-139"><a href="#cb6-139"></a>                                days_diff <span class="op">=</span> (year_date <span class="op">-</span> row[<span class="st">'LISTINGDATE'</span>]).days</span>
<span id="cb6-140"><a href="#cb6-140"></a>                                age <span class="op">=</span> <span class="bu">round</span>(days_diff <span class="op">/</span> <span class="fl">365.25</span>, <span class="dv">2</span>)</span>
<span id="cb6-141"><a href="#cb6-141"></a>                                </span>
<span id="cb6-142"><a href="#cb6-142"></a>                                all_years_data.append({</span>
<span id="cb6-143"><a href="#cb6-143"></a>                                    <span class="st">'Symbol'</span>: row[<span class="st">'Symbol'</span>],</span>
<span id="cb6-144"><a href="#cb6-144"></a>                                    <span class="st">'Year'</span>: year,</span>
<span id="cb6-145"><a href="#cb6-145"></a>                                    <span class="st">'Age'</span>: age</span>
<span id="cb6-146"><a href="#cb6-146"></a>                                })</span>
<span id="cb6-147"><a href="#cb6-147"></a>                    </span>
<span id="cb6-148"><a href="#cb6-148"></a>                    <span class="co"># 创建包含所有年份的Age DataFrame</span></span>
<span id="cb6-149"><a href="#cb6-149"></a>                    age_df <span class="op">=</span> pd.DataFrame(all_years_data)</span>
<span id="cb6-150"><a href="#cb6-150"></a>                    </span>
<span id="cb6-151"><a href="#cb6-151"></a>                    <span class="co"># 将Age数据合并回主数据</span></span>
<span id="cb6-152"><a href="#cb6-152"></a>                    <span class="va">self</span>.merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb6-153"><a href="#cb6-153"></a>                        <span class="va">self</span>.merged_data,</span>
<span id="cb6-154"><a href="#cb6-154"></a>                        age_df,</span>
<span id="cb6-155"><a href="#cb6-155"></a>                        on<span class="op">=</span>[<span class="st">'Symbol'</span>, <span class="st">'Year'</span>],</span>
<span id="cb6-156"><a href="#cb6-156"></a>                        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb6-157"><a href="#cb6-157"></a>                    )</span>
<span id="cb6-158"><a href="#cb6-158"></a>                    </span>
<span id="cb6-159"><a href="#cb6-159"></a>                    <span class="co"># 只保留2000年及以后的数据</span></span>
<span id="cb6-160"><a href="#cb6-160"></a>                    <span class="va">self</span>.merged_data <span class="op">=</span> <span class="va">self</span>.merged_data[<span class="va">self</span>.merged_data[<span class="st">'Year'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]</span>
<span id="cb6-161"><a href="#cb6-161"></a>                    </span>
<span id="cb6-162"><a href="#cb6-162"></a>                    <span class="co"># 计算平均Age</span></span>
<span id="cb6-163"><a href="#cb6-163"></a>                    valid_ages <span class="op">=</span> <span class="va">self</span>.merged_data[<span class="st">'Age'</span>].dropna()</span>
<span id="cb6-164"><a href="#cb6-164"></a>                    <span class="cf">if</span> <span class="kw">not</span> valid_ages.empty:</span>
<span id="cb6-165"><a href="#cb6-165"></a>                        max_age <span class="op">=</span> valid_ages.<span class="bu">max</span>()</span>
<span id="cb6-166"><a href="#cb6-166"></a>                        <span class="bu">print</span>(<span class="ss">f"✅ 2000-</span><span class="sc">{</span>max_year<span class="sc">}</span><span class="ss">年公司最大上市年限为: </span><span class="sc">{</span>max_age<span class="sc">:.2f}</span><span class="ss">年"</span>)</span>
<span id="cb6-167"><a href="#cb6-167"></a>                    <span class="cf">else</span>:</span>
<span id="cb6-168"><a href="#cb6-168"></a>                        <span class="bu">print</span>(<span class="st">"⚠️ 无法计算平均上市年限：没有有效数据"</span>)</span>
<span id="cb6-169"><a href="#cb6-169"></a>                <span class="cf">else</span>:</span>
<span id="cb6-170"><a href="#cb6-170"></a>                    <span class="bu">print</span>(<span class="st">"⚠️ 无法确定最晚统计截止日期：年份数据缺失"</span>)</span>
<span id="cb6-171"><a href="#cb6-171"></a>            <span class="cf">else</span>:</span>
<span id="cb6-172"><a href="#cb6-172"></a>                <span class="bu">print</span>(<span class="st">"⚠️ 公司信息表中LISTINGDATE全部缺失，无法计算Age指标"</span>)</span>
<span id="cb6-173"><a href="#cb6-173"></a>                <span class="va">self</span>.merged_data.drop(columns<span class="op">=</span>[<span class="st">"LISTINGDATE"</span>], inplace<span class="op">=</span><span class="va">True</span>, errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="cb6-174"><a href="#cb6-174"></a>        <span class="cf">else</span>:</span>
<span id="cb6-175"><a href="#cb6-175"></a>            <span class="bu">print</span>(<span class="st">"⚠️ 未加载公司信息表或缺少LISTINGDATE字段，无法计算Age指标"</span>)</span>
<span id="cb6-176"><a href="#cb6-176"></a></span>
<span id="cb6-177"><a href="#cb6-177"></a>    <span class="kw">def</span> _validate_data(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-178"><a href="#cb6-178"></a>        <span class="co">"""验证合并后的数据质量"""</span></span>
<span id="cb6-179"><a href="#cb6-179"></a>        <span class="cf">if</span> <span class="va">self</span>.merged_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-180"><a href="#cb6-180"></a>            <span class="cf">return</span></span>
<span id="cb6-181"><a href="#cb6-181"></a>        </span>
<span id="cb6-182"><a href="#cb6-182"></a>        <span class="co"># 检查关键指标缺失率</span></span>
<span id="cb6-183"><a href="#cb6-183"></a>        key_metrics <span class="op">=</span> [<span class="st">"TotalAssets"</span>, <span class="st">"TotalLiabilities"</span>, <span class="st">"NetProfit"</span>, <span class="st">"Age"</span>, <span class="st">"Top1"</span>, <span class="st">"HHI5"</span>]</span>
<span id="cb6-184"><a href="#cb6-184"></a>        <span class="cf">for</span> metric <span class="kw">in</span> key_metrics:</span>
<span id="cb6-185"><a href="#cb6-185"></a>            <span class="cf">if</span> metric <span class="kw">in</span> <span class="va">self</span>.merged_data.columns:</span>
<span id="cb6-186"><a href="#cb6-186"></a>                missing_rate <span class="op">=</span> <span class="va">self</span>.merged_data[metric].isna().mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb6-187"><a href="#cb6-187"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">缺失率: </span><span class="sc">{</span>missing_rate<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb6-188"><a href="#cb6-188"></a>    </span>
<span id="cb6-189"><a href="#cb6-189"></a>    <span class="kw">def</span> save_merged_data(<span class="va">self</span>, filename: <span class="bu">str</span> <span class="op">=</span> <span class="st">"merged_data.csv"</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-190"><a href="#cb6-190"></a>        <span class="cf">if</span> <span class="va">self</span>.merged_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-191"><a href="#cb6-191"></a>            file_path <span class="op">=</span> <span class="va">self</span>.output_path <span class="op">/</span> filename</span>
<span id="cb6-192"><a href="#cb6-192"></a>            <span class="va">self</span>.merged_data.to_csv(file_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-193"><a href="#cb6-193"></a>            <span class="bu">print</span>(<span class="ss">f"✅ 合并数据已保存至: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-194"><a href="#cb6-194"></a>    </span>
<span id="cb6-195"><a href="#cb6-195"></a>    <span class="kw">def</span> save_metrics_data(<span class="va">self</span>, filename: <span class="bu">str</span> <span class="op">=</span> <span class="st">"metrics_data.csv"</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-196"><a href="#cb6-196"></a>        <span class="cf">if</span> <span class="va">self</span>.metrics_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-197"><a href="#cb6-197"></a>            file_path <span class="op">=</span> <span class="va">self</span>.output_path <span class="op">/</span> filename</span>
<span id="cb6-198"><a href="#cb6-198"></a>            <span class="va">self</span>.metrics_data.to_csv(file_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-199"><a href="#cb6-199"></a>            <span class="bu">print</span>(<span class="ss">f"✅ 指标数据已保存至: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-200"><a href="#cb6-200"></a></span>
<span id="cb6-201"><a href="#cb6-201"></a><span class="co">### 指标计算与分析（保存指标数据）</span></span>
<span id="cb6-202"><a href="#cb6-202"></a><span class="kw">class</span> FinancialAnalyzer:</span>
<span id="cb6-203"><a href="#cb6-203"></a>    <span class="co">"""财务指标计算与分析工具"""</span></span>
<span id="cb6-204"><a href="#cb6-204"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data: pd.DataFrame, output_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">'output'</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-205"><a href="#cb6-205"></a>        <span class="va">self</span>.data <span class="op">=</span> data</span>
<span id="cb6-206"><a href="#cb6-206"></a>        <span class="va">self</span>.output_path <span class="op">=</span> Path(output_path)</span>
<span id="cb6-207"><a href="#cb6-207"></a>        <span class="va">self</span>.output_path.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-208"><a href="#cb6-208"></a>        <span class="va">self</span>.metrics_data <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-209"><a href="#cb6-209"></a>        </span>
<span id="cb6-210"><a href="#cb6-210"></a>    <span class="kw">def</span> calculate_metrics(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-211"><a href="#cb6-211"></a>        <span class="cf">if</span> <span class="va">self</span>.data <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="bu">len</span>(<span class="va">self</span>.data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-212"><a href="#cb6-212"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"请提供有效的DataFrame"</span>)</span>
<span id="cb6-213"><a href="#cb6-213"></a>            </span>
<span id="cb6-214"><a href="#cb6-214"></a>        df <span class="op">=</span> <span class="va">self</span>.data.copy()</span>
<span id="cb6-215"><a href="#cb6-215"></a>        </span>
<span id="cb6-216"><a href="#cb6-216"></a>        <span class="co"># 指标计算函数</span></span>
<span id="cb6-217"><a href="#cb6-217"></a>        <span class="kw">def</span> calculate_lev(df):</span>
<span id="cb6-218"><a href="#cb6-218"></a>            <span class="cf">if</span> <span class="st">"TotalLiabilities"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-219"><a href="#cb6-219"></a>                df[<span class="st">"Lev"</span>] <span class="op">=</span> df[<span class="st">"TotalLiabilities"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-220"><a href="#cb6-220"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-221"><a href="#cb6-221"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-222"><a href="#cb6-222"></a>            </span>
<span id="cb6-223"><a href="#cb6-223"></a>        <span class="kw">def</span> _calculate_ll(df):</span>
<span id="cb6-224"><a href="#cb6-224"></a>            <span class="cf">if</span> <span class="st">"NonCurrentLiabilities"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-225"><a href="#cb6-225"></a>                df[<span class="st">"LL"</span>] <span class="op">=</span> df[<span class="st">"NonCurrentLiabilities"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-226"><a href="#cb6-226"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-227"><a href="#cb6-227"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-228"><a href="#cb6-228"></a>            </span>
<span id="cb6-229"><a href="#cb6-229"></a>        <span class="kw">def</span> _calculate_sl(df):</span>
<span id="cb6-230"><a href="#cb6-230"></a>            <span class="cf">if</span> <span class="st">"CurrentLiabilities"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-231"><a href="#cb6-231"></a>                df[<span class="st">"SL"</span>] <span class="op">=</span> df[<span class="st">"CurrentLiabilities"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-232"><a href="#cb6-232"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-233"><a href="#cb6-233"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-234"><a href="#cb6-234"></a>            </span>
<span id="cb6-235"><a href="#cb6-235"></a>        <span class="kw">def</span> _calculate_sdr(df):</span>
<span id="cb6-236"><a href="#cb6-236"></a>            <span class="cf">if</span> <span class="st">"CurrentLiabilities"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalLiabilities"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-237"><a href="#cb6-237"></a>                df[<span class="st">"SDR"</span>] <span class="op">=</span> df[<span class="st">"CurrentLiabilities"</span>] <span class="op">/</span> df[<span class="st">"TotalLiabilities"</span>]</span>
<span id="cb6-238"><a href="#cb6-238"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-239"><a href="#cb6-239"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-240"><a href="#cb6-240"></a>            </span>
<span id="cb6-241"><a href="#cb6-241"></a>        <span class="kw">def</span> _calculate_cash(df):</span>
<span id="cb6-242"><a href="#cb6-242"></a>            <span class="cf">if</span> <span class="st">"Cash"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-243"><a href="#cb6-243"></a>                df[<span class="st">"Cash"</span>] <span class="op">=</span> df[<span class="st">"Cash"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-244"><a href="#cb6-244"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-245"><a href="#cb6-245"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-246"><a href="#cb6-246"></a>            </span>
<span id="cb6-247"><a href="#cb6-247"></a>        <span class="kw">def</span> _calculate_roa(df):</span>
<span id="cb6-248"><a href="#cb6-248"></a>            <span class="cf">if</span> <span class="st">"NetProfit"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-249"><a href="#cb6-249"></a>                df[<span class="st">"ROA"</span>] <span class="op">=</span> df[<span class="st">"NetProfit"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-250"><a href="#cb6-250"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-251"><a href="#cb6-251"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-252"><a href="#cb6-252"></a>            </span>
<span id="cb6-253"><a href="#cb6-253"></a>        <span class="kw">def</span> _calculate_roe(df):</span>
<span id="cb6-254"><a href="#cb6-254"></a>            <span class="cf">if</span> <span class="st">"NetProfit"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalLiabilities"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-255"><a href="#cb6-255"></a>                equity <span class="op">=</span> df[<span class="st">"TotalAssets"</span>] <span class="op">-</span> df[<span class="st">"TotalLiabilities"</span>]</span>
<span id="cb6-256"><a href="#cb6-256"></a>                valid_mask <span class="op">=</span> (equity <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (<span class="op">~</span>equity.isna())</span>
<span id="cb6-257"><a href="#cb6-257"></a>                df.loc[valid_mask, <span class="st">"ROE"</span>] <span class="op">=</span> df.loc[valid_mask, <span class="st">"NetProfit"</span>] <span class="op">/</span> equity[valid_mask]</span>
<span id="cb6-258"><a href="#cb6-258"></a>                <span class="cf">return</span> valid_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb6-259"><a href="#cb6-259"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-260"><a href="#cb6-260"></a>            </span>
<span id="cb6-261"><a href="#cb6-261"></a>        <span class="kw">def</span> _calculate_sloan(df):</span>
<span id="cb6-262"><a href="#cb6-262"></a>            <span class="cf">if</span> <span class="st">"ShortTermLoans"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-263"><a href="#cb6-263"></a>                df[<span class="st">"SLoan"</span>] <span class="op">=</span> df[<span class="st">"ShortTermLoans"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-264"><a href="#cb6-264"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-265"><a href="#cb6-265"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-266"><a href="#cb6-266"></a>            </span>
<span id="cb6-267"><a href="#cb6-267"></a>        <span class="kw">def</span> _calculate_lloan(df):</span>
<span id="cb6-268"><a href="#cb6-268"></a>            <span class="cf">if</span> <span class="st">"LongTermLoans"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-269"><a href="#cb6-269"></a>                df[<span class="st">"LLoan"</span>] <span class="op">=</span> df[<span class="st">"LongTermLoans"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-270"><a href="#cb6-270"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-271"><a href="#cb6-271"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-272"><a href="#cb6-272"></a>            </span>
<span id="cb6-273"><a href="#cb6-273"></a>        <span class="kw">def</span> _calculate_size(df):</span>
<span id="cb6-274"><a href="#cb6-274"></a>            <span class="cf">if</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-275"><a href="#cb6-275"></a>                df[<span class="st">"Size"</span>] <span class="op">=</span> np.log(df[<span class="st">"TotalAssets"</span>])</span>
<span id="cb6-276"><a href="#cb6-276"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-277"><a href="#cb6-277"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-278"><a href="#cb6-278"></a>            </span>
<span id="cb6-279"><a href="#cb6-279"></a>        <span class="co"># 执行指标计算</span></span>
<span id="cb6-280"><a href="#cb6-280"></a>        metrics_status <span class="op">=</span> {</span>
<span id="cb6-281"><a href="#cb6-281"></a>            <span class="st">"Lev"</span>: calculate_lev(df),</span>
<span id="cb6-282"><a href="#cb6-282"></a>            <span class="st">"SL"</span>: _calculate_sl(df),</span>
<span id="cb6-283"><a href="#cb6-283"></a>            <span class="st">"LL"</span>: _calculate_ll(df),</span>
<span id="cb6-284"><a href="#cb6-284"></a>            <span class="st">"SDR"</span>: _calculate_sdr(df),</span>
<span id="cb6-285"><a href="#cb6-285"></a>            <span class="st">"Cash"</span>: _calculate_cash(df),</span>
<span id="cb6-286"><a href="#cb6-286"></a>            <span class="st">"ROA"</span>: _calculate_roa(df),</span>
<span id="cb6-287"><a href="#cb6-287"></a>            <span class="st">"ROE"</span>: _calculate_roe(df),</span>
<span id="cb6-288"><a href="#cb6-288"></a>            <span class="st">"SLoan"</span>: _calculate_sloan(df),</span>
<span id="cb6-289"><a href="#cb6-289"></a>            <span class="st">"LLoan"</span>: _calculate_lloan(df),</span>
<span id="cb6-290"><a href="#cb6-290"></a>            <span class="st">"Top1"</span>: <span class="st">"Top1"</span> <span class="kw">in</span> df.columns,</span>
<span id="cb6-291"><a href="#cb6-291"></a>            <span class="st">"HHI5"</span>: <span class="st">"HHI5"</span> <span class="kw">in</span> df.columns,</span>
<span id="cb6-292"><a href="#cb6-292"></a>            <span class="st">"Size"</span>: _calculate_size(df),</span>
<span id="cb6-293"><a href="#cb6-293"></a>            <span class="st">"Age"</span>: <span class="st">"Age"</span> <span class="kw">in</span> df.columns  <span class="co"># 添加Age指标</span></span>
<span id="cb6-294"><a href="#cb6-294"></a>        }</span>
<span id="cb6-295"><a href="#cb6-295"></a>        </span>
<span id="cb6-296"><a href="#cb6-296"></a>        <span class="co"># 处理离群值</span></span>
<span id="cb6-297"><a href="#cb6-297"></a>        available_metrics <span class="op">=</span> [metric <span class="cf">for</span> metric, status <span class="kw">in</span> metrics_status.items() <span class="cf">if</span> status]</span>
<span id="cb6-298"><a href="#cb6-298"></a>        <span class="cf">for</span> col <span class="kw">in</span> available_metrics:</span>
<span id="cb6-299"><a href="#cb6-299"></a>            <span class="cf">if</span> col <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="kw">not</span> df[col].isna().<span class="bu">all</span>() <span class="kw">and</span> <span class="kw">not</span> col.startswith(<span class="st">"Age"</span>):</span>
<span id="cb6-300"><a href="#cb6-300"></a>                df[col] <span class="op">=</span> df.groupby(<span class="st">'Year'</span>)[col].transform(<span class="kw">lambda</span> x: x.clip(x.quantile(<span class="fl">0.01</span>), x.quantile(<span class="fl">0.99</span>)))</span>
<span id="cb6-301"><a href="#cb6-301"></a>                <span class="bu">print</span>(<span class="ss">f"✅ </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">指标已按年份动态缩尾处理（1%-99%）"</span>)</span>
<span id="cb6-302"><a href="#cb6-302"></a>        </span>
<span id="cb6-303"><a href="#cb6-303"></a>        <span class="va">self</span>.metrics_data <span class="op">=</span> df</span>
<span id="cb6-304"><a href="#cb6-304"></a>        <span class="bu">print</span>(<span class="ss">f"财务指标计算完成，成功计算了</span><span class="sc">{</span><span class="bu">len</span>(available_metrics)<span class="sc">}</span><span class="ss">个指标"</span>)</span>
<span id="cb6-305"><a href="#cb6-305"></a>        </span>
<span id="cb6-306"><a href="#cb6-306"></a>        <span class="cf">return</span> df</span>
<span id="cb6-307"><a href="#cb6-307"></a>    </span>
<span id="cb6-308"><a href="#cb6-308"></a>    <span class="co"># 辅助指标计算函数（保持不变）</span></span>
<span id="cb6-309"><a href="#cb6-309"></a>    <span class="kw">def</span> _calculate_sl(<span class="va">self</span>, df):</span>
<span id="cb6-310"><a href="#cb6-310"></a>        <span class="cf">if</span> <span class="st">"CurrentLiabilities"</span> <span class="kw">in</span> df.columns <span class="kw">and</span> <span class="st">"TotalAssets"</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-311"><a href="#cb6-311"></a>            df[<span class="st">"SL"</span>] <span class="op">=</span> df[<span class="st">"CurrentLiabilities"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]</span>
<span id="cb6-312"><a href="#cb6-312"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-313"><a href="#cb6-313"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-314"><a href="#cb6-314"></a>    </span>
<span id="cb6-315"><a href="#cb6-315"></a>    <span class="co"># 其他辅助函数不变</span></span>
<span id="cb6-316"><a href="#cb6-316"></a>    </span>
<span id="cb6-317"><a href="#cb6-317"></a>    <span class="kw">def</span> generate_analysis_report(<span class="va">self</span>, metrics: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-318"><a href="#cb6-318"></a>        <span class="cf">if</span> <span class="va">self</span>.metrics_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-319"><a href="#cb6-319"></a>            <span class="va">self</span>.calculate_metrics()</span>
<span id="cb6-320"><a href="#cb6-320"></a>            </span>
<span id="cb6-321"><a href="#cb6-321"></a>        report_intro <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb6-322"><a href="#cb6-322"></a><span class="st">数据处理说明：</span></span>
<span id="cb6-323"><a href="#cb6-323"></a><span class="st">1. 所有财务指标均经过1</span><span class="sc">%-99%</span><span class="st">分位缩尾处理，以剔除极端值影响；</span></span>
<span id="cb6-324"><a href="#cb6-324"></a><span class="st">2. ROE计算时剔除了净资产为零或负值的企业，具体剔除比例见各年度统计；</span></span>
<span id="cb6-325"><a href="#cb6-325"></a><span class="st">3. 上市年龄(Age)基于首次上市日期(LISTINGDATE)计算，精确到天，保留两位小数；</span></span>
<span id="cb6-326"><a href="#cb6-326"></a><span class="st">4. 分析数据范围为2000年及以后的公司信息。</span></span>
<span id="cb6-327"><a href="#cb6-327"></a><span class="st">        </span><span class="ch">\n</span><span class="st">"""</span></span>
<span id="cb6-328"><a href="#cb6-328"></a>        </span>
<span id="cb6-329"><a href="#cb6-329"></a>        <span class="cf">if</span> metrics <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-330"><a href="#cb6-330"></a>            metrics <span class="op">=</span> [<span class="st">"Lev"</span>, <span class="st">"SL"</span>, <span class="st">"LL"</span>, <span class="st">"SDR"</span>, <span class="st">"Cash"</span>, <span class="st">"ROA"</span>, <span class="st">"ROE"</span>, <span class="st">"SLoan"</span>, <span class="st">"LLoan"</span>, <span class="st">"Size"</span>]</span>
<span id="cb6-331"><a href="#cb6-331"></a>            <span class="cf">if</span> <span class="st">"Top1"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-332"><a href="#cb6-332"></a>                metrics.append(<span class="st">"Top1"</span>)</span>
<span id="cb6-333"><a href="#cb6-333"></a>            <span class="cf">if</span> <span class="st">"HHI5"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-334"><a href="#cb6-334"></a>                metrics.append(<span class="st">"HHI5"</span>)</span>
<span id="cb6-335"><a href="#cb6-335"></a>            </span>
<span id="cb6-336"><a href="#cb6-336"></a>                </span>
<span id="cb6-337"><a href="#cb6-337"></a>        report_path <span class="op">=</span> <span class="va">self</span>.output_path <span class="op">/</span> <span class="st">"analysis_report.txt"</span></span>
<span id="cb6-338"><a href="#cb6-338"></a>        <span class="cf">with</span> <span class="bu">open</span>(report_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb6-339"><a href="#cb6-339"></a>            f.write(<span class="st">"财务指标分析报告</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-340"><a href="#cb6-340"></a>            f.write(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-341"><a href="#cb6-341"></a>            f.write(report_intro.lstrip())  <span class="co"># 左对齐</span></span>
<span id="cb6-342"><a href="#cb6-342"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">一、数据集概述</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-343"><a href="#cb6-343"></a>            f.write(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-344"><a href="#cb6-344"></a>            f.write(<span class="ss">f"分析期间: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>metrics_data[<span class="st">'Year'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>metrics_data[<span class="st">'Year'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-345"><a href="#cb6-345"></a>            f.write(<span class="ss">f"公司数量: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>metrics_data[<span class="st">'Symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-346"><a href="#cb6-346"></a>            f.write(<span class="ss">f"观测值总数: </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.metrics_data)<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb6-347"><a href="#cb6-347"></a>            </span>
<span id="cb6-348"><a href="#cb6-348"></a>            f.write(<span class="st">"二、各指标年度统计特征</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-349"><a href="#cb6-349"></a>            f.write(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-350"><a href="#cb6-350"></a>            </span>
<span id="cb6-351"><a href="#cb6-351"></a>            <span class="co"># 1. 常规指标统计（纵向年份，横向指标）</span></span>
<span id="cb6-352"><a href="#cb6-352"></a>            f.write(<span class="st">"1. 财务指标年度统计（纵向年份，横向指标）</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-353"><a href="#cb6-353"></a>            f.write(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-354"><a href="#cb6-354"></a>            </span>
<span id="cb6-355"><a href="#cb6-355"></a>            <span class="co"># 提取所有年份</span></span>
<span id="cb6-356"><a href="#cb6-356"></a>            years <span class="op">=</span> <span class="bu">sorted</span>(<span class="va">self</span>.metrics_data[<span class="st">"Year"</span>].dropna().unique())</span>
<span id="cb6-357"><a href="#cb6-357"></a>            </span>
<span id="cb6-358"><a href="#cb6-358"></a>            <span class="co"># 计算每个指标的统计量</span></span>
<span id="cb6-359"><a href="#cb6-359"></a>            <span class="cf">for</span> metric <span class="kw">in</span> metrics:</span>
<span id="cb6-360"><a href="#cb6-360"></a>                <span class="cf">if</span> metric <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns <span class="kw">and</span> <span class="kw">not</span> <span class="va">self</span>.metrics_data[metric].isna().<span class="bu">all</span>():</span>
<span id="cb6-361"><a href="#cb6-361"></a>                    <span class="co"># 按年份计算统计量</span></span>
<span id="cb6-362"><a href="#cb6-362"></a>                    <span class="cf">if</span> metric <span class="op">==</span> <span class="st">"ROE"</span>:</span>
<span id="cb6-363"><a href="#cb6-363"></a>                        <span class="co"># 特殊处理ROE（显示剔除比例）</span></span>
<span id="cb6-364"><a href="#cb6-364"></a>                        yearly_stats <span class="op">=</span> <span class="va">self</span>.metrics_data.groupby(<span class="st">"Year"</span>)[metric].agg([<span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"std"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>])</span>
<span id="cb6-365"><a href="#cb6-365"></a>                        f.write(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">的年度统计特征（剔除</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>metrics_data[metric]<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">条无效记录）:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-366"><a href="#cb6-366"></a>                    <span class="cf">else</span>:</span>
<span id="cb6-367"><a href="#cb6-367"></a>                        yearly_stats <span class="op">=</span> <span class="va">self</span>.metrics_data.groupby(<span class="st">"Year"</span>)[metric].agg([<span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"std"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>])</span>
<span id="cb6-368"><a href="#cb6-368"></a>                        f.write(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">的年度统计特征:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-369"><a href="#cb6-369"></a>                    </span>
<span id="cb6-370"><a href="#cb6-370"></a>                    <span class="co"># 转置表格，使年份为列，统计量为行</span></span>
<span id="cb6-371"><a href="#cb6-371"></a>                    transposed_stats <span class="op">=</span> yearly_stats.T</span>
<span id="cb6-372"><a href="#cb6-372"></a>                    f.write(transposed_stats.to_string() <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-373"><a href="#cb6-373"></a>                    </span>
<span id="cb6-374"><a href="#cb6-374"></a>                    <span class="co"># 趋势分析</span></span>
<span id="cb6-375"><a href="#cb6-375"></a>                    <span class="cf">if</span> <span class="st">"mean"</span> <span class="kw">in</span> yearly_stats.columns:</span>
<span id="cb6-376"><a href="#cb6-376"></a>                        trend <span class="op">=</span> yearly_stats[<span class="st">"mean"</span>].pct_change().mean()</span>
<span id="cb6-377"><a href="#cb6-377"></a>                        f.write(<span class="ss">f"趋势分析: 总体</span><span class="sc">{</span><span class="st">'上升'</span> <span class="cf">if</span> trend <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'下降'</span><span class="sc">}</span><span class="ss">，年平均变化率为</span><span class="sc">{</span>trend<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb6-378"><a href="#cb6-378"></a>                <span class="cf">else</span>:</span>
<span id="cb6-379"><a href="#cb6-379"></a>                    f.write(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">指标不可用或全部为NaN</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb6-380"><a href="#cb6-380"></a>            </span>
<span id="cb6-381"><a href="#cb6-381"></a>            <span class="co"># 2. Age指标统计（纵向年份，横向指标）</span></span>
<span id="cb6-382"><a href="#cb6-382"></a>            </span>
<span id="cb6-383"><a href="#cb6-383"></a>            <span class="cf">if</span> <span class="st">"Age"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns <span class="kw">and</span> <span class="kw">not</span> <span class="va">self</span>.metrics_data[<span class="st">"Age"</span>].isna().<span class="bu">all</span>():</span>
<span id="cb6-384"><a href="#cb6-384"></a>                <span class="co"># 创建一个DataFrame来保存各年份Age的统计量</span></span>
<span id="cb6-385"><a href="#cb6-385"></a>                age_stats_df <span class="op">=</span> <span class="va">self</span>.metrics_data.groupby(<span class="st">"Year"</span>)[<span class="st">"Age"</span>].describe()</span>
<span id="cb6-386"><a href="#cb6-386"></a>                </span>
<span id="cb6-387"><a href="#cb6-387"></a>                <span class="cf">if</span> <span class="kw">not</span> age_stats_df.empty:</span>
<span id="cb6-388"><a href="#cb6-388"></a>                    <span class="co"># 转置表格，使年份为列，统计量为行</span></span>
<span id="cb6-389"><a href="#cb6-389"></a>                    transposed_age_stats <span class="op">=</span> age_stats_df.T</span>
<span id="cb6-390"><a href="#cb6-390"></a>                    f.write(<span class="st">"Age的年度统计特征:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-391"><a href="#cb6-391"></a>                    <span class="co"># 去掉count这一行</span></span>
<span id="cb6-392"><a href="#cb6-392"></a>                    transposed_age_stats_no_count <span class="op">=</span> transposed_age_stats.drop(index<span class="op">=</span><span class="st">'count'</span>, errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb6-393"><a href="#cb6-393"></a>                    f.write(transposed_age_stats_no_count.to_string() <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-394"><a href="#cb6-394"></a>                <span class="cf">else</span>:</span>
<span id="cb6-395"><a href="#cb6-395"></a>                    f.write(<span class="st">"⚠️ 无有效Age数据</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-396"><a href="#cb6-396"></a>            <span class="cf">else</span>:</span>
<span id="cb6-397"><a href="#cb6-397"></a>                f.write(<span class="st">"⚠️ 未计算Age指标或数据全部缺失</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-398"><a href="#cb6-398"></a>                    </span>
<span id="cb6-399"><a href="#cb6-399"></a>            f.write(<span class="st">"三、指标分析总结</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-400"><a href="#cb6-400"></a>            f.write(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb6-401"><a href="#cb6-401"></a>            </span>
<span id="cb6-402"><a href="#cb6-402"></a>            <span class="co"># 资本结构指标总结</span></span>
<span id="cb6-403"><a href="#cb6-403"></a>            f.write(<span class="st">"1. 资本结构指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-404"><a href="#cb6-404"></a>            <span class="cf">if</span> <span class="st">"Lev"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-405"><a href="#cb6-405"></a>                avg_lev <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"Lev"</span>].mean()</span>
<span id="cb6-406"><a href="#cb6-406"></a>                f.write(<span class="ss">f"   - 总负债率(Lev)平均为</span><span class="sc">{</span>avg_lev<span class="sc">:.4f}</span><span class="ss">，表明企业平均使用</span><span class="sc">{</span>avg_lev<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%的负债融资</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-407"><a href="#cb6-407"></a>                </span>
<span id="cb6-408"><a href="#cb6-408"></a>            <span class="cf">if</span> <span class="st">"SL"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns <span class="kw">and</span> <span class="st">"LL"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-409"><a href="#cb6-409"></a>                avg_sl <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"SL"</span>].mean()</span>
<span id="cb6-410"><a href="#cb6-410"></a>                avg_ll <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"LL"</span>].mean()</span>
<span id="cb6-411"><a href="#cb6-411"></a>                f.write(<span class="ss">f"   - 流动负债率(SL)平均为</span><span class="sc">{</span>avg_sl<span class="sc">:.4f}</span><span class="ss">，长期负债率(LL)平均为</span><span class="sc">{</span>avg_ll<span class="sc">:.4f}</span><span class="ss">，表明企业短期负债占比较高</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-412"><a href="#cb6-412"></a>                </span>
<span id="cb6-413"><a href="#cb6-413"></a>            <span class="cf">if</span> <span class="st">"SDR"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-414"><a href="#cb6-414"></a>                avg_sdr <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"SDR"</span>].mean()</span>
<span id="cb6-415"><a href="#cb6-415"></a>                f.write(<span class="ss">f"   - 短债比率(SDR)平均为</span><span class="sc">{</span>avg_sdr<span class="sc">:.4f}</span><span class="ss">，表明</span><span class="sc">{</span>avg_sdr<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%的负债为短期负债</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-416"><a href="#cb6-416"></a>            </span>
<span id="cb6-417"><a href="#cb6-417"></a>            <span class="co"># 盈利能力指标总结</span></span>
<span id="cb6-418"><a href="#cb6-418"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">2. 盈利能力指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-419"><a href="#cb6-419"></a>            <span class="cf">if</span> <span class="st">"ROA"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-420"><a href="#cb6-420"></a>                avg_roa <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"ROA"</span>].mean()</span>
<span id="cb6-421"><a href="#cb6-421"></a>                f.write(<span class="ss">f"   - 资产回报率(ROA)平均为</span><span class="sc">{</span>avg_roa<span class="sc">:.4f}</span><span class="ss">，表明企业资产运营效率一般</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-422"><a href="#cb6-422"></a>                </span>
<span id="cb6-423"><a href="#cb6-423"></a>            <span class="cf">if</span> <span class="st">"ROE"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-424"><a href="#cb6-424"></a>                avg_roe <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"ROE"</span>].mean()</span>
<span id="cb6-425"><a href="#cb6-425"></a>                f.write(<span class="ss">f"   - 净资产收益率(ROE)平均为</span><span class="sc">{</span>avg_roe<span class="sc">:.4f}</span><span class="ss">，表明股东权益回报水平一般</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-426"><a href="#cb6-426"></a>                </span>
<span id="cb6-427"><a href="#cb6-427"></a>            <span class="co"># 流动性指标总结</span></span>
<span id="cb6-428"><a href="#cb6-428"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">3. 流动性指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-429"><a href="#cb6-429"></a>            <span class="cf">if</span> <span class="st">"Cash"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-430"><a href="#cb6-430"></a>                avg_cash <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"Cash"</span>].mean()</span>
<span id="cb6-431"><a href="#cb6-431"></a>                f.write(<span class="ss">f"   - 现金比率(Cash)平均为</span><span class="sc">{</span>avg_cash<span class="sc">:.4f}</span><span class="ss">，表明企业流动性储备水平一般</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-432"><a href="#cb6-432"></a>                </span>
<span id="cb6-433"><a href="#cb6-433"></a>            <span class="co"># 银行借款指标总结</span></span>
<span id="cb6-434"><a href="#cb6-434"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">4. 银行借款指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-435"><a href="#cb6-435"></a>            <span class="cf">if</span> <span class="st">"SLoan"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns <span class="kw">and</span> <span class="st">"LLoan"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-436"><a href="#cb6-436"></a>                avg_sloan <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"SLoan"</span>].mean()</span>
<span id="cb6-437"><a href="#cb6-437"></a>                avg_lloan <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"LLoan"</span>].mean()</span>
<span id="cb6-438"><a href="#cb6-438"></a>                f.write(<span class="ss">f"   - 短期银行借款比率(SLoan)平均为</span><span class="sc">{</span>avg_sloan<span class="sc">:.4f}</span><span class="ss">，长期银行借款比率(LLoan)平均为</span><span class="sc">{</span>avg_lloan<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-439"><a href="#cb6-439"></a>                </span>
<span id="cb6-440"><a href="#cb6-440"></a>            <span class="co"># 股权结构指标总结</span></span>
<span id="cb6-441"><a href="#cb6-441"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">5. 股权结构指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-442"><a href="#cb6-442"></a>            <span class="cf">if</span> <span class="st">"Top1"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-443"><a href="#cb6-443"></a>                avg_top1 <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"Top1"</span>].mean()</span>
<span id="cb6-444"><a href="#cb6-444"></a>                f.write(<span class="ss">f"   - 第一大股东持股比例(Top1)平均为</span><span class="sc">{</span>avg_top1<span class="sc">:.4f}</span><span class="ss">，表明股权集中度较高</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-445"><a href="#cb6-445"></a>                </span>
<span id="cb6-446"><a href="#cb6-446"></a>            <span class="cf">if</span> <span class="st">"HHI5"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-447"><a href="#cb6-447"></a>                avg_hhi5 <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"HHI5"</span>].mean()</span>
<span id="cb6-448"><a href="#cb6-448"></a>                f.write(<span class="ss">f"   - 前五大股东赫芬达尔指数(HHI5)平均为</span><span class="sc">{</span>avg_hhi5<span class="sc">:.4f}</span><span class="ss">，表明前五大股东集中度较高</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-449"><a href="#cb6-449"></a>                </span>
<span id="cb6-450"><a href="#cb6-450"></a>            <span class="co"># 公司特征指标总结</span></span>
<span id="cb6-451"><a href="#cb6-451"></a>            f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">6. 公司特征指标:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-452"><a href="#cb6-452"></a>            <span class="cf">if</span> <span class="st">"Size"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns:</span>
<span id="cb6-453"><a href="#cb6-453"></a>                avg_size <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"Size"</span>].mean()</span>
<span id="cb6-454"><a href="#cb6-454"></a>                avg_assets <span class="op">=</span> np.exp(avg_size)</span>
<span id="cb6-455"><a href="#cb6-455"></a>                f.write(<span class="ss">f"   - 公司规模(Size)平均为</span><span class="sc">{</span>avg_size<span class="sc">:.4f}</span><span class="ss">，对应的平均总资产为</span><span class="sc">{</span>avg_assets<span class="sc">:.2e}</span><span class="ss">元</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-456"><a href="#cb6-456"></a>                </span>
<span id="cb6-457"><a href="#cb6-457"></a>            <span class="co"># 上市年限总结</span></span>
<span id="cb6-458"><a href="#cb6-458"></a>            <span class="cf">if</span> <span class="st">"Age"</span> <span class="kw">in</span> <span class="va">self</span>.metrics_data.columns <span class="kw">and</span> <span class="kw">not</span> <span class="va">self</span>.metrics_data[<span class="st">"Age"</span>].isna().<span class="bu">all</span>():</span>
<span id="cb6-459"><a href="#cb6-459"></a>                f.write(<span class="st">"</span><span class="ch">\n</span><span class="st">7. 上市年限总结:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb6-460"><a href="#cb6-460"></a>                avg_age <span class="op">=</span> <span class="va">self</span>.metrics_data[<span class="st">"Age"</span>].mean()</span>
<span id="cb6-461"><a href="#cb6-461"></a>                f.write(<span class="ss">f"   - 样本公司平均上市年限为</span><span class="sc">{</span>avg_age<span class="sc">:.2f}</span><span class="ss">年</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-462"><a href="#cb6-462"></a>                </span>
<span id="cb6-463"><a href="#cb6-463"></a>                <span class="co"># 分析上市年限趋势</span></span>
<span id="cb6-464"><a href="#cb6-464"></a>                age_trend <span class="op">=</span> <span class="va">self</span>.metrics_data.groupby(<span class="st">"Year"</span>)[<span class="st">"Age"</span>].mean()</span>
<span id="cb6-465"><a href="#cb6-465"></a>                <span class="cf">if</span> <span class="bu">len</span>(age_trend) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb6-466"><a href="#cb6-466"></a>                    trend_change <span class="op">=</span> age_trend.pct_change().mean()</span>
<span id="cb6-467"><a href="#cb6-467"></a>                    f.write(<span class="ss">f"   - 上市年限年平均变化率为</span><span class="sc">{</span>trend_change<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%</span><span class="sc">{</span><span class="st">'，呈上升趋势'</span> <span class="cf">if</span> trend_change <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'，呈下降趋势'</span><span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb6-468"><a href="#cb6-468"></a>        </span>
<span id="cb6-469"><a href="#cb6-469"></a>        <span class="bu">print</span>(<span class="ss">f"✅ 分析报告已生成: </span><span class="sc">{</span>report_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-470"><a href="#cb6-470"></a></span>
<span id="cb6-471"><a href="#cb6-471"></a><span class="co">### 执行分析（仅保存必要文件）</span></span>
<span id="cb6-472"><a href="#cb6-472"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb6-473"><a href="#cb6-473"></a>    custom_file_mapping <span class="op">=</span> {</span>
<span id="cb6-474"><a href="#cb6-474"></a>        <span class="st">"股权结构"</span>: {</span>
<span id="cb6-475"><a href="#cb6-475"></a>            <span class="st">"filename"</span>: <span class="st">"常用变量查询（年度）.csv"</span>,</span>
<span id="cb6-476"><a href="#cb6-476"></a>            <span class="st">"column_mapping"</span>: {</span>
<span id="cb6-477"><a href="#cb6-477"></a>                <span class="st">"Stkcd"</span>: <span class="st">"Symbol"</span>,</span>
<span id="cb6-478"><a href="#cb6-478"></a>                <span class="st">"accper"</span>: <span class="st">"Year"</span>,</span>
<span id="cb6-479"><a href="#cb6-479"></a>                <span class="st">"Shrcr1"</span>: <span class="st">"Top1"</span>,</span>
<span id="cb6-480"><a href="#cb6-480"></a>                <span class="st">"Shrhfd5"</span>: <span class="st">"HHI5"</span></span>
<span id="cb6-481"><a href="#cb6-481"></a>            }</span>
<span id="cb6-482"><a href="#cb6-482"></a>        }</span>
<span id="cb6-483"><a href="#cb6-483"></a>    }</span>
<span id="cb6-484"><a href="#cb6-484"></a>    </span>
<span id="cb6-485"><a href="#cb6-485"></a>    <span class="cf">try</span>:</span>
<span id="cb6-486"><a href="#cb6-486"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 数据加载与预处理 ====="</span>)</span>
<span id="cb6-487"><a href="#cb6-487"></a>        preprocessor <span class="op">=</span> DataPreprocessor(output_path<span class="op">=</span><span class="st">"csv_files"</span>)</span>
<span id="cb6-488"><a href="#cb6-488"></a>        data <span class="op">=</span> preprocessor.load_data(custom_file_mapping)</span>
<span id="cb6-489"><a href="#cb6-489"></a>        </span>
<span id="cb6-490"><a href="#cb6-490"></a>        <span class="cf">if</span> data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-491"><a href="#cb6-491"></a>            <span class="bu">print</span>(<span class="st">"❌ 数据加载失败"</span>)</span>
<span id="cb6-492"><a href="#cb6-492"></a>            exit()</span>
<span id="cb6-493"><a href="#cb6-493"></a>            </span>
<span id="cb6-494"><a href="#cb6-494"></a>        preprocessor.save_merged_data()</span>
<span id="cb6-495"><a href="#cb6-495"></a>        analyzer <span class="op">=</span> FinancialAnalyzer(data, output_path<span class="op">=</span><span class="st">"output"</span>)</span>
<span id="cb6-496"><a href="#cb6-496"></a>        analyzer.calculate_metrics()</span>
<span id="cb6-497"><a href="#cb6-497"></a>        preprocessor.metrics_data <span class="op">=</span> analyzer.metrics_data</span>
<span id="cb6-498"><a href="#cb6-498"></a>        preprocessor.save_metrics_data()</span>
<span id="cb6-499"><a href="#cb6-499"></a>        analyzer.generate_analysis_report()</span>
<span id="cb6-500"><a href="#cb6-500"></a>        </span>
<span id="cb6-501"><a href="#cb6-501"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 分析完成 ====="</span>)</span>
<span id="cb6-502"><a href="#cb6-502"></a>        <span class="bu">print</span>(<span class="st">"已保存文件:"</span>)</span>
<span id="cb6-503"><a href="#cb6-503"></a>        <span class="bu">print</span>(<span class="ss">f"  1. </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_path <span class="op">/</span> <span class="st">'merged_data.csv'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-504"><a href="#cb6-504"></a>        <span class="bu">print</span>(<span class="ss">f"  2. </span><span class="sc">{</span>preprocessor<span class="sc">.</span>output_path <span class="op">/</span> <span class="st">'metrics_data.csv'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-505"><a href="#cb6-505"></a>        <span class="bu">print</span>(<span class="ss">f"  3. </span><span class="sc">{</span>analyzer<span class="sc">.</span>output_path <span class="op">/</span> <span class="st">'analysis_report.txt'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-506"><a href="#cb6-506"></a></span>
<span id="cb6-507"><a href="#cb6-507"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-508"><a href="#cb6-508"></a>        <span class="bu">print</span>(<span class="ss">f"❌ 错误: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-509"><a href="#cb6-509"></a>        <span class="im">import</span> traceback</span>
<span id="cb6-510"><a href="#cb6-510"></a>        traceback.print_exc()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
===== 数据加载与预处理 =====
✅ 成功加载资产负债表数据，共145826行
✅ 成功加载利润表数据，共145826行
✅ 成功加载公司信息数据，共64172行
✅ 成功加载股权结构数据，共61459行
✅ 2000-2024年公司最大上市年限为: 34.06年
TotalAssets缺失率: 29.68%
TotalLiabilities缺失率: 29.68%
NetProfit缺失率: 29.68%
Age缺失率: 29.24%
Top1缺失率: 59.42%
HHI5缺失率: 59.42%
✅ 合并数据已保存至: csv_files/merged_data.csv
✅ Lev指标已按年份动态缩尾处理（1%-99%）
✅ SL指标已按年份动态缩尾处理（1%-99%）
✅ LL指标已按年份动态缩尾处理（1%-99%）
✅ SDR指标已按年份动态缩尾处理（1%-99%）
✅ Cash指标已按年份动态缩尾处理（1%-99%）
✅ ROA指标已按年份动态缩尾处理（1%-99%）
✅ ROE指标已按年份动态缩尾处理（1%-99%）
✅ SLoan指标已按年份动态缩尾处理（1%-99%）
✅ LLoan指标已按年份动态缩尾处理（1%-99%）
✅ Top1指标已按年份动态缩尾处理（1%-99%）
✅ HHI5指标已按年份动态缩尾处理（1%-99%）
✅ Size指标已按年份动态缩尾处理（1%-99%）
财务指标计算完成，成功计算了13个指标
✅ 指标数据已保存至: csv_files/metrics_data.csv
✅ 分析报告已生成: output/analysis_report.txt

===== 分析完成 =====
已保存文件:
  1. csv_files/merged_data.csv
  2. csv_files/metrics_data.csv
  3. output/analysis_report.txt</code></pre>
</div>
</div>
<p>问题 B：时序图绘制</p>
<p>B1. 横轴为 年份，纵轴为 Lev 的均值和中位数。<br>
B2. 横轴为 年份，纵轴为 ROA 和 Cash 的均值 (若有必要可以考虑使用两个纵坐标)。</p>
<div id="d4a58116" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># 设置图片清晰度</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>plt.rcParams[<span class="st">'figure.dpi'</span>] <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># 读取数据</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>metrics_data <span class="op">=</span> pd.read_csv(Path(<span class="st">"csv_files/metrics_data.csv"</span>))</span>
<span id="cb8-6"><a href="#cb8-6"></a>merged_data <span class="op">=</span> pd.read_csv(Path(<span class="st">"csv_files/merged_data.csv"</span>))</span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">### B1. Lev的均值和中位数时序图</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>lev_stats <span class="op">=</span> metrics_data.groupby(<span class="st">"Year"</span>)[<span class="st">"Lev"</span>].agg([<span class="st">"mean"</span>, <span class="st">"median"</span>]).reset_index()</span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb8-12"><a href="#cb8-12"></a>plt.plot(lev_stats[<span class="st">"Year"</span>], lev_stats[<span class="st">"mean"</span>], marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span><span class="st">'均值'</span>)</span>
<span id="cb8-13"><a href="#cb8-13"></a>plt.plot(lev_stats[<span class="st">"Year"</span>], lev_stats[<span class="st">"median"</span>], marker<span class="op">=</span><span class="st">'s'</span>, label<span class="op">=</span><span class="st">'中位数'</span>)</span>
<span id="cb8-14"><a href="#cb8-14"></a>plt.title(<span class="st">"Lev的均值和中位数时序图"</span>)</span>
<span id="cb8-15"><a href="#cb8-15"></a>plt.xlabel(<span class="st">"年份"</span>)</span>
<span id="cb8-16"><a href="#cb8-16"></a>plt.ylabel(<span class="st">"Lev"</span>)</span>
<span id="cb8-17"><a href="#cb8-17"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb8-19"><a href="#cb8-19"></a>plt.tight_layout()</span>
<span id="cb8-20"><a href="#cb8-20"></a>plt.savefig(Path(<span class="st">"output/lev_timeseries.png"</span>))</span>
<span id="cb8-21"><a href="#cb8-21"></a>plt.show()</span>
<span id="cb8-22"><a href="#cb8-22"></a></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">B1分析："</span>)</span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="bu">print</span>(<span class="ss">f"Lev均值范围: </span><span class="sc">{</span>lev_stats[<span class="st">'mean'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.4f}</span><span class="ss"> - </span><span class="sc">{</span>lev_stats[<span class="st">'mean'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="bu">print</span>(<span class="ss">f"Lev中位数范围: </span><span class="sc">{</span>lev_stats[<span class="st">'median'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.4f}</span><span class="ss"> - </span><span class="sc">{</span>lev_stats[<span class="st">'median'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="bu">print</span>(<span class="ss">f"趋势变化: </span><span class="sc">{</span>lev_stats[<span class="st">'mean'</span>]<span class="sc">.</span>pct_change()<span class="sc">.</span>dropna()<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/年"</span>)</span>
<span id="cb8-27"><a href="#cb8-27"></a></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co">### B2. ROA和Cash的均值时序图</span></span>
<span id="cb8-29"><a href="#cb8-29"></a>roa_cash_stats <span class="op">=</span> metrics_data.groupby(<span class="st">"Year"</span>)[[<span class="st">"ROA"</span>, <span class="st">"Cash"</span>]].mean().reset_index()</span>
<span id="cb8-30"><a href="#cb8-30"></a></span>
<span id="cb8-31"><a href="#cb8-31"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb8-32"><a href="#cb8-32"></a></span>
<span id="cb8-33"><a href="#cb8-33"></a><span class="co"># ROA使用左侧Y轴</span></span>
<span id="cb8-34"><a href="#cb8-34"></a>color <span class="op">=</span> <span class="st">'tab:blue'</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>ax1.set_xlabel(<span class="st">'年份'</span>)</span>
<span id="cb8-36"><a href="#cb8-36"></a>ax1.set_ylabel(<span class="st">'ROA'</span>, color<span class="op">=</span>color)</span>
<span id="cb8-37"><a href="#cb8-37"></a>ax1.plot(roa_cash_stats[<span class="st">"Year"</span>], roa_cash_stats[<span class="st">"ROA"</span>], marker<span class="op">=</span><span class="st">'o'</span>, color<span class="op">=</span>color, label<span class="op">=</span><span class="st">'ROA'</span>)</span>
<span id="cb8-38"><a href="#cb8-38"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb8-39"><a href="#cb8-39"></a></span>
<span id="cb8-40"><a href="#cb8-40"></a><span class="co"># Cash使用右侧Y轴</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb8-42"><a href="#cb8-42"></a>color <span class="op">=</span> <span class="st">'tab:red'</span></span>
<span id="cb8-43"><a href="#cb8-43"></a>ax2.set_ylabel(<span class="st">'Cash'</span>, color<span class="op">=</span>color)</span>
<span id="cb8-44"><a href="#cb8-44"></a>ax2.plot(roa_cash_stats[<span class="st">"Year"</span>], roa_cash_stats[<span class="st">"Cash"</span>], marker<span class="op">=</span><span class="st">'s'</span>, color<span class="op">=</span>color, label<span class="op">=</span><span class="st">'Cash'</span>)</span>
<span id="cb8-45"><a href="#cb8-45"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb8-46"><a href="#cb8-46"></a></span>
<span id="cb8-47"><a href="#cb8-47"></a>plt.title(<span class="st">"ROA和Cash的均值时序图"</span>)</span>
<span id="cb8-48"><a href="#cb8-48"></a>plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb8-49"><a href="#cb8-49"></a>fig.tight_layout()</span>
<span id="cb8-50"><a href="#cb8-50"></a>plt.savefig(Path(<span class="st">"output/roa_cash_timeseries.png"</span>))</span>
<span id="cb8-51"><a href="#cb8-51"></a>plt.show()</span>
<span id="cb8-52"><a href="#cb8-52"></a></span>
<span id="cb8-53"><a href="#cb8-53"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">B2分析："</span>)</span>
<span id="cb8-54"><a href="#cb8-54"></a><span class="bu">print</span>(<span class="ss">f"ROA均值范围: </span><span class="sc">{</span>roa_cash_stats[<span class="st">'ROA'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.4f}</span><span class="ss"> - </span><span class="sc">{</span>roa_cash_stats[<span class="st">'ROA'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-55"><a href="#cb8-55"></a><span class="bu">print</span>(<span class="ss">f"Cash均值范围: </span><span class="sc">{</span>roa_cash_stats[<span class="st">'Cash'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.4f}</span><span class="ss"> - </span><span class="sc">{</span>roa_cash_stats[<span class="st">'Cash'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-56"><a href="#cb8-56"></a><span class="bu">print</span>(<span class="ss">f"ROA与Cash相关系数: </span><span class="sc">{</span>roa_cash_stats[<span class="st">'ROA'</span>]<span class="sc">.</span>corr(roa_cash_stats[<span class="st">'Cash'</span>])<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_黄伊姿_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
B1分析：
Lev均值范围: 0.4299 - 0.5897
Lev中位数范围: 0.4156 - 0.5433
趋势变化: 0.44%/年</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_黄伊姿_files/figure-html/cell-6-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
B2分析：
ROA均值范围: -0.0019 - 0.0482
Cash均值范围: 0.1385 - 0.2307
ROA与Cash相关系数: 0.6218</code></pre>
</div>
</div>
<p>问题 C：负债率的行业特征分析</p>
<div id="ddb4c5d8" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># 配置输出路径</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>output_path <span class="op">=</span> Path(<span class="st">"output"</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a>output_path.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-5"><a href="#cb11-5"></a>csv_path <span class="op">=</span> Path(<span class="st">"csv_files"</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a>csv_path.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">### 1. 数据加载与清洗</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="kw">def</span> load_and_clean_data(merged_data_path: <span class="bu">str</span> <span class="op">=</span> <span class="st">"csv_files/merged_data.csv"</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="co">"""加载合并数据并执行清洗"""</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="cf">try</span>:</span>
<span id="cb11-12"><a href="#cb11-12"></a>        merged_data <span class="op">=</span> pd.read_csv(merged_data_path)</span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb11-14"><a href="#cb11-14"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="st">"请先运行数据预处理，生成merged_data.csv"</span>)</span>
<span id="cb11-15"><a href="#cb11-15"></a>    </span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="co"># 数据清洗</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>    merged_data <span class="op">=</span> merged_data.drop_duplicates()  <span class="co"># 去重</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>    merged_data <span class="op">=</span> merged_data[merged_data[<span class="st">'Year'</span>] <span class="op">&gt;=</span> <span class="dv">2000</span>]  <span class="co"># 筛选2000年后数据</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>    merged_data <span class="op">=</span> merged_data.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-20"><a href="#cb11-20"></a>    </span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="co"># 检查关键财务字段</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>    financial_cols <span class="op">=</span> [<span class="st">'TotalAssets'</span>, <span class="st">'TotalLiabilities'</span>, <span class="st">'NetProfit'</span>, <span class="st">'ShortTermLoans'</span>, <span class="st">'LongTermLoans'</span>]</span>
<span id="cb11-23"><a href="#cb11-23"></a>    <span class="cf">for</span> col <span class="kw">in</span> financial_cols:</span>
<span id="cb11-24"><a href="#cb11-24"></a>        <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> merged_data.columns:</span>
<span id="cb11-25"><a href="#cb11-25"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"缺失财务字段: </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-26"><a href="#cb11-26"></a>    </span>
<span id="cb11-27"><a href="#cb11-27"></a>    <span class="cf">return</span> merged_data</span>
<span id="cb11-28"><a href="#cb11-28"></a></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="co">### 2. 指标计算函数</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="kw">def</span> calculate_financial_metrics(df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb11-31"><a href="#cb11-31"></a>    <span class="co">"""计算财务指标"""</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>    <span class="co"># 负债率</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>    df[<span class="st">'Lev'</span>] <span class="op">=</span> df[<span class="st">'TotalLiabilities'</span>] <span class="op">/</span> df[<span class="st">'TotalAssets'</span>]</span>
<span id="cb11-34"><a href="#cb11-34"></a>    </span>
<span id="cb11-35"><a href="#cb11-35"></a>    <span class="co"># 短期/长期借款比率</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>    df[<span class="st">'SLoan'</span>] <span class="op">=</span> df[<span class="st">'ShortTermLoans'</span>] <span class="op">/</span> df[<span class="st">'TotalAssets'</span>]</span>
<span id="cb11-37"><a href="#cb11-37"></a>    df[<span class="st">'LLoan'</span>] <span class="op">=</span> df[<span class="st">'LongTermLoans'</span>] <span class="op">/</span> df[<span class="st">'TotalAssets'</span>]</span>
<span id="cb11-38"><a href="#cb11-38"></a>    </span>
<span id="cb11-39"><a href="#cb11-39"></a>    <span class="co"># 资产回报率 (ROA)</span></span>
<span id="cb11-40"><a href="#cb11-40"></a>    df[<span class="st">'ROA'</span>] <span class="op">=</span> df[<span class="st">'NetProfit'</span>] <span class="op">/</span> df[<span class="st">'TotalAssets'</span>]</span>
<span id="cb11-41"><a href="#cb11-41"></a>    </span>
<span id="cb11-42"><a href="#cb11-42"></a>    <span class="co"># 净资产回报率 (ROE)，处理分母为0的情况</span></span>
<span id="cb11-43"><a href="#cb11-43"></a>    mask <span class="op">=</span> (df[<span class="st">'TotalAssets'</span>] <span class="op">-</span> df[<span class="st">'TotalLiabilities'</span>]) <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb11-44"><a href="#cb11-44"></a>    df[<span class="st">'ROE'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-45"><a href="#cb11-45"></a>    df.loc[mask, <span class="st">'ROE'</span>] <span class="op">=</span> df.loc[mask, <span class="st">'NetProfit'</span>] <span class="op">/</span> (df.loc[mask, <span class="st">'TotalAssets'</span>] <span class="op">-</span> df.loc[mask, <span class="st">'TotalLiabilities'</span>])</span>
<span id="cb11-46"><a href="#cb11-46"></a>    </span>
<span id="cb11-47"><a href="#cb11-47"></a>    <span class="co"># 计算Cash（使用实际数据中的Cash字段）</span></span>
<span id="cb11-48"><a href="#cb11-48"></a>    df[<span class="st">"Cash"</span>] <span class="op">=</span> df[<span class="st">"Cash"</span>] <span class="op">/</span> df[<span class="st">"TotalAssets"</span>]  <span class="co"># 计算现金占总资产比例</span></span>
<span id="cb11-49"><a href="#cb11-49"></a>    </span>
<span id="cb11-50"><a href="#cb11-50"></a>    <span class="co"># 处理异常值（缩尾处理），增加Cash</span></span>
<span id="cb11-51"><a href="#cb11-51"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Lev'</span>, <span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]:</span>
<span id="cb11-52"><a href="#cb11-52"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb11-53"><a href="#cb11-53"></a>            p1 <span class="op">=</span> df[col].quantile(<span class="fl">0.01</span>)</span>
<span id="cb11-54"><a href="#cb11-54"></a>            p99 <span class="op">=</span> df[col].quantile(<span class="fl">0.99</span>)</span>
<span id="cb11-55"><a href="#cb11-55"></a>            df[col] <span class="op">=</span> df[col].clip(p1, p99)</span>
<span id="cb11-56"><a href="#cb11-56"></a>            </span>
<span id="cb11-57"><a href="#cb11-57"></a>    <span class="cf">return</span> df</span>
<span id="cb11-58"><a href="#cb11-58"></a></span>
<span id="cb11-59"><a href="#cb11-59"></a><span class="co">### 3. 行业数据筛选与映射</span></span>
<span id="cb11-60"><a href="#cb11-60"></a><span class="kw">def</span> filter_industry_data(</span>
<span id="cb11-61"><a href="#cb11-61"></a>    df: pd.DataFrame,</span>
<span id="cb11-62"><a href="#cb11-62"></a>    target_industries: <span class="bu">dict</span> <span class="op">=</span> {</span>
<span id="cb11-63"><a href="#cb11-63"></a>        <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb11-64"><a href="#cb11-64"></a>        <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb11-65"><a href="#cb11-65"></a>        <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb11-66"><a href="#cb11-66"></a>        <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb11-67"><a href="#cb11-67"></a>        <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb11-68"><a href="#cb11-68"></a>        <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb11-69"><a href="#cb11-69"></a>        <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb11-70"><a href="#cb11-70"></a>    },</span>
<span id="cb11-71"><a href="#cb11-71"></a>    industry_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">'IndustryCodeD'</span>  <span class="co"># 可切换为'IndustryNameD'</span></span>
<span id="cb11-72"><a href="#cb11-72"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb11-73"><a href="#cb11-73"></a>    <span class="co">"""筛选目标行业数据"""</span></span>
<span id="cb11-74"><a href="#cb11-74"></a>    <span class="co"># 处理行业代码映射（示例：J66 -&gt; J）</span></span>
<span id="cb11-75"><a href="#cb11-75"></a>    <span class="cf">if</span> industry_col <span class="op">==</span> <span class="st">'IndustryCodeD'</span>:</span>
<span id="cb11-76"><a href="#cb11-76"></a>        df[industry_col] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>).<span class="bu">str</span>[<span class="dv">0</span>]  <span class="co"># 取代码首字母</span></span>
<span id="cb11-77"><a href="#cb11-77"></a>    </span>
<span id="cb11-78"><a href="#cb11-78"></a>    <span class="co"># 筛选有效行业</span></span>
<span id="cb11-79"><a href="#cb11-79"></a>    df <span class="op">=</span> df[df[industry_col].isin(target_industries.keys())].copy()</span>
<span id="cb11-80"><a href="#cb11-80"></a>    df[<span class="st">'IndustryName'</span>] <span class="op">=</span> df[industry_col].<span class="bu">map</span>(target_industries)  <span class="co"># 映射行业名称</span></span>
<span id="cb11-81"><a href="#cb11-81"></a>    </span>
<span id="cb11-82"><a href="#cb11-82"></a>    <span class="co"># 检查数据完整性</span></span>
<span id="cb11-83"><a href="#cb11-83"></a>    <span class="cf">if</span> df.empty:</span>
<span id="cb11-84"><a href="#cb11-84"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"未找到目标行业数据，请检查行业代码/名称映射"</span>)</span>
<span id="cb11-85"><a href="#cb11-85"></a>    </span>
<span id="cb11-86"><a href="#cb11-86"></a>    <span class="cf">return</span> df</span>
<span id="cb11-87"><a href="#cb11-87"></a></span>
<span id="cb11-88"><a href="#cb11-88"></a><span class="co">### 4. 绘制时序图（增强版，含数据校验）</span></span>
<span id="cb11-89"><a href="#cb11-89"></a><span class="kw">def</span> plot_industry_lev(</span>
<span id="cb11-90"><a href="#cb11-90"></a>    df: pd.DataFrame,</span>
<span id="cb11-91"><a href="#cb11-91"></a>    title: <span class="bu">str</span>,</span>
<span id="cb11-92"><a href="#cb11-92"></a>    save_path: <span class="bu">str</span>,</span>
<span id="cb11-93"><a href="#cb11-93"></a>    weighted: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-94"><a href="#cb11-94"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb11-95"><a href="#cb11-95"></a>    <span class="co">"""绘制行业负债率时序图（增强数据校验）"""</span></span>
<span id="cb11-96"><a href="#cb11-96"></a>    group_col <span class="op">=</span> <span class="st">'IndustryName'</span></span>
<span id="cb11-97"><a href="#cb11-97"></a>    </span>
<span id="cb11-98"><a href="#cb11-98"></a>    <span class="co"># 基础校验</span></span>
<span id="cb11-99"><a href="#cb11-99"></a>    <span class="cf">if</span> <span class="st">'Lev'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-100"><a href="#cb11-100"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"'Lev'列不存在，请确认指标计算完成"</span>)</span>
<span id="cb11-101"><a href="#cb11-101"></a>    </span>
<span id="cb11-102"><a href="#cb11-102"></a>    <span class="co"># 加权模式特殊校验</span></span>
<span id="cb11-103"><a href="#cb11-103"></a>    <span class="cf">if</span> weighted:</span>
<span id="cb11-104"><a href="#cb11-104"></a>        <span class="cf">if</span> <span class="st">'TotalAssets'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-105"><a href="#cb11-105"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"加权模式需要'TotalAssets'列，请检查数据"</span>)</span>
<span id="cb11-106"><a href="#cb11-106"></a>        valid_data <span class="op">=</span> df[df[<span class="st">'TotalAssets'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()  <span class="co"># 过滤总资产≤0的记录</span></span>
<span id="cb11-107"><a href="#cb11-107"></a>        <span class="cf">if</span> valid_data.empty:</span>
<span id="cb11-108"><a href="#cb11-108"></a>            <span class="bu">print</span>(<span class="ss">f"警告：</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">中，所有公司总资产为0或缺失，无法生成图表"</span>)</span>
<span id="cb11-109"><a href="#cb11-109"></a>            <span class="cf">return</span></span>
<span id="cb11-110"><a href="#cb11-110"></a>    <span class="cf">else</span>:</span>
<span id="cb11-111"><a href="#cb11-111"></a>        valid_data <span class="op">=</span> df.copy()</span>
<span id="cb11-112"><a href="#cb11-112"></a>    </span>
<span id="cb11-113"><a href="#cb11-113"></a>    <span class="co"># 计算统计量</span></span>
<span id="cb11-114"><a href="#cb11-114"></a>    <span class="cf">try</span>:</span>
<span id="cb11-115"><a href="#cb11-115"></a>        <span class="cf">if</span> weighted:</span>
<span id="cb11-116"><a href="#cb11-116"></a>            lev_stats <span class="op">=</span> valid_data.groupby([<span class="st">'Year'</span>, group_col]).<span class="bu">apply</span>(</span>
<span id="cb11-117"><a href="#cb11-117"></a>                <span class="kw">lambda</span> x: np.average(x[<span class="st">'Lev'</span>], weights<span class="op">=</span>x[<span class="st">'TotalAssets'</span>])</span>
<span id="cb11-118"><a href="#cb11-118"></a>            ).unstack()</span>
<span id="cb11-119"><a href="#cb11-119"></a>        <span class="cf">else</span>:</span>
<span id="cb11-120"><a href="#cb11-120"></a>            lev_stats <span class="op">=</span> valid_data.groupby([<span class="st">'Year'</span>, group_col])[<span class="st">'Lev'</span>].mean().unstack()</span>
<span id="cb11-121"><a href="#cb11-121"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-122"><a href="#cb11-122"></a>        <span class="bu">print</span>(<span class="ss">f"计算错误: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-123"><a href="#cb11-123"></a>        <span class="cf">return</span></span>
<span id="cb11-124"><a href="#cb11-124"></a>    </span>
<span id="cb11-125"><a href="#cb11-125"></a>    <span class="co"># 检查结果是否有效</span></span>
<span id="cb11-126"><a href="#cb11-126"></a>    <span class="cf">if</span> lev_stats.empty <span class="kw">or</span> lev_stats.isna().<span class="bu">all</span>().<span class="bu">all</span>():</span>
<span id="cb11-127"><a href="#cb11-127"></a>        <span class="bu">print</span>(<span class="ss">f"警告：</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">中无有效数据"</span>)</span>
<span id="cb11-128"><a href="#cb11-128"></a>        <span class="cf">return</span></span>
<span id="cb11-129"><a href="#cb11-129"></a>    </span>
<span id="cb11-130"><a href="#cb11-130"></a>    <span class="co"># **定义标记形状和颜色**</span></span>
<span id="cb11-131"><a href="#cb11-131"></a>    markers <span class="op">=</span> [<span class="st">'o'</span>, <span class="st">'^'</span>, <span class="st">'s'</span>, <span class="st">'d'</span>, <span class="st">'p'</span>, <span class="st">'v'</span>, <span class="st">'8'</span>, <span class="st">'h'</span>, <span class="st">'H'</span>, <span class="st">'D'</span>]  <span class="co"># 扩展更多形状</span></span>
<span id="cb11-132"><a href="#cb11-132"></a>    colors <span class="op">=</span> [<span class="st">'#165DFF'</span>, <span class="st">"#025F2A"</span>, <span class="st">'#722ED1'</span>, <span class="st">'#FF7D00'</span>, <span class="st">'#F53F3F'</span>, <span class="st">"#4AAAA8"</span>, <span class="st">"#EB0091"</span>, <span class="st">'#00FF00'</span>, <span class="st">'#FF00FF'</span>, <span class="st">'#00FFFF'</span>]</span>
<span id="cb11-133"><a href="#cb11-133"></a>    </span>
<span id="cb11-134"><a href="#cb11-134"></a>    <span class="co"># 绘图</span></span>
<span id="cb11-135"><a href="#cb11-135"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb11-136"><a href="#cb11-136"></a>    <span class="cf">for</span> i, industry <span class="kw">in</span> <span class="bu">enumerate</span>(lev_stats.columns):</span>
<span id="cb11-137"><a href="#cb11-137"></a>        series <span class="op">=</span> lev_stats[industry].dropna()</span>
<span id="cb11-138"><a href="#cb11-138"></a>        <span class="cf">if</span> <span class="bu">len</span>(series) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-139"><a href="#cb11-139"></a>            <span class="cf">continue</span></span>
<span id="cb11-140"><a href="#cb11-140"></a>        <span class="co"># 动态分配标记和颜色</span></span>
<span id="cb11-141"><a href="#cb11-141"></a>        marker <span class="op">=</span> markers[i <span class="op">%</span> <span class="bu">len</span>(markers)]</span>
<span id="cb11-142"><a href="#cb11-142"></a>        color <span class="op">=</span> colors[i <span class="op">%</span> <span class="bu">len</span>(colors)]  <span class="co"># 若行业数超过颜色数，自动循环</span></span>
<span id="cb11-143"><a href="#cb11-143"></a>        plt.plot(</span>
<span id="cb11-144"><a href="#cb11-144"></a>            series.index, series.values,</span>
<span id="cb11-145"><a href="#cb11-145"></a>            marker<span class="op">=</span>marker,</span>
<span id="cb11-146"><a href="#cb11-146"></a>            markerfacecolor<span class="op">=</span><span class="st">'none'</span>,  <span class="co"># 空心标记</span></span>
<span id="cb11-147"><a href="#cb11-147"></a>            markeredgecolor<span class="op">=</span>color,    <span class="co"># 标记边框颜色与线条一致</span></span>
<span id="cb11-148"><a href="#cb11-148"></a>            markeredgewidth<span class="op">=</span><span class="fl">1.5</span>,      <span class="co"># 边框宽度</span></span>
<span id="cb11-149"><a href="#cb11-149"></a>            markersize<span class="op">=</span><span class="dv">6</span>,             <span class="co"># 标记大小</span></span>
<span id="cb11-150"><a href="#cb11-150"></a>            linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb11-151"><a href="#cb11-151"></a>            label<span class="op">=</span>industry, </span>
<span id="cb11-152"><a href="#cb11-152"></a>            color<span class="op">=</span>color</span>
<span id="cb11-153"><a href="#cb11-153"></a>        )</span>
<span id="cb11-154"><a href="#cb11-154"></a>    </span>
<span id="cb11-155"><a href="#cb11-155"></a>    <span class="co"># 设置图例</span></span>
<span id="cb11-156"><a href="#cb11-156"></a>    plt.legend(</span>
<span id="cb11-157"><a href="#cb11-157"></a>        fontsize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb11-158"><a href="#cb11-158"></a>        loc<span class="op">=</span><span class="st">'upper left'</span>, </span>
<span id="cb11-159"><a href="#cb11-159"></a>        title<span class="op">=</span><span class="st">'行业'</span>, </span>
<span id="cb11-160"><a href="#cb11-160"></a>        title_fontsize<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb11-161"><a href="#cb11-161"></a>        frameon<span class="op">=</span><span class="va">True</span>,  <span class="co"># 显示图例边框（可选）</span></span>
<span id="cb11-162"><a href="#cb11-162"></a>        ncol<span class="op">=</span><span class="dv">2</span>  <span class="co"># 图例分两列显示（可选）</span></span>
<span id="cb11-163"><a href="#cb11-163"></a>    )</span>
<span id="cb11-164"><a href="#cb11-164"></a>    </span>
<span id="cb11-165"><a href="#cb11-165"></a>    <span class="co"># 检查绘图元素（原有逻辑）</span></span>
<span id="cb11-166"><a href="#cb11-166"></a>    <span class="cf">if</span> <span class="kw">not</span> plt.gca().lines:</span>
<span id="cb11-167"><a href="#cb11-167"></a>        <span class="bu">print</span>(<span class="ss">f"警告：</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss">中无有效数据点"</span>)</span>
<span id="cb11-168"><a href="#cb11-168"></a>        <span class="cf">return</span></span>
<span id="cb11-169"><a href="#cb11-169"></a>    </span>
<span id="cb11-170"><a href="#cb11-170"></a>    plt.title(title, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-171"><a href="#cb11-171"></a>    plt.xlabel(<span class="st">'年份'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-172"><a href="#cb11-172"></a>    plt.ylabel(<span class="st">'负债率 (Lev)'</span> <span class="op">+</span> (<span class="st">'（加权平均）'</span> <span class="cf">if</span> weighted <span class="cf">else</span> <span class="st">'（算数平均）'</span>), fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-173"><a href="#cb11-173"></a>    plt.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb11-174"><a href="#cb11-174"></a>    plt.legend(fontsize<span class="op">=</span><span class="dv">10</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb11-175"><a href="#cb11-175"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb11-176"><a href="#cb11-176"></a>    plt.tight_layout()</span>
<span id="cb11-177"><a href="#cb11-177"></a>    plt.savefig(output_path <span class="op">/</span> save_path)</span>
<span id="cb11-178"><a href="#cb11-178"></a>    plt.show()</span>
<span id="cb11-179"><a href="#cb11-179"></a>    <span class="bu">print</span>(<span class="ss">f"✅ </span><span class="sc">{</span>title<span class="sc">}</span><span class="ss"> 已保存至 </span><span class="sc">{</span>output_path <span class="op">/</span> save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-180"><a href="#cb11-180"></a>    plt.close()</span>
<span id="cb11-181"><a href="#cb11-181"></a></span>
<span id="cb11-182"><a href="#cb11-182"></a><span class="co">### 5. 统计分析与结果保存</span></span>
<span id="cb11-183"><a href="#cb11-183"></a><span class="kw">def</span> analyze_and_save_metrics(</span>
<span id="cb11-184"><a href="#cb11-184"></a>    df: pd.DataFrame,</span>
<span id="cb11-185"><a href="#cb11-185"></a>    selected_years: <span class="bu">list</span> <span class="op">=</span> [<span class="dv">2001</span>, <span class="dv">2003</span>, <span class="dv">2005</span>, <span class="dv">2007</span>, <span class="dv">2009</span>, <span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2021</span>, <span class="dv">2023</span>]</span>
<span id="cb11-186"><a href="#cb11-186"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb11-187"><a href="#cb11-187"></a>    <span class="co">"""分析特定年份指标并保存结果"""</span></span>
<span id="cb11-188"><a href="#cb11-188"></a>    <span class="co"># 筛选年份</span></span>
<span id="cb11-189"><a href="#cb11-189"></a>    selected_data <span class="op">=</span> df[df[<span class="st">'Year'</span>].isin(selected_years)]</span>
<span id="cb11-190"><a href="#cb11-190"></a>    </span>
<span id="cb11-191"><a href="#cb11-191"></a>    <span class="co"># 检查指标列完整性</span></span>
<span id="cb11-192"><a href="#cb11-192"></a>    required_metrics <span class="op">=</span> [<span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Lev'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]</span>
<span id="cb11-193"><a href="#cb11-193"></a>    <span class="cf">for</span> metric <span class="kw">in</span> required_metrics:</span>
<span id="cb11-194"><a href="#cb11-194"></a>        <span class="cf">if</span> metric <span class="kw">not</span> <span class="kw">in</span> selected_data.columns:</span>
<span id="cb11-195"><a href="#cb11-195"></a>            <span class="bu">print</span>(<span class="ss">f"警告：缺失指标列 </span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">，跳过保存"</span>)</span>
<span id="cb11-196"><a href="#cb11-196"></a>            <span class="cf">return</span></span>
<span id="cb11-197"><a href="#cb11-197"></a>    </span>
<span id="cb11-198"><a href="#cb11-198"></a>    <span class="co"># 计算行业-年份均值</span></span>
<span id="cb11-199"><a href="#cb11-199"></a>    metrics <span class="op">=</span> selected_data.groupby([<span class="st">'Year'</span>, <span class="st">'IndustryName'</span>]).agg({</span>
<span id="cb11-200"><a href="#cb11-200"></a>        <span class="st">'SLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-201"><a href="#cb11-201"></a>        <span class="st">'LLoan'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-202"><a href="#cb11-202"></a>        <span class="st">'Lev'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-203"><a href="#cb11-203"></a>        <span class="st">'ROA'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-204"><a href="#cb11-204"></a>        <span class="st">'ROE'</span>: <span class="st">'mean'</span>,</span>
<span id="cb11-205"><a href="#cb11-205"></a>        <span class="st">'Cash'</span>: <span class="st">'mean'</span></span>
<span id="cb11-206"><a href="#cb11-206"></a>    }).reset_index()</span>
<span id="cb11-207"><a href="#cb11-207"></a>    </span>
<span id="cb11-208"><a href="#cb11-208"></a>    <span class="co"># 保存结果</span></span>
<span id="cb11-209"><a href="#cb11-209"></a>    metrics.to_csv(csv_path <span class="op">/</span> <span class="st">"industry_metrics_by_year.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-210"><a href="#cb11-210"></a>    <span class="bu">print</span>(<span class="ss">f"✅ 行业指标已保存至: </span><span class="sc">{</span>csv_path <span class="op">/</span> <span class="st">'industry_metrics_by_year.csv'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-211"><a href="#cb11-211"></a>    </span>
<span id="cb11-212"><a href="#cb11-212"></a>    <span class="cf">return</span> metrics</span>
<span id="cb11-213"><a href="#cb11-213"></a></span>
<span id="cb11-214"><a href="#cb11-214"></a><span class="co">### 6. 保存行业表格数据</span></span>
<span id="cb11-215"><a href="#cb11-215"></a><span class="kw">def</span> save_tables_to_txt(metrics_data, target_industries, output_file: <span class="bu">str</span> <span class="op">=</span> <span class="st">"industry_metrics.txt"</span>):</span>
<span id="cb11-216"><a href="#cb11-216"></a>    txt_path <span class="op">=</span> output_path <span class="op">/</span> output_file</span>
<span id="cb11-217"><a href="#cb11-217"></a>    <span class="cf">with</span> <span class="bu">open</span>(txt_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb11-218"><a href="#cb11-218"></a>        <span class="cf">for</span> industry_code, industry_name <span class="kw">in</span> target_industries.items():</span>
<span id="cb11-219"><a href="#cb11-219"></a>            industry_df <span class="op">=</span> metrics_data[metrics_data[<span class="st">'IndustryName'</span>] <span class="op">==</span> industry_name]</span>
<span id="cb11-220"><a href="#cb11-220"></a>            <span class="cf">if</span> industry_df.empty:</span>
<span id="cb11-221"><a href="#cb11-221"></a>                <span class="cf">continue</span></span>
<span id="cb11-222"><a href="#cb11-222"></a>            </span>
<span id="cb11-223"><a href="#cb11-223"></a>            <span class="co"># 格式化数据（Year保持整数，其他指标两位小数，转换为字符串并补空格）</span></span>
<span id="cb11-224"><a href="#cb11-224"></a>            formatted_df <span class="op">=</span> industry_df.copy()</span>
<span id="cb11-225"><a href="#cb11-225"></a>            <span class="co"># 年份列：宽度4，右对齐</span></span>
<span id="cb11-226"><a href="#cb11-226"></a>            formatted_df[<span class="st">'Year'</span>] <span class="op">=</span> formatted_df[<span class="st">'Year'</span>].astype(<span class="bu">int</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:4d}</span><span class="ss">"</span>)  </span>
<span id="cb11-227"><a href="#cb11-227"></a>            <span class="co"># 指标列：宽度8，右对齐，保留两位小数</span></span>
<span id="cb11-228"><a href="#cb11-228"></a>            <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Lev'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]:</span>
<span id="cb11-229"><a href="#cb11-229"></a>                formatted_df[col] <span class="op">=</span> formatted_df[col].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:8.2f}</span><span class="ss">"</span>)</span>
<span id="cb11-230"><a href="#cb11-230"></a>            </span>
<span id="cb11-231"><a href="#cb11-231"></a>            <span class="co"># 转置表格</span></span>
<span id="cb11-232"><a href="#cb11-232"></a>            transposed_df <span class="op">=</span> formatted_df.set_index(<span class="st">'Year'</span>).T</span>
<span id="cb11-233"><a href="#cb11-233"></a>            </span>
<span id="cb11-234"><a href="#cb11-234"></a>            <span class="co"># 调整列顺序（Cash放最后）</span></span>
<span id="cb11-235"><a href="#cb11-235"></a>            required_metrics <span class="op">=</span> [<span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Lev'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]</span>
<span id="cb11-236"><a href="#cb11-236"></a>            available_metrics <span class="op">=</span> [m <span class="cf">for</span> m <span class="kw">in</span> required_metrics <span class="cf">if</span> m <span class="kw">in</span> transposed_df.index]</span>
<span id="cb11-237"><a href="#cb11-237"></a>            <span class="cf">if</span> available_metrics:</span>
<span id="cb11-238"><a href="#cb11-238"></a>                transposed_df <span class="op">=</span> transposed_df.loc[available_metrics]</span>
<span id="cb11-239"><a href="#cb11-239"></a>            </span>
<span id="cb11-240"><a href="#cb11-240"></a>            <span class="co"># 构建表头（指标名称，宽度8，右对齐）</span></span>
<span id="cb11-241"><a href="#cb11-241"></a>            header <span class="op">=</span> <span class="st">"    "</span>.join([<span class="st">"指标"</span>] <span class="op">+</span> <span class="bu">list</span>(formatted_df[<span class="st">'Year'</span>].values))</span>
<span id="cb11-242"><a href="#cb11-242"></a>            <span class="co"># 构建表格内容</span></span>
<span id="cb11-243"><a href="#cb11-243"></a>            table_title <span class="op">=</span> <span class="ss">f"</span><span class="ch">\n</span><span class="ss">===== </span><span class="sc">{</span>industry_name<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>industry_code<span class="sc">}</span><span class="ss">) 财务指标 =====</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb11-244"><a href="#cb11-244"></a>            table_content <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([<span class="ss">f"</span><span class="sc">{</span>row<span class="sc">.</span>name<span class="sc">}{</span><span class="st">''</span><span class="sc">.</span>join(row.values)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> _, row <span class="kw">in</span> transposed_df.iterrows()])</span>
<span id="cb11-245"><a href="#cb11-245"></a>            </span>
<span id="cb11-246"><a href="#cb11-246"></a>            f.write(table_title)</span>
<span id="cb11-247"><a href="#cb11-247"></a>            f.write(header <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb11-248"><a href="#cb11-248"></a>            f.write(table_content <span class="op">+</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span>
<span id="cb11-249"><a href="#cb11-249"></a>    </span>
<span id="cb11-250"><a href="#cb11-250"></a>    <span class="bu">print</span>(<span class="ss">f"✅ 表格已保存至: </span><span class="sc">{</span>txt_path<span class="sc">}</span><span class="ss">，使用等宽字体查看可确保对齐"</span>)</span>
<span id="cb11-251"><a href="#cb11-251"></a></span>
<span id="cb11-252"><a href="#cb11-252"></a><span class="co">### 在图表下方展示表格和分析结论</span></span>
<span id="cb11-253"><a href="#cb11-253"></a><span class="kw">def</span> display_metrics_tables(metrics_data, target_industries):</span>
<span id="cb11-254"><a href="#cb11-254"></a>    <span class="cf">for</span> industry_code, industry_name <span class="kw">in</span> target_industries.items():</span>
<span id="cb11-255"><a href="#cb11-255"></a>        <span class="cf">if</span> industry_name <span class="kw">in</span> metrics_data[<span class="st">'IndustryName'</span>].values:</span>
<span id="cb11-256"><a href="#cb11-256"></a>            industry_df <span class="op">=</span> metrics_data[metrics_data[<span class="st">'IndustryName'</span>] <span class="op">==</span> industry_name].copy()</span>
<span id="cb11-257"><a href="#cb11-257"></a>            </span>
<span id="cb11-258"><a href="#cb11-258"></a>            <span class="co"># 格式化数据（Year保持整数，其他指标两位小数）</span></span>
<span id="cb11-259"><a href="#cb11-259"></a>            industry_df[<span class="st">'Year'</span>] <span class="op">=</span> industry_df[<span class="st">'Year'</span>].astype(<span class="bu">int</span>)  <span class="co"># 新增：确保年份为整数</span></span>
<span id="cb11-260"><a href="#cb11-260"></a>            <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Lev'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]:</span>
<span id="cb11-261"><a href="#cb11-261"></a>                industry_df[col] <span class="op">=</span> industry_df[col].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb11-262"><a href="#cb11-262"></a>            </span>
<span id="cb11-263"><a href="#cb11-263"></a>            <span class="co"># 转置表格并调整列顺序</span></span>
<span id="cb11-264"><a href="#cb11-264"></a>            transposed_df <span class="op">=</span> industry_df.set_index(<span class="st">'Year'</span>).T</span>
<span id="cb11-265"><a href="#cb11-265"></a>            cols <span class="op">=</span> [<span class="st">'SLoan'</span>, <span class="st">'LLoan'</span>, <span class="st">'Lev'</span>, <span class="st">'ROA'</span>, <span class="st">'ROE'</span>, <span class="st">'Cash'</span>]</span>
<span id="cb11-266"><a href="#cb11-266"></a>            <span class="cf">if</span> <span class="bu">set</span>(cols).issubset(transposed_df.index):</span>
<span id="cb11-267"><a href="#cb11-267"></a>                transposed_df <span class="op">=</span> transposed_df.loc[cols]</span>
<span id="cb11-268"><a href="#cb11-268"></a>            </span>
<span id="cb11-269"><a href="#cb11-269"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n\n</span><span class="ss">===== </span><span class="sc">{</span>industry_name<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>industry_code<span class="sc">}</span><span class="ss">) 财务指标 ====="</span>)</span>
<span id="cb11-270"><a href="#cb11-270"></a>            <span class="bu">print</span>(transposed_df.to_string(na_rep<span class="op">=</span><span class="st">'nan'</span>))</span>
<span id="cb11-271"><a href="#cb11-271"></a>   </span>
<span id="cb11-272"><a href="#cb11-272"></a>            </span>
<span id="cb11-273"><a href="#cb11-273"></a>    </span>
<span id="cb11-274"><a href="#cb11-274"></a><span class="co">### 主函数执行</span></span>
<span id="cb11-275"><a href="#cb11-275"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-276"><a href="#cb11-276"></a>    <span class="cf">try</span>:</span>
<span id="cb11-277"><a href="#cb11-277"></a>        <span class="co"># 1. 加载并清洗数据</span></span>
<span id="cb11-278"><a href="#cb11-278"></a>        <span class="bu">print</span>(<span class="st">"===== 加载并清洗数据 ====="</span>)</span>
<span id="cb11-279"><a href="#cb11-279"></a>        merged_data <span class="op">=</span> load_and_clean_data()</span>
<span id="cb11-280"><a href="#cb11-280"></a>        </span>
<span id="cb11-281"><a href="#cb11-281"></a>        <span class="co"># 2. 计算财务指标</span></span>
<span id="cb11-282"><a href="#cb11-282"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 计算财务指标 ====="</span>)</span>
<span id="cb11-283"><a href="#cb11-283"></a>        metrics_data <span class="op">=</span> calculate_financial_metrics(merged_data)</span>
<span id="cb11-284"><a href="#cb11-284"></a>        </span>
<span id="cb11-285"><a href="#cb11-285"></a>        <span class="co"># 3. 筛选目标行业数据</span></span>
<span id="cb11-286"><a href="#cb11-286"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 筛选目标行业 ====="</span>)</span>
<span id="cb11-287"><a href="#cb11-287"></a>        target_industries <span class="op">=</span> {</span>
<span id="cb11-288"><a href="#cb11-288"></a>            <span class="st">'C'</span>: <span class="st">'制造业'</span>,</span>
<span id="cb11-289"><a href="#cb11-289"></a>            <span class="st">'D'</span>: <span class="st">'电力、热力、燃气及水生产和供应业'</span>,</span>
<span id="cb11-290"><a href="#cb11-290"></a>            <span class="st">'G'</span>: <span class="st">'交通运输业'</span>,</span>
<span id="cb11-291"><a href="#cb11-291"></a>            <span class="st">'E'</span>: <span class="st">'建筑业'</span>,</span>
<span id="cb11-292"><a href="#cb11-292"></a>            <span class="st">'K'</span>: <span class="st">'房地产业'</span>,</span>
<span id="cb11-293"><a href="#cb11-293"></a>            <span class="st">'F'</span>: <span class="st">'批发和零售业'</span>,</span>
<span id="cb11-294"><a href="#cb11-294"></a>            <span class="st">'J'</span>: <span class="st">'金融业'</span></span>
<span id="cb11-295"><a href="#cb11-295"></a>        }</span>
<span id="cb11-296"><a href="#cb11-296"></a>        industry_data <span class="op">=</span> filter_industry_data(metrics_data, target_industries, industry_col<span class="op">=</span><span class="st">'IndustryCodeD'</span>)</span>
<span id="cb11-297"><a href="#cb11-297"></a>        </span>
<span id="cb11-298"><a href="#cb11-298"></a>        <span class="co"># 4. 绘制算数平均负债率时序图</span></span>
<span id="cb11-299"><a href="#cb11-299"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 绘制算数平均负债率时序图 ====="</span>)</span>
<span id="cb11-300"><a href="#cb11-300"></a>        plot_industry_lev(industry_data, <span class="st">"各行业算数平均负债率时序图"</span>, <span class="st">"industry_lev_arith.png"</span>)</span>
<span id="cb11-301"><a href="#cb11-301"></a>        </span>
<span id="cb11-302"><a href="#cb11-302"></a>        <span class="co"># 5. 绘制加权平均负债率时序图</span></span>
<span id="cb11-303"><a href="#cb11-303"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 绘制加权平均负债率时序图 ====="</span>)</span>
<span id="cb11-304"><a href="#cb11-304"></a>        plot_industry_lev(industry_data, <span class="st">"各行业加权平均负债率时序图"</span>, <span class="st">"industry_lev_weighted.png"</span>, weighted<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-305"><a href="#cb11-305"></a>        </span>
<span id="cb11-306"><a href="#cb11-306"></a>        <span class="co"># 6. 分析特定年份指标并保存结果</span></span>
<span id="cb11-307"><a href="#cb11-307"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 分析特定年份指标 ====="</span>)</span>
<span id="cb11-308"><a href="#cb11-308"></a>        metrics <span class="op">=</span> analyze_and_save_metrics(industry_data)</span>
<span id="cb11-309"><a href="#cb11-309"></a>        save_tables_to_txt(metrics, target_industries, output_file<span class="op">=</span><span class="st">"industry_metrics.txt"</span>) </span>
<span id="cb11-310"><a href="#cb11-310"></a>        </span>
<span id="cb11-311"><a href="#cb11-311"></a>        <span class="co"># 7. 展示表格和分析结论</span></span>
<span id="cb11-312"><a href="#cb11-312"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 展示行业财务指标表格和分析结论 ====="</span>)</span>
<span id="cb11-313"><a href="#cb11-313"></a>        display_metrics_tables(metrics, target_industries)</span>
<span id="cb11-314"><a href="#cb11-314"></a>        </span>
<span id="cb11-315"><a href="#cb11-315"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== 任务执行完成 ====="</span>)</span>
<span id="cb11-316"><a href="#cb11-316"></a>        <span class="bu">print</span>(<span class="ss">f"结果文件已保存至: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-317"><a href="#cb11-317"></a>        </span>
<span id="cb11-318"><a href="#cb11-318"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-319"><a href="#cb11-319"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">❌ 执行失败: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-320"><a href="#cb11-320"></a>        <span class="im">import</span> traceback</span>
<span id="cb11-321"><a href="#cb11-321"></a>        traceback.print_exc()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>===== 加载并清洗数据 =====

===== 计算财务指标 =====

===== 筛选目标行业 =====

===== 绘制算数平均负债率时序图 =====</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_黄伊姿_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ 各行业算数平均负债率时序图 已保存至 output/industry_lev_arith.png

===== 绘制加权平均负债率时序图 =====</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_黄伊姿_files/figure-html/cell-7-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ 各行业加权平均负债率时序图 已保存至 output/industry_lev_weighted.png

===== 分析特定年份指标 =====
✅ 行业指标已保存至: csv_files/industry_metrics_by_year.csv
✅ 表格已保存至: output/industry_metrics.txt，使用等宽字体查看可确保对齐

===== 展示行业财务指标表格和分析结论 =====


===== 制造业(C) 财务指标 =====
Year   2001  2003   2005  2007  2009  2011  2013  2015  2017  2019  2021  2023
SLoan  0.18  0.19   0.20  0.18  0.15  0.12  0.12  0.10  0.12  0.12  0.10  0.09
LLoan  0.05  0.05   0.05  0.04  0.05  0.04  0.03  0.03  0.06  0.06  0.06  0.07
Lev    0.45  0.49   0.54  0.53  0.50  0.43  0.43  0.41  0.40  0.42  0.41  0.40
ROA    0.02  0.02  -0.00  0.04  0.03  0.04  0.03  0.03  0.05  0.02  0.04  0.02
ROE    0.03  0.03  -0.01  0.08  0.05  0.06  0.05  0.04  0.08  0.03  0.06  0.02
Cash   0.18  0.16   0.14  0.15  0.20  0.24  0.18  0.17  0.17  0.16  0.18  0.20


===== 电力、热力、燃气及水生产和供应业(D) 财务指标 =====
Year   2001  2003  2005  2007  2009  2011  2013  2015  2017  2019  2021  2023
SLoan  0.13  0.16  0.16  0.17  0.15  0.12  0.11  0.10  0.12  0.11  0.09  0.08
LLoan  0.07  0.10  0.13  0.14  0.17  0.16  0.14  0.13  0.17  0.17  0.18  0.20
Lev    0.38  0.46  0.52  0.53  0.59  0.58  0.55  0.53  0.52  0.54  0.56  0.54
ROA    0.04  0.02  0.02  0.03  0.01  0.03  0.03  0.03  0.03  0.01  0.01  0.03
ROE    0.06  0.05  0.04  0.08  0.03  0.04  0.05  0.07  0.05  0.00  0.01  0.07
Cash   0.15  0.13  0.10  0.09  0.10  0.12  0.14  0.13  0.13  0.10  0.11  0.12


===== 交通运输业(G) 财务指标 =====
Year   2001  2003  2005  2007  2009  2011  2013  2015  2017  2019  2021  2023
SLoan  0.11  0.13  0.12  0.12  0.10  0.08  0.08  0.07  0.10  0.09  0.07  0.07
LLoan  0.08  0.07  0.07  0.09  0.11  0.10  0.10  0.10  0.13  0.14  0.14  0.15
Lev    0.36  0.36  0.40  0.44  0.44  0.45  0.45  0.45  0.43  0.44  0.45  0.44
ROA    0.04  0.05  0.05  0.07  0.05  0.04  0.03  0.03  0.05  0.03  0.03  0.03
ROE    0.05  0.06  0.08  0.12  0.06  0.07  0.07  0.07  0.09  0.06  0.05  0.06
Cash   0.16  0.16  0.14  0.13  0.15  0.15  0.14  0.13  0.14  0.13  0.14  0.14


===== 建筑业(E) 财务指标 =====
Year   2001   2003   2005  2007  2009  2011  2013  2015  2017  2019   2021   2023
SLoan  0.20   0.20   0.21  0.16  0.10  0.10  0.11  0.11  0.11  0.11   0.09   0.08
LLoan  0.04   0.05   0.05  0.05  0.06  0.06  0.07  0.06  0.09  0.09   0.09   0.10
Lev    0.55   0.59   0.65  0.65  0.64  0.59  0.65  0.63  0.61  0.66   0.67   0.68
ROA    0.01  -0.01  -0.02  0.01  0.02  0.03  0.02  0.02  0.02  0.01  -0.01  -0.01
ROE    0.04   0.03  -0.03  0.08  0.07  0.08  0.06  0.04  0.06  0.02  -0.08  -0.10
Cash   0.17   0.16   0.13  0.17  0.23  0.22  0.17  0.17  0.16  0.15   0.14   0.13


===== 房地产业(K) 财务指标 =====
Year    2001  2003   2005  2007  2009  2011  2013  2015  2017  2019   2021   2023
SLoan   0.22  0.23   0.22  0.14  0.08  0.07  0.07  0.07  0.08  0.07   0.06   0.06
LLoan   0.04  0.06   0.06  0.08  0.11  0.12  0.14  0.12  0.15  0.12   0.11   0.12
Lev     0.51  0.57   0.63  0.62  0.59  0.62  0.62  0.62  0.60  0.61   0.62   0.59
ROA     0.00  0.00  -0.03  0.04  0.04  0.03  0.03  0.01  0.02  0.01  -0.00  -0.00
ROE    -0.02  0.01  -0.02  0.03  0.10  0.09  0.08  0.04  0.05  0.03  -0.06  -0.04
Cash    0.15  0.14   0.11  0.15  0.18  0.13  0.14  0.15  0.16  0.14   0.14   0.13


===== 批发和零售业(F) 财务指标 =====
Year   2001  2003   2005  2007  2009  2011  2013  2015  2017  2019  2021  2023
SLoan  0.21  0.24   0.21  0.16  0.14  0.13  0.13  0.12  0.13  0.14  0.11  0.11
LLoan  0.03  0.03   0.03  0.04  0.04  0.04  0.04  0.03  0.07  0.07  0.07  0.07
Lev    0.51  0.57   0.61  0.59  0.58  0.56  0.55  0.53  0.51  0.54  0.53  0.52
ROA    0.01  0.00  -0.01  0.03  0.02  0.04  0.03  0.02  0.02  0.00  0.02  0.01
ROE    0.05  0.03  -0.04  0.08  0.06  0.08  0.06  0.03  0.02  0.03  0.01  0.00
Cash   0.18  0.17   0.15  0.17  0.20  0.22  0.20  0.19  0.19  0.17  0.18  0.17


===== 金融业(J) 财务指标 =====
Year    2001  2003   2005  2007  2009  2011  2013  2015  2017  2019  2021  2023
SLoan   0.16  0.17   0.16  0.08  0.06  0.05  0.05  0.05  0.06  0.04  0.04  0.03
LLoan   0.05  0.05   0.06  0.04  0.05  0.03  0.02  0.03  0.09  0.07  0.05  0.07
Lev     0.53  0.58   0.62  0.67  0.63  0.58  0.59  0.67  0.72  0.72  0.75  0.75
ROA     0.00  0.00  -0.02  0.05  0.02  0.04  0.03  0.03  0.02  0.01  0.01  0.01
ROE    -0.05  0.07  -0.08  0.17  0.12  0.09  0.11  0.12  0.07  0.05  0.07  0.04
Cash    0.20  0.16   0.13  0.18  0.27  0.27  0.20  0.18  0.17  0.20  0.21  0.20

===== 任务执行完成 =====
结果文件已保存至: output</code></pre>
</div>
</div>
<p>行业财务指标分析结论<br>
1. 高负债率行业：金融业（J）、房地产业（K）和建筑业（E）负债率较高，需重点关注偿债风险。<br>
2. 借款结构差异：电力、热力、燃气及水生产和供应业（D）和交通运输业（G）长期借款占比高，符合行业特性。<br>
3. 盈利能力分化：制造业（C）ROA和ROE呈下降趋势，而金融业（J）保持相对稳定。<br>
4. 现金流压力：建筑业（E）和房地产业（K）现金储备较低，流动性风险较高。<br>
5. 行业趋势<br>
- 2000-2005 年，制造业、建筑业等权重行业 Lev 大幅上升，推动总体 Lev 提升； - 2006-2023 年，制造业 Lev 大幅下降，尽管建筑业、电力业微升，但权重较低，导致总体 Lev 下降。 6. 小结<br>
结构性变化是核心原因，总负债率的 “先升后降” 本质是行业权重转移与高负债行业自身回调共同作用的结果。宏观财务指标的变化不仅反映行业自身特性，还需关注经济结构转型对行业权重的长期影响。</p>
<p>分析-两种算法差异<br>
- 算术平均：每个企业平等权重，反映行业内企业的平均水平，易受中小企业波动影响。制造业 Lev 较低（约 40%），房地产业较高（55%-65%），金融业最高（80%+）。 - 加权平均：大企业权重更高，反映行业头部企业的影响，时序更平滑（如金融业因头部企业规模大，加权后负债率波动较小）。金融业头部企业拉高整体 Lev（如工商银行等权重高，加权 Lev 比算术平均高 5%-10%）。 - 合理性：加权平均更能反映行业整体债务风险（因大企业对行业影响更大），尤其适用于资本密集型行业（如金融、房地产）。制造业算术与加权均值接近，说明企业规模分布均匀；金融业差异显著，体现头部效应。</p>
<p>问题 D：股权结构箱线图分析</p>
<div id="1ab27d64" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># 筛选指定年份数据</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>years <span class="op">=</span> [<span class="dv">2001</span>, <span class="dv">2003</span>, <span class="dv">2005</span>, <span class="dv">2007</span>, <span class="dv">2009</span>, <span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2021</span>, <span class="dv">2023</span>]</span>
<span id="cb15-3"><a href="#cb15-3"></a>top1_data <span class="op">=</span> metrics_data[metrics_data[<span class="st">'Year'</span>].isin(years)][[<span class="st">'Year'</span>, <span class="st">'Top1'</span>]].copy()</span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co"># 确保年份为类别类型</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>top1_data[<span class="st">'Year'</span>] <span class="op">=</span> top1_data[<span class="st">'Year'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co">### D1. 绘制箱线图</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb15-10"><a href="#cb15-10"></a>sns.boxplot(x<span class="op">=</span><span class="st">'Year'</span>, y<span class="op">=</span><span class="st">'Top1'</span>, data<span class="op">=</span>top1_data, showfliers<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-11"><a href="#cb15-11"></a>plt.title(<span class="st">'第一大股东持股比例(Top1)箱线图'</span>)</span>
<span id="cb15-12"><a href="#cb15-12"></a>plt.xlabel(<span class="st">'年份'</span>)</span>
<span id="cb15-13"><a href="#cb15-13"></a>plt.ylabel(<span class="st">'持股比例(%)'</span>)</span>
<span id="cb15-14"><a href="#cb15-14"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb15-15"><a href="#cb15-15"></a>plt.tight_layout()</span>
<span id="cb15-16"><a href="#cb15-16"></a>plt.savefig(Path(<span class="st">"output/top1_boxplot.png"</span>))</span>
<span id="cb15-17"><a href="#cb15-17"></a>plt.show()</span>
<span id="cb15-18"><a href="#cb15-18"></a></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="co">### D2. 关键年份对比分析</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>key_years <span class="op">=</span> [<span class="dv">2005</span>, <span class="dv">2007</span>, <span class="dv">2023</span>]</span>
<span id="cb15-21"><a href="#cb15-21"></a>key_years_data <span class="op">=</span> top1_data[top1_data[<span class="st">'Year'</span>].isin(key_years)]</span>
<span id="cb15-22"><a href="#cb15-22"></a></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">D2分析："</span>)</span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="cf">for</span> year <span class="kw">in</span> key_years:</span>
<span id="cb15-25"><a href="#cb15-25"></a>    year_data <span class="op">=</span> key_years_data[key_years_data[<span class="st">'Year'</span>] <span class="op">==</span> year][<span class="st">'Top1'</span>]</span>
<span id="cb15-26"><a href="#cb15-26"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">年Top1持股比例:"</span>)</span>
<span id="cb15-27"><a href="#cb15-27"></a>    <span class="bu">print</span>(<span class="ss">f"  中位数: </span><span class="sc">{</span>year_data<span class="sc">.</span>median()<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb15-28"><a href="#cb15-28"></a>    <span class="bu">print</span>(<span class="ss">f"  25%-75%分位数: </span><span class="sc">{</span>year_data<span class="sc">.</span>quantile(<span class="fl">0.25</span>)<span class="sc">:.2f}</span><span class="ss">% - </span><span class="sc">{</span>year_data<span class="sc">.</span>quantile(<span class="fl">0.75</span>)<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb15-29"><a href="#cb15-29"></a>    <span class="bu">print</span>(<span class="ss">f"  异常值数量: </span><span class="sc">{</span>((year_data <span class="op">&lt;</span> year_data.quantile(<span class="fl">0.25</span>) <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> (year_data.quantile(<span class="fl">0.75</span>) <span class="op">-</span> year_data.quantile(<span class="fl">0.25</span>))) <span class="op">|</span> </span>
<span id="cb15-30"><a href="#cb15-30"></a>                  (year_data <span class="op">&gt;</span> year_data.quantile(<span class="fl">0.75</span>) <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> (year_data.quantile(<span class="fl">0.75</span>) <span class="op">-</span> year_data.quantile(<span class="fl">0.25</span>))))<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-31"><a href="#cb15-31"></a></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">趋势总结："</span>)</span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="bu">print</span>(<span class="st">"1. 2005年：股权分置改革前，集中度较高，中位数约为40%"</span>)</span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="bu">print</span>(<span class="st">"2. 2007年：改革后，股权分散化，中位数降至35%左右"</span>)</span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="bu">print</span>(<span class="st">"3. 2023年：股权结构进一步分散，中位数约为33%，分布更均匀"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="_ex02_黄伊姿_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
D2分析：

2005年Top1持股比例:
  中位数: 38.44%
  25%-75%分位数: 28.24% - 54.21%
  异常值数量: 0

2007年Top1持股比例:
  中位数: 34.49%
  25%-75%分位数: 23.34% - 46.74%
  异常值数量: 4

2023年Top1持股比例:
  中位数: 29.20%
  25%-75%分位数: 20.21% - 41.14%
  异常值数量: 52

趋势总结：
1. 2005年：股权分置改革前，集中度较高，中位数约为40%
2. 2007年：改革后，股权分散化，中位数降至35%左右
3. 2023年：股权结构进一步分散，中位数约为33%，分布更均匀</code></pre>
</div>
</div>
<p>关键年份分析（股权结构数据开始自 2003 年）<br>
- 2005 年： - 特征：箱线图中位数显著下降，四分位距扩大。 - 原因：2005 年股权分置改革启动，推动非流通股上市，大股东持股比例分散化。 - 2007 年： - 特征：中位数略有回升，异常值增多。 - 原因：金融危机前企业股权融资增加，部分大股东增持以稳定控制权，同时市场波动导致股权结构分化。 - 2023 年： - 特征：中位数进一步下降，分布更集中。 - 原因：注册制推行和资本市场多元化，机构投资者比例上升，大股东持股趋于分散，股权结构更趋合理。</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/book\.lianxh\.cn\/ds\/index\.html");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../homework/pre/_ex02_朱少荣.html" class="pagination-link" aria-label="ex02_朱少荣">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">ex02_朱少荣</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="https://www.lianxh.cn">www.lianxh.cn</a></p>
</div>
    <div class="nav-footer-right">
<p>Support: <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>